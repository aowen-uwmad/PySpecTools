<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <title>pyspectools.mmw.mmw_analysis &#8212; PySpecTools 4.4.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html">
          PySpecTools</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq.html">PySpecTools FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pyspectools.spectra.html"><cite>Spectra</cite> Module</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">PySpecTools</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
              
                
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <h1>Source code for pyspectools.mmw.mmw_analysis</h1><div class="highlight"><pre>
<span></span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">lmfit</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">peakutils</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>

<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">fft_routines</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">interpolation</span>
<span class="kn">from</span> <span class="nn">..lineshapes</span> <span class="kn">import</span> <span class="n">sec_deriv_lorentzian</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Miscellanous routines for parsing and batch processing</span>
<span class="sd">    the millimeter-wave data.</span>
<span class="sd">&quot;&quot;&quot;</span>

<div class="viewcode-block" id="parse_data"><a class="viewcode-back" href="../../../pyspectools.mmw.html#pyspectools.mmw.mmw_analysis.parse_data">[docs]</a><span class="k">def</span> <span class="nf">parse_data</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function for parsing data from a millimeter-wave</span>
<span class="sd">        data file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">settings</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="n">intensity</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="c1"># Boolean flags to check when to start/stop</span>
    <span class="c1"># reading parameters</span>
    <span class="n">read_params</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">read_int</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">read_zeeman</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">finished</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">fieldoff_intensities</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">fieldon_intensities</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">read_file</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">read_file</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;*****&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="n">read_int</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">finished</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="s2">&quot;Scan&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;[Field ON]&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
                    <span class="n">read_zeeman</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">scan_details</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">scan_details</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="c1"># settings[&quot;Date&quot;] = str(scan_details[4])</span>
                <span class="n">read_params</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">read_int</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">read_int</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">read_zeeman</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">fieldoff_intensities</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fieldon_intensities</span> <span class="o">+=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()]</span>
                    <span class="n">finished</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">read_params</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># Read in the frequency step, frequency, and other info</span>
                <span class="c1"># needed to reconstruct the frequency data</span>
                <span class="n">scan_params</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
                <span class="n">shift</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">scan_params</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;Frequency step&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">scan_params</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scan_params</span><span class="p">)</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                    <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;Multiplier&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.</span>
                    <span class="n">shift</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="c1"># If the multiplier data is there, we don&#39;t shift the read</span>
                <span class="c1"># index over by one</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;Multiplier&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">scan_params</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;Center&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">scan_params</span><span class="p">[</span><span class="mi">2</span> <span class="o">+</span> <span class="n">shift</span><span class="p">])</span>
                <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;Points&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">scan_params</span><span class="p">[</span><span class="mi">3</span> <span class="o">+</span> <span class="n">shift</span><span class="p">])</span>
                <span class="n">read_params</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># Start reading intensities immediately afterwards</span>
                <span class="n">read_int</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">continue</span>
    <span class="n">fieldoff_intensities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fieldoff_intensities</span><span class="p">)</span>
    <span class="n">fieldon_intensities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fieldon_intensities</span><span class="p">)</span>

    <span class="c1"># Generate the frequency grid</span>
    <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;Frequency step&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;Frequency step&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;Multiplier&quot;</span><span class="p">]</span>
    <span class="c1"># This calculates the length of either side</span>
    <span class="n">side_length</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;Frequency step&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">settings</span><span class="p">[</span><span class="s2">&quot;Points&quot;</span><span class="p">]</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">start_freq</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">side_length</span>
    <span class="n">end_freq</span> <span class="o">=</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">side_length</span>
    <span class="n">frequency</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">start_freq</span><span class="p">,</span> <span class="n">end_freq</span><span class="p">,</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;Points&quot;</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">fieldoff_intensities</span><span class="p">,</span> <span class="n">fieldon_intensities</span><span class="p">,</span> <span class="n">settings</span></div>


<div class="viewcode-block" id="open_mmw"><a class="viewcode-back" href="../../../pyspectools.mmw.html#pyspectools.mmw.mmw_analysis.open_mmw">[docs]</a><span class="k">def</span> <span class="nf">open_mmw</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function for opening and processing a single millimeter</span>
<span class="sd">        wave data file.</span>
<span class="sd">        </span>
<span class="sd">        Returns a pandas dataframe containing Frequency and</span>
<span class="sd">        Intensity information.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">frequency</span><span class="p">,</span> <span class="n">fieldoff_intensities</span><span class="p">,</span> <span class="n">fieldon_intensities</span><span class="p">,</span> <span class="n">settings</span> <span class="o">=</span> <span class="n">parse_data</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
    <span class="c1"># Sometimes there are spurious zeros at the end of intensity data;</span>
    <span class="c1"># this will trim the padding</span>
    <span class="n">npoints</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Points&quot;</span><span class="p">)</span>
    <span class="n">fieldoff_intensities</span> <span class="o">=</span> <span class="n">fieldoff_intensities</span><span class="p">[:</span><span class="n">npoints</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">fieldon_intensities</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">fieldon_intensities</span> <span class="o">=</span> <span class="n">fieldon_intensities</span><span class="p">[:</span><span class="n">npoints</span><span class="p">]</span>
    <span class="c1"># Calculate sample rate in Hz for FFT step</span>
    <span class="n">sample_rate</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="n">settings</span><span class="p">[</span><span class="s2">&quot;Frequency step&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">1e6</span>
    <span class="n">param_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;window_function&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;cutoff&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">690</span><span class="p">],</span>
        <span class="s2">&quot;sample_rate&quot;</span><span class="p">:</span> <span class="n">sample_rate</span>
    <span class="p">}</span>
    <span class="n">param_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="n">fieldoff_intensities</span> <span class="o">=</span> <span class="n">fft_routines</span><span class="o">.</span><span class="n">fft_filter</span><span class="p">(</span><span class="n">fieldoff_intensities</span><span class="p">,</span> <span class="o">**</span><span class="n">param_dict</span><span class="p">)</span>
    <span class="c1"># field on is not always there, but if it we use it to calculate Off - On</span>
    <span class="k">if</span> <span class="n">fieldon_intensities</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">fieldon_intensities</span> <span class="o">=</span> <span class="n">fft_routines</span><span class="o">.</span><span class="n">fft_filter</span><span class="p">(</span><span class="n">fieldon_intensities</span><span class="p">,</span> <span class="o">**</span><span class="n">param_dict</span><span class="p">)</span>
        <span class="n">intensity</span> <span class="o">=</span> <span class="n">fieldoff_intensities</span> <span class="o">-</span> <span class="n">fieldon_intensities</span>
    <span class="k">else</span><span class="p">:</span>
    <span class="c1"># if field on is missing, just use zeros instead</span>
        <span class="n">fieldon_intensities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">fieldoff_intensities</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">intensity</span> <span class="o">=</span> <span class="n">fieldoff_intensities</span>
    <span class="c1"># Format the data as a Pandas dataframe</span>
    <span class="n">mmw_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;Frequency&quot;</span><span class="p">:</span> <span class="n">frequency</span><span class="p">,</span> 
              <span class="s2">&quot;Field OFF&quot;</span><span class="p">:</span> <span class="n">fieldoff_intensities</span><span class="p">,</span> 
              <span class="s2">&quot;Field ON&quot;</span><span class="p">:</span> <span class="n">fieldon_intensities</span><span class="p">,</span> 
              <span class="s2">&quot;OFF - ON&quot;</span><span class="p">:</span> <span class="n">intensity</span>
              <span class="p">},</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">mmw_df</span></div>


<div class="viewcode-block" id="test_filtering"><a class="viewcode-back" href="../../../pyspectools.mmw.html#pyspectools.mmw.mmw_analysis.test_filtering">[docs]</a><span class="k">def</span> <span class="nf">test_filtering</span><span class="p">(</span><span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Convenience function to open a legacy data file and</span>
<span class="sd">    process it; kwargs are passed to the `fft_filter`</span>
<span class="sd">    function call. The function then returns a Matplotlib</span>
<span class="sd">    figure and axis object, showing the FFT filtered</span>
<span class="sd">    spectrum and the time-domain signal chunk that it</span>
<span class="sd">    corresponds to.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path : str</span>
<span class="sd">        Filepath to the data file.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    fig, ax</span>
<span class="sd">        Matplotlib figure/axis objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">frequency</span><span class="p">,</span> <span class="n">off</span><span class="p">,</span> <span class="n">on</span><span class="p">,</span> <span class="n">settings</span> <span class="o">=</span> <span class="n">parse_data</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">filtered</span> <span class="o">=</span> <span class="n">fft_routines</span><span class="o">.</span><span class="n">fft_filter</span><span class="p">(</span><span class="n">off</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    
    <span class="n">fig</span><span class="p">,</span> <span class="n">axarray</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
    
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axarray</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Frequency domain&quot;</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="n">filtered</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Frequency (MHz)&quot;</span><span class="p">)</span>
    
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axarray</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Time domain&quot;</span><span class="p">)</span>
    <span class="n">cutoff</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cutoff&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="mi">500</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft</span><span class="p">(</span><span class="n">filtered</span><span class="p">)[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">*</span><span class="n">cutoff</span><span class="p">)])</span>
    
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span></div>


<div class="viewcode-block" id="sec_deriv_peak_detection"><a class="viewcode-back" href="../../../pyspectools.mmw.html#pyspectools.mmw.mmw_analysis.sec_deriv_peak_detection">[docs]</a><span class="k">def</span> <span class="nf">sec_deriv_peak_detection</span><span class="p">(</span><span class="n">df_group</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">magnet_thres</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function designed to take advantage of split-combine-apply techniques to analyze</span>
<span class="sd">    concatenated spectra, or a single spectrum. The spectrum is cross-correlated with</span>
<span class="sd">    a window corresponding to a second-derivative Lorentzian line shape, with the parameters</span>
<span class="sd">    corresponding to the actual downward facing peak such that the cross-correlation</span>
<span class="sd">    is upwards facing for a match.</span>
<span class="sd">    </span>
<span class="sd">    This X-correlation analysis is only done for the Field OFF data; every peak</span>
<span class="sd">    should appear in the Field OFF, and should disappear under the presence of</span>
<span class="sd">    a magnetic field. If the Field ON spectrum is non-zero, the peak finding is</span>
<span class="sd">    followed up by calculating the ratio of the intensity at the same position</span>
<span class="sd">    for ON/OFF; if the ratio is below a threshold, we consider it a magnetic line.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_group : pandas DataFrame</span>
<span class="sd">        Dataframe containing the millimeter-wave spectra.</span>
<span class="sd">    threshold : int, optional</span>
<span class="sd">        Absolute intensity units threshold for peak detection.</span>
<span class="sd">        This value corresponds to the value used in the X-correlation</span>
<span class="sd">        spectrum, by default 5</span>
<span class="sd">    window_size : int, optional</span>
<span class="sd">        Size of the second derivative Lorentizan window function, </span>
<span class="sd">        by default 25</span>
<span class="sd">    magnet_thres : float, optional</span>
<span class="sd">        Threshold for determining if a peak is magnetic, given</span>
<span class="sd">        as the ratio of ON/OFF. A value of 1 means the line is</span>
<span class="sd">        nominally unaffected by a magnetic field, and less than</span>
<span class="sd">        1 corresponds to larger responses to magnetic fields. </span>
<span class="sd">        By default 0.5</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas DataFrame</span>
<span class="sd">        DataFrame holding the detected peaks and their associated</span>
<span class="sd">        magnet tests, if applicable.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Get the frequencies and whatnot as numpy arrays; peakutils does not play</span>
    <span class="c1"># nicely with Series objects.</span>
    <span class="n">signal</span> <span class="o">=</span> <span class="n">df_group</span><span class="p">[</span><span class="s2">&quot;Field OFF&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="n">frequency</span> <span class="o">=</span> <span class="n">df_group</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    <span class="c1"># Improve SNR with cross-correlation</span>
    <span class="n">corr_signal</span> <span class="o">=</span> <span class="n">cross_correlate_lorentzian</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">window_size</span><span class="p">)</span>
    <span class="c1"># Find the peaks that match the specified threshold</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">peakutils</span><span class="o">.</span><span class="n">indexes</span><span class="p">(</span><span class="n">corr_signal</span><span class="p">,</span> <span class="n">thres</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">thres_abs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">peak_subset</span> <span class="o">=</span> <span class="n">df_group</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
    <span class="c1"># Only evaluate magnetic if spectrum has a Field ON component</span>
    <span class="k">if</span> <span class="n">peak_subset</span><span class="p">[</span><span class="s2">&quot;Field ON&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">:</span>
        <span class="n">peak_subset</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;Ratio&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_subset</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;Field ON&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">peak_subset</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;Field OFF&quot;</span><span class="p">]</span>
        <span class="n">peak_subset</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;Magnetic&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">peak_subset</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s2">&quot;Ratio&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">magnet_thres</span>
    <span class="k">return</span> <span class="n">peak_subset</span></div>


<div class="viewcode-block" id="cross_correlate_lorentzian"><a class="viewcode-back" href="../../../pyspectools.mmw.html#pyspectools.mmw.mmw_analysis.cross_correlate_lorentzian">[docs]</a><span class="k">def</span> <span class="nf">cross_correlate_lorentzian</span><span class="p">(</span><span class="n">signal</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the cross-correlation spectrum between an input signal and the</span>
<span class="sd">    second derivative lineshape of a Lorentzian function. This is a matched</span>
<span class="sd">    filter analysis to extract optimal signal to noise for millimeter-wave</span>
<span class="sd">    data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    signal : np.ndarray</span>
<span class="sd">        NumPy 1D array containing the raw signal.</span>
<span class="sd">    window_size : int</span>
<span class="sd">        Size of the window function.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    corr_signal</span>
<span class="sd">        NumPy 1D array containing the cross-correlation spectrum.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;x0&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
        <span class="s2">&quot;gamma&quot;</span><span class="p">:</span> <span class="mf">0.25</span><span class="p">,</span>
        <span class="s2">&quot;I&quot;</span><span class="p">:</span> <span class="mi">1</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="c1"># Create a template of the second derivative Lorentzian profile for</span>
    <span class="c1"># x-correlating with the spectrum</span>
    <span class="n">temp_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">window_size</span><span class="p">)</span>
    <span class="n">temp_y</span> <span class="o">=</span> <span class="n">sec_deriv_lorentzian</span><span class="p">(</span><span class="n">temp_x</span><span class="p">,</span> <span class="o">**</span><span class="n">params</span><span class="p">)</span>
    <span class="c1"># Cross-correlate with the Lorentzian profile; &quot;same&quot; mode ensures</span>
    <span class="c1"># it is the same length as the original signal for easy indexing</span>
    <span class="n">corr_signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">correlate</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">temp_y</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;same&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">corr_signal</span></div>
    

<div class="viewcode-block" id="interp_mmw"><a class="viewcode-back" href="../../../pyspectools.mmw.html#pyspectools.mmw.mmw_analysis.interp_mmw">[docs]</a><span class="k">def</span> <span class="nf">interp_mmw</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">nelements</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">window_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function that will process archival millimeter-wave data</span>
<span class="sd">        by providing a list of filepaths.</span>
<span class="sd">        </span>
<span class="sd">        The function will parse the data out of each file, and</span>
<span class="sd">        produce a plot that is stitched together.</span>
<span class="sd">        </span>
<span class="sd">        The first step is to read in all the data, and append</span>
<span class="sd">        the parsed data into full_freq and full_int, corresponding</span>
<span class="sd">        to the experimental frequency and intensities. This is</span>
<span class="sd">        used to then determine the limits to the x axis for plotting.</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">full_freq</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">full_int</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Parsing files.&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
        <span class="n">frequency</span><span class="p">,</span> <span class="n">intensity</span><span class="p">,</span> <span class="n">settings</span> <span class="o">=</span> <span class="n">parse_data</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
        <span class="n">intensity</span> <span class="o">=</span> <span class="n">fft_routines</span><span class="o">.</span><span class="n">fft_filter</span><span class="p">(</span><span class="n">intensity</span><span class="p">,</span> <span class="n">window_function</span><span class="p">,</span> <span class="n">cutoff</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">minx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span>
            <span class="n">maxx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">curr_minx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span>
            <span class="n">curr_maxx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">curr_minx</span> <span class="o">&lt;</span> <span class="n">minx</span><span class="p">:</span>
                <span class="n">minx</span> <span class="o">=</span> <span class="n">curr_minx</span>
            <span class="k">if</span> <span class="n">curr_maxx</span> <span class="o">&gt;</span> <span class="n">maxx</span><span class="p">:</span>
                <span class="n">maxx</span> <span class="o">=</span> <span class="n">curr_maxx</span>
        <span class="n">full_freq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span>
        <span class="n">full_int</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">intensity</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stitching the spectrum together using a weighted</span>
<span class="sd">        Shepard interpolation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Lowest frequency: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">minx</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Highest frequency: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">maxx</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Performing Shepard interpolation&quot;</span><span class="p">)</span>
    <span class="n">frequency</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">minx</span><span class="p">,</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">nelements</span><span class="p">)</span>
    <span class="n">interp_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">nelements</span><span class="p">)</span>
    
    <span class="c1"># Loop over each frequency bin</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">interp_freq</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">frequency</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">frequency</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">0.5</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;50</span><span class="si">% d</span><span class="s2">one.&quot;</span><span class="p">)</span>
        <span class="c1"># Calculate the Shepard interpolation at the given frequency point</span>
        <span class="n">interp_y</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">interpolation</span><span class="o">.</span><span class="n">eval_shep_interp</span><span class="p">(</span><span class="n">full_freq</span><span class="p">,</span> <span class="n">full_int</span><span class="p">,</span> <span class="n">interp_freq</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">16.</span><span class="p">)</span>
    
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="n">interp_y</span><span class="p">)),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">,</span> <span class="s2">&quot;Intensity&quot;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="batch_interpolate"><a class="viewcode-back" href="../../../pyspectools.mmw.html#pyspectools.mmw.mmw_analysis.batch_interpolate">[docs]</a><span class="k">def</span> <span class="nf">batch_interpolate</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">datapoints</span><span class="o">=</span><span class="mi">50000</span><span class="p">,</span> <span class="n">zeeman_on</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">window_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pass_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function for batch processing multiple scan files, and concetanates them</span>
<span class="sd">        together to generate a single, interactive spectrum.</span>
<span class="sd">        </span>
<span class="sd">        Takes input argument files as a list of filepaths corresponding to scans</span>
<span class="sd">        that are (generally) without Zeeman. The optional argument, zeeman_on,</span>
<span class="sd">        is a list of filepaths corresponding to scans with Zeeman on.</span>
<span class="sd">        </span>
<span class="sd">        All of the scans will be processed with the same window functions and</span>
<span class="sd">        cut offs, so be sure to optimize them before batch processing.</span>
<span class="sd">        </span>
<span class="sd">        Returns a dataframe with up to three columns: Zeeman off/on, and off - on.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">spectrum_df</span> <span class="o">=</span> <span class="n">interp_mmw</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">datapoints</span><span class="p">,</span> <span class="n">window_function</span><span class="p">,</span> <span class="n">pass_filter</span><span class="p">)</span>
    <span class="c1"># If Zeeman on spectra are provided, we process those too, and perform subtraction</span>
    <span class="k">if</span> <span class="n">zeeman_on</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">zeeman_on_df</span> <span class="o">=</span> <span class="n">interp_mmw</span><span class="p">(</span><span class="n">zeeman_on</span><span class="p">,</span> <span class="n">datapoints</span><span class="p">,</span> <span class="n">window_function</span><span class="p">,</span> <span class="n">pass_filter</span><span class="p">)</span>
        <span class="n">spectrum_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">,</span> <span class="s2">&quot;Zeeman OFF&quot;</span><span class="p">]</span>
        <span class="n">spectrum_df</span><span class="p">[</span><span class="s2">&quot;Zeeman ON&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">zeeman_on_df</span><span class="p">[</span><span class="s2">&quot;Intensity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
        <span class="n">spectrum_df</span><span class="p">[</span><span class="s2">&quot;OFF - ON&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">spectrum_df</span><span class="p">[</span><span class="s2">&quot;Zeeman OFF&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">spectrum_df</span><span class="p">[</span><span class="s2">&quot;Zeeman ON&quot;</span><span class="p">]</span>
    
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_spectrum</span><span class="p">(</span><span class="n">spectrum_df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">df</span></div>


<div class="viewcode-block" id="batch_shepard"><a class="viewcode-back" href="../../../pyspectools.mmw.html#pyspectools.mmw.mmw_analysis.batch_shepard">[docs]</a><span class="k">def</span> <span class="nf">batch_shepard</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">stepsize</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">xrange</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">4.</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">npoints</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">window_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pass_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Routine for performing mass interpolation using Shepard&#39;s interpolation method</span>
<span class="sd">        on mmw data. Input is a list of files, and parameters used to interpolate and</span>
<span class="sd">        to filter the data.</span>
<span class="sd">        </span>
<span class="sd">        Stepsize is given in units of MHz.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading data...&quot;</span><span class="p">)</span>
    <span class="n">datalist</span> <span class="o">=</span> <span class="p">[</span>
        <span class="n">open_mmw</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">window_function</span><span class="p">,</span> <span class="n">pass_filter</span><span class="p">)</span> <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span>
    <span class="p">]</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Load complete.&quot;</span><span class="p">)</span>
    <span class="n">min_freq</span> <span class="o">=</span> <span class="mf">1e9</span>
    <span class="n">max_freq</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finding frequency range&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">datalist</span><span class="p">:</span>
        <span class="n">current_min</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">current_max</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">current_min</span> <span class="o">&lt;</span> <span class="n">min_freq</span><span class="p">:</span>
            <span class="n">min_freq</span> <span class="o">=</span> <span class="n">current_min</span>
        <span class="k">if</span> <span class="n">current_max</span> <span class="o">&gt;</span> <span class="n">max_freq</span><span class="p">:</span>
            <span class="n">max_freq</span> <span class="o">=</span> <span class="n">current_max</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Max freq: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">max_freq</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Min freq: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">min_freq</span><span class="p">))</span>
    <span class="c1"># Initialize the new frequency range in one MHz steps</span>
    <span class="n">xnew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_freq</span><span class="p">,</span> <span class="n">max_freq</span><span class="p">,</span> <span class="n">stepsize</span><span class="p">)</span>
    <span class="n">new_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">xnew</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Performing interpolation&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Zeeman OFF&quot;</span><span class="p">,</span> <span class="s2">&quot;Zeeman ON&quot;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
        <span class="n">new_df</span><span class="p">[</span><span class="n">column</span><span class="p">]</span> <span class="o">=</span> <span class="n">interpolation</span><span class="o">.</span><span class="n">calc_shep_interp</span><span class="p">(</span>
            <span class="n">datalist</span><span class="p">,</span>
            <span class="n">xnew</span><span class="p">,</span>
            <span class="n">column</span><span class="p">,</span>
            <span class="n">p</span><span class="p">,</span>
            <span class="n">threshold</span><span class="p">,</span>
            <span class="n">npoints</span>
        <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Interpolation done&quot;</span><span class="p">)</span>
    <span class="n">new_df</span><span class="p">[</span><span class="s2">&quot;OFF - ON&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_df</span><span class="p">[</span><span class="s2">&quot;Zeeman OFF&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">new_df</span><span class="p">[</span><span class="s2">&quot;Zeeman ON&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">new_df</span>  </div>


<div class="viewcode-block" id="batch_plot"><a class="viewcode-back" href="../../../pyspectools.mmw.html#pyspectools.mmw.mmw_analysis.batch_plot">[docs]</a><span class="k">def</span> <span class="nf">batch_plot</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">window_function</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pass_filter</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">full_df</span> <span class="o">=</span> <span class="n">open_mmw</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">window_function</span><span class="p">,</span> <span class="n">pass_filter</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">full_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span>
                <span class="n">full_df</span><span class="p">,</span>
                <span class="n">open_mmw</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">window_function</span><span class="p">,</span> <span class="n">pass_filter</span><span class="p">)</span>
            <span class="p">])</span>
    <span class="n">full_df</span> <span class="o">=</span> <span class="n">full_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;Frequency&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plot_spectrum</span><span class="p">(</span><span class="n">full_df</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">full_df</span><span class="p">,</span> <span class="n">fig</span></div>


<div class="viewcode-block" id="fit_spectrum_chunk"><a class="viewcode-back" href="../../../pyspectools.mmw.html#pyspectools.mmw.mmw_analysis.fit_spectrum_chunk">[docs]</a><span class="k">def</span> <span class="nf">fit_spectrum_chunk</span><span class="p">(</span><span class="n">dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">freq_range</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">frequencies</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Automates the fitting of multiple frequencies to a single spectrum.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    dataframe : pd.DataFrame</span>
<span class="sd">        Pandas DataFrame containing the millimeter-wave spectrum.</span>
<span class="sd">    freq_range : 2-tuple</span>
<span class="sd">        Iterable with two floats, corresponding to the limits of the spectrum</span>
<span class="sd">        (in frequency) we want to consider for the fit.</span>
<span class="sd">    frequencies : np.ndarray</span>
<span class="sd">        NumPy 1D array containing center frequencies to fit.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    [type]</span>
<span class="sd">        [description]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">freq_range</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">freq_range</span><span class="p">)</span>
    <span class="n">sliced_df</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="o">*</span><span class="n">freq_range</span><span class="p">)]</span>
    <span class="n">sliced_df</span><span class="p">[</span><span class="s2">&quot;XCorrelation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cross_correlate_lorentzian</span><span class="p">(</span>
        <span class="n">sliced_df</span><span class="p">[</span><span class="s2">&quot;Field OFF&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
    <span class="n">param_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="c1"># Build fitting objective function from sum of second derivative</span>
    <span class="c1"># profiles</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">frequency</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">frequencies</span><span class="p">):</span>
        <span class="n">curr_model</span> <span class="o">=</span> <span class="n">lmfit</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">(</span>
            <span class="n">sec_deriv_lorentzian</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Line</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">_&quot;</span>
        <span class="p">)</span>
        <span class="n">curr_params</span> <span class="o">=</span> <span class="n">curr_model</span><span class="o">.</span><span class="n">make_params</span><span class="p">()</span>
        <span class="n">curr_params</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Line</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">_x0&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">frequency</span> <span class="o">-</span> <span class="mf">0.3</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="n">frequency</span> <span class="o">-</span> <span class="mf">15.</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="n">frequency</span> <span class="o">+</span> <span class="mf">15.</span><span class="p">)</span>
        <span class="n">curr_params</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Line</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">_I&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="o">=-</span><span class="mf">1.</span><span class="p">,</span> <span class="nb">min</span><span class="o">=-</span><span class="mf">20.</span><span class="p">,</span> <span class="nb">max</span><span class="o">=-</span><span class="mf">0.05</span><span class="p">)</span>
        <span class="n">curr_params</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Line</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">_gamma&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="nb">min</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">curr_model</span>
            <span class="n">parameters</span> <span class="o">=</span> <span class="n">curr_params</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">+=</span> <span class="n">curr_model</span>
            <span class="n">parameters</span> <span class="o">+=</span> <span class="n">curr_params</span>
            
    <span class="c1"># Fit the cumulative spectrum </span>
    <span class="n">fit_results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span>
        <span class="n">sliced_df</span><span class="p">[</span><span class="s2">&quot;XCorrelation&quot;</span><span class="p">],</span>
        <span class="n">parameters</span><span class="p">,</span>
        <span class="n">x</span><span class="o">=</span><span class="n">sliced_df</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    <span class="n">sliced_df</span><span class="p">[</span><span class="s2">&quot;Fit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_results</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

    <span class="c1"># print(&quot;Results of the fit:&quot;)</span>
    <span class="c1"># for param, covar in zip(fit_results.best_values, np.sqrt(np.diag(fit_results.covar))):</span>
    <span class="c1">#     print(param + &quot;: &quot; + str(fit_results.best_values[param]) + &quot;  +/-  &quot; + str(covar))</span>
    
    <span class="k">return</span> <span class="n">fit_results</span><span class="p">,</span> <span class="n">sliced_df</span></div>


<div class="viewcode-block" id="fit_lines"><a class="viewcode-back" href="../../../pyspectools.mmw.html#pyspectools.mmw.mmw_analysis.fit_lines">[docs]</a><span class="k">def</span> <span class="nf">fit_lines</span><span class="p">(</span><span class="n">dataframe</span><span class="p">,</span> <span class="n">frequencies</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">window_length</span><span class="o">=</span><span class="mf">10.</span><span class="p">,</span> <span class="n">ycol</span><span class="o">=</span><span class="s2">&quot;Field off&quot;</span><span class="p">,</span> <span class="n">off_dataframe</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Wrapper for the fit_chunk function, for when you want to</span>
<span class="sd">        try and fit many lines in a catalog.</span>
<span class="sd">        </span>
<span class="sd">        The input arguments are the survey dataframe, a list of</span>
<span class="sd">        center frequencies you want to try and fit, the name of</span>
<span class="sd">        the species. Optional argument is the name of column you</span>
<span class="sd">        want to use for the intensities.</span>
<span class="sd">        </span>
<span class="sd">        The function will iterate through each center frequency</span>
<span class="sd">        and try to fit it.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">foldername</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;../data/clean/mmw_fits/</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">foldername</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">FileExistsError</span><span class="p">:</span>
        <span class="k">pass</span>
    
    <span class="n">successes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">fit_freq</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">amplitudes</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">uncertainties</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    
    <span class="c1"># Loop over each catalog frequency</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">frequency</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">frequencies</span><span class="p">):</span>
        
        <span class="c1"># Slice out a 20 MHz window - this should be sufficiently</span>
        <span class="c1"># large to capture uncertainty in lines</span>
        <span class="n">min_freq</span> <span class="o">=</span> <span class="n">frequency</span> <span class="o">-</span> <span class="n">window_length</span>
        <span class="n">max_freq</span> <span class="o">=</span> <span class="n">frequency</span> <span class="o">+</span> <span class="n">window_length</span>
        <span class="c1"># Attempt to fit the window</span>
        <span class="n">fit</span><span class="p">,</span> <span class="n">spec_df</span> <span class="o">=</span> <span class="n">fit_spectrum_chunk</span><span class="p">(</span>
            <span class="n">dataframe</span><span class="p">,</span>
            <span class="n">min_freq</span><span class="p">,</span>
            <span class="n">max_freq</span><span class="p">,</span>
            <span class="p">[</span><span class="n">frequency</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">fit_freq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">fit</span><span class="o">.</span><span class="n">best_values</span><span class="p">[</span><span class="s2">&quot;center0&quot;</span><span class="p">],</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">amplitudes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">fit</span><span class="o">.</span><span class="n">best_values</span><span class="p">[</span><span class="s2">&quot;A0&quot;</span><span class="p">],</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">uncertainties</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">fit</span><span class="o">.</span><span class="n">covar</span><span class="p">))[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">successes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">package</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">successes</span><span class="p">,</span> <span class="n">fit_freq</span><span class="p">,</span> <span class="n">uncertainties</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">))</span>
    <span class="n">fit_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
        <span class="n">data</span><span class="o">=</span><span class="n">package</span><span class="p">,</span> 
        <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Catalog frequency&quot;</span><span class="p">,</span> <span class="s2">&quot;Success&quot;</span><span class="p">,</span> <span class="s2">&quot;Fitted frequency&quot;</span><span class="p">,</span> <span class="s2">&quot;Uncertainty&quot;</span><span class="p">,</span> <span class="s2">&quot;Amplitude&quot;</span><span class="p">]</span>
    <span class="p">)</span>
    
    <span class="n">fit_df</span><span class="p">[</span><span class="s2">&quot;Calc. vs Obs.&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_df</span><span class="p">[</span><span class="s2">&quot;Catalog frequency&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">fit_df</span><span class="p">[</span><span class="s2">&quot;Fitted frequency&quot;</span><span class="p">]</span>
    
    <span class="n">fit_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">foldername</span> <span class="o">+</span> <span class="s2">&quot;/fit_results.csv&quot;</span><span class="p">)</span>
    
    <span class="c1"># Make the static comparison</span>
    <span class="k">if</span> <span class="n">off_dataframe</span><span class="p">:</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axarray</span> <span class="o">=</span> <span class="n">static_comparison</span><span class="p">(</span>
            <span class="n">fit_df</span><span class="p">[</span><span class="s2">&quot;Fitted frequency&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">dataframe</span><span class="p">,</span>
            <span class="n">off_dataframe</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">foldername</span> <span class="o">+</span> <span class="s2">&quot;/on-off-comparison.pdf&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;pdf&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">fit_df</span></div>
            
        
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2019, Kelvin Lee.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.0.3.<br/>
    </p>
  </div>
</footer>
  </body>
</html>