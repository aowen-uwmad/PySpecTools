<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <title>pyspectools.ftmw_analysis &#8212; PySpecTools 4.4.0 documentation</title>
    <link rel="stylesheet" href="../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../index.html">
          PySpecTools</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">PySpecTools FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Example Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyspectools.spectra.html"><cite>Spectra</cite> Module</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">PySpecTools</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
              
                
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <h1>Source code for pyspectools.ftmw_analysis</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">combinations</span><span class="p">,</span> <span class="n">product</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">peakutils</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">signal</span> <span class="k">as</span> <span class="n">spsig</span>
<span class="kn">import</span> <span class="nn">plotly.graph_objs</span> <span class="k">as</span> <span class="nn">go</span>
<span class="kn">from</span> <span class="nn">tqdm.autonotebook</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">networkx</span> <span class="k">as</span> <span class="nn">nx</span>
<span class="kn">from</span> <span class="nn">ipywidgets</span> <span class="kn">import</span> <span class="n">interactive</span><span class="p">,</span> <span class="n">VBox</span><span class="p">,</span> <span class="n">HBox</span>
<span class="kn">from</span> <span class="nn">lmfit.models</span> <span class="kn">import</span> <span class="n">LinearModel</span>

<span class="kn">from</span> <span class="nn">pyspectools</span> <span class="kn">import</span> <span class="n">routines</span>
<span class="kn">from</span> <span class="nn">pyspectools</span> <span class="kn">import</span> <span class="n">figurefactory</span> <span class="k">as</span> <span class="n">ff</span>
<span class="kn">from</span> <span class="nn">pyspectools</span> <span class="kn">import</span> <span class="n">fitting</span>
<span class="kn">from</span> <span class="nn">pyspectools.spectra</span> <span class="kn">import</span> <span class="n">analysis</span>
<span class="kn">from</span> <span class="nn">pyspectools</span> <span class="kn">import</span> <span class="n">parsers</span>


<div class="viewcode-block" id="parse_specdata"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.parse_specdata">[docs]</a><span class="k">def</span> <span class="nf">parse_specdata</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="c1"># For reading the output of a SPECData analysis</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span></div>


<div class="viewcode-block" id="parse_spectrum"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.parse_spectrum">[docs]</a><span class="k">def</span> <span class="nf">parse_spectrum</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">20.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Function to read in a blackchirp or QtFTM spectrum from file &quot;&quot;&quot;</span>
    <span class="n">dataframe</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
        <span class="n">filename</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">,</span> <span class="s2">&quot;Intensity&quot;</span><span class="p">],</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">dataframe</span><span class="p">[</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Intensity&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">threshold</span><span class="p">]</span></div>


<div class="viewcode-block" id="center_cavity"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.center_cavity">[docs]</a><span class="k">def</span> <span class="nf">center_cavity</span><span class="p">(</span><span class="n">dataframe</span><span class="p">,</span> <span class="n">thres</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Finds the center frequency of a Doppler pair in cavity FTM measurements</span>
<span class="sd">        and provides a column of offset frequencies.</span>

<span class="sd">        Sometimes the peak finding threshold has to be tweaked to get the center</span>
<span class="sd">        frequency correctly.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Find the peak intensities</span>
    <span class="n">center_indexes</span> <span class="o">=</span> <span class="n">peakutils</span><span class="o">.</span><span class="n">indexes</span><span class="p">(</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Intensity&quot;</span><span class="p">],</span> <span class="n">thres</span><span class="o">=</span><span class="n">thres</span><span class="p">)</span>
    <span class="n">peak_frequencies</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">center_indexes</span><span class="p">][</span><span class="s2">&quot;Frequency&quot;</span><span class="p">]</span>
    <span class="c1"># Calculate the center frequency as the average</span>
    <span class="n">center</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">peak_frequencies</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Center frequency at &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">center</span><span class="p">))</span>
    <span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Offset Frequency&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">center</span></div>


<div class="viewcode-block" id="Batch"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.Batch">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Batch</span><span class="p">:</span>
    <span class="n">assay</span><span class="p">:</span> <span class="nb">str</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">machine</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">date</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span>
    <span class="n">scans</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="nb">filter</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">exp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">zeropad</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">window</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

<div class="viewcode-block" id="Batch.from_qtftm"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.Batch.from_qtftm">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_qtftm</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">assay</span><span class="p">,</span> <span class="n">machine</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a Batch object from a QtFTM scan file.</span>
<span class="sd">        :param filepath:</span>
<span class="sd">        :param assay:</span>
<span class="sd">        :param machine:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">assays</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;dr&quot;</span><span class="p">,</span> <span class="s2">&quot;magnet&quot;</span><span class="p">,</span> <span class="s2">&quot;discharge&quot;</span><span class="p">,</span> <span class="s2">&quot;dipole&quot;</span><span class="p">]</span>
        <span class="n">assay</span> <span class="o">=</span> <span class="n">assay</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">assay</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">assays</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Not a valid assay type; choose dr, magnet, discharge, dipole.&quot;</span>
            <span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">read_file</span><span class="p">:</span>
            <span class="n">batch_df</span><span class="p">,</span> <span class="n">batch_data</span> <span class="o">=</span> <span class="n">parse_batch</span><span class="p">(</span><span class="n">read_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">())</span>
        <span class="n">batch_data</span><span class="p">[</span><span class="s2">&quot;assay&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">assay</span>
        <span class="n">batch_data</span><span class="p">[</span><span class="s2">&quot;machine&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">batch_obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">batch_data</span><span class="p">)</span>
        <span class="n">batch_obj</span><span class="o">.</span><span class="n">details</span> <span class="o">=</span> <span class="n">batch_df</span>
        <span class="k">return</span> <span class="n">batch_obj</span></div>

<div class="viewcode-block" id="Batch.from_remote"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.Batch.from_remote">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_remote</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">root_path</span><span class="p">,</span> <span class="n">batch_id</span><span class="p">,</span> <span class="n">assay</span><span class="p">,</span> <span class="n">machine</span><span class="p">,</span> <span class="n">ssh_obj</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a Batch object by retrieving a QtFTM batch file from a remote</span>
<span class="sd">        location. The user must provide a path to the root directory of the</span>
<span class="sd">        batch type, e.g. /home/data/QtFTM/batch/, and the corresponding</span>
<span class="sd">        batch type ID. Additionally, the type of batch must be specified to</span>
<span class="sd">        determine the type of analysis required.</span>

<span class="sd">        Optionally, the user can provide a reference to a RemoteClient object</span>
<span class="sd">        from `pyspectools.routines`. If none is provided, a RemoteClient object</span>
<span class="sd">        will be created with public key authentication (if available), otherwise</span>
<span class="sd">        the user will be queried for a hostname, username, and password.</span>

<span class="sd">        Keep in mind this method can be slow as every scan is downloaded. I</span>
<span class="sd">        recommend creating this once, then saving a local copy for subsequent</span>
<span class="sd">        analysis.</span>
<span class="sd">        :param root_path: str path to the batch type root directory</span>
<span class="sd">        :param batch_id: int or str value for the batch number</span>
<span class="sd">        :param assay: str the batch type</span>
<span class="sd">        :param machine: str reference the machine used for the batch</span>
<span class="sd">        :param ssh_obj: `RemoteClient` object</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ssh_obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">default_keypath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">),</span> <span class="s2">&quot;.ssh/id_rsa.pub&quot;</span><span class="p">)</span>
            <span class="n">hostname</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Please provide remote hostname:    &quot;</span><span class="p">)</span>
            <span class="n">username</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Please provide login:              &quot;</span><span class="p">)</span>
            <span class="n">ssh_settings</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;hostname&quot;</span><span class="p">:</span> <span class="n">hostname</span><span class="p">,</span> <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">username</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">default_keypath</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">ssh_settings</span><span class="p">[</span><span class="s2">&quot;key_filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_keypath</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">password</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Please provide password:              &quot;</span><span class="p">)</span>
                <span class="n">ssh_settings</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">password</span>
            <span class="n">ssh_obj</span> <span class="o">=</span> <span class="n">routines</span><span class="o">.</span><span class="n">RemoteClient</span><span class="p">(</span><span class="o">**</span><span class="n">ssh_settings</span><span class="p">)</span>
        <span class="c1"># Parse the scan data from remote file</span>
        <span class="n">remote_path</span> <span class="o">=</span> <span class="n">ssh_obj</span><span class="o">.</span><span class="n">ls</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">batch_id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">batch_df</span><span class="p">,</span> <span class="n">batch_data</span> <span class="o">=</span> <span class="n">parse_batch</span><span class="p">(</span><span class="n">ssh_obj</span><span class="o">.</span><span class="n">open_remote</span><span class="p">(</span><span class="n">remote_path</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">batch_data</span><span class="p">[</span><span class="s2">&quot;assay&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">assay</span>
        <span class="n">batch_data</span><span class="p">[</span><span class="s2">&quot;machine&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">machine</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="n">batch_obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">batch_data</span><span class="p">)</span>
        <span class="n">batch_obj</span><span class="o">.</span><span class="n">details</span> <span class="o">=</span> <span class="n">batch_df</span>
        <span class="n">batch_obj</span><span class="o">.</span><span class="n">remote</span> <span class="o">=</span> <span class="n">ssh_obj</span>
        <span class="n">batch_obj</span><span class="o">.</span><span class="n">get_scans</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="n">batch_df</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">batch_obj</span></div>

<div class="viewcode-block" id="Batch.from_pickle"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.Batch.from_pickle">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_pickle</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to create a Scan object from a previously pickled</span>
<span class="sd">        Scan.</span>
<span class="sd">        :param filepath: path to the Scan pickle</span>
<span class="sd">        :return: instance of the Scan object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">batch_obj</span> <span class="o">=</span> <span class="n">routines</span><span class="o">.</span><span class="n">read_obj</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">batch_obj</span><span class="p">,</span> <span class="n">Batch</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;File is not a Scan object; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">batch_obj</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">batch_obj</span></div>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-Batch </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__copy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">batch_obj</span> <span class="o">=</span> <span class="n">Batch</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">batch_obj</span>

<div class="viewcode-block" id="Batch.find_scan"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.Batch.find_scan">[docs]</a>    <span class="k">def</span> <span class="nf">find_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">id</span><span class="p">):</span>
        <span class="n">scans</span> <span class="o">=</span> <span class="p">[</span><span class="n">scan</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scans</span> <span class="k">if</span> <span class="n">scan</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="nb">id</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">scans</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No scans were found.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">scans</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></div>

<div class="viewcode-block" id="Batch.get_scans"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.Batch.get_scans">[docs]</a>    <span class="k">def</span> <span class="nf">get_scans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root_path</span><span class="p">,</span> <span class="n">ids</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to create Scan objects for all of the scans in</span>
<span class="sd">        a QtFTM batch.</span>
<span class="sd">        :param root_path: str scans root path</span>
<span class="sd">        :param ids: list scan ids</span>
<span class="sd">        :param src: str optional specifying whether a remote or local path is used</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">root_path</span> <span class="o">=</span> <span class="n">root_path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;batch&quot;</span><span class="p">,</span> <span class="s2">&quot;scans&quot;</span><span class="p">)</span>
        <span class="n">path_list</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_path</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">scan_id</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.txt&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">scan_id</span> <span class="ow">in</span> <span class="n">ids</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;remote&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">scans</span> <span class="o">=</span> <span class="p">[</span><span class="n">Scan</span><span class="o">.</span><span class="n">from_remote</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">path_list</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">scans</span> <span class="o">=</span> <span class="p">[</span><span class="n">Scan</span><span class="o">.</span><span class="n">from_qtftm</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">path_list</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scans</span> <span class="o">=</span> <span class="n">scans</span></div>

<div class="viewcode-block" id="Batch.process_dr"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.Batch.process_dr">[docs]</a>    <span class="k">def</span> <span class="nf">process_dr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">significance</span><span class="o">=</span><span class="mf">16.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to batch process all of the DR measurements.</span>
<span class="sd">        :param global_depletion: float between 0. and 1. specifying the expected depletion for any line</span>
<span class="sd">                                 without a specific expected value.</span>
<span class="sd">        :param depletion_dict: dict with keys corresponding to cavity frequencies, and values the expected</span>
<span class="sd">                               depletion value between 0. and 1.</span>
<span class="sd">        :return dr_dict: dict with keys corresponding to cavity frequency, with each value</span>
<span class="sd">                         a dict of the DR frequencies, scan IDs and Scan objects.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">assay</span> <span class="o">!=</span> <span class="s2">&quot;dr&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;Batch is not a DR test! I think it&#39;s </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assay</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="c1"># Find the cavity frequencies that DR was performed on</span>
        <span class="n">progressions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_progression_batch</span><span class="p">()</span>
        <span class="n">dr_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">progression</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">progressions</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">ref</span> <span class="o">=</span> <span class="n">progression</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ref_fit</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">fit_cavity</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">roi</span><span class="p">,</span> <span class="n">ref_x</span><span class="p">,</span> <span class="n">ref_y</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">get_line_roi</span><span class="p">()</span>
                <span class="n">signal</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ref_y</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)]</span>
                <span class="n">sigma</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">spectrum</span><span class="p">[</span><span class="s2">&quot;Intensity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">roi</span><span class="p">])</span>
                            <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">progression</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
                    <span class="o">*</span> <span class="n">significance</span>
                <span class="p">)</span>
                <span class="n">connections</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">scan</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">progression</span> <span class="k">if</span> <span class="n">scan</span><span class="o">.</span><span class="n">is_depleted</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">roi</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
                <span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">connections</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">counter</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">connections</span><span class="p">)</span>
                    <span class="n">signal</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                        <span class="p">[</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">spectrum</span><span class="p">[</span><span class="s2">&quot;Intensity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">roi</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">connections</span>
                        <span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">dr_dict</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;frequencies&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">scan</span><span class="o">.</span><span class="n">dr_frequency</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">connections</span><span class="p">],</span>
                        <span class="s2">&quot;ids&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">scan</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">connections</span><span class="p">],</span>
                        <span class="s2">&quot;cavity&quot;</span><span class="p">:</span> <span class="n">ref</span><span class="o">.</span><span class="n">fit</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span>
                        <span class="s2">&quot;signal&quot;</span><span class="p">:</span> <span class="n">signal</span><span class="p">,</span>
                        <span class="s2">&quot;expected&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ref_y</span><span class="p">)</span> <span class="o">-</span> <span class="n">sigma</span><span class="p">,</span>
                    <span class="p">}</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Progression </span><span class="si">{}</span><span class="s2"> could not be fit; ignoring.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Possible depletions detected in these indexes: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">dr_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There are </span><span class="si">{}</span><span class="s2"> possible depletions.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">counter</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">dr_dict</span></div>

<div class="viewcode-block" id="Batch.split_progression_batch"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.Batch.split_progression_batch">[docs]</a>    <span class="k">def</span> <span class="nf">split_progression_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Split up a DR batch into individual progressions based on the cavity frequency</span>
<span class="sd">        and whether or not the scan IDs are consecutive.</span>
<span class="sd">        :return progressions: dict with keys corresponding to progression index and values are lists of Scans</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">progressions</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">details</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">details</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">freq</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">details</span><span class="p">[</span><span class="s2">&quot;ftfreq&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">slice_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">details</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">details</span><span class="p">[</span><span class="s2">&quot;ftfreq&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">freq</span><span class="p">]</span>
            <span class="n">chunks</span> <span class="o">=</span> <span class="n">routines</span><span class="o">.</span><span class="n">group_consecutives</span><span class="p">(</span><span class="n">slice_df</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">:</span>
                <span class="n">progressions</span><span class="p">[</span><span class="n">counter</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">scan</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scans</span> <span class="k">if</span> <span class="n">scan</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">chunk</span>
                <span class="p">]</span>
                <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">progressions</span></div>

<div class="viewcode-block" id="Batch.interactive_dr_batch"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.Batch.interactive_dr_batch">[docs]</a>    <span class="k">def</span> <span class="nf">interactive_dr_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an interactive widget slider with a Plotly figure. The batch will be split</span>
<span class="sd">        up into &quot;subbatches&quot; by the cavity frequency and whether or not the scan IDs are</span>
<span class="sd">        consecutive.</span>
<span class="sd">        :return vbox: VBox object with the Plotly figure and slider objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">progressions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_progression_batch</span><span class="p">()</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">FigureWidget</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s2">&quot;width&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">900.0</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s2">&quot;showlegend&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">def</span> <span class="nf">update_figure</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_traces</span><span class="p">([</span><span class="n">scan</span><span class="o">.</span><span class="n">scatter_trace</span><span class="p">()</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">progressions</span><span class="p">[</span><span class="n">index</span><span class="p">]])</span>

        <span class="n">index_slider</span> <span class="o">=</span> <span class="n">interactive</span><span class="p">(</span><span class="n">update_figure</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">progressions</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">vbox</span> <span class="o">=</span> <span class="n">VBox</span><span class="p">((</span><span class="n">fig</span><span class="p">,</span> <span class="n">index_slider</span><span class="p">))</span>
        <span class="n">vbox</span><span class="o">.</span><span class="n">layout</span><span class="o">.</span><span class="n">align_items</span> <span class="o">=</span> <span class="s2">&quot;center&quot;</span>
        <span class="k">return</span> <span class="n">vbox</span></div>

<div class="viewcode-block" id="Batch.plot_scans"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.Batch.plot_scans">[docs]</a>    <span class="k">def</span> <span class="nf">plot_scans</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a plotly figure of all of the Scans within a Batch.</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">FigureWidget</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> Batch </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">machine</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s2">&quot;showlegend&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_traces</span><span class="p">([</span><span class="n">scan</span><span class="o">.</span><span class="n">scatter_trace</span><span class="p">()</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scans</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="Batch.reprocess_fft"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.Batch.reprocess_fft">[docs]</a>    <span class="k">def</span> <span class="nf">reprocess_fft</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reprocess all of the FIDs with specified settings. The default values</span>
<span class="sd">        are taken from the Batch attributes, and kwargs provided will override</span>
<span class="sd">        the defaults.</span>
<span class="sd">        :param kwargs:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">param_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;filter&quot;</span><span class="p">,</span> <span class="s2">&quot;exp&quot;</span><span class="p">,</span> <span class="s2">&quot;zeropad&quot;</span><span class="p">,</span> <span class="s2">&quot;window&quot;</span><span class="p">]</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">param_list</span>
        <span class="p">}</span>
        <span class="n">params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="p">[</span><span class="n">scan</span><span class="o">.</span><span class="n">process_fid</span><span class="p">(</span><span class="o">**</span><span class="n">params</span><span class="p">)</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scans</span><span class="p">)]</span></div>

<div class="viewcode-block" id="Batch.to_pickle"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.Batch.to_pickle">[docs]</a>    <span class="k">def</span> <span class="nf">to_pickle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pickles the Batch object with the joblib wrapper implemented</span>
<span class="sd">        in routines.</span>
<span class="sd">        :param filepath: optional argument to pickle to. Defaults to the {assay}-{id}.pkl</span>
<span class="sd">        :param kwargs: additional settings for the pickle operation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filepath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">-</span><span class="si">{}</span><span class="s2">.pkl&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assay</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="c1"># the RemoteClient object has some thread locking going on that prevents</span>
        <span class="c1"># pickling TODO - figure out why paramiko doesn&#39;t allow pickling</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;remote&quot;</span><span class="p">):</span>
            <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;remote&quot;</span><span class="p">)</span>
        <span class="n">routines</span><span class="o">.</span><span class="n">save_obj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Batch.create_dr_network"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.Batch.create_dr_network">[docs]</a>    <span class="k">def</span> <span class="nf">create_dr_network</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scans</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Take a list of scans, and generate a NetworkX Graph object</span>
<span class="sd">        for analysis and plotting.</span>
<span class="sd">        :param scans: list of scan IDs to connect</span>
<span class="sd">        :return fig: Plotly FigureWidget object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">connections</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">cavity_frequency</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">scan</span><span class="o">.</span><span class="n">dr_frequency</span><span class="p">)]</span>
            <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scans</span>
            <span class="k">if</span> <span class="n">scan</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">scans</span>
        <span class="p">]</span>
        <span class="n">fig</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">progressions</span> <span class="o">=</span> <span class="n">ff</span><span class="o">.</span><span class="n">dr_network_diagram</span><span class="p">(</span><span class="n">connections</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="Batch.find_optimum_scans"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.Batch.find_optimum_scans">[docs]</a>    <span class="k">def</span> <span class="nf">find_optimum_scans</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">thres</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        :param thres:</span>
<span class="sd">        :return:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">progressions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">split_progression_batch</span><span class="p">()</span>
        <span class="n">data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">progression</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">progressions</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="n">snrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">scan</span><span class="o">.</span><span class="n">calc_snr</span><span class="p">(</span><span class="n">thres</span><span class="o">=</span><span class="n">thres</span><span class="p">)</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">progression</span><span class="p">]</span>
            <span class="n">best_scan</span> <span class="o">=</span> <span class="n">progression</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">snrs</span><span class="p">)]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fit_result</span> <span class="o">=</span> <span class="n">best_scan</span><span class="o">.</span><span class="n">fit_cavity</span><span class="p">(</span><span class="n">plot</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fit_result</span><span class="o">.</span><span class="n">best_values</span><span class="p">[</span><span class="s2">&quot;w&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.049</span><span class="p">:</span>
                    <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;frequency&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">fit_result</span><span class="o">.</span><span class="n">best_values</span><span class="p">[</span><span class="s2">&quot;x0&quot;</span><span class="p">],</span> <span class="mi">4</span><span class="p">),</span>
                            <span class="s2">&quot;snr&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">snrs</span><span class="p">),</span>
                            <span class="s2">&quot;scan&quot;</span><span class="p">:</span> <span class="n">best_scan</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                            <span class="s2">&quot;attenuation&quot;</span><span class="p">:</span> <span class="n">best_scan</span><span class="o">.</span><span class="n">cavity_atten</span><span class="p">,</span>
                            <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">index</span><span class="p">,</span>
                        <span class="p">}</span>
                    <span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Index </span><span class="si">{}</span><span class="s2"> failed to fit!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
        <span class="n">opt_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">opt_df</span></div>

<div class="viewcode-block" id="Batch.search_frequency"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.Batch.search_frequency">[docs]</a>    <span class="k">def</span> <span class="nf">search_frequency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Search the Batch scans for a particular frequency, and return</span>
<span class="sd">        any scans that lie within the tolerance window</span>
<span class="sd">        :param frequency: float specifying frequency to search</span>
<span class="sd">        :param tol: float decimal percentage to use for the search tolerance</span>
<span class="sd">        :return new_batch: a new Batch object with selected scans</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">upper</span> <span class="o">=</span> <span class="n">frequency</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">tol</span><span class="p">)</span>
        <span class="n">lower</span> <span class="o">=</span> <span class="n">frequency</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">tol</span><span class="p">)</span>
        <span class="n">scans</span> <span class="o">=</span> <span class="p">[</span><span class="n">scan</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">scans</span> <span class="k">if</span> <span class="n">lower</span> <span class="o">&lt;=</span> <span class="n">scan</span><span class="o">.</span><span class="n">cavity_frequency</span> <span class="o">&lt;=</span> <span class="n">upper</span><span class="p">]</span>
        <span class="c1"># new_batch = deepcopy(self)</span>
        <span class="c1"># new_batch.scans = scans</span>
        <span class="k">return</span> <span class="n">scans</span></div></div>


<div class="viewcode-block" id="Scan"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.Scan">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Scan</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DataClass for a Scan. Holds all of the relevant information that</span>
<span class="sd">    describes a FT scan, such as the ID, what machine it was collected</span>
<span class="sd">    on, and the experimental settings.</span>

<span class="sd">    Has a few class methods that will make look ups easily such as</span>
<span class="sd">    the date the scan was collected and the gases used.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">machine</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">fid</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span>
    <span class="n">date</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span>
    <span class="n">shots</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">cavity_voltage</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">cavity_atten</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">cavity_frequency</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">dr_frequency</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">dr_power</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">fid_points</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">fid_spacing</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">discharge</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">magnet</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">gases</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="nb">filter</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">exp</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">zeropad</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">window</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Functions called after __init__ is called.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Perform FFT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_fid</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dunder method to produce a deep copy - this will be used when</span>
<span class="sd">        manipulating multiple Scan objects.</span>
<span class="sd">        :return: A deep copy of the current Scan object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">class</span> <span class="nc">Empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">):</span>
            <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
                <span class="k">pass</span>

        <span class="n">new_scan</span> <span class="o">=</span> <span class="n">Empty</span><span class="p">()</span>
        <span class="n">new_scan</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span>
        <span class="n">new_scan</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_scan</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scan </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Scan.average"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.Scan.average">[docs]</a>    <span class="k">def</span> <span class="nf">average</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">others</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dunder method to co-average two or more Scans in the time domain.</span>
<span class="sd">        :param other: Scan object, or tuple/list</span>
<span class="sd">        :return: A new Scan object with the co-added FID</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_scan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__deepcopy__</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">new_scan</span><span class="o">.</span><span class="n">fid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">others</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_scan</span><span class="o">.</span><span class="n">fid</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">new_scan</span><span class="o">.</span><span class="n">average_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">scan</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">others</span><span class="p">]</span>
        <span class="c1"># If there is no extend method, then assume we&#39;re working with a</span>
        <span class="c1"># single Scan</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">new_scan</span><span class="o">.</span><span class="n">fid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">([</span><span class="n">new_scan</span><span class="o">.</span><span class="n">fid</span><span class="p">,</span> <span class="n">others</span><span class="o">.</span><span class="n">fid</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">new_scan</span><span class="o">.</span><span class="n">average_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">others</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>
        <span class="n">new_scan</span><span class="o">.</span><span class="n">process_fid</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">new_scan</span></div>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dunder method to co-add two or more Scans in the time domain.</span>
<span class="sd">        :param other: Scan object, or tuple/list</span>
<span class="sd">        :return: A new Scan object with the co-added FID</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_scan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__deepcopy__</span><span class="p">()</span>
        <span class="n">new_scan</span><span class="o">.</span><span class="n">fid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">new_scan</span><span class="o">.</span><span class="n">fid</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">fid</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">new_scan</span><span class="o">.</span><span class="n">process_fid</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">new_scan</span>

    <span class="k">def</span> <span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dunder method to subtract another Scan from the current Scan in the time domain.</span>
<span class="sd">        i.e. this scan - other scan</span>
<span class="sd">        :param other: Scan object, or tuple/list</span>
<span class="sd">        :return: A new Scan object with the subtracted FID</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_scan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__deepcopy__</span><span class="p">()</span>
        <span class="n">new_scan</span><span class="o">.</span><span class="n">fid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">subtract</span><span class="p">(</span><span class="n">new_scan</span><span class="o">.</span><span class="n">fid</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">fid</span><span class="p">)</span>
        <span class="n">new_scan</span><span class="o">.</span><span class="n">process_fid</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">new_scan</span>

<div class="viewcode-block" id="Scan.subtract_frequency"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.Scan.subtract_frequency">[docs]</a>    <span class="k">def</span> <span class="nf">subtract_frequency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to subtract another Scan from the current in the frequency domain.</span>
<span class="sd">        :param other: Scan object to subtract with</span>
<span class="sd">        :return: A new Scan object with the subtracted spectrum</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_scan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__deepcopy__</span><span class="p">()</span>
        <span class="n">new_scan</span><span class="o">.</span><span class="n">spectrum</span><span class="p">[</span><span class="s2">&quot;Intensity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">new_scan</span><span class="o">.</span><span class="n">spectrum</span><span class="p">[</span><span class="s2">&quot;Intensity&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">spectrum</span><span class="p">[</span><span class="s2">&quot;Intensity&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">new_scan</span><span class="o">.</span><span class="n">subtracted</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">id</span>
        <span class="k">return</span> <span class="n">new_scan</span></div>

<div class="viewcode-block" id="Scan.add_frequency"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.Scan.add_frequency">[docs]</a>    <span class="k">def</span> <span class="nf">add_frequency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to add another Scan from the current in the frequency domain.</span>
<span class="sd">        :param other: Scan object to add with</span>
<span class="sd">        :return: A new Scan object with the co-added spectrum</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_scan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__deepcopy__</span><span class="p">()</span>
        <span class="n">new_scan</span><span class="o">.</span><span class="n">spectrum</span><span class="p">[</span><span class="s2">&quot;Intensity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">new_scan</span><span class="o">.</span><span class="n">spectrum</span><span class="p">[</span><span class="s2">&quot;Intensity&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">other</span><span class="o">.</span><span class="n">spectrum</span><span class="p">[</span><span class="s2">&quot;Intensity&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">new_scan</span><span class="o">.</span><span class="n">subtracted</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">id</span>
        <span class="k">return</span> <span class="n">new_scan</span></div>

<div class="viewcode-block" id="Scan.from_dict"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.Scan.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to initialize a Scan object from a dictionary</span>
<span class="sd">        of FT scan data collected from `parse_scan`.</span>
<span class="sd">        :param data_dict: dict containing parsed data from FT</span>
<span class="sd">        :return: Scan object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scan_obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">data_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">scan_obj</span></div>

<div class="viewcode-block" id="Scan.from_qtftm"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.Scan.from_qtftm">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_qtftm</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to initialize a Scan object from a FT scan file.</span>
<span class="sd">        Will load the lines into memory and parse the data into</span>
<span class="sd">        a dictionary, which then gets passed into a Scan object.</span>
<span class="sd">        :param filepath: str path to FID file</span>
<span class="sd">        :return: Scan object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">read_file</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="n">parse_scan</span><span class="p">(</span><span class="n">read_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">())</span>
        <span class="n">scan_obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">data_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">scan_obj</span></div>

<div class="viewcode-block" id="Scan.from_pickle"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.Scan.from_pickle">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_pickle</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to create a Scan object from a previously pickled</span>
<span class="sd">        Scan.</span>
<span class="sd">        :param filepath: path to the Scan pickle</span>
<span class="sd">        :return: instance of the Scan object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">scan_obj</span> <span class="o">=</span> <span class="n">routines</span><span class="o">.</span><span class="n">read_obj</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">scan_obj</span><span class="p">,</span> <span class="n">Scan</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;File is not a Scan object; </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">scan_obj</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">scan_obj</span></div>

<div class="viewcode-block" id="Scan.from_remote"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.Scan.from_remote">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_remote</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">remote_path</span><span class="p">,</span> <span class="n">ssh_obj</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to initialize a Scan object from a remote server.</span>
<span class="sd">        Has the option to pass an instance of a paramiko SSHClient, which would be</span>
<span class="sd">        useful in a Batch. If none is supplied, an instance will be created.</span>

<span class="sd">        :param remote_path: str remote path to the file</span>
<span class="sd">        :param ssh_obj: optional argument to supply a paramiko SSHClient object</span>
<span class="sd">        :return: Scan object from remote QtFTM file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ssh_obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">default_keypath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~&quot;</span><span class="p">),</span> <span class="s2">&quot;.ssh/id_rsa.pub&quot;</span><span class="p">)</span>
            <span class="n">hostname</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Please provide remote hostname:    &quot;</span><span class="p">)</span>
            <span class="n">username</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Please provide login:              &quot;</span><span class="p">)</span>
            <span class="n">ssh_settings</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;hostname&quot;</span><span class="p">:</span> <span class="n">hostname</span><span class="p">,</span> <span class="s2">&quot;username&quot;</span><span class="p">:</span> <span class="n">username</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">default_keypath</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">ssh_settings</span><span class="p">[</span><span class="s2">&quot;key_filename&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_keypath</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">password</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Please provide password:              &quot;</span><span class="p">)</span>
                <span class="n">ssh_settings</span><span class="p">[</span><span class="s2">&quot;password&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">password</span>
            <span class="n">ssh_obj</span> <span class="o">=</span> <span class="n">routines</span><span class="o">.</span><span class="n">RemoteClient</span><span class="p">(</span><span class="o">**</span><span class="n">ssh_settings</span><span class="p">)</span>
        <span class="c1"># Parse the scan data from remote file</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="n">parse_scan</span><span class="p">(</span><span class="n">ssh_obj</span><span class="o">.</span><span class="n">open_remote</span><span class="p">(</span><span class="n">remote_path</span><span class="p">))</span>
        <span class="n">scan_obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">data_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">scan_obj</span></div>

<div class="viewcode-block" id="Scan.to_file"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.Scan.to_file">[docs]</a>    <span class="k">def</span> <span class="nf">to_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;yaml&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to dump data to YAML format.</span>
<span class="sd">            Extensions are automatically decided, but</span>
<span class="sd">            can also be supplied.</span>

<span class="sd">            parameters:</span>
<span class="sd">            --------------------</span>
<span class="sd">            :param filepath - str path to yaml file</span>
<span class="sd">            :param format - str denoting the syntax used for dumping. Defaults to YAML.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filepath</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span><span class="p">:</span>
                <span class="n">filepath</span> <span class="o">+=</span> <span class="s2">&quot;.json&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filepath</span> <span class="o">+=</span> <span class="s2">&quot;.yml&quot;</span>
        <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span><span class="p">:</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">routines</span><span class="o">.</span><span class="n">dump_json</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">routines</span><span class="o">.</span><span class="n">dump_yaml</span>
        <span class="n">writer</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scan.to_pickle"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.Scan.to_pickle">[docs]</a>    <span class="k">def</span> <span class="nf">to_pickle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Pickles the Scan object with the joblib wrapper implemented</span>
<span class="sd">        in routines.</span>
<span class="sd">        :param filepath: optional argument to pickle to. Defaults to the id.pkl</span>
<span class="sd">        :param kwargs: additional settings for the pickle operation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filepath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.pkl&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">routines</span><span class="o">.</span><span class="n">save_obj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Scan.process_fid"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.Scan.process_fid">[docs]</a>    <span class="k">def</span> <span class="nf">process_fid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform an FFT on the FID to yield the frequency domain spectrum.</span>
<span class="sd">        Kwargs are passed into the FID processing, which will override the</span>
<span class="sd">        Scan attributes.</span>
<span class="sd">        :param kwargs: Optional keyword arguments for processing the FID</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Calculate the frequency bins</span>
        <span class="n">frequencies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cavity_frequency</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cavity_frequency</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Calculate the time bins</span>
        <span class="n">time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fid_spacing</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fid_points</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fid_points</span><span class="p">)</span>
        <span class="n">process_list</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;window&quot;</span><span class="p">,</span> <span class="s2">&quot;filter&quot;</span><span class="p">,</span> <span class="s2">&quot;exp&quot;</span><span class="p">,</span> <span class="s2">&quot;zeropad&quot;</span><span class="p">]</span>
        <span class="n">process_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">value</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">process_list</span>
        <span class="p">}</span>
        <span class="c1"># Override with user settings</span>
        <span class="n">process_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">temp_fid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span> <span class="o">=</span> <span class="n">fid2fft</span><span class="p">(</span>
            <span class="n">temp_fid</span><span class="p">,</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">fid_spacing</span><span class="p">,</span> <span class="n">frequencies</span><span class="p">,</span> <span class="o">**</span><span class="n">process_dict</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fid_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;Time (us)&quot;</span><span class="p">:</span> <span class="n">time</span> <span class="o">*</span> <span class="mf">1e6</span><span class="p">,</span> <span class="s2">&quot;FID&quot;</span><span class="p">:</span> <span class="n">temp_fid</span><span class="p">})</span></div>

<div class="viewcode-block" id="Scan.within_time"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.Scan.within_time">[docs]</a>    <span class="k">def</span> <span class="nf">within_time</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date_range</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function for determining of the scan was taken between</span>
<span class="sd">        a specified date range in month/day/year, in the format</span>
<span class="sd">        04/09/08 for April 9th, 2008.</span>
<span class="sd">        :param date_range: list containing the beginning and end date strings</span>
<span class="sd">        :return: bool - True if within range, False otherwise</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">early</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">date_range</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;%m/</span><span class="si">%d</span><span class="s2">/%y&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">early</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">late</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">date_range</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="s2">&quot;%m/</span><span class="si">%d</span><span class="s2">/%y&quot;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">late</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">9999</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">early</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">date</span> <span class="o">&lt;=</span> <span class="n">late</span></div>

<div class="viewcode-block" id="Scan.is_depleted"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.Scan.is_depleted">[docs]</a>    <span class="k">def</span> <span class="nf">is_depleted</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ref</span><span class="p">,</span> <span class="n">roi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">depletion</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function for determining if the signal in this Scan is less</span>
<span class="sd">        than that of another scan. This is done by a simple comparison</span>
<span class="sd">        of the average of 10 largest intensities in the two spectra. If</span>
<span class="sd">        the current scan is less intense than the reference by the</span>
<span class="sd">        expected depletion percentage, then it is &quot;depleted&quot;.</span>

<span class="sd">        This function can be used to determine if a scan if depleted</span>
<span class="sd">        in DR/magnet/discharge assays.</span>

<span class="sd">        TODO - implement a chi squared test of sorts to determine if a</span>
<span class="sd">               depletion is statistically significant</span>

<span class="sd">        :param ref: second Scan object for comparison</span>
<span class="sd">        :param depletion: percentage of depletion expected of the reference</span>
<span class="sd">        :return: bool - True if signal in this Scan is less intense than the reference</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">y_ref</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">spectrum</span><span class="p">[</span><span class="s2">&quot;Intensity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y_obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="p">[</span><span class="s2">&quot;Intensity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_freq</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">fit</span><span class="o">.</span><span class="n">frequency</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_id</span> <span class="o">=</span> <span class="n">ref</span><span class="o">.</span><span class="n">id</span>
        <span class="k">if</span> <span class="n">roi</span><span class="p">:</span>
            <span class="n">y_ref</span> <span class="o">=</span> <span class="n">y_ref</span><span class="p">[</span><span class="n">roi</span><span class="p">]</span>
            <span class="n">y_obs</span> <span class="o">=</span> <span class="n">y_obs</span><span class="p">[</span><span class="n">roi</span><span class="p">]</span>
        <span class="c1"># This doesn&#39;t work, or is not particularly discriminating.</span>
        <span class="c1"># chisq, p_value = chisquare(</span>
        <span class="c1">#    y_obs, y_ref</span>
        <span class="c1"># )</span>
        <span class="k">if</span> <span class="n">depletion</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">y_obs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">16.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">depletion</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_ref</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">sigma</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">y_obs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">expected</span></div>

<div class="viewcode-block" id="Scan.scatter_trace"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.Scan.scatter_trace">[docs]</a>    <span class="k">def</span> <span class="nf">scatter_trace</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a Plotly Scattergl trace. Called by the Batch function, although</span>
<span class="sd">        performance-wise it takes forever to plot up ~3000 scans.</span>
<span class="sd">        :return trace: Scattergl object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Scan ID: </span><span class="si">{}</span><span class="s2">&lt;br&gt;Cavity: </span><span class="si">{}</span><span class="s2">&lt;br&gt;DR: </span><span class="si">{}</span><span class="s2">&lt;br&gt;Magnet: </span><span class="si">{}</span><span class="s2">&lt;br&gt;Attn: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cavity_frequency</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dr_frequency</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">magnet</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cavity_atten</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">Scattergl</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="p">[</span><span class="s2">&quot;Intensity&quot;</span><span class="p">])),</span>
            <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="p">[</span><span class="s2">&quot;Intensity&quot;</span><span class="p">],</span>
            <span class="n">text</span><span class="o">=</span><span class="n">text</span><span class="p">,</span>
            <span class="n">marker</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;rgb(43,140,190)&quot;</span><span class="p">},</span>
            <span class="n">hoverinfo</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">trace</span></div>

<div class="viewcode-block" id="Scan.fit_cavity"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.Scan.fit_cavity">[docs]</a>    <span class="k">def</span> <span class="nf">fit_cavity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform a fit to the cavity spectrum. Uses a paired Gaussian model</span>
<span class="sd">        that minimizes the number of fitting parameters.</span>
<span class="sd">        :param plot: bool specify whether a Plotly figure is made</span>
<span class="sd">        :return: Model Fit result</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="p">[</span><span class="s2">&quot;Intensity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="p">[</span><span class="s2">&quot;Frequency (MHz)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">PairGaussianModel</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit_pair</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="p">[</span><span class="s2">&quot;Fit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">best_fit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit</span> <span class="o">=</span> <span class="n">result</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="o">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="o">.</span><span class="n">best_values</span><span class="p">[</span><span class="s2">&quot;x0&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">plot</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">FigureWidget</span><span class="p">()</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s2">&quot;xaxis&quot;</span><span class="p">][</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Frequency (MHz)&quot;</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s2">&quot;xaxis&quot;</span><span class="p">][</span><span class="s2">&quot;tickformat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.2f&quot;</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Observed&quot;</span><span class="p">)</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">best_fit</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Fit&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">fig</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="Scan.get_line_roi"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.Scan.get_line_roi">[docs]</a>    <span class="k">def</span> <span class="nf">get_line_roi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;fit&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Auto peak fitting has not been run yet!&quot;</span><span class="p">)</span>
        <span class="c1"># Get one of the Doppler horns plus 4sigma</span>
        <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="o">.</span><span class="n">best_values</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="p">[</span><span class="s2">&quot;Frequency (MHz)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="p">[</span><span class="s2">&quot;Intensity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">low_end</span> <span class="o">=</span> <span class="n">routines</span><span class="o">.</span><span class="n">find_nearest</span><span class="p">(</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;x0&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;xsep&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;w&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">4.0</span>
        <span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">high_end</span> <span class="o">=</span> <span class="n">routines</span><span class="o">.</span><span class="n">find_nearest</span><span class="p">(</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;x0&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;xsep&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">params</span><span class="p">[</span><span class="s2">&quot;w&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">4.0</span>
        <span class="p">)</span>
        <span class="n">index</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">low_end</span><span class="p">,</span> <span class="n">high_end</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">index</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="n">low_end</span><span class="p">:</span><span class="n">high_end</span><span class="p">],</span> <span class="n">y</span><span class="p">[</span><span class="n">low_end</span><span class="p">:</span><span class="n">high_end</span><span class="p">]</span></div>

<div class="viewcode-block" id="Scan.calc_snr"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.Scan.calc_snr">[docs]</a>    <span class="k">def</span> <span class="nf">calc_snr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">thres</span><span class="o">=</span><span class="mf">0.6</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">noise</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Get the last 10 points at the end and at the beginning</span>
            <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="p">[</span><span class="s2">&quot;Intensity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="p">[</span><span class="s2">&quot;Intensity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="mi">10</span><span class="p">],</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="n">peaks</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="p">[</span><span class="s2">&quot;Intensity&quot;</span><span class="p">]</span>
            <span class="o">.</span><span class="n">iloc</span><span class="p">[</span>
                <span class="n">peakutils</span><span class="o">.</span><span class="n">indexes</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span><span class="p">[</span><span class="s2">&quot;Intensity&quot;</span><span class="p">],</span> <span class="n">thres</span><span class="o">=</span><span class="n">thres</span><span class="p">,</span> <span class="n">thres_abs</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
            <span class="p">]</span>
            <span class="o">.</span><span class="n">values</span>
        <span class="p">)</span>
        <span class="n">signal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">peaks</span><span class="p">)[:</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">signal</span> <span class="o">/</span> <span class="n">noise</span></div></div>


<div class="viewcode-block" id="parse_scan"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.parse_scan">[docs]</a><span class="k">def</span> <span class="nf">parse_scan</span><span class="p">(</span><span class="n">filecontents</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Function for extracting the FID data from an FT scan. The data</span>
<span class="sd">    is returned as a dictionary, which can be used to initialize a</span>
<span class="sd">    Scan object.</span>
<span class="sd">    :param filecontents: list of lines from an FID file</span>
<span class="sd">    :return: dict containing parsed data from FID</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gases&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">()}</span>
    <span class="c1"># FID regex</span>
    <span class="n">fid_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^fid\d*&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
    <span class="c1"># Regex to find gas channels</span>
    <span class="n">gas_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^#Gas \d name&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
    <span class="n">flow_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^#Gas \d flow&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
    <span class="c1"># Regex to detect which channel is set to the discharge</span>
    <span class="n">dc_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^#Pulse ch \d name\s*DC&quot;</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
    <span class="n">dc_channel</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filecontents</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;#Scan&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">split_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">split_line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;machine&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">split_line</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;machine&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;FT1&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;#Probe freq&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;cavity_frequency&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;#Shots&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;shots&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;#Date&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">strip_targets</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;#Date&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
                <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">strip_targets</span><span class="p">),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">%a</span><span class="s2"> %b </span><span class="si">%d</span><span class="s2"> %H:%M:%S %Y&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;#Cavity Voltage&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;cavity_voltage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;#Attenuation&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;cavity_atten&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;#DR freq&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;dr_frequency&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;#DR power&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;dr_power&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;#FID spacing&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;fid_spacing&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\de[+-]?\d\d&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;#FID points&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;fid_points&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="c1"># Get the name of the gas</span>
        <span class="k">if</span> <span class="n">gas_regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="n">split_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="c1"># Only bother parsing if the channel is used</span>
            <span class="n">gas_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">split_line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;gases&quot;</span><span class="p">][</span><span class="n">gas_index</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gas&quot;</span><span class="p">:</span> <span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">split_line</span><span class="p">[</span><span class="mi">3</span><span class="p">:])}</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;gases&quot;</span><span class="p">][</span><span class="n">gas_index</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;gas&quot;</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">}</span>
        <span class="c1"># Get the flow rate for channel</span>
        <span class="k">if</span> <span class="n">flow_regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="n">split_line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
            <span class="n">gas_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">split_line</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;gases&quot;</span><span class="p">][</span><span class="n">gas_index</span><span class="p">][</span><span class="s2">&quot;flow&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">split_line</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;#Magnet enabled&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;magnet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">]))</span>
        <span class="c1"># Find the channel the discharge is set to and compile a regex</span>
        <span class="c1"># to look for the channel</span>
        <span class="k">if</span> <span class="n">dc_regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="n">dc_index</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span>
            <span class="n">dc_channel</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^#Pulse ch </span><span class="si">{}</span><span class="s2"> enabled&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dc_index</span><span class="p">),</span> <span class="n">re</span><span class="o">.</span><span class="n">M</span><span class="p">)</span>
        <span class="c1"># Once the discharge channel index is known, start searching for it</span>
        <span class="k">if</span> <span class="n">dc_channel</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">dc_channel</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
                <span class="n">data</span><span class="p">[</span><span class="s2">&quot;discharge&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="c1"># Find when the FID lines start popping up</span>
        <span class="k">if</span> <span class="n">fid_regex</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="n">fid</span> <span class="o">=</span> <span class="n">filecontents</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span>
            <span class="n">fid</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">fid</span><span class="p">]</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;fid&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="perform_fft"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.perform_fft">[docs]</a><span class="k">def</span> <span class="nf">perform_fft</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">spacing</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stop</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="s2">&quot;boxcar&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Perform an FFT on an FID to get the frequency domain spectrum.</span>
<span class="sd">    All of the arguments are optional, and provide control over how the FFT is performed, as well as post-processing</span>
<span class="sd">    parameters like window functions and zero-padding.</span>

<span class="sd">    This is based on the FFT code by Kyle Crabtree, with modifications to fit this dataclass.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fid - Numpy 1D array</span>
<span class="sd">        Array holding the values of the FID</span>
<span class="sd">    spacing - float</span>
<span class="sd">        Time spacing between FID points in microseconds</span>
<span class="sd">    start - int, optional</span>
<span class="sd">        Starting index for the FID array to perform the FFT</span>
<span class="sd">    stop - int, optional</span>
<span class="sd">        End index for the FID array to perform the FFT</span>
<span class="sd">    zpf - int, optional</span>
<span class="sd">        Pad the FID with zeros to nth nearest power of 2</span>
<span class="sd">    window - str</span>
<span class="sd">        Specify the window function used to process the FID. Defaults to boxcar, which is effectively no filtering.</span>
<span class="sd">        The names of the window functions available can be found at:</span>
<span class="sd">        https://docs.scipy.org/doc/scipy/reference/signal.windows.html</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">window</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">window</span> <span class="ow">in</span> <span class="n">spsig</span><span class="o">.</span><span class="n">windows</span><span class="o">.</span><span class="n">__all__</span><span class="p">:</span>
        <span class="n">window_f</span> <span class="o">=</span> <span class="n">spsig</span><span class="o">.</span><span class="n">windows</span><span class="o">.</span><span class="n">get_window</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">fid</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="n">fid</span> <span class="o">*=</span> <span class="n">window_f</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Specified window function is not implemented in SciPy!&quot;</span><span class="p">)</span>
    <span class="c1"># Set values to zero up to starting index</span>
    <span class="n">fid</span><span class="p">[:</span><span class="n">start</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">if</span> <span class="n">stop</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># If we&#39;re using negative indexes</span>
        <span class="n">fid</span><span class="p">[</span><span class="n">fid</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">stop</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Otherwise, index with a positive number</span>
        <span class="n">fid</span><span class="p">[</span><span class="n">stop</span><span class="p">:]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="c1"># Perform the FFT</span>
    <span class="n">fft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
    <span class="n">read_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">df</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">fid</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="n">spacing</span>
    <span class="c1"># Generate the frequency array</span>
    <span class="n">frequency</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;sideband&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">,</span> <span class="n">read_length</span><span class="p">)</span>
    <span class="n">frequency</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;probe_freq&quot;</span><span class="p">]</span>
    <span class="n">fft</span><span class="p">[(</span><span class="n">frequency</span> <span class="o">&gt;=</span> <span class="n">f_max</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">frequency</span> <span class="o">&lt;=</span> <span class="n">f_min</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">fft</span> <span class="o">*=</span> <span class="mf">1000.0</span>
    <span class="k">return</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">fft</span></div>


<div class="viewcode-block" id="fid2fft"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.fid2fft">[docs]</a><span class="k">def</span> <span class="nf">fid2fft</span><span class="p">(</span><span class="n">fid</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">frequencies</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Process an FID by performing an FFT to yield the frequency domain</span>
<span class="sd">    information. Kwargs are passed as additional processing options,</span>
<span class="sd">    and are implemented as some case statements to ensure the settings</span>
<span class="sd">    are valid (e.g. conforms to sampling rate, etc.)</span>

<span class="sd">    :param fid: np.array corresponding to the FID intensity</span>
<span class="sd">    :param rate: sampling rate in Hz</span>
<span class="sd">    :param frequencies: np.array corresponding to the frequency bins</span>
<span class="sd">    :param kwargs: signal processing options:</span>
<span class="sd">                    delay - delays the FID processing by setting the start</span>
<span class="sd">                            of the FID to zero</span>
<span class="sd">                    zeropad - Toggles whether or not the number of sampled</span>
<span class="sd">                              points is doubled to get artificially higher</span>
<span class="sd">                              resolution in the FFT</span>
<span class="sd">                    window - Various window functions provided by `scipy.signal`</span>
<span class="sd">                    exp - Specifies an exponential filter</span>
<span class="sd">                    filter - 2-tuple specifying the frequency cutoffs for a</span>
<span class="sd">                             band pass filter</span>
<span class="sd">    :return: freq_df - pandas dataframe with the FFT spectrum</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Remove DC</span>
    <span class="n">new_fid</span> <span class="o">=</span> <span class="n">fid</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;delay&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">delay</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;delay&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">rate</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">)</span>
        <span class="n">new_fid</span><span class="p">[:</span><span class="n">delay</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="c1"># Zero-pad the FID</span>
    <span class="k">if</span> <span class="s2">&quot;zeropad&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;zeropad&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Pad the FID with zeros to get higher resolution</span>
            <span class="n">fid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_fid</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_fid</span><span class="p">)))</span>
            <span class="c1"># Since we&#39;ve padded with zeros, we&#39;ll have to update the</span>
            <span class="c1"># frequency array</span>
            <span class="n">frequencies</span> <span class="o">=</span> <span class="n">spsig</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">frequencies</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">frequencies</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
    <span class="c1"># Apply a window function to the FID</span>
    <span class="k">if</span> <span class="s2">&quot;window&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;window&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="n">spsig</span><span class="o">.</span><span class="n">windows</span><span class="o">.</span><span class="n">__all__</span><span class="p">:</span>
            <span class="n">new_fid</span> <span class="o">*=</span> <span class="n">spsig</span><span class="o">.</span><span class="n">get_window</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;window&quot;</span><span class="p">],</span> <span class="n">new_fid</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="c1"># Apply an exponential filter on the FID</span>
    <span class="k">if</span> <span class="s2">&quot;exp&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;exp&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">new_fid</span> <span class="o">*=</span> <span class="n">spsig</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_fid</span><span class="p">),</span> <span class="n">tau</span><span class="o">=</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;exp&quot;</span><span class="p">])</span>
    <span class="c1"># Apply a bandpass filter on the FID</span>
    <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;filter&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;filter&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">low</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;filter&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">low</span> <span class="o">&lt;</span> <span class="n">high</span><span class="p">:</span>
            <span class="n">new_fid</span> <span class="o">=</span> <span class="n">apply_butter_filter</span><span class="p">(</span><span class="n">new_fid</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">rate</span><span class="p">)</span>
    <span class="c1"># Perform the FFT</span>
    <span class="n">fft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">new_fid</span><span class="p">)</span>
    <span class="c1"># Get the real part of the FFT, and only the non-duplicated side</span>
    <span class="n">real_fft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fft</span><span class="p">[:</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">new_fid</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_fid</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e3</span>
    <span class="n">frequencies</span> <span class="o">=</span> <span class="n">spsig</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">real_fft</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="c1"># For some reason, resampling screws up the frequency ordering...</span>
    <span class="n">real_fft</span> <span class="o">=</span> <span class="n">real_fft</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">frequencies</span><span class="p">)]</span>
    <span class="n">frequencies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">frequencies</span><span class="p">)</span>
    <span class="c1"># Package into a pandas dataframe</span>
    <span class="n">freq_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;Frequency (MHz)&quot;</span><span class="p">:</span> <span class="n">frequencies</span><span class="p">,</span> <span class="s2">&quot;Intensity&quot;</span><span class="p">:</span> <span class="n">real_fft</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">freq_df</span></div>


<div class="viewcode-block" id="butter_bandpass"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.butter_bandpass">[docs]</a><span class="k">def</span> <span class="nf">butter_bandpass</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A modified version of the Butterworth bandpass filter described here,</span>
<span class="sd">        adapted for use with the FID signal.</span>
<span class="sd">        http://scipy-cookbook.readthedocs.io/items/ButterworthBandpass.html</span>
<span class="sd">        The arguments are:</span>

<span class="sd">        :param low The low frequency cut-off, given in kHz.</span>
<span class="sd">        :param high The high frequency cut-off, given in kHz.</span>
<span class="sd">        :param rate The sampling rate, given in Hz. From the FIDs, this means that</span>
<span class="sd">                    the inverse of the FID spacing is used.</span>
<span class="sd">        :return bandpass window</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Calculate the Nyquist frequency</span>
    <span class="n">nyq</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">rate</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">))</span>
    <span class="n">low</span> <span class="o">=</span> <span class="p">(</span><span class="n">low</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">)</span> <span class="o">/</span> <span class="n">nyq</span>
    <span class="n">high</span> <span class="o">=</span> <span class="p">(</span><span class="n">high</span> <span class="o">*</span> <span class="mf">1e3</span><span class="p">)</span> <span class="o">/</span> <span class="n">nyq</span>
    <span class="k">if</span> <span class="n">high</span> <span class="o">&gt;</span> <span class="mf">1.0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;High frequency cut-off exceeds the Nyquist frequency.&quot;</span><span class="p">)</span>
    <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">spsig</span><span class="o">.</span><span class="n">butter</span><span class="p">(</span><span class="n">order</span><span class="p">,</span> <span class="p">[</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">],</span> <span class="n">btype</span><span class="o">=</span><span class="s2">&quot;band&quot;</span><span class="p">,</span> <span class="n">analog</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span></div>


<div class="viewcode-block" id="apply_butter_filter"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.apply_butter_filter">[docs]</a><span class="k">def</span> <span class="nf">apply_butter_filter</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A modified Butterworth bandpass filter, adapted from the Scipy cookbook.</span>

<span class="sd">        The argument data supplies the FID, which then uses the scipy signal</span>
<span class="sd">        processing function to apply the digital filter, and returns the filtered</span>
<span class="sd">        FID.</span>

<span class="sd">        See the `butter_bandpass` function for additional arguments.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">butter_bandpass</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">spsig</span><span class="o">.</span><span class="n">lfilter</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">y</span></div>


<div class="viewcode-block" id="parse_batch"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.parse_batch">[docs]</a><span class="k">def</span> <span class="nf">parse_batch</span><span class="p">(</span><span class="n">filecontents</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filecontents</span><span class="p">):</span>
        <span class="k">if</span> <span class="s2">&quot;#Batch scan&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">if</span> <span class="s2">&quot;#Date&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>
            <span class="n">strip_targets</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;#Date&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">]</span>
            <span class="n">data</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
                <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s2">&quot;|&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">strip_targets</span><span class="p">),</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">%a</span><span class="s2"> %b </span><span class="si">%d</span><span class="s2"> %H:%M:%S %Y&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;batchscan&quot;</span><span class="p">):</span>
            <span class="n">scan_details</span> <span class="o">=</span> <span class="n">filecontents</span><span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:]</span>
            <span class="n">scan_details</span> <span class="o">=</span> <span class="p">[</span><span class="n">scan</span><span class="o">.</span><span class="n">split</span><span class="p">()</span> <span class="k">for</span> <span class="n">scan</span> <span class="ow">in</span> <span class="n">scan_details</span><span class="p">]</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;id&quot;</span><span class="p">,</span>
        <span class="s2">&quot;max&quot;</span><span class="p">,</span>
        <span class="s2">&quot;iscal&quot;</span><span class="p">,</span>
        <span class="s2">&quot;issat&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ftfreq&quot;</span><span class="p">,</span>
        <span class="s2">&quot;attn&quot;</span><span class="p">,</span>
        <span class="s2">&quot;drfreq&quot;</span><span class="p">,</span>
        <span class="s2">&quot;drpower&quot;</span><span class="p">,</span>
        <span class="s2">&quot;pulses&quot;</span><span class="p">,</span>
        <span class="s2">&quot;shots&quot;</span><span class="p">,</span>
        <span class="s2">&quot;autofitpair_freq&quot;</span><span class="p">,</span>
        <span class="s2">&quot;autofitpair_int&quot;</span><span class="p">,</span>
        <span class="s2">&quot;autofitfreq&quot;</span><span class="p">,</span>
        <span class="s2">&quot;autofitint&quot;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">scan_details</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">headers</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">data</span></div>


<div class="viewcode-block" id="generate_ftb_line"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.generate_ftb_line">[docs]</a><span class="k">def</span> <span class="nf">generate_ftb_line</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="n">shots</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Function that generates an FTB file for a list of</span>
<span class="sd">        frequencies, plus categorization tests.</span>

<span class="sd">        kwargs are passed as additional options for the ftb</span>
<span class="sd">        batch. Keywords are:</span>

<span class="sd">        magnet: bool</span>
<span class="sd">        dipole: float</span>
<span class="sd">        atten: int</span>
<span class="sd">        skiptune: bool</span>
<span class="sd">        drfreq: float</span>
<span class="sd">        drpower: int</span>
<span class="sd">        cal</span>

<span class="sd">        parameters:</span>
<span class="sd">        ---------------</span>
<span class="sd">        :param frequency: float for frequency in MHz</span>
<span class="sd">        :param shots: int number of shots to integrate for</span>

<span class="sd">        returns:</span>
<span class="sd">        ---------------</span>
<span class="sd">        :return ftbline: str</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;ftm:</span><span class="si">{:.4f}</span><span class="s2"> shots:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="n">shots</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot; </span><span class="si">{}</span><span class="s2">:</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
    <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="k">return</span> <span class="n">line</span></div>


<div class="viewcode-block" id="neu_categorize_frequencies"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.neu_categorize_frequencies">[docs]</a><span class="k">def</span> <span class="nf">neu_categorize_frequencies</span><span class="p">(</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">intensities</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nshots</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Routine to generate an FTB batch file for performing a series of tests</span>
<span class="sd">        on frequencies.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ftb_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">intensities</span><span class="p">:</span>
        <span class="n">norm_int</span> <span class="o">=</span> <span class="n">intensities</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">intensities</span><span class="p">)</span>
        <span class="n">shotcounts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">nshots</span> <span class="o">/</span> <span class="n">norm_int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shotcounts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">frequencies</span><span class="p">),</span> <span class="n">nshots</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

    <span class="c1"># default settings for all stuff</span>
    <span class="n">param_dict</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;dipole&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
        <span class="s2">&quot;magnet&quot;</span><span class="p">:</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span>
        <span class="s2">&quot;drpower&quot;</span><span class="p">:</span> <span class="s2">&quot;10&quot;</span><span class="p">,</span>
        <span class="s2">&quot;skiptune&quot;</span><span class="p">:</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">param_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">freq</span><span class="p">,</span> <span class="n">shot</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">shotcounts</span><span class="p">):</span>
        <span class="n">ftb_string</span> <span class="o">+=</span> <span class="n">generate_ftb_str</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">shot</span><span class="p">,</span> <span class="o">**</span><span class="n">param_dict</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;magnet&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">param_dict</span><span class="p">[</span><span class="s2">&quot;magnet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>
            <span class="n">ftb_string</span> <span class="o">+=</span> <span class="n">generate_ftb_str</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">shot</span><span class="p">,</span> <span class="o">**</span><span class="n">param_dict</span><span class="p">)</span></div>


<div class="viewcode-block" id="categorize_frequencies"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.categorize_frequencies">[docs]</a><span class="k">def</span> <span class="nf">categorize_frequencies</span><span class="p">(</span>
    <span class="n">frequencies</span><span class="p">,</span>
    <span class="n">nshots</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
    <span class="n">intensities</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">power</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">attn_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">dipole</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">attn</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">magnet</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">dr</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">discharge</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function that will format an FT batch file to perform categorization</span>
<span class="sd">        tests, with some flexibility on how certain tests are performed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ftb_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">intensities</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">shots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">frequencies</span><span class="p">),</span> <span class="n">nshots</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">shots</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">nshots</span> <span class="o">/</span> <span class="n">intensities</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dipole</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">attn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># If dipole test requested, but no attenuation</span>
            <span class="c1"># supplied do the default sweep</span>
            <span class="n">dipole_test</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">]</span>
            <span class="n">dipole_flag</span> <span class="o">=</span> <span class="s2">&quot;dipole&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Otherwise run specific attenuations</span>
            <span class="n">dipole_test</span> <span class="o">=</span> <span class="n">attn_list</span>
            <span class="n">dipole_flag</span> <span class="o">=</span> <span class="s2">&quot;atten&quot;</span>

    <span class="k">if</span> <span class="n">dr</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">freq_list</span> <span class="o">=</span> <span class="n">combinations</span><span class="p">(</span><span class="n">frequencies</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">freq_list</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">freq_list</span> <span class="o">=</span> <span class="n">frequencies</span>

    <span class="c1"># loop over each frequency and number of shots</span>
    <span class="k">for</span> <span class="n">value</span><span class="p">,</span> <span class="n">shotcount</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">freq_list</span><span class="p">,</span> <span class="n">shots</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">dr</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">freq</span><span class="p">,</span> <span class="n">dr_freq</span> <span class="o">=</span> <span class="n">value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">freq</span> <span class="o">=</span> <span class="n">value</span>
            <span class="c1"># Generate normal observation</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">freq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
            <span class="n">shotcount</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">shotcount</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dr</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">dr_freq</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dr_freq</span><span class="p">)</span>

            <span class="n">ftb_str</span> <span class="o">+=</span> <span class="n">generate_ftb_line</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">shotcount</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s2">&quot;skiptune&quot;</span><span class="p">:</span> <span class="s2">&quot;false&quot;</span><span class="p">})</span>

            <span class="k">if</span> <span class="n">dr</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">ftb_str</span> <span class="o">+=</span> <span class="n">generate_ftb_line</span><span class="p">(</span>
                    <span class="n">freq</span><span class="p">,</span> <span class="n">shotcount</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s2">&quot;skiptune&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;drfreq&quot;</span><span class="p">:</span> <span class="n">dr_freq</span><span class="p">}</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">dipole</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">dipole_value</span> <span class="ow">in</span> <span class="n">dipole_test</span><span class="p">:</span>
                    <span class="n">ftb_str</span> <span class="o">+=</span> <span class="n">generate_ftb_line</span><span class="p">(</span>
                        <span class="n">freq</span><span class="p">,</span> <span class="n">shotcount</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="n">dipole_flag</span><span class="p">:</span> <span class="n">dipole_value</span><span class="p">}</span>
                    <span class="p">)</span>

            <span class="k">if</span> <span class="n">magnet</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">ftb_str</span> <span class="o">+=</span> <span class="n">generate_ftb_line</span><span class="p">(</span><span class="n">freq</span><span class="p">,</span> <span class="n">shotcount</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s2">&quot;magnet&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">})</span>

            <span class="k">if</span> <span class="n">discharge</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># Toggle the discharge stack on and off</span>
                <span class="n">ftb_str</span> <span class="o">+=</span> <span class="n">generate_ftb_line</span><span class="p">(</span>
                    <span class="n">freq</span><span class="p">,</span> <span class="n">shotcount</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s2">&quot;pulse,1,enabled&quot;</span><span class="p">:</span> <span class="s2">&quot;false&quot;</span><span class="p">}</span>
                <span class="p">)</span>
                <span class="n">ftb_str</span> <span class="o">+=</span> <span class="n">generate_ftb_line</span><span class="p">(</span>
                    <span class="n">freq</span><span class="p">,</span> <span class="n">shotcount</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s2">&quot;pulse,1,enabled&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">}</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error with &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">ftb_str</span></div>


<div class="viewcode-block" id="calculate_integration_times"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.calculate_integration_times">[docs]</a><span class="k">def</span> <span class="nf">calculate_integration_times</span><span class="p">(</span><span class="n">intensity</span><span class="p">,</span> <span class="n">nshots</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method for calculating the expected integration time</span>
<span class="sd">        in shot counts based on the intensity; either theoretical</span>
<span class="sd">        line strengths or SNR.</span>

<span class="sd">        parameters:</span>
<span class="sd">        ---------------</span>
<span class="sd">        intensity - array of intensity metric; e.g. SNR</span>
<span class="sd">        nshots - optional int number of shots used for the strongest line</span>

<span class="sd">        returns:</span>
<span class="sd">        ---------------</span>
<span class="sd">        shot_counts - array of shot counts for each frequency</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">norm_int</span> <span class="o">=</span> <span class="n">intensity</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">intensity</span><span class="p">)</span>
    <span class="n">shot_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">nshots</span> <span class="o">/</span> <span class="n">norm_int</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">shot_counts</span></div>


<div class="viewcode-block" id="AssayBatch"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.AssayBatch">[docs]</a><span class="k">class</span> <span class="nc">AssayBatch</span><span class="p">:</span>
<div class="viewcode-block" id="AssayBatch.from_csv"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.AssayBatch.from_csv">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_csv</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">exp_id</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Create an AssayBatch session by providing a</span>
<span class="sd">            filepath to a file containing the frequency and</span>
<span class="sd">            intensity information, as well as the experiment</span>
<span class="sd">            ID from which it was based.</span>

<span class="sd">            parameters:</span>
<span class="sd">            --------------</span>
<span class="sd">            filepath - path to a CSV file with Frequency/Intensity</span>
<span class="sd">                       columns</span>
<span class="sd">            exp_id - experiment ID; typically the chirp experiment number</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">exp_id</span><span class="p">)</span></div>

<div class="viewcode-block" id="AssayBatch.load_session"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.AssayBatch.load_session">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load_session</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Loads a previously saved AssayBatch session.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">routines</span><span class="o">.</span><span class="n">read_obj</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">session</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span></div>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">exp_id</span><span class="p">,</span> <span class="n">freq_col</span><span class="o">=</span><span class="s2">&quot;Frequency&quot;</span><span class="p">,</span> <span class="n">int_col</span><span class="o">=</span><span class="s2">&quot;Intensity&quot;</span><span class="p">):</span>
        <span class="n">folders</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;assays&quot;</span><span class="p">,</span> <span class="s2">&quot;ftbfiles&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s2">&quot;assays/plots&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s2">&quot;./assays/plots&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">exp_id</span> <span class="o">=</span> <span class="n">exp_id</span>

        <span class="k">if</span> <span class="n">freq_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">freq_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">freq_col</span> <span class="o">=</span> <span class="n">freq_col</span>
        <span class="k">if</span> <span class="n">int_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">int_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">int_col</span> <span class="o">=</span> <span class="n">int_col</span>

<div class="viewcode-block" id="AssayBatch.calc_scan_SNR"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.AssayBatch.calc_scan_SNR">[docs]</a>    <span class="k">def</span> <span class="nf">calc_scan_SNR</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">peak_int</span><span class="p">,</span> <span class="n">noise_array</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Calculate the signal-to-noise ratio of a peak</span>
<span class="sd">            for a given reference noise intensity array</span>
<span class="sd">            and peak intensity.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">noise_array</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">peak_int</span> <span class="o">/</span> <span class="n">noise</span></div>

<div class="viewcode-block" id="AssayBatch.dipole_analysis"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.AssayBatch.dipole_analysis">[docs]</a>    <span class="k">def</span> <span class="nf">dipole_analysis</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">batch_path</span><span class="p">,</span>
        <span class="n">thres</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
        <span class="n">dipoles</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">],</span>
        <span class="n">snr_thres</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Method for determining the optimal dipole moment to use </span>
<span class="sd">            for each frequency in a given exported batch of dipole tests.</span>

<span class="sd">            In addition to returning a pandas dataframe, it is also</span>
<span class="sd">            stored as the object attribute dipole_df.</span>

<span class="sd">            parameters:</span>
<span class="sd">            ----------------</span>
<span class="sd">            batch_path - filepath to the exported XY file from a QtFTM batch</span>
<span class="sd">            thres - threshold in absolute intensity for peak detection (in Volts)</span>
<span class="sd">            dipoles - list of dipole moments used in the screening</span>
<span class="sd">            snr_thres - threshold in signal-to-noise for line detection</span>

<span class="sd">            returns:</span>
<span class="sd">            ----------------</span>
<span class="sd">            optimal_df - pandas dataframe containing the optimal dipole moments</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">batch_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">batch_path</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">batch_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Scan&quot;</span><span class="p">,</span> <span class="s2">&quot;Intensity&quot;</span><span class="p">]</span>

        <span class="c1"># Reference scan numbers from the batch</span>
        <span class="n">scan_numbers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">around</span><span class="p">(</span><span class="n">batch_df</span><span class="p">[</span><span class="s2">&quot;Scan&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
        <span class="c1"># Make a dataframe for what we expect everything should be</span>
        <span class="n">full_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">],</span> <span class="n">dipoles</span><span class="p">)),</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">,</span> <span class="s2">&quot;Dipole&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">full_df</span><span class="p">[</span><span class="s2">&quot;Scan&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">scan_numbers</span>

        <span class="c1"># Loop over each scan, and determine whether or not there is a peak</span>
        <span class="c1"># If there is sufficiently strong feature, add it to the list with the</span>
        <span class="c1"># scan number</span>
        <span class="n">detected_scans</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">scan</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">scan_numbers</span><span class="p">):</span>
            <span class="n">scan_slice</span> <span class="o">=</span> <span class="n">batch_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="p">(</span><span class="n">batch_df</span><span class="p">[</span><span class="s2">&quot;Scan&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">scan</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">batch_df</span><span class="p">[</span><span class="s2">&quot;Scan&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">scan</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="c1"># Find the peaks based on absolute signal intensity</span>
            <span class="c1"># Assumption is that everything is integrated for the same period of time</span>
            <span class="n">peaks</span> <span class="o">=</span> <span class="n">scan_slice</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span>
                <span class="n">peakutils</span><span class="o">.</span><span class="n">indexes</span><span class="p">(</span><span class="n">scan_slice</span><span class="p">[</span><span class="s2">&quot;Intensity&quot;</span><span class="p">],</span> <span class="n">thres</span><span class="o">=</span><span class="n">thres</span><span class="p">,</span> <span class="n">thres_abs</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="p">]</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;Intensity&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">peak_int</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;Intensity&quot;</span><span class="p">][:</span><span class="mi">2</span><span class="p">])</span>
            <span class="n">snr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calc_scan_SNR</span><span class="p">(</span><span class="n">peak_int</span><span class="p">,</span> <span class="n">scan_slice</span><span class="p">[</span><span class="s2">&quot;Intensity&quot;</span><span class="p">][</span><span class="o">-</span><span class="mi">10</span><span class="p">:])</span>
            <span class="k">if</span> <span class="n">snr</span> <span class="o">&gt;=</span> <span class="n">snr_thres</span><span class="p">:</span>
                <span class="n">detected_scans</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">scan</span><span class="p">,</span> <span class="n">snr</span><span class="p">])</span>
        <span class="n">snr_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">detected_scans</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Scan&quot;</span><span class="p">,</span> <span class="s2">&quot;SNR&quot;</span><span class="p">])</span>
        <span class="c1"># Merge the dataframes based on scan number. This will identify</span>
        <span class="c1"># scans where we observe a line</span>
        <span class="n">obs_df</span> <span class="o">=</span> <span class="n">full_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">snr_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Scan&quot;</span><span class="p">],</span> <span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">optimal_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="c1"># Loop over each frequency in order to determine the optimal</span>
        <span class="c1"># dipole moment to use</span>
        <span class="k">for</span> <span class="n">frequency</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">obs_df</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">]):</span>
            <span class="n">slice_df</span> <span class="o">=</span> <span class="n">obs_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">obs_df</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">frequency</span><span class="p">]</span>
            <span class="c1"># Sort the best response dipole moment at the top</span>
            <span class="n">slice_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;SNR&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">slice_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">slice_df</span><span class="p">))</span>
            <span class="n">optimal_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">slice_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">optimal_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">optimal_data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">,</span> <span class="s2">&quot;Dipole&quot;</span><span class="p">,</span> <span class="s2">&quot;Scan&quot;</span><span class="p">,</span> <span class="s2">&quot;SNR&quot;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">optimal_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;SNR&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dipole_df</span> <span class="o">=</span> <span class="n">optimal_df</span>

        <span class="c1"># Generate histogram of dipole moments</span>
        <span class="k">with</span> <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">context</span><span class="p">(</span><span class="s2">&quot;publication&quot;</span><span class="p">):</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dipole_df</span><span class="p">[</span><span class="s2">&quot;Dipole&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Dipole (D)&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Counts&quot;</span><span class="p">)</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                <span class="s2">&quot;./assays/plots/</span><span class="si">{}</span><span class="s2">-dipole.pdf&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_id</span><span class="p">),</span>
                <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;pdf&quot;</span><span class="p">,</span>
                <span class="n">transparent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">optimal_df</span></div>

<div class="viewcode-block" id="AssayBatch.generate_magnet_test"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.AssayBatch.generate_magnet_test">[docs]</a>    <span class="k">def</span> <span class="nf">generate_magnet_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataframe</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nshots</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Generate an FT batch file for performing magnetic tests.</span>

<span class="sd">            parameters:</span>
<span class="sd">            -----------------</span>
<span class="sd">            dataframe - dataframe used for the frequency information.</span>
<span class="sd">                        By default the dipole dataframe will be used.</span>
<span class="sd">            cal - bool denoting whether a calibration line is used.</span>
<span class="sd">                  A user can provide it in kwargs, or use the default</span>
<span class="sd">                  which is the first line in the dataframe (strongest</span>
<span class="sd">                  if sorted by intensity)</span>
<span class="sd">            nshots - optional int specifying number of shots for each</span>
<span class="sd">                     line, or if SNR is in the dataframe, the number</span>
<span class="sd">                     of shots for the strongest line.</span>
<span class="sd">            kwargs - passed into the calibration settings, which are</span>
<span class="sd">                     cal_freq, cal_rate, and cal_shots</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dataframe</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dataframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dipole_df</span>
            <span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Shots&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_integration_times</span><span class="p">(</span>
                <span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;SNR&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">nshots</span>
            <span class="p">)</span>
        <span class="n">ftb_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># If there are no shots determined,</span>
        <span class="k">if</span> <span class="s2">&quot;Shots&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataframe</span><span class="p">:</span>
            <span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Shots&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nshots</span>

        <span class="c1"># If calibration is requested</span>
        <span class="c1"># cal_rate sets the number of scans per calibration</span>
        <span class="k">if</span> <span class="n">cal</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">cal_settings</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;cal_freq&quot;</span><span class="p">:</span> <span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                <span class="s2">&quot;cal_rate&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
                <span class="s2">&quot;cal_shots&quot;</span><span class="p">:</span> <span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Shots&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
            <span class="p">}</span>
            <span class="k">if</span> <span class="s2">&quot;Dipole&quot;</span> <span class="ow">in</span> <span class="n">dataframe</span><span class="p">:</span>
                <span class="n">cal_settings</span><span class="p">[</span><span class="s2">&quot;cal_dipole&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Dipole&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">cal_settings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="c1"># Generate the calibration string</span>
            <span class="n">cal_str</span> <span class="o">=</span> <span class="n">generate_ftb_line</span><span class="p">(</span>
                <span class="n">cal_settings</span><span class="p">[</span><span class="s2">&quot;cal_freq&quot;</span><span class="p">],</span>
                <span class="n">cal_settings</span><span class="p">[</span><span class="s2">&quot;cal_shots&quot;</span><span class="p">],</span>
                <span class="o">**</span><span class="p">{</span><span class="s2">&quot;dipole&quot;</span><span class="p">:</span> <span class="n">cal_settings</span><span class="p">[</span><span class="s2">&quot;cal_dipole&quot;</span><span class="p">],</span> <span class="s2">&quot;skiptune&quot;</span><span class="p">:</span> <span class="s2">&quot;false&quot;</span><span class="p">},</span>
            <span class="p">)</span>
            <span class="n">cal_str</span> <span class="o">=</span> <span class="n">cal_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot; cal</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># generate the batch file</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
            <span class="c1"># If we want to add a calibration line</span>
            <span class="k">if</span> <span class="n">index</span> <span class="o">%</span> <span class="n">cal_settings</span><span class="p">[</span><span class="s2">&quot;cal_rate&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ftb_str</span> <span class="o">+=</span> <span class="n">cal_str</span>
            <span class="n">param_dict</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="c1"># Make sure the magnet is off</span>
            <span class="k">if</span> <span class="s2">&quot;Dipole&quot;</span> <span class="ow">in</span> <span class="n">row</span><span class="p">:</span>
                <span class="n">param_df</span><span class="p">[</span><span class="s2">&quot;dipole&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Dipole&quot;</span><span class="p">]</span>
            <span class="n">param_df</span><span class="p">[</span><span class="s2">&quot;magnet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;false&quot;</span>
            <span class="n">param_df</span><span class="p">[</span><span class="s2">&quot;skiptune&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;false&quot;</span>
            <span class="n">ftb_str</span> <span class="o">+=</span> <span class="n">generate_ftb_line</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Shots&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">param_df</span><span class="p">)</span>
            <span class="c1"># Turn on the magnet</span>
            <span class="n">param_df</span><span class="p">[</span><span class="s2">&quot;skiptune&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>
            <span class="n">param_df</span><span class="p">[</span><span class="s2">&quot;magnet&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>
            <span class="n">ftb_str</span> <span class="o">+=</span> <span class="n">generate_ftb_line</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Shots&quot;</span><span class="p">],</span> <span class="o">**</span><span class="n">param_df</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;./ftbfiles/</span><span class="si">{}</span><span class="s2">.ftb&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_id</span><span class="p">),</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">write_file</span><span class="p">:</span>
            <span class="n">write_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ftb_str</span><span class="p">)</span></div>

<div class="viewcode-block" id="AssayBatch.generate_bruteforce_dr"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.AssayBatch.generate_bruteforce_dr">[docs]</a>    <span class="k">def</span> <span class="nf">generate_bruteforce_dr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nshots</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">dr_channel</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Brute force double resonance test on every single frequency</span>
<span class="sd">            observed in the initial dipole test.</span>

<span class="sd">            This method will perform DR measurements on sequentially</span>
<span class="sd">            weaker lines, if the dipole_df is sorted by SNR.</span>

<span class="sd">            Optionally, the </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ftb_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">combos</span> <span class="o">=</span> <span class="n">combinations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dipole_df</span><span class="p">[[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">,</span> <span class="s2">&quot;Dipole&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">combo</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">combos</span><span class="p">):</span>
            <span class="c1"># For the first time a cavity frequency is used</span>
            <span class="c1"># we will measure it once without DR</span>
            <span class="n">freq</span> <span class="o">=</span> <span class="n">combo</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">last_freq</span> <span class="o">!=</span> <span class="n">freq</span><span class="p">):</span>
                <span class="n">ftb_str</span> <span class="o">+=</span> <span class="n">generate_ftb_line</span><span class="p">(</span>
                    <span class="n">freq</span><span class="p">,</span>
                    <span class="n">nshots</span><span class="p">,</span>
                    <span class="o">**</span><span class="p">{</span>
                        <span class="s2">&quot;dipole&quot;</span><span class="p">:</span> <span class="n">combo</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                        <span class="s2">&quot;pulse,</span><span class="si">{}</span><span class="s2">,enable&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dr_channel</span><span class="p">):</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;skiptune&quot;</span><span class="p">:</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">)</span>
            <span class="c1"># Only do DR if the DR frequency is significantly different from</span>
            <span class="c1"># the cavity frequency</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">combo</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">freq</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mf">100.0</span><span class="p">:</span>
                <span class="n">ftb_str</span> <span class="o">+=</span> <span class="n">generate_ftb_line</span><span class="p">(</span>
                    <span class="n">freq</span><span class="p">,</span>
                    <span class="n">nshots</span><span class="p">,</span>
                    <span class="o">**</span><span class="p">{</span>
                        <span class="s2">&quot;dipole&quot;</span><span class="p">:</span> <span class="n">combo</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                        <span class="s2">&quot;drfreq&quot;</span><span class="p">:</span> <span class="n">combo</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                        <span class="s2">&quot;pulse,</span><span class="si">{}</span><span class="s2">,enable&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dr_channel</span><span class="p">):</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;skiptune&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">)</span>
            <span class="n">last_freq</span> <span class="o">=</span> <span class="n">combo</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There are </span><span class="si">{}</span><span class="s2"> combinations to measure.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;./ftbfiles/</span><span class="si">{}</span><span class="s2">-bruteDR.ftb&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_id</span><span class="p">),</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">write_file</span><span class="p">:</span>
            <span class="n">write_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ftb_str</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FTB file saved to ./ftbfiles/</span><span class="si">{}</span><span class="s2">-bruteDR.ftb&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_id</span><span class="p">))</span></div>

<div class="viewcode-block" id="AssayBatch.find_progressions"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.AssayBatch.find_progressions">[docs]</a>    <span class="k">def</span> <span class="nf">find_progressions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Uses the dipole assay data to look for harmonic</span>
<span class="sd">            progression.</span>

<span class="sd">            Kwargs are passed into the affinity propagation</span>
<span class="sd">            clustering; usually this means &quot;preference&quot; should</span>
<span class="sd">            be set to tune the number of clusters.</span>

<span class="sd">            returns:</span>
<span class="sd">            --------------</span>
<span class="sd">            cluster_dict - dictionary containing all of the clustered</span>
<span class="sd">                           progressions</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">progressions</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">harmonic_finder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dipole_df</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">progression_df</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">harmonic_fitter</span><span class="p">(</span><span class="n">progressions</span><span class="p">)</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">ap_obj</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">cluster_AP_analysis</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">progression_df</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_dict</span> <span class="o">=</span> <span class="n">data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_obj</span> <span class="o">=</span> <span class="n">ap_obj</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_dict</span></div>

<div class="viewcode-block" id="AssayBatch.generate_progression_test"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.AssayBatch.generate_progression_test">[docs]</a>    <span class="k">def</span> <span class="nf">generate_progression_test</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nshots</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">dr_channel</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Take the dipole moment dataframe and generate a DR batch.</span>
<span class="sd">            If possible, we will instead use the progressions predicted</span>
<span class="sd">            by the cluster model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ftb_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># Loop over progressions</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">sub_dict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># Take only frequencies that are in the current progression</span>
            <span class="n">slice_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dipole_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dipole_df</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">sub_dict</span><span class="p">[</span><span class="s2">&quot;Frequencies&quot;</span><span class="p">])</span>
            <span class="p">]</span>
            <span class="n">prog_data</span> <span class="o">=</span> <span class="n">slice_df</span><span class="p">[[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">,</span> <span class="s2">&quot;Dipole&quot;</span><span class="p">,</span> <span class="s2">&quot;Shots&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
            <span class="k">for</span> <span class="n">sub_index</span><span class="p">,</span> <span class="n">pair</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">combinations</span><span class="p">(</span><span class="n">prog_data</span><span class="p">,</span> <span class="mi">2</span><span class="p">)):</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">sub_index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">last_freq</span> <span class="o">!=</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">ftb_str</span> <span class="o">+=</span> <span class="n">generate_ftb_line</span><span class="p">(</span>
                        <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                        <span class="mi">10</span><span class="p">,</span>
                        <span class="o">**</span><span class="p">{</span>
                            <span class="s2">&quot;dipole&quot;</span><span class="p">:</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                            <span class="s2">&quot;pulse,</span><span class="si">{}</span><span class="s2">,enable&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dr_channel</span><span class="p">):</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;skiptune&quot;</span><span class="p">:</span> <span class="s2">&quot;false&quot;</span><span class="p">,</span>
                        <span class="p">},</span>
                    <span class="p">)</span>
                <span class="c1"># Perform the DR measurement</span>
                <span class="n">ftb_str</span> <span class="o">+=</span> <span class="n">generate_ftb_line</span><span class="p">(</span>
                    <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                    <span class="mi">10</span><span class="p">,</span>
                    <span class="o">**</span><span class="p">{</span>
                        <span class="s2">&quot;dipole&quot;</span><span class="p">:</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                        <span class="s2">&quot;pulse,</span><span class="si">{}</span><span class="s2">,enable&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">dr_channel</span><span class="p">):</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;skiptune&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span>
                    <span class="p">},</span>
                <span class="p">)</span>
                <span class="n">last_freq</span> <span class="o">=</span> <span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;There are </span><span class="si">{}</span><span class="s2"> combinations to test.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">count</span><span class="p">))</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
            <span class="s2">&quot;./ftbfiles/</span><span class="si">{}</span><span class="s2">-progressionDR.ftb&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_id</span><span class="p">),</span> <span class="s2">&quot;w+&quot;</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">write_file</span><span class="p">:</span>
            <span class="n">write_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ftb_str</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;FTB file saved to ./ftbfiles/</span><span class="si">{}</span><span class="s2">-progressionDR.ftb&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_id</span><span class="p">))</span></div>

<div class="viewcode-block" id="AssayBatch.plot_scan"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.AssayBatch.plot_scan">[docs]</a>    <span class="k">def</span> <span class="nf">plot_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan_number</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Quick method for plotting up a strip to highlight a particular</span>
<span class="sd">            scan in a batch.</span>

<span class="sd">            parameters:</span>
<span class="sd">            ---------------</span>
<span class="sd">            scan_number - float corresponding to the scan </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">FigureWidget</span><span class="p">()</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">add_scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Scan&quot;</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Intensity&quot;</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">scan_number</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">[</span><span class="n">scan_number</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Intensity&quot;</span><span class="p">])])</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="AssayBatch.static_plot"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.AssayBatch.static_plot">[docs]</a>    <span class="k">def</span> <span class="nf">static_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scan_number</span><span class="p">,</span> <span class="n">dataframe</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Produce a static plot with matplotlib of a particular</span>
<span class="sd">            scan from a batch.</span>

<span class="sd">            Saves the plot to ./assays/plots/</span>

<span class="sd">            By default, the full dataframe will be used for the plotting.</span>
<span class="sd">            Other dataframes (such as from other assays) can also be used.</span>

<span class="sd">            parameters:</span>
<span class="sd">            ---------------</span>
<span class="sd">            scan_number - float corresponding to the scan of interest</span>
<span class="sd">            dataframe - optional arg; pandas dataframe with Scan/Intensity</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">dataframe</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dataframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="n">slice_df</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Scan&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">scan_number</span> <span class="o">-</span> <span class="mf">1.5</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Scan&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">scan_number</span> <span class="o">+</span> <span class="mf">1.5</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">scan_numbers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">slice_df</span><span class="p">[</span><span class="s2">&quot;Scan&quot;</span><span class="p">]))</span>

        <span class="k">with</span> <span class="n">plt</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">context</span><span class="p">(</span><span class="s2">&quot;publication&quot;</span><span class="p">):</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">slice_df</span><span class="p">[</span><span class="s2">&quot;Scan&quot;</span><span class="p">],</span> <span class="n">slice_df</span><span class="p">[</span><span class="s2">&quot;Intensity&quot;</span><span class="p">])</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">scan_numbers</span><span class="p">)</span>
            <span class="c1"># Makes the x axis not scientific notation</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">get_major_formatter</span><span class="p">()</span><span class="o">.</span><span class="n">set_useOffset</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Scan number&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Intensity&quot;</span><span class="p">)</span>

            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                <span class="s2">&quot;./assays/plots/</span><span class="si">{}</span><span class="s2">.pdf&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">scan_number</span><span class="p">),</span>
                <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;pdf&quot;</span><span class="p">,</span>
                <span class="n">transparent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="AssayBatch.save_session"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.AssayBatch.save_session">[docs]</a>    <span class="k">def</span> <span class="nf">save_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Method to save the current assay analysis session to disk.</span>

<span class="sd">            The data can be reloaded using the AssayBatch.load_session</span>
<span class="sd">            class method.</span>

<span class="sd">            parameters:</span>
<span class="sd">            ---------------</span>
<span class="sd">            filepath - path to save the data to. By default, the path will</span>
<span class="sd">                       be the experiment ID.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filepath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="s2">&quot;./assays/</span><span class="si">{}</span><span class="s2">-assay-analysis.dat&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">exp_id</span><span class="p">)</span>
        <span class="n">routines</span><span class="o">.</span><span class="n">save_obj</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Saved session to </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">filepath</span><span class="p">))</span></div></div>


<div class="viewcode-block" id="predict_prolate_series"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.predict_prolate_series">[docs]</a><span class="k">def</span> <span class="nf">predict_prolate_series</span><span class="p">(</span><span class="n">progressions</span><span class="p">,</span> <span class="n">J_thres</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
    <span class="n">fit_df</span><span class="p">,</span> <span class="n">fits</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">harmonic_fitter</span><span class="p">(</span><span class="n">progressions</span><span class="p">,</span> <span class="n">J_thres</span><span class="p">)</span>
    <span class="n">J_model</span> <span class="o">=</span> <span class="n">LinearModel</span><span class="p">()</span>
    <span class="n">BJ_model</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">BJModel</span><span class="p">()</span>
    <span class="n">predictions</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">fit_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
        <span class="n">J_values</span> <span class="o">=</span> <span class="n">row</span><span class="p">[[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="k">if</span> <span class="s2">&quot;J&quot;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">col</span><span class="p">)]]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">J_values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">J_fit</span> <span class="o">=</span> <span class="n">J_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">J_values</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">J_values</span><span class="p">)))</span>
            <span class="n">J_predicted</span> <span class="o">=</span> <span class="n">J_fit</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            <span class="n">BJ_params</span> <span class="o">=</span> <span class="n">row</span><span class="p">[[</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">freq_predicted</span> <span class="o">=</span> <span class="n">BJ_model</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span>
                <span class="n">J</span><span class="o">=</span><span class="n">J_predicted</span><span class="p">,</span> <span class="n">B</span><span class="o">=</span><span class="n">BJ_params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">D</span><span class="o">=</span><span class="n">BJ_params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">J_values</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">frequencies</span> <span class="o">=</span> <span class="n">row</span><span class="p">[[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
            <span class="n">approx_B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">frequencies</span><span class="p">))</span>
            <span class="n">next_freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">frequencies</span><span class="p">)</span> <span class="o">+</span> <span class="n">approx_B</span>
            <span class="n">low_freq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">frequencies</span><span class="p">)</span> <span class="o">-</span> <span class="n">approx_B</span>
            <span class="n">freq_predicted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                <span class="p">(</span><span class="n">frequencies</span><span class="p">,</span> <span class="p">[</span><span class="n">next_freq</span><span class="p">,</span> <span class="n">low_freq</span><span class="p">]),</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span>
            <span class="p">)</span>
            <span class="n">freq_predicted</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">freq_predicted</span><span class="p">)</span>
            <span class="n">J_predicted</span> <span class="o">=</span> <span class="n">freq_predicted</span> <span class="o">/</span> <span class="n">approx_B</span>
        <span class="c1"># Filter out negative frequencies</span>
        <span class="n">freq_predicted</span> <span class="o">=</span> <span class="n">freq_predicted</span><span class="p">[</span><span class="mf">0.0</span> <span class="o">&lt;</span> <span class="n">freq_predicted</span><span class="p">]</span>
        <span class="n">predictions</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;predicted_freq&quot;</span><span class="p">:</span> <span class="n">freq_predicted</span><span class="p">,</span>
            <span class="s2">&quot;predicted_J&quot;</span><span class="p">:</span> <span class="n">J_predicted</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="k">return</span> <span class="n">predictions</span></div>


<div class="viewcode-block" id="BlackchirpExperiment"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.BlackchirpExperiment">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">BlackchirpExperiment</span><span class="p">:</span>
    <span class="n">exp_id</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">fid_start</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">fid_end</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="n">ft_min</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">ft_max</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">40000.0</span>
    <span class="n">ft_filter</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;boxcar&quot;</span>
    <span class="n">freq_offset</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">fids</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">header</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

<div class="viewcode-block" id="BlackchirpExperiment.from_dir"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.BlackchirpExperiment.from_dir">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dir</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="n">exp_id</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">fids</span><span class="p">,</span> <span class="n">timedata</span> <span class="o">=</span> <span class="n">parsers</span><span class="o">.</span><span class="n">parse_blackchirp</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="n">exp_obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">exp_id</span><span class="o">=</span><span class="n">exp_id</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">header</span><span class="p">,</span> <span class="n">fids</span><span class="o">=</span><span class="n">fids</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">exp_obj</span></div>

<div class="viewcode-block" id="BlackchirpExperiment.process_ffts"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.BlackchirpExperiment.process_ffts">[docs]</a>    <span class="k">def</span> <span class="nf">process_ffts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">weighting</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Batch perform FFTs on all of the FIDs. The end result is a Pandas DataFrame with the Frequency and Intensity</span>
<span class="sd">        data, where the intensity is just the weighted co-average of all the FFTs. By default, every FID is equally</span>
<span class="sd">        weighted. </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        weighting</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">weight_factors</span> <span class="o">=</span> <span class="p">{</span><span class="n">index</span><span class="p">:</span> <span class="mf">1.0</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fids</span><span class="p">))}</span>
        <span class="k">if</span> <span class="n">weighting</span><span class="p">:</span>
            <span class="n">weight_factors</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">weighting</span><span class="p">)</span>
        <span class="c1"># Work out the frequency bins</span>
        <span class="n">frequency</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">determine_frequencies</span><span class="p">()</span>
        <span class="c1"># Weight the FIDs</span>
        <span class="n">weighted_fids</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fids</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">weight</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">weight_factors</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
        <span class="p">]</span>
        <span class="n">averaged</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weighted_fids</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
            <span class="p">[</span><span class="n">weight</span> <span class="k">for</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">weight_factors</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
        <span class="p">)</span>
        <span class="c1"># Calculate the sample rate; inverse of the spacing, converted back to seconds</span>
        <span class="n">rate</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;spacing&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e6</span>
        <span class="n">fid2fft</span><span class="p">(</span><span class="n">averaged</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">frequency</span><span class="p">)</span>

        <span class="n">spectrum_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">{</span><span class="s2">&quot;Frequency&quot;</span><span class="p">:</span> <span class="n">fft_data</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq_offset</span><span class="p">,</span> <span class="s2">&quot;Intensity&quot;</span><span class="p">:</span> <span class="n">averaged</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectrum</span> <span class="o">=</span> <span class="n">spectrum_df</span>
        <span class="k">return</span> <span class="n">spectrum_df</span></div></div>


<div class="viewcode-block" id="BlackChirpFid"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.BlackChirpFid">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">BlackChirpFid</span><span class="p">:</span>
    <span class="n">xy_data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span>
    <span class="n">header</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>

<div class="viewcode-block" id="BlackChirpFid.from_binary"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.BlackChirpFid.from_binary">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_binary</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a BlackChirp FID object from a binary BlackChirp FID file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath - str</span>
<span class="sd">            Filepath to the BlackChirp .fid file</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        BlackChirpFid object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">param_dict</span><span class="p">,</span> <span class="n">xy_data</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">parsers</span><span class="o">.</span><span class="n">read_binary_fid</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="n">fid_obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">xy_data</span><span class="p">,</span> <span class="n">param_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fid_obj</span></div>

<div class="viewcode-block" id="BlackChirpFid.to_pickle"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.BlackChirpFid.to_pickle">[docs]</a>    <span class="k">def</span> <span class="nf">to_pickle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save the Blackchirp FID to a pickle file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath - str</span>
<span class="sd">            Filepath to save the FID to</span>
<span class="sd">        kwargs - dict-like</span>
<span class="sd">            Additional keyword arguments that are passed to the</span>
<span class="sd">            pickle function.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">routines</span><span class="o">.</span><span class="n">save_obj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="BlackChirpFid.perform_fft"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.BlackChirpFid.perform_fft">[docs]</a>    <span class="k">def</span> <span class="nf">perform_fft</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">stop</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="s2">&quot;boxcar&quot;</span><span class="p">,</span> <span class="n">f_min</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">f_max</span><span class="o">=</span><span class="mf">30000.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Perform an FFT on the current FID to get the frequency domain spectrum.</span>
<span class="sd">        All of the arguments are optional, and provide control over how the FFT is performed, as well as post-processing</span>
<span class="sd">        parameters like window functions and zero-padding.</span>

<span class="sd">        This is based on the FFT code by Kyle Crabtree, with modifications to fit this dataclass.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        start - int, optional</span>
<span class="sd">            Starting index for the FID array to perform the FFT</span>
<span class="sd">        stop - int, optional</span>
<span class="sd">            End index for the FID array to perform the FFT</span>
<span class="sd">        zpf - int, optional</span>
<span class="sd">            Pad the FID with zeros to nth nearest power of 2</span>
<span class="sd">        window - str</span>
<span class="sd">            Specify the window function used to process the FID. Defaults to boxcar, which is effectively no filtering.</span>
<span class="sd">            The names of the window functions available can be found at:</span>
<span class="sd">            https://docs.scipy.org/doc/scipy/reference/signal.windows.html</span>
<span class="sd">        f_min - float</span>
<span class="sd">            Specify the minimum frequency in the spectrum; everything below this value is set to zero</span>
<span class="sd">        f_max - float</span>
<span class="sd">            Specify the maximum frequency in the spectrum; everything above this value is set to zero</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xy_data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">window</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">window</span> <span class="ow">in</span> <span class="n">spsig</span><span class="o">.</span><span class="n">windows</span><span class="o">.</span><span class="n">__all__</span><span class="p">:</span>
            <span class="n">window_f</span> <span class="o">=</span> <span class="n">spsig</span><span class="o">.</span><span class="n">windows</span><span class="o">.</span><span class="n">get_window</span><span class="p">(</span><span class="n">window</span><span class="p">,</span> <span class="n">fid</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="n">fid</span> <span class="o">*=</span> <span class="n">window_f</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Specified window function is not implemented in SciPy!&quot;</span><span class="p">)</span>
        <span class="c1"># Set values to zero up to starting index</span>
        <span class="n">fid</span><span class="p">[:</span><span class="n">start</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">if</span> <span class="n">stop</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># If we&#39;re using negative indexes</span>
            <span class="n">fid</span><span class="p">[</span><span class="n">fid</span><span class="o">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">stop</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Otherwise, index with a positive number</span>
            <span class="n">fid</span><span class="p">[</span><span class="n">stop</span><span class="p">:]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="c1"># Perform the FFT</span>
        <span class="n">fft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">rfft</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span>
        <span class="n">read_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">df</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">fid</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;spacing&quot;</span><span class="p">]</span>
        <span class="c1"># Generate the frequency array</span>
        <span class="n">frequency</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;sideband&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">,</span> <span class="n">read_length</span><span class="p">)</span>
        <span class="n">frequency</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;probe_freq&quot;</span><span class="p">]</span>
        <span class="n">fft</span><span class="p">[(</span><span class="n">frequency</span> <span class="o">&gt;=</span> <span class="n">f_max</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">frequency</span> <span class="o">&lt;=</span> <span class="n">f_min</span><span class="p">)]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">fft</span> <span class="o">*=</span> <span class="mf">1000.0</span>
        <span class="k">return</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">fft</span></div>

<div class="viewcode-block" id="BlackChirpFid.determine_frequencies"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.ftmw_analysis.BlackChirpFid.determine_frequencies">[docs]</a>    <span class="k">def</span> <span class="nf">determine_frequencies</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the frequency bins for the FFT.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        frequency - numpy 1D array</span>
<span class="sd">            Array containing the frequency bins (x values)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xy_data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">fid</span><span class="o">.</span><span class="n">size</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;spacing&quot;</span><span class="p">]</span>
        <span class="n">read_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fid</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="c1"># Generate the frequency array</span>
        <span class="n">frequency</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;sideband&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">df</span><span class="p">,</span> <span class="n">read_length</span><span class="p">)</span>
        <span class="n">frequency</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="s2">&quot;probe_freq&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">frequency</span></div></div>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2017—2020, Kelvin Lee.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.0.3.<br/>
    </p>
  </div>
</footer>
  </body>
</html>