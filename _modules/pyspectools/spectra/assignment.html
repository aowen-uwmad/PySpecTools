<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pyspectools.spectra.assignment &#8212; PySpecTools 4.4.0 documentation</title>
    <link rel="stylesheet" href="../../../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/language_data.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">
<script type="text/javascript" src="../../../_static/js/jquery-1.11.0.min.js "></script>
<script type="text/javascript" src="../../../_static/js/jquery-fix.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-3.3.7/js/bootstrap.min.js "></script>
<script type="text/javascript" src="../../../_static/bootstrap-sphinx.js "></script>

  </head><body>

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../../../index.html">
          PySpecTools</a>
        <span class="navbar-text navbar-version pull-left"><b></b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../../../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../faq.html">PySpecTools FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../examples.html">Example Notebooks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../pyspectools.spectra.html"><cite>Spectra</cite> Module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api.html">API Reference</a></li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"></ul>
</li>
              
            
            
              
                
              
            
            
            
            
              <li class="hidden-sm"></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../../../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="body col-md-12 content" role="main">
      
  <h1>Source code for pyspectools.spectra.assignment</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    `assignment` module</span>

<span class="sd">    This module contains three main classes for performing analysis of broad-</span>
<span class="sd">    band spectra. The `AssignmentSession` class will be what the user will</span>
<span class="sd">    mainly interact with, which will digest a spectrum, find peaks, make</span>
<span class="sd">    assignments and keep track of them, and generate the reports at the end.</span>

<span class="sd">    To perform the assignments, the user can use the `LineList` class, which</span>
<span class="sd">    does the grunt work of homogenizing the different sources of frequency</span>
<span class="sd">    and molecular information: it is able to take SPCAT and .lin formats, as</span>
<span class="sd">    well as simply a list of frequencies. `LineList` then interacts with the</span>
<span class="sd">    `AssignmentSession` class, which handles the assignments.</span>

<span class="sd">    The smallest building block in this procedure is the `Transition` class;</span>
<span class="sd">    every peak, every molecule transition, every artifact is considered as</span>
<span class="sd">    a `Transition` object. The `LineList` contains a list of `Transition`s,</span>
<span class="sd">    and the peaks found by the `AssignmentSession` are also kept as a </span>
<span class="sd">    `LineList`.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">rmtree</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Type</span><span class="p">,</span> <span class="n">Any</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span><span class="p">,</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">combinations</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">tqdm.autonotebook</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">lmfit.models</span> <span class="kn">import</span> <span class="n">GaussianModel</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">HTML</span>
<span class="kn">from</span> <span class="nn">periodictable</span> <span class="kn">import</span> <span class="n">formula</span>
<span class="kn">from</span> <span class="nn">plotly.offline</span> <span class="kn">import</span> <span class="n">plot</span>
<span class="kn">from</span> <span class="nn">plotly</span> <span class="kn">import</span> <span class="n">graph_objs</span> <span class="k">as</span> <span class="n">go</span>
<span class="kn">from</span> <span class="nn">uncertainties</span> <span class="kn">import</span> <span class="n">ufloat</span>
<span class="kn">from</span> <span class="nn">jinja2</span> <span class="kn">import</span> <span class="n">Template</span>
<span class="kn">from</span> <span class="nn">monsterurl</span> <span class="kn">import</span> <span class="n">get_monster</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage.filters</span> <span class="kn">import</span> <span class="n">gaussian_filter</span>

<span class="kn">from</span> <span class="nn">pyspectools</span> <span class="kn">import</span> <span class="n">routines</span><span class="p">,</span> <span class="n">parsers</span><span class="p">,</span> <span class="n">figurefactory</span>
<span class="kn">from</span> <span class="nn">pyspectools</span> <span class="kn">import</span> <span class="n">ftmw_analysis</span> <span class="k">as</span> <span class="n">fa</span>
<span class="kn">from</span> <span class="nn">pyspectools</span> <span class="kn">import</span> <span class="n">fitting</span>
<span class="kn">from</span> <span class="nn">pyspectools</span> <span class="kn">import</span> <span class="n">units</span>
<span class="kn">from</span> <span class="nn">pyspectools</span> <span class="kn">import</span> <span class="n">database</span>
<span class="kn">from</span> <span class="nn">pyspectools.astro</span> <span class="kn">import</span> <span class="n">analysis</span> <span class="k">as</span> <span class="n">aa</span>
<span class="kn">from</span> <span class="nn">pyspectools.spectra</span> <span class="kn">import</span> <span class="n">analysis</span>


<div class="viewcode-block" id="Transition"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.Transition">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Transition</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        DataClass for handling assignments.</span>
<span class="sd">        Attributes are assigned in order to be sufficiently informative for a</span>
<span class="sd">        line assignment to be unambiguous and reproduce it later in a form</span>
<span class="sd">        that is both machine and human readable.</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            IUPAC/common name; the former is preferred to be unambiguous</span>
<span class="sd">        formula : str</span>
<span class="sd">            Chemical formula, or usually the stochiometry</span>
<span class="sd">        smiles : str</span>
<span class="sd">            SMILES code that provides a machine and human readable chemical specification</span>
<span class="sd">        frequency : float</span>
<span class="sd">            Observed frequency in MHz</span>
<span class="sd">        intensity : float</span>
<span class="sd">            Observed intensity, in whatever units the experiments are in. Examples are Jy/beam, or micro volts.</span>
<span class="sd">        catalog_frequency : float</span>
<span class="sd">            Catalog frequency in MHz</span>
<span class="sd">        catalog_intensity : float</span>
<span class="sd">            Catalog line intensity, typically in SPCAT units</span>
<span class="sd">        S : float</span>
<span class="sd">            Theoretical line strength; differs from the catalog line strength as it may be used for intrinsic line</span>
<span class="sd">            strength S u^2</span>
<span class="sd">        peak_id : int</span>
<span class="sd">            Peak id from specific experiment</span>
<span class="sd">        uline : bool</span>
<span class="sd">            Flag to indicate whether line is identified or not</span>
<span class="sd">        composition : list of str</span>
<span class="sd">            A list of atomic symbols specifying what the experimental elemental composition is. Influences which</span>
<span class="sd">            molecules are considered possible in the Splatalogue assignment procedure.</span>
<span class="sd">        v_qnos : list of int</span>
<span class="sd">            Quantum numbers for vibrational modes. Index corresponds to mode, and int value to number of quanta.</span>
<span class="sd">            Length should be equal to 3N-6.</span>
<span class="sd">        r_qnos : str</span>
<span class="sd">            Rotational quantum numbers. TODO - better way of managing rotational quantum numbers</span>
<span class="sd">        experiment : int</span>
<span class="sd">            Experiment ID to use as a prefix/suffix for record keeping</span>
<span class="sd">        weighting : float</span>
<span class="sd">            Value for weighting factor used in the automated assignment</span>
<span class="sd">        fit : dict</span>
<span class="sd">            Contains the fitted parameters and model</span>
<span class="sd">        ustate_energy : float</span>
<span class="sd">            Energy of the upper state in Kelvin</span>
<span class="sd">        lstate_energy: float</span>
<span class="sd">            Energy of the lower state in Kelvin</span>
<span class="sd">        intereference : bool</span>
<span class="sd">            Flag to indicate if this assignment is not molecular in nature</span>
<span class="sd">        source : str</span>
<span class="sd">            Indicates what the source used for this assignment is</span>
<span class="sd">        public : bool</span>
<span class="sd">            Flag to indicate if the information for this assignment is public/published</span>
<span class="sd">        velocity : float</span>
<span class="sd">            Velocity of the source used to make the assignment in km/s</span>
<span class="sd">        discharge : bool</span>
<span class="sd">            Whether or not the line is discharge dependent</span>
<span class="sd">        magnet : bool</span>
<span class="sd">            Whether or not the line is magnet dependent (i.e. open shell)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">smiles</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">formula</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">frequency</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">catalog_frequency</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">catalog_intensity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">deviation</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">intensity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">uncertainty</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">S</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">peak_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">experiment</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">uline</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">composition</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">v_qnos</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">r_qnos</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">fit</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">ustate_energy</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">lstate_energy</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">interference</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">weighting</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Catalog&quot;</span>
    <span class="n">public</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">velocity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">discharge</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">magnet</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">multiple</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">final</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Dunder method for comparing molecules.</span>
<span class="sd">            This method is simply a shortcut to see if</span>
<span class="sd">            two molecules are the same based on their</span>
<span class="sd">            SMILES code, the chemical name, and frequency.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">Transition</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">comparisons</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">smiles</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">smiles</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">v_qnos</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">v_qnos</span><span class="p">,</span>
            <span class="p">]</span>
            <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">comparisons</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dunder method for representing an Transition, which returns</span>
<span class="sd">        the name of the line and the frequency.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            name and frequency of the Transition</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uline</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">frequency</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">frequency</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog_frequency</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">frequency</span><span class="si">:</span><span class="s2">,.4f</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uline</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">frequency</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">frequency</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog_frequency</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">frequency</span><span class="si">:</span><span class="s2">,.4f</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="fm">__lt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="n">other</span><span class="o">.</span><span class="n">frequency</span>

    <span class="k">def</span> <span class="fm">__gt__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span> <span class="o">&gt;</span> <span class="n">other</span><span class="o">.</span><span class="n">frequency</span>

<div class="viewcode-block" id="Transition.check_molecule"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.Transition.check_molecule">[docs]</a>    <span class="k">def</span> <span class="nf">check_molecule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        Check equivalency based on a common carrier. Compares the</span>
<span class="sd">        name, formula, and smiles of this `Transition` object with</span>
<span class="sd">        another.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if the two `Transitions` belong to the same carrier.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">==</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">formula</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">formula</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">smiles</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">smiles</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Transition.calc_intensity"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.Transition.calc_intensity">[docs]</a>    <span class="k">def</span> <span class="nf">calc_intensity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Q</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mf">300.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert linestrength into intensity.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Q - float</span>
<span class="sd">            Partition function for the molecule at temperature T</span>
<span class="sd">        T - float</span>
<span class="sd">            Temperature to calculate the intensity at in Kelvin</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        I - float</span>
<span class="sd">            log10 of the intensity in SPCAT format</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Take the frequency value to calculate I</span>
        <span class="n">frequency</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog_frequency</span><span class="p">])</span>
        <span class="n">I</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">S2I</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">intensity</span><span class="p">,</span>
            <span class="n">Q</span><span class="p">,</span>
            <span class="n">frequency</span><span class="p">,</span>
            <span class="n">units</span><span class="o">.</span><span class="n">calc_E_lower</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ustate_energy</span><span class="p">),</span>
            <span class="n">T</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">S</span> <span class="o">=</span> <span class="n">I</span>
        <span class="k">return</span> <span class="n">I</span></div>

<div class="viewcode-block" id="Transition.calc_linestrength"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.Transition.calc_linestrength">[docs]</a>    <span class="k">def</span> <span class="nf">calc_linestrength</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Q</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="mf">300.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert intensity into linestrength.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Q - float</span>
<span class="sd">            Partition function for the molecule at temperature T</span>
<span class="sd">        T - float</span>
<span class="sd">            Temperature to calculate the intensity at in Kelvin</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        intensity - float</span>
<span class="sd">            intrinsic linestrength of the transition</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Take the frequency value to calculate I</span>
        <span class="n">frequency</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">catalog_frequency</span><span class="p">])</span>
        <span class="n">intensity</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">I2S</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">S</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">units</span><span class="o">.</span><span class="n">calc_E_lower</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ustate_energy</span><span class="p">),</span> <span class="n">T</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">intensity</span> <span class="o">=</span> <span class="n">intensity</span>
        <span class="k">return</span> <span class="n">intensity</span></div>

<div class="viewcode-block" id="Transition.to_file"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.Transition.to_file">[docs]</a>    <span class="k">def</span> <span class="nf">to_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;yaml&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Save an Transition object to disk with a specified file format.</span>
<span class="sd">        Defaults to YAML.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath : str</span>
<span class="sd">            Path to yaml file</span>
<span class="sd">        format : str, optional</span>
<span class="sd">            Denoting the syntax used for dumping. Defaults to YAML.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filepath</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span><span class="p">:</span>
                <span class="n">filepath</span> <span class="o">+=</span> <span class="s2">&quot;.json&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">filepath</span> <span class="o">+=</span> <span class="s2">&quot;.yml&quot;</span>
        <span class="k">if</span> <span class="nb">format</span> <span class="o">==</span> <span class="s2">&quot;json&quot;</span><span class="p">:</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">routines</span><span class="o">.</span><span class="n">dump_json</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">writer</span> <span class="o">=</span> <span class="n">routines</span><span class="o">.</span><span class="n">dump_yaml</span>
        <span class="n">writer</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span></div>

<div class="viewcode-block" id="Transition.get_spectrum"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.Transition.get_spectrum">[docs]</a>    <span class="k">def</span> <span class="nf">get_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a synthetic peak by supplying</span>
<span class="sd">        the x axis for a particular spectrum. This method</span>
<span class="sd">        assumes that some fit parameters have been determined</span>
<span class="sd">        previously.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        x : Numpy 1D array</span>
<span class="sd">            Frequency bins from an experiment to simulate the line features.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Numpy 1D array</span>
<span class="sd">            Values of the model function spectrum at each particular value of x</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;fit&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fit</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;get_spectrum() with no fit data available!&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Transition.from_dict"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.Transition.from_dict">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dict</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">data_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">        Method for generating an Assignment object</span>
<span class="sd">        from a dictionary. All this method does is</span>
<span class="sd">        unpack a dictionary into the __init__ method.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data_dict : dict</span>
<span class="sd">            Dictionary containing all of the Assignment DataClass fields that are to be populated.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Transition</span>
<span class="sd">            Converted Assignment object from the input dictionary</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">assignment_obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">data_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">assignment_obj</span></div>

<div class="viewcode-block" id="Transition.from_yml"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.Transition.from_yml">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_yml</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">yaml_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method for initializing an Assignment object from a YAML file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        yaml_path : str</span>
<span class="sd">            path to yaml file</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Transition</span>
<span class="sd">            Assignment object loaded from a YAML file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">yaml_dict</span> <span class="o">=</span> <span class="n">routines</span><span class="o">.</span><span class="n">read_yaml</span><span class="p">(</span><span class="n">yaml_path</span><span class="p">)</span>
        <span class="n">assignment_obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">yaml_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">assignment_obj</span></div>

<div class="viewcode-block" id="Transition.from_json"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.Transition.from_json">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_json</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">json_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method for initializing an Assignment object from a JSON file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        json_path : str</span>
<span class="sd">            Path to JSON file</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Transition</span>
<span class="sd">            Assignment object loaded from a JSON file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">json_dict</span> <span class="o">=</span> <span class="n">routines</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="n">json_path</span><span class="p">)</span>
        <span class="n">assignment_obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">json_dict</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">assignment_obj</span></div>

<div class="viewcode-block" id="Transition.reset_assignment"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.Transition.reset_assignment">[docs]</a>    <span class="k">def</span> <span class="nf">reset_assignment</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to reset an assigned line into its original state.</span>
<span class="sd">        The only information that is kept regards to the frequency,</span>
<span class="sd">        intensity, and aspects about the experiment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">remain</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;frequency&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span>
            <span class="s2">&quot;intensity&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity</span><span class="p">,</span>
            <span class="s2">&quot;experiment&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="p">,</span>
            <span class="s2">&quot;velocity&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">velocity</span><span class="p">,</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">empty</span> <span class="o">=</span> <span class="n">Transition</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">empty</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">remain</span><span class="p">)</span></div>

<div class="viewcode-block" id="Transition.choose_assignment"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.Transition.choose_assignment">[docs]</a>    <span class="k">def</span> <span class="nf">choose_assignment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to manually pick an assignment from</span>
<span class="sd">        a list of multiple possible assignments found</span>
<span class="sd">        during `process_linelist`. After the new assignment</span>
<span class="sd">        is copied over, the `final` attribute is set to</span>
<span class="sd">        True and will no longer throw a warning duiring</span>
<span class="sd">        finalize_assignments.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index : int</span>
<span class="sd">            Index of the candidate to use for the assignment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">multiple</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">multiple</span><span class="p">)</span>
        <span class="n">remain</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;frequency&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span>
            <span class="s2">&quot;intensity&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">intensity</span><span class="p">,</span>
            <span class="s2">&quot;experiment&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="p">,</span>
            <span class="s2">&quot;velocity&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">velocity</span><span class="p">,</span>
            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
            <span class="s2">&quot;multiple&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiple</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">chosen</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">multiple</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
        <span class="n">chosen</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">remain</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">chosen</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">final</span> <span class="o">=</span> <span class="kc">True</span></div></div>


<div class="viewcode-block" id="LineList"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.LineList">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">LineList</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class for handling and homogenizing all of the possible line lists: from peaks to assignments to catalog files.</span>

<span class="sd">        Attributes</span>
<span class="sd">        ----------</span>
<span class="sd">        name: str, optional</span>
<span class="sd">            Name of the line list. Can be used to identify the molecule, or to simply state the purpose of the list.</span>
<span class="sd">        formula: str, optional</span>
<span class="sd">            Chemical formula for the molecule, if applicable.</span>
<span class="sd">        smi: str, optional</span>
<span class="sd">            SMILES representation of the molecule, if applicable.</span>
<span class="sd">        filecontents: str, optional</span>
<span class="sd">            String representation of the file contents used to make the line list.</span>
<span class="sd">        filepath: str, optional</span>
<span class="sd">            Path to the file used to make the list.</span>
<span class="sd">        transitions: list, optional</span>
<span class="sd">            A designated list for holding Transition objects. This is the bulk of the information for a given</span>
<span class="sd">            line list.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">formula</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">smi</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">filecontents</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">transitions</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">frequencies</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">catalog_frequencies</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">source</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nentries</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Line list for: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> Formula: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">formula</span><span class="si">}</span><span class="s2">, Number of entries: </span><span class="si">{</span><span class="n">nentries</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">nentries</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Line list name: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">, Number of entries: </span><span class="si">{</span><span class="n">nentries</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">frequency</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">catalog_frequencies</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">catalog_frequency</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span>
            <span class="p">]</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="nb">object</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dunder method for comparison of LineLists. Since users can accidently</span>
<span class="sd">        use different method/formulas yet use the same catalog/lin file to</span>
<span class="sd">        create the LineList, we only perform the check on the list of transitions.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        other : LineList object</span>
<span class="sd">            The other LineList to be used for comparison.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            If True, the two LineList objects are equal.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">LineList</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">NotImplemented</span>
        <span class="c1"># Assert that we&#39;re comparing LineList objects</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">transitions</span>

    <span class="k">def</span> <span class="fm">__add__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transition_obj</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Transition</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dunder method to add Transitions to the LineList.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        transition_obj : [type]</span>
<span class="sd">            [description]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">transition_obj</span><span class="p">)</span> <span class="o">==</span> <span class="n">Transition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Transition</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sets up syntax for looping over a LineList. This is recommended more</span>
<span class="sd">        for users, but not for programming. When writing new code in the</span>
<span class="sd">        module, iterate over the transitions attribute explicitly.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span>

<div class="viewcode-block" id="LineList.from_catalog"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.LineList.from_catalog">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_catalog</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">formula</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">min_freq</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">max_freq</span><span class="o">=</span><span class="mf">1e12</span><span class="p">,</span>
        <span class="n">max_lstate</span><span class="o">=</span><span class="mf">9000.0</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a Line List object from an SPCAT catalog.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name: str</span>
<span class="sd">            Name of the molecule the catalog belongs to</span>
<span class="sd">        formula: str</span>
<span class="sd">            Chemical formula of the molecule</span>
<span class="sd">        filepath: str</span>
<span class="sd">            Path to the catalog file.</span>
<span class="sd">        min_freq: float, optional</span>
<span class="sd">            Minimum frequency in MHz for the frequency cutoff</span>
<span class="sd">        max_freq: float, optional</span>
<span class="sd">            Maximum frequency in MHz for the frequency cutoff</span>
<span class="sd">        max_lstate: float, optional</span>
<span class="sd">            Maximum lower state energy to filter out absurd lines</span>
<span class="sd">        kwargs: optional</span>
<span class="sd">            Additional attributes that are passed into the Transition objects.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        linelist_obj</span>
<span class="sd">            Instance of LineList with the digested catalog.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">catalog_df</span> <span class="o">=</span> <span class="n">parsers</span><span class="o">.</span><span class="n">parse_cat</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">low_freq</span><span class="o">=</span><span class="n">min_freq</span><span class="p">,</span> <span class="n">high_freq</span><span class="o">=</span><span class="n">max_freq</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;N&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;J&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;N&#39;&#39;&quot;</span><span class="p">,</span> <span class="s2">&quot;J&#39;&#39;&quot;</span><span class="p">]</span>
            <span class="n">catalog_df</span><span class="p">[</span><span class="s2">&quot;qno&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">catalog_df</span><span class="p">[</span><span class="n">columns</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="s2">&quot;N&#39;=</span><span class="si">{}</span><span class="s2">, J&#39;=</span><span class="si">{}</span><span class="s2"> - N&#39;&#39;=</span><span class="si">{}</span><span class="s2">, J&#39;&#39;=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">x</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>
            <span class="c1"># Create a formatted quantum number string</span>
            <span class="c1"># catalog_df[&quot;qno&quot;] = &quot;N&#39;={}, J&#39;={} - N&#39;&#39;={}, J&#39;&#39;={}&quot;.format(</span>
            <span class="c1">#    *catalog_df[[&quot;N&#39;&quot;, &quot;J&#39;&quot;, &quot;N&#39;&#39;&quot;, &quot;J&#39;&#39;&quot;]].values</span>
            <span class="c1"># )</span>
            <span class="c1"># Calculate E upper to have a complete set of data</span>
            <span class="n">catalog_df</span><span class="p">[</span><span class="s2">&quot;Upper state energy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">calc_E_upper</span><span class="p">(</span>
                <span class="n">catalog_df</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">],</span> <span class="n">catalog_df</span><span class="p">[</span><span class="s2">&quot;Lower state energy&quot;</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="c1"># Filter out the lower states</span>
            <span class="n">catalog_df</span> <span class="o">=</span> <span class="n">catalog_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">catalog_df</span><span class="p">[</span><span class="s2">&quot;Lower state energy&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_lstate</span><span class="p">]</span>
            <span class="n">vfunc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">Transition</span><span class="p">)</span>
            <span class="c1"># Vectorized generation of all the Transition objects</span>
            <span class="n">transitions</span> <span class="o">=</span> <span class="n">vfunc</span><span class="p">(</span>
                <span class="n">catalog_frequency</span><span class="o">=</span><span class="n">catalog_df</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">],</span>
                <span class="n">catalog_intensity</span><span class="o">=</span><span class="n">catalog_df</span><span class="p">[</span><span class="s2">&quot;Intensity&quot;</span><span class="p">],</span>
                <span class="n">uncertainty</span><span class="o">=</span><span class="n">catalog_df</span><span class="p">[</span><span class="s2">&quot;Uncertainty&quot;</span><span class="p">],</span>
                <span class="n">lstate_energy</span><span class="o">=</span><span class="n">catalog_df</span><span class="p">[</span><span class="s2">&quot;Lower state energy&quot;</span><span class="p">],</span>
                <span class="n">ustate_energy</span><span class="o">=</span><span class="n">catalog_df</span><span class="p">[</span><span class="s2">&quot;Upper state energy&quot;</span><span class="p">],</span>
                <span class="n">r_qnos</span><span class="o">=</span><span class="n">catalog_df</span><span class="p">[</span><span class="s2">&quot;qno&quot;</span><span class="p">],</span>
                <span class="n">source</span><span class="o">=</span><span class="s2">&quot;Catalog&quot;</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
                <span class="n">uline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">linelist_obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
                <span class="n">name</span><span class="p">,</span>
                <span class="n">formula</span><span class="p">,</span>
                <span class="n">filepath</span><span class="o">=</span><span class="n">filepath</span><span class="p">,</span>
                <span class="n">transitions</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">transitions</span><span class="p">),</span>
                <span class="n">source</span><span class="o">=</span><span class="s2">&quot;Catalog&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">linelist_obj</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="LineList.from_dataframe"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.LineList.from_dataframe">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_dataframe</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Peaks&quot;</span><span class="p">,</span>
        <span class="n">freq_col</span><span class="o">=</span><span class="s2">&quot;Frequency&quot;</span><span class="p">,</span>
        <span class="n">int_col</span><span class="o">=</span><span class="s2">&quot;Intensity&quot;</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Specialized class method for creating a LineList object from a Pandas Dataframe. This method is called by</span>
<span class="sd">        the AssignmentSession.df2ulines function to generate a Peaks LineList during peak detection.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dataframe: pandas DataFrame</span>
<span class="sd">            DataFrame containing frequency and intensity information</span>
<span class="sd">        freq_col: str, optional</span>
<span class="sd">            Name of the frequency column</span>
<span class="sd">        int_col: str, optional</span>
<span class="sd">            Name of the intensity column</span>
<span class="sd">        kwargs</span>
<span class="sd">            Optional settings are passed into the creation of Transition objects.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        LineList</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vfunc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">Transition</span><span class="p">)</span>
        <span class="n">transitions</span> <span class="o">=</span> <span class="n">vfunc</span><span class="p">(</span>
            <span class="n">frequency</span><span class="o">=</span><span class="n">dataframe</span><span class="p">[</span><span class="n">freq_col</span><span class="p">],</span>
            <span class="n">intensity</span><span class="o">=</span><span class="n">dataframe</span><span class="p">[</span><span class="n">int_col</span><span class="p">],</span>
            <span class="n">uline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">linelist_obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">transitions</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">transitions</span><span class="p">),</span> <span class="n">source</span><span class="o">=</span><span class="s2">&quot;Peaks&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">linelist_obj</span></div>

<div class="viewcode-block" id="LineList.from_list"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.LineList.from_list">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_list</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">frequencies</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">formula</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generic, low level method for creating a LineList object from a list</span>
<span class="sd">        of frequencies. This method can be used when neither lin, catalog, nor</span>
<span class="sd">        splatalogue is appropriate and you would like to manually create it</span>
<span class="sd">        by handpicked frequencies.</span>

<span class="sd">                    obj.uline == True,</span>
<span class="sd">            Name of the species - doesn&#39;t have to be its real name, just an identifier.</span>
<span class="sd">        frequencies: list</span>
<span class="sd">            A list of floats corresponding to the &quot;catalog&quot; frequencies.</span>
<span class="sd">        formula: str, optional</span>
<span class="sd">            Formula of the species, if known.</span>
<span class="sd">        kwargs</span>
<span class="sd">            Optional settings are passed into the creation of Transition objects.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        LineList</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vfunc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">Transition</span><span class="p">)</span>
        <span class="n">frequencies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">frequencies</span><span class="p">)</span>
        <span class="n">transitions</span> <span class="o">=</span> <span class="n">vfunc</span><span class="p">(</span>
            <span class="n">catalog_frequency</span><span class="o">=</span><span class="n">frequencies</span><span class="p">,</span>
            <span class="n">uline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">linelist_obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">transitions</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">transitions</span><span class="p">),</span> <span class="n">source</span><span class="o">=</span><span class="s2">&quot;Catalog&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">linelist_obj</span></div>

<div class="viewcode-block" id="LineList.from_pgopher"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.LineList.from_pgopher">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_pgopher</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">formula</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to take the output of a PGopher file and create a LineList</span>
<span class="sd">        object. The PGopher output must be in the comma delimited specification.</span>
<span class="sd">        </span>
<span class="sd">        This is actually the ideal way to generate LineList objects: it fills</span>
<span class="sd">        in all of the relevant fields, such as linestrength and state energies.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of the molecule</span>
<span class="sd">        filepath : str</span>
<span class="sd">            Path to the PGopher CSV output</span>
<span class="sd">        formula : str, optional</span>
<span class="sd">            Chemical formula of the molecule, defaults to an empty string.</span>
<span class="sd">            </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        LineList</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pgopher_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pgopher_df</span> <span class="o">=</span> <span class="n">pgopher_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">vfunc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">Transition</span><span class="p">)</span>
        <span class="n">transitions</span> <span class="o">=</span> <span class="n">vfunc</span><span class="p">(</span>
            <span class="n">catalog_frequency</span><span class="o">=</span><span class="n">pgopher_df</span><span class="p">[</span><span class="s2">&quot;Position&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span>
            <span class="n">catalog_intensity</span><span class="o">=</span><span class="n">pgopher_df</span><span class="p">[</span><span class="s2">&quot;Intensity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">),</span>
            <span class="n">ustate_energy</span><span class="o">=</span><span class="n">pgopher_df</span><span class="p">[</span><span class="s2">&quot;Eupper&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">MHz2cm</span><span class="p">),</span>
            <span class="n">lstate_energy</span><span class="o">=</span><span class="n">pgopher_df</span><span class="p">[</span><span class="s2">&quot;Elower&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">MHz2cm</span><span class="p">),</span>
            <span class="n">S</span><span class="o">=</span><span class="n">pgopher_df</span><span class="p">[</span><span class="s2">&quot;Spol&quot;</span><span class="p">],</span>
            <span class="n">uline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">linelist_obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">transitions</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">transitions</span><span class="p">),</span> <span class="n">source</span><span class="o">=</span><span class="s2">&quot;Catalog&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="LineList.from_lin"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.LineList.from_lin">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_lin</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">formula</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a LineList object from a .lin file. This method should be used for intermediate assignments, when one</span>
<span class="sd">        does not know what the identity of a molecule is but has measured some frequency data.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of the molecule</span>
<span class="sd">        filepath : str</span>
<span class="sd">            File path to the .lin file.</span>
<span class="sd">        formula : str, optional</span>
<span class="sd">            Chemical formula of the molecule if known.</span>
<span class="sd">        kwargs</span>
<span class="sd">            Additional kwargs are passed into the Transition objects.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        LineList</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lin_df</span> <span class="o">=</span> <span class="n">parsers</span><span class="o">.</span><span class="n">parse_lin</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="n">vfunc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">Transition</span><span class="p">)</span>
        <span class="n">transitions</span> <span class="o">=</span> <span class="n">vfunc</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
            <span class="n">catalog_frequency</span><span class="o">=</span><span class="n">lin_df</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">],</span>
            <span class="n">uncertainty</span><span class="o">=</span><span class="n">lin_df</span><span class="p">[</span><span class="s2">&quot;Uncertainty&quot;</span><span class="p">],</span>
            <span class="n">r_qnos</span><span class="o">=</span><span class="n">lin_df</span><span class="p">[</span><span class="s2">&quot;Quantum numbers&quot;</span><span class="p">],</span>
            <span class="n">uline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">source</span><span class="o">=</span><span class="s2">&quot;Line file&quot;</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">linelist_obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">formula</span><span class="p">,</span>
            <span class="n">filepath</span><span class="o">=</span><span class="n">filepath</span><span class="p">,</span>
            <span class="n">transitions</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">transitions</span><span class="p">),</span>
            <span class="n">source</span><span class="o">=</span><span class="s2">&quot;Line file&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">linelist_obj</span></div>

<div class="viewcode-block" id="LineList.from_splatalogue_query"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.LineList.from_splatalogue_query">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_splatalogue_query</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method for converting a Splatalogue query dataframe into a LineList</span>
<span class="sd">        object. This is designed with the intention of pre-querying a set</span>
<span class="sd">        of molecules ahead of time, so that the user can have direct control</span>
<span class="sd">        over which molecules are specifically targeted without having to</span>
<span class="sd">        generate specific catalog files.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dataframe : pandas DataFrame</span>
<span class="sd">            DataFrame generated by the function `analysis.search_molecule`</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        LineList</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vfunc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">Transition</span><span class="p">)</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Chemical Name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">transitions</span> <span class="o">=</span> <span class="n">vfunc</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Chemical Name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">catalog_frequency</span><span class="o">=</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">catalog_intensity</span><span class="o">=</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;CDMS/JPL Intensity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">ustate_energy</span><span class="o">=</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;E_U (K)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">formula</span><span class="o">=</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Species&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">r_qnos</span><span class="o">=</span><span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Resolved QNs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
            <span class="n">uline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">source</span><span class="o">=</span><span class="s2">&quot;Splatalogue&quot;</span><span class="p">,</span>
            <span class="n">public</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">linelist_obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">transitions</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">transitions</span><span class="p">),</span> <span class="n">source</span><span class="o">=</span><span class="s2">&quot;Splatalogue&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">linelist_obj</span></div>

<div class="viewcode-block" id="LineList.from_artifacts"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.LineList.from_artifacts">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_artifacts</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">frequencies</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Specialized class method for creating a LineList object specifically for artifacts/RFI. These Transitions are</span>
<span class="sd">        specially flagged as Artifacts.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        frequencies: iterable of floats</span>
<span class="sd">            List or array of floats corresponding to known artifact frequencies.</span>
<span class="sd">        kwargs</span>
<span class="sd">            Kwargs are passed into the Transition object creation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        LineList</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">vfunc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">Transition</span><span class="p">)</span>
        <span class="n">transitions</span> <span class="o">=</span> <span class="n">vfunc</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Artifact&quot;</span><span class="p">,</span>
            <span class="n">catalog_frequency</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">frequencies</span><span class="p">),</span>
            <span class="n">uline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">source</span><span class="o">=</span><span class="s2">&quot;Artifact&quot;</span><span class="p">,</span>
            <span class="n">public</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">linelist_obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Artifacts&quot;</span><span class="p">,</span> <span class="n">transitions</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">transitions</span><span class="p">),</span> <span class="n">source</span><span class="o">=</span><span class="s2">&quot;Artifacts&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">linelist_obj</span></div>

<div class="viewcode-block" id="LineList.from_clock"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.LineList.from_clock">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_clock</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">max_multi</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">clock</span><span class="o">=</span><span class="mf">65000.0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method of generating a LineList object by calculating all possible</span>
<span class="sd">        combinations of the</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        max_multi : int, optional</span>
<span class="sd">            [description], by default 64</span>
<span class="sd">        </span>
<span class="sd">        clock : float, optional</span>
<span class="sd">            Clock frequency to calculate sub-harmonics of,</span>
<span class="sd">            in units of MHz. Defaults to 65,000 MHz, which corresponds</span>
<span class="sd">            to the Keysight AWG</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        LineList object</span>
<span class="sd">            LineList object with the full list of possible clock</span>
<span class="sd">            spurs, as harmonics, sum, and difference frequencies.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">frequencies</span> <span class="o">=</span> <span class="p">[</span><span class="n">clock</span> <span class="o">/</span> <span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">max_multi</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">(</span><span class="n">frequencies</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="c1"># Round to 4 decimal places</span>
            <span class="n">frequencies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="nb">sum</span><span class="p">(</span><span class="n">pair</span><span class="p">),</span> <span class="mi">4</span><span class="p">))</span>
            <span class="n">frequencies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">4</span><span class="p">))</span>
        <span class="c1"># Remove duplicates</span>
        <span class="n">frequencies</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">frequencies</span><span class="p">))</span>
        <span class="n">frequencies</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">frequencies</span><span class="p">)</span>
        <span class="c1"># Generate Transition objects from this list of frequencies</span>
        <span class="n">vfunc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">Transition</span><span class="p">)</span>
        <span class="n">transitions</span> <span class="o">=</span> <span class="n">vfunc</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Artifact&quot;</span><span class="p">,</span>
            <span class="n">catalog_frequency</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">frequencies</span><span class="p">),</span>
            <span class="n">uline</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">source</span><span class="o">=</span><span class="s2">&quot;Artifact&quot;</span><span class="p">,</span>
            <span class="n">public</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">linelist_obj</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ClockSpurs&quot;</span><span class="p">,</span> <span class="n">transitions</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="n">transitions</span><span class="p">),</span> <span class="n">source</span><span class="o">=</span><span class="s2">&quot;Artifacts&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">linelist_obj</span></div>

<div class="viewcode-block" id="LineList.to_dataframe"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.LineList.to_dataframe">[docs]</a>    <span class="k">def</span> <span class="nf">to_dataframe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Convert the transition data into a Pandas DataFrame.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dataframe</span>
<span class="sd">            Pandas Dataframe with all of the transitions in the line list.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">list_rep</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="vm">__dict__</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">list_rep</span><span class="p">)</span></div>

<div class="viewcode-block" id="LineList.to_ftb"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.LineList.to_ftb">[docs]</a>    <span class="k">def</span> <span class="nf">to_ftb</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">thres</span><span class="o">=-</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">shots</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">dipole</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to create an FTB file from a LineList object. This will</span>
<span class="sd">        create entries for every transition entry above a certain intensity</span>
<span class="sd">        threshold, in whatever units the intensities are in; i.e. SPCAT will</span>
<span class="sd">        be in log units, while experimental peaks will be in whatever arbitrary</span>
<span class="sd">        voltage scale.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath: None or str, optional</span>
<span class="sd">            Path to write the ftb file to. If None (default), uses the name of</span>
<span class="sd">            the LineList and writes to the ftb folder.</span>
<span class="sd">        thres: float, optional</span>
<span class="sd">            Threshold to cutoff transitions in the ftb file. Transitions with</span>
<span class="sd">            less intensity than this value not be included. Units are in the</span>
<span class="sd">            same units as whatever the LineList units are.</span>
<span class="sd">        shots: int, optional</span>
<span class="sd">            Number of shots to integrate.</span>
<span class="sd">        dipole: float, optional</span>
<span class="sd">            Target dipole moment for the species</span>
<span class="sd">        kwargs</span>
<span class="sd">            Additional kwargs are passed into the ftb creation, e.g. magnet,</span>
<span class="sd">            discharge, etc.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If no path is given, use the default naming scheme.</span>
        <span class="k">if</span> <span class="n">filepath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ftb/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">-batch.ftb&quot;</span>
        <span class="c1"># If the source of information are from experimentally measured peaks,</span>
        <span class="c1"># we&#39;ll use the correct attributes.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="s2">&quot;Peaks&quot;</span><span class="p">:</span>
            <span class="n">freq_attr</span> <span class="o">=</span> <span class="s2">&quot;frequency&quot;</span>
            <span class="n">int_attr</span> <span class="o">=</span> <span class="s2">&quot;intensity&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">freq_attr</span> <span class="o">=</span> <span class="s2">&quot;catalog_frequency&quot;</span>
            <span class="n">int_attr</span> <span class="o">=</span> <span class="s2">&quot;catalog_intensity&quot;</span>
        <span class="c1"># Get all the frequencies that have intensities above a threshold</span>
        <span class="n">frequencies</span> <span class="o">=</span> <span class="p">[</span>
            <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">freq_attr</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span>
            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">int_attr</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">thres</span>
        <span class="p">]</span>
        <span class="n">ftb_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;dipole&quot;</span><span class="p">:</span> <span class="n">dipole</span><span class="p">}</span>
        <span class="n">ftb_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ftb_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># Loop over the frequencies</span>
        <span class="k">for</span> <span class="n">frequency</span> <span class="ow">in</span> <span class="n">frequencies</span><span class="p">:</span>
            <span class="n">ftb_str</span> <span class="o">+=</span> <span class="n">fa</span><span class="o">.</span><span class="n">generate_ftb_line</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span> <span class="n">shots</span><span class="o">=</span><span class="n">shots</span><span class="p">,</span> <span class="o">**</span><span class="n">ftb_kwargs</span>
            <span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">write_file</span><span class="p">:</span>
            <span class="n">write_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">ftb_str</span><span class="p">)</span></div>

<div class="viewcode-block" id="LineList.to_pickle"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.LineList.to_pickle">[docs]</a>    <span class="k">def</span> <span class="nf">to_pickle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to serialize the LineList to a Pickle file. If no filepath is provided, the function will default</span>
<span class="sd">        to using the name attribute of the LineList to name the file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath: str or None, optional</span>
<span class="sd">            If None, uses name attribute for the filename, and saves to the linelists folder.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filepath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="s2">&quot;linelists/</span><span class="si">{}</span><span class="s2">-linelist.pkl&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="n">routines</span><span class="o">.</span><span class="n">save_obj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)</span></div>

<div class="viewcode-block" id="LineList.find_nearest"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.LineList.find_nearest">[docs]</a>    <span class="k">def</span> <span class="nf">find_nearest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frequency</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Look up transitions to find the nearest in frequency to the query. If the matched frequency is within a</span>
<span class="sd">        tolerance, then the function will return the corresponding Transition. Otherwise, it returns None.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        frequency: float</span>
<span class="sd">            Frequency in MHz to search for.</span>
<span class="sd">        tol: float, optional</span>
<span class="sd">            Maximum tolerance for the deviation from the LineList frequency and query frequency</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Transition object or None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">match_freq</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">routines</span><span class="o">.</span><span class="n">find_nearest</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span><span class="p">,</span> <span class="n">frequency</span><span class="p">)</span>
        <span class="n">deviation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">frequency</span> <span class="o">-</span> <span class="n">match_freq</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">deviation</span> <span class="o">&lt;=</span> <span class="n">tol</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="LineList.find_candidates"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.LineList.find_candidates">[docs]</a>    <span class="k">def</span> <span class="nf">find_candidates</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">frequency</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">lstate_threshold</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span>
        <span class="n">freq_tol</span><span class="o">=</span><span class="mf">1e-1</span><span class="p">,</span>
        <span class="n">int_tol</span><span class="o">=-</span><span class="mf">10.0</span><span class="p">,</span>
        <span class="n">max_uncertainty</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function for searching the LineList for candidates. The first step uses pure Python to isolate transitions</span>
<span class="sd">        that meet three criteria: the lower state energy, the catalog intensity, and the frequency distance.</span>

<span class="sd">        If no candidates are found, the function will return None. Otherwise, it will return the list of transitions</span>
<span class="sd">        and a list of associated normalized weights.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        frequency: float</span>
<span class="sd">            Frequency in MHz to try and match.</span>
<span class="sd">        lstate_threshold: float, optional</span>
<span class="sd">            Lower state energy threshold in Kelvin</span>
<span class="sd">        freq_tol: float, optional</span>
<span class="sd">            Frequency tolerance in MHz for matching two frequencies</span>
<span class="sd">        int_tol: float, optional</span>
<span class="sd">            log Intensity threshold</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        transitions, weighting or None</span>
<span class="sd">            If candidates are found, lists of the transitions and the associated weights are returned.</span>
<span class="sd">            Otherwise, returns None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Filter out all transition objects quickly with a list comprehension</span>
        <span class="c1"># and if statement</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">==</span> <span class="s2">&quot;Peaks&quot;</span><span class="p">:</span>
            <span class="n">freq_attr</span> <span class="o">=</span> <span class="s2">&quot;frequency&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">freq_attr</span> <span class="o">=</span> <span class="s2">&quot;catalog_frequency&quot;</span>
        <span class="n">transitions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">obj</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">lstate_energy</span> <span class="o">&lt;=</span> <span class="n">lstate_threshold</span><span class="p">,</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">catalog_intensity</span> <span class="o">&gt;=</span> <span class="n">int_tol</span><span class="p">,</span>
                    <span class="nb">abs</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">freq_attr</span><span class="p">)</span> <span class="o">-</span> <span class="n">frequency</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">freq_tol</span><span class="p">,</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">uncertainty</span> <span class="o">&lt;=</span> <span class="n">max_uncertainty</span><span class="p">,</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="p">]</span>
        <span class="c1"># If there are candidates, calculate the weights associated with each transition</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">transitions</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">transition_frequencies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;freq_attr&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">transitions</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">transition_intensities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;catalog_intensity&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">transitions</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="c1"># If there are actually no catalog intensities, it should sum up to zero in which case we won&#39;t</span>
            <span class="c1"># use the intensities in the weight factors</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">transition_intensities</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">transition_intensities</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">weighting</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">line_weighting</span><span class="p">(</span>
                <span class="n">frequency</span><span class="p">,</span> <span class="n">transition_frequencies</span><span class="p">,</span> <span class="n">transition_intensities</span>
            <span class="p">)</span>
            <span class="c1"># Only normalize if there&#39;s more than one</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">weighting</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">weighting</span> <span class="o">/=</span> <span class="n">weighting</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">transitions</span><span class="p">,</span> <span class="n">weighting</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="LineList.update_transition"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.LineList.update_transition">[docs]</a>    <span class="k">def</span> <span class="nf">update_transition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function for updating a specific Transition object within the Line List.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index: int</span>
<span class="sd">            Index for the list Transition object</span>
<span class="sd">        kwargs: optional</span>
<span class="sd">            Updates to the Transition object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="LineList.update_linelist"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.LineList.update_linelist">[docs]</a>    <span class="k">def</span> <span class="nf">update_linelist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transition_objs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Transition</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds transitions to a LineList if they do not exist in the list already.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        transition_objs: list</span>
<span class="sd">            List of Transition objects</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="p">[</span><span class="n">obj</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">transition_objs</span> <span class="k">if</span> <span class="n">obj</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">]</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="LineList.get_ulines"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.LineList.get_ulines">[docs]</a>    <span class="k">def</span> <span class="nf">get_ulines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function for retrieving unidentified lines in a Line List.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        uline_objs: list</span>
<span class="sd">            List of all of the transition objects where the uline flag is set to True.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">uline_objs</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span> <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">uline</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">uline_objs</span></div>

<div class="viewcode-block" id="LineList.get_assignments"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.LineList.get_assignments">[docs]</a>    <span class="k">def</span> <span class="nf">get_assignments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function for retrieving assigned lines in a Line List.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        assign_objs: list</span>
<span class="sd">            List of all of the transition objects where the uline flag is set to False.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">assign_objs</span> <span class="o">=</span> <span class="p">[</span><span class="n">obj</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span> <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">uline</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">assign_objs</span></div>

<div class="viewcode-block" id="LineList.get_frequencies"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.LineList.get_frequencies">[docs]</a>    <span class="k">def</span> <span class="nf">get_frequencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">numpy</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to extract all the frequencies out of a LineList</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        numpy: bool, optional</span>
<span class="sd">            If True, returns a NumPy `ndarray` with the frequencies.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        List or np.ndarray</span>
<span class="sd">            List of transition frequencies</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">frequencies</span> <span class="o">=</span> <span class="p">[</span><span class="n">transition</span><span class="o">.</span><span class="n">frequency</span> <span class="k">for</span> <span class="n">transition</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">numpy</span><span class="p">:</span>
            <span class="n">frequencies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">frequencies</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">frequencies</span></div>

<div class="viewcode-block" id="LineList.get_multiple"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.LineList.get_multiple">[docs]</a>    <span class="k">def</span> <span class="nf">get_multiple</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        </span>
<span class="sd">        Convenience function to extract all the transitions within a LineList</span>
<span class="sd">        that have multiple possible assignments.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        List</span>
<span class="sd">            List of `Transition` objects that have multiple assignments</span>
<span class="sd">            remaining.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">assign_objs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">transition</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">transition</span><span class="o">.</span><span class="n">final</span> <span class="o">==</span> <span class="kc">False</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">transition</span><span class="o">.</span><span class="n">multiple</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">assign_objs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transition</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">assign_objs</span></div>

<div class="viewcode-block" id="LineList.add_uline"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.LineList.add_uline">[docs]</a>    <span class="k">def</span> <span class="nf">add_uline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frequency</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">intensity</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to manually add a U-line to the LineList.</span>
<span class="sd">        The function creates a Transition object with the frequency and</span>
<span class="sd">        intensity values provided by a user, which is then compared with</span>
<span class="sd">        the other transition entries within the LineList. If it doesn&#39;t</span>
<span class="sd">        already exist, it will then add the new Transition to the LineList.</span>
<span class="sd">        </span>
<span class="sd">        Kwargs are passed to the creation of the Transition object.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        frequency, intensity: float</span>
<span class="sd">            Floats corresponding to the frequency and intensity of the line in</span>
<span class="sd">            a given unit.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">transition</span> <span class="o">=</span> <span class="n">Transition</span><span class="p">(</span>
            <span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">,</span> <span class="n">intensity</span><span class="o">=</span><span class="n">intensity</span><span class="p">,</span> <span class="n">uline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">transition</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">transitions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transition</span><span class="p">)</span></div>

<div class="viewcode-block" id="LineList.add_ulines"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.LineList.add_ulines">[docs]</a>    <span class="k">def</span> <span class="nf">add_ulines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to add multiple pairs of frequency/intensity to the current</span>
<span class="sd">        LineList.</span>
<span class="sd">        </span>
<span class="sd">        Kwargs are passed to the creation of the Transition object.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data: iterable of 2-tuple</span>
<span class="sd">            List-like of 2-tuples corresponding to frequency and intensity.</span>
<span class="sd">            Data should look like this example:</span>
<span class="sd">            [</span>
<span class="sd">                (12345.213, 5.),</span>
<span class="sd">                (18623.125, 12.3)</span>
<span class="sd">            ]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="c1"># This assertion makes sure that every line has a specified</span>
            <span class="c1"># frequency AND intensity value</span>
            <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">add_uline</span><span class="p">(</span><span class="o">*</span><span class="n">line</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Session"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.Session">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Session</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; </span>
<span class="sd">    Data class for handling parameters used for an AssignmentSession.</span>
<span class="sd">    The user generally shouldn&#39;t need to directly interact with this class,</span>
<span class="sd">    but can give some level of dynamic control and bookkeeping to how and</span>
<span class="sd">    what molecules can be assigned, particularly with the composition, the</span>
<span class="sd">    frequency thresholds for matching, and the noise statistics.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    experiment : int</span>
<span class="sd">        ID for experiment</span>
<span class="sd">    composition : list of str</span>
<span class="sd">        List of atomic symbols. Used for filtering out species in the Splatalogue assignment procedure.</span>
<span class="sd">    temperature : float</span>
<span class="sd">        Temperature in K. Used for filtering transitions in the automated assigment, which are 3 times this value.</span>
<span class="sd">    doppler : float</span>
<span class="sd">        Doppler width in km/s; default value is about 5 kHz at 15 GHz. Used for simulating lineshapes and</span>
<span class="sd">        for lineshape analysis.</span>
<span class="sd">    velocity : float</span>
<span class="sd">        Radial velocity of the source in km/s; used to offset the frequency spectrum</span>
<span class="sd">    freq_prox : float</span>
<span class="sd">        frequency cutoff for line assignments. If freq_abs attribute is True, this value is taken as the absolute value.</span>
<span class="sd">        Otherwise, it is a percentage of the frequency being compared.</span>
<span class="sd">    freq_abs : bool</span>
<span class="sd">        If True, freq_prox attribute is taken as the absolute value of frequency, otherwise as a decimal percentage of</span>
<span class="sd">        the frequency being compared.</span>
<span class="sd">    baseline : float</span>
<span class="sd">        Baseline level of signal used for intensity calculations and peak detection</span>
<span class="sd">    noise_rms : float</span>
<span class="sd">        RMS of the noise used for intensity calculations and peak detection</span>
<span class="sd">    noise_region : 2-tuple of floats</span>
<span class="sd">        The frequency region used to define the noise floor.</span>
<span class="sd">    max_uncertainty : float</span>
<span class="sd">        Value to use as the maximum uncertainty for considering a transition</span>
<span class="sd">        for assignments.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">experiment</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">composition</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">temperature</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">4.0</span>
    <span class="n">doppler</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">velocity</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">freq_prox</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.1</span>
    <span class="n">freq_abs</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">baseline</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">noise_rms</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="n">noise_region</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">max_uncertainty</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.2</span>

    <span class="k">def</span> <span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">form</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Experiment: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">experiment</span><span class="si">}</span><span class="s2">,&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Composition: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">composition</span><span class="si">}</span><span class="s2">,&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;Temperature: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">temperature</span><span class="si">}</span><span class="s2"> K&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">form</span></div>


<div class="viewcode-block" id="AssignmentSession"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession">[docs]</a><span class="k">class</span> <span class="nc">AssignmentSession</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Main class for bookkeeping and analyzing broadband spectra. This class</span>
<span class="sd">        revolves around operating on a single continuous spectrum, using the</span>
<span class="sd">        class functions to automatically assess the noise statistics, find</span>
<span class="sd">        peaks, and do the bulk of the bookkeeping on what molecules are assigned</span>
<span class="sd">        to what peak.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="AssignmentSession.load_session"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.load_session">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load_session</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Load an AssignmentSession from disk, once it has</span>
<span class="sd">            been saved with the save_session method which creates a pickle</span>
<span class="sd">            file.</span>

<span class="sd">            Parameters</span>
<span class="sd">            --------------</span>
<span class="sd">            filepath : str</span>
<span class="sd">                path to the AssignmentSession pickle file; typically in the sessions/{experiment_id}.pkl</span>

<span class="sd">            Returns</span>
<span class="sd">            --------------</span>
<span class="sd">            AssignmentSession</span>
<span class="sd">                Instance of the AssignmentSession loaded from disk</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">routines</span><span class="o">.</span><span class="n">read_obj</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="c1"># If the pickle file is just read independently, just make all the</span>
        <span class="c1"># folders ahead of time</span>
        <span class="n">folders</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;assignment_objs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;queries&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sessions&quot;</span><span class="p">,</span>
            <span class="s2">&quot;clean&quot;</span><span class="p">,</span>
            <span class="s2">&quot;figures&quot;</span><span class="p">,</span>
            <span class="s2">&quot;reports&quot;</span><span class="p">,</span>
            <span class="s2">&quot;logs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;outputs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ftb&quot;</span><span class="p">,</span>
            <span class="s2">&quot;linelists&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
        <span class="n">session</span><span class="o">.</span><span class="n">_init_logging</span><span class="p">()</span>
        <span class="n">session</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reloading session: </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">session</span></div>

<div class="viewcode-block" id="AssignmentSession.from_ascii"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.from_ascii">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_ascii</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">,</span>
        <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">experiment</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">composition</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;C&quot;</span><span class="p">,</span> <span class="s2">&quot;H&quot;</span><span class="p">],</span>
        <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">temperature</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span>
        <span class="n">velocity</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">col_names</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">freq_col</span><span class="o">=</span><span class="s2">&quot;Frequency&quot;</span><span class="p">,</span>
        <span class="n">int_col</span><span class="o">=</span><span class="s2">&quot;Intensity&quot;</span><span class="p">,</span>
        <span class="n">skiprows</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class method for AssignmentSession to generate a session using an ASCII</span>
<span class="sd">        file. This is the preferred method for starting an AssignmentSession.</span>
<span class="sd">        The ASCII files are parsed using the pandas method `read_csv`, with</span>
<span class="sd">        the arguments for reading simply passed to that function.</span>

<span class="sd">        Example based on blackchirp spectrum:</span>
<span class="sd">        The first row in an ASCII output from blackchirp contains the headers,</span>
<span class="sd">        which typically should be renamed to &quot;Frequency, Intensity&quot;. This can</span>
<span class="sd">        be done with this call:</span>

<span class="sd">        ```</span>
<span class="sd">        session = AssignmentSession.from_ascii(</span>
<span class="sd">            filepath=&quot;ft1020.txt&quot;,</span>
<span class="sd">            experiment=0,</span>
<span class="sd">            col_names=[&quot;Frequency&quot;, &quot;Intensity&quot;],</span>
<span class="sd">            skiprows=1</span>
<span class="sd">            )</span>
<span class="sd">        ```</span>

<span class="sd">        Example based on astronomical spectra:</span>
<span class="sd">        File formats are not homogenized, and delimiters may change. This exam-</span>
<span class="sd">        ple reads in a comma-separated spectrum, with a radial velocity of</span>
<span class="sd">        +26.2 km/s.</span>
<span class="sd">        </span>
<span class="sd">        ```</span>
<span class="sd">        session = AssignmentSession.from_ascii(</span>
<span class="sd">            filepath=&quot;spectrum.mid.dat&quot;,</span>
<span class="sd">            experiment=0,</span>
<span class="sd">            col_names=[&quot;Frequency&quot;, &quot;Intensity&quot;],</span>
<span class="sd">            velocity=26.2,</span>
<span class="sd">            delimiter=&quot;,&quot;</span>
<span class="sd">            )</span>
<span class="sd">        ```</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath : str</span>
<span class="sd">            Filepath to the ASCII spectrum</span>
<span class="sd">        experiment : int</span>
<span class="sd">            Integer identifier for the experiment</span>
<span class="sd">        composition : list of str, optional</span>
<span class="sd">            List of atomic symbols, representing the atomic composition of the experiment</span>
<span class="sd">        delimiter : str, optional</span>
<span class="sd">            Delimiter character used in the ASCII file. For example, &quot;\t&quot;, &quot;\s&quot;, &quot;,&quot;</span>
<span class="sd">        velocity: float, optional</span>
<span class="sd">            Radial velocity to offset the frequency in km/s.</span>
<span class="sd">        temperature : float, optional</span>
<span class="sd">            Rotational temperature in Kelvin used for the experiment.</span>
<span class="sd">        col_names : None or list of str, optional</span>
<span class="sd">            Names to rename the columns. If None, this is ignored.</span>
<span class="sd">        freq_col : str, optional</span>
<span class="sd">            Name of the column to be used for the frequency axis</span>
<span class="sd">        int_col : str, optional</span>
<span class="sd">            Name of the column to be used for the intensity axis</span>
<span class="sd">        skip_rows : int, optional</span>
<span class="sd">            Number of rows to skip reading.</span>
<span class="sd">        verbose : bool, optional</span>
<span class="sd">            If True, the logging module will also print statements and display</span>
<span class="sd">            any interaction that happens.</span>
<span class="sd">        kwargs</span>
<span class="sd">            Additional kwargs are passed onto initializing the Session class</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        AssignmentSession</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">spec_df</span> <span class="o">=</span> <span class="n">parsers</span><span class="o">.</span><span class="n">parse_ascii</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">delimiter</span><span class="p">,</span> <span class="n">col_names</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="n">skiprows</span><span class="p">)</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span>
            <span class="n">spec_df</span><span class="p">,</span>
            <span class="n">experiment</span><span class="p">,</span>
            <span class="n">composition</span><span class="p">,</span>
            <span class="n">temperature</span><span class="p">,</span>
            <span class="n">velocity</span><span class="p">,</span>
            <span class="n">freq_col</span><span class="p">,</span>
            <span class="n">int_col</span><span class="p">,</span>
            <span class="n">verbose</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">session</span></div>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_val</span><span class="p">,</span> <span class="n">exc_tb</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;log_handlers&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handlers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">handler</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;Experiment </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">experiment</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="nf">__deepcopy__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">memodict</span><span class="o">=</span><span class="p">{}):</span>
        <span class="c1"># Kill all of the loggers prior to copying, otherwise thread lock</span>
        <span class="c1"># prevents pickling</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;log_handlers&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handlers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">handler</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">settings</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;exp_dataframe&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="s2">&quot;experiment&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">experiment</span><span class="p">,</span>
            <span class="s2">&quot;composition&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">composition</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">new_copy</span> <span class="o">=</span> <span class="n">AssignmentSession</span><span class="p">(</span><span class="o">**</span><span class="n">settings</span><span class="p">)</span>
        <span class="n">new_copy</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
        <span class="n">new_copy</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_copy</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">exp_dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
        <span class="n">experiment</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">composition</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
        <span class="n">temperature</span><span class="o">=</span><span class="mf">4.0</span><span class="p">,</span>
        <span class="n">velocity</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">freq_col</span><span class="o">=</span><span class="s2">&quot;Frequency&quot;</span><span class="p">,</span>
        <span class="n">int_col</span><span class="o">=</span><span class="s2">&quot;Intensity&quot;</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; init method for AssignmentSession.</span>

<span class="sd">            Attributes</span>
<span class="sd">            ----------</span>
<span class="sd">            session : `Session` object</span>
<span class="sd">                Class containing parameters for the experiment, including the</span>
<span class="sd">                chemical composition, the noise statistics, radial velocity,</span>
<span class="sd">                etc.</span>
<span class="sd">            data : Pandas DataFrame</span>
<span class="sd">                This pandas dataframe contains the actual x/y data for the</span>
<span class="sd">                spectrum being analyzed.</span>
<span class="sd">            freq_col, int_col : str</span>
<span class="sd">                Names of the frequency and intensity columns that are contained</span>
<span class="sd">                in the `self.data` dataframe</span>
<span class="sd">            t_threshold : float</span>
<span class="sd">                This value is used to cut off upper-states for assignment. This</span>
<span class="sd">                corresponds to three times the user specified temperature for</span>
<span class="sd">                the experiment.</span>
<span class="sd">            umols : list</span>
<span class="sd">                TODO this list should be used to keep track of unidentified</span>
<span class="sd">                molecules during the assignment process. Later on if an the</span>
<span class="sd">                carrier is identified we should be able to update everything</span>
<span class="sd">                consistently.</span>
<span class="sd">            verbose : bool</span>
<span class="sd">                Specifies whether the logging is printed in addition to being</span>
<span class="sd">                dumped to file.</span>
<span class="sd">            line_lists : dict</span>
<span class="sd">                Dictionary containing all of the `LineList` objects being used</span>
<span class="sd">                for assignments. When the `find_peaks` function is run, a</span>
<span class="sd">                `LineList` is generated, holding every peak found as a corres-</span>
<span class="sd">                ponding `Transition`. This `LineList` is then referenced by</span>
<span class="sd">                the &quot;Peaks&quot; key in the line_lists dictionary.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make folders for organizing output</span>
        <span class="n">folders</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;assignment_objs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;queries&quot;</span><span class="p">,</span>
            <span class="s2">&quot;sessions&quot;</span><span class="p">,</span>
            <span class="s2">&quot;clean&quot;</span><span class="p">,</span>
            <span class="s2">&quot;figures&quot;</span><span class="p">,</span>
            <span class="s2">&quot;reports&quot;</span><span class="p">,</span>
            <span class="s2">&quot;logs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;outputs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;ftb&quot;</span><span class="p">,</span>
            <span class="s2">&quot;linelists&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
        <span class="c1"># Initialize a Session dataclass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">experiment</span><span class="p">,</span> <span class="n">composition</span><span class="p">,</span> <span class="n">temperature</span><span class="p">,</span> <span class="n">velocity</span><span class="o">=</span><span class="n">velocity</span><span class="p">)</span>
        <span class="c1"># Update additional setttings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">exp_dataframe</span>
        <span class="c1"># Set the temperature threshold for transitions to be 3x the set value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">t_threshold</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">temperature</span> <span class="o">*</span> <span class="mf">3.0</span>
        <span class="c1"># Initial threshold for peak detection is set to None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">umol_names</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="c1"># Holds catalogs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">LineList</span><span class="p">]]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_logging</span><span class="p">()</span>
        <span class="c1"># Default settings for columns</span>
        <span class="k">if</span> <span class="n">freq_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">freq_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">freq_col</span> <span class="o">=</span> <span class="n">freq_col</span>
        <span class="k">if</span> <span class="n">int_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">int_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">int_col</span> <span class="o">=</span> <span class="n">int_col</span>
        <span class="k">if</span> <span class="n">velocity</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_velocity</span><span class="p">(</span><span class="n">velocity</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__truediv__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;AssignmentSession&quot;</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to divide the spectral intensity of the current experiment by another.</span>
<span class="sd">        This gives the ratio of spectral intensities, and can be useful for determining</span>
<span class="sd">        whether a line becomes stronger or weaker between experiments.</span>

<span class="sd">        If the copy keyword is True, this method creates a deep copy of the current experiment and returns the copy</span>
<span class="sd">        with the updated intensities. Otherwise, the spectrum of the current experiment is modified.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        other - AssignmentSession object</span>
<span class="sd">            Other AssignmentSession object to compare spectra with. Acts as denominator.</span>
<span class="sd">        copy - bool, optional</span>
<span class="sd">            If True, returns a copy of the experiment, with the ID number added</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        new_experiment - AssignmentSession object</span>
<span class="sd">            Generated new experiment with the divided spectrum, if copy is True</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">copy</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">new_experiment</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">new_experiment</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">new_experiment</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">int_col</span><span class="p">]</span> <span class="o">/</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">other</span><span class="o">.</span><span class="n">int_col</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">new_experiment</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">experiment</span> <span class="o">+=</span> <span class="n">other</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">experiment</span>
            <span class="k">return</span> <span class="n">new_experiment</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">int_col</span><span class="p">]</span> <span class="o">/</span> <span class="n">other</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">other</span><span class="o">.</span><span class="n">int_col</span><span class="p">]</span>
            <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__sub__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;AssignmentSession&quot;</span><span class="p">,</span> <span class="n">copy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dunder method to blank the current experiment with another. This method</span>
<span class="sd">        will take every detected frequency in the reference experiment, and</span>
<span class="sd">        blank the corresponding regions from the current experiment. In effect</span>
<span class="sd">        this</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        other</span>
<span class="sd">        copy</span>
<span class="sd">        window</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">copy</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">experiment</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">experiment</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">blank_freqs</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="c1"># Get regions to blank</span>
        <span class="k">for</span> <span class="n">transition</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">line_lists</span><span class="p">[</span><span class="s2">&quot;Peaks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">transitions</span><span class="p">:</span>
            <span class="c1"># Use the measured frequency where possible</span>
            <span class="k">if</span> <span class="n">transition</span><span class="o">.</span><span class="n">frequency</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
                <span class="n">frequency</span> <span class="o">=</span> <span class="n">transition</span><span class="o">.</span><span class="n">frequency</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">frequency</span> <span class="o">=</span> <span class="n">transition</span><span class="o">.</span><span class="n">catalog_frequency</span>
            <span class="n">blank_freqs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">frequency</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">blank_spectrum</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">blank_spectrum</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                <span class="n">blank_freqs</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">baseline</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">noise_rms</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">freq_col</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">int_col</span><span class="p">,</span>
                <span class="n">window</span><span class="p">,</span>
                <span class="n">df</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">experiment</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">int_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">blank_spectrum</span>
            <span class="n">new_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">experiment</span> <span class="o">-</span> <span class="n">other</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">experiment</span>
            <span class="n">experiment</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">experiment</span> <span class="o">=</span> <span class="n">new_id</span>
            <span class="k">return</span> <span class="n">experiment</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Peak/Noise detection not yet run!&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="s2">&quot;LineList&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dunder method to check if a molecule is contained within this experiment.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        item : Union[LineList, str]</span>
<span class="sd">            Item to check; can be a `LineList` or a `str`. If the item is</span>
<span class="sd">            a `LineList`, check and see if the `LineList` is present in the</span>
<span class="sd">            current list. If the item is a `str`, check in the assignment</span>
<span class="sd">            table for a name or a formula.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if present in the experiment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">check</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span><span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;formula&quot;</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">check</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">LineList</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frequency</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dunder method to look up a frequency contained within the</span>
<span class="sd">        experiment peak line list.</span>
<span class="sd">        </span>
<span class="sd">        Additional kwargs are passed into `LineList.find_candidates`</span>
<span class="sd">        function, which allows one to specify tolerances for the</span>
<span class="sd">        lookup.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        frequency : float</span>
<span class="sd">            Frequency to search the experiment for in MHz.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pd.DataFrame</span>
<span class="sd">            DataFrame of the matched frequencies.</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        -------</span>
<span class="sd">        AttributeError</span>
<span class="sd">            If peak detection has not been run yet</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;Peaks&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">[</span><span class="s2">&quot;Peaks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_candidates</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AttributeError</span><span class="p">(</span><span class="s2">&quot;Experiment has no peaks!&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="AssignmentSession.umol_gen"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.umol_gen">[docs]</a>    <span class="k">def</span> <span class="nf">umol_gen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">silly</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generator for unidentified molecule names. Wraps</span>
<span class="sd">        Yields</span>
<span class="sd">        ------</span>
<span class="sd">        str</span>
<span class="sd">            Formatted as &quot;UMol_XXX&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">counter</span> <span class="o">&lt;=</span> <span class="mi">200</span><span class="p">:</span>
            <span class="c1"># If we want to use silly names from the monsterurl generator</span>
            <span class="k">if</span> <span class="n">silly</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">get_monster</span><span class="p">()</span>
            <span class="c1"># Otherwise use boring counters</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;U-molecule-</span><span class="si">{</span><span class="n">counter</span><span class="si">:</span><span class="s2">03d</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">yield</span> <span class="n">name</span>
            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span></div>

<div class="viewcode-block" id="AssignmentSession.create_ulinelist"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.create_ulinelist">[docs]</a>    <span class="k">def</span> <span class="nf">create_ulinelist</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">silly</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a LineList object for an unidentified molecule. This uses the</span>
<span class="sd">        class method `umol_gen` to automatically generate names for U-molecules</span>
<span class="sd">        which can then be renamed once it has been identified.</span>

<span class="sd">        The session attribute `umol_names` also keeps track of filepaths to</span>
<span class="sd">        catalog names. If the filepath has been used previously, then it will</span>
<span class="sd">        raise an Exception noting that the filepath is already associated with</span>
<span class="sd">        another catalog.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath: str</span>
<span class="sd">            File path to the catalog or .lin file to use as a reference</span>
<span class="sd">        silly: bool, optional</span>
<span class="sd">            Flag whether to use boring numbered identifiers, or randomly</span>
<span class="sd">            generated `AdjectiveAdjectiveAnimal`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        LineList object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filepath</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">umol_names</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">suffix</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">umol_gen</span><span class="p">(</span><span class="n">silly</span><span class="o">=</span><span class="n">silly</span><span class="p">))</span>
            <span class="n">parameters</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s2">&quot;formula&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span> <span class="s2">&quot;filepath&quot;</span><span class="p">:</span> <span class="n">filepath</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">ext</span> <span class="o">==</span> <span class="s2">&quot;.lin&quot;</span><span class="p">:</span>
                <span class="n">method</span> <span class="o">=</span> <span class="n">LineList</span><span class="o">.</span><span class="n">from_lin</span>
            <span class="k">elif</span> <span class="n">ext</span> <span class="o">==</span> <span class="s2">&quot;.cat&quot;</span><span class="p">:</span>
                <span class="n">method</span> <span class="o">=</span> <span class="n">LineList</span><span class="o">.</span><span class="n">from_catalog</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File extension not recognized: </span><span class="si">{</span><span class="n">ext</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="n">linelist</span> <span class="o">=</span> <span class="n">method</span><span class="p">(</span><span class="o">**</span><span class="n">parameters</span><span class="p">)</span>
            <span class="n">linelist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="c1"># Give the first frequency just for book keeping</span>
            <span class="n">frequency</span> <span class="o">=</span> <span class="n">linelist</span><span class="o">.</span><span class="n">transitions</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">catalog_frequency</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Created a U-molecule: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">, with frequency </span><span class="si">{</span><span class="n">frequency</span><span class="si">:</span><span class="s2">,.4f</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
            <span class="c1"># Create a symlink so we know which catalog this molecule refers to</span>
            <span class="n">sym_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;linelists/</span><span class="si">{</span><span class="n">name</span><span class="si">}{</span><span class="n">ext</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">sym_path</span><span class="o">.</span><span class="n">symlink_to</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
            <span class="c1"># Also for internal record keeping</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">umol_names</span><span class="p">[</span><span class="n">filepath</span><span class="p">]</span> <span class="o">=</span> <span class="n">name</span>
            <span class="k">return</span> <span class="n">linelist</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">umol_names</span><span class="p">[</span><span class="n">filepath</span><span class="p">]</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;U-molecule already exists with name: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">!&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AssignmentSession.rename_umolecule"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.rename_umolecule">[docs]</a>    <span class="k">def</span> <span class="nf">rename_umolecule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">formula</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to update the name of a LineList. This function should be used</span>
<span class="sd">        to update a LineList, particularly when the identity of an unidentified</span>
<span class="sd">        molecule is discovered.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name: str</span>
<span class="sd">            Old name of the LineList.</span>
<span class="sd">        new_name: str</span>
<span class="sd">            New name of the LineList - preferably, a real molecule name.</span>
<span class="sd">        formula: str, optional</span>
<span class="sd">            New formula of the LineList.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">:</span>
            <span class="c1"># Rename the LineList within the experiment</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">[</span><span class="n">new_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">[</span><span class="n">new_name</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">new_name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">[</span><span class="n">new_name</span><span class="p">]</span><span class="o">.</span><span class="n">formula</span> <span class="o">=</span> <span class="n">formula</span>
            <span class="c1"># Create symlinks to the catalog with the new name for book keeping</span>
            <span class="n">sym_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;linelists/</span><span class="si">{</span><span class="n">new_name</span><span class="si">}</span><span class="s2">.cat&quot;</span><span class="p">)</span>
            <span class="n">sym_path</span><span class="o">.</span><span class="n">symlink_to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">[</span><span class="n">new_name</span><span class="p">]</span><span class="o">.</span><span class="n">filepath</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> does not exist in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">experiment</span><span class="si">}</span><span class="s2"> line_lists&quot;</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="AssignmentSession.add_ulines"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.add_ulines">[docs]</a>    <span class="k">def</span> <span class="nf">add_ulines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]],</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to manually add multiple pairs of frequency/intensity to the current</span>
<span class="sd">        experiment&#39;s Peaks list.</span>
<span class="sd">        </span>
<span class="sd">        Kwargs are passed to the creation of the Transition object.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        data: iterable of 2-tuple</span>
<span class="sd">            List-like of 2-tuples corresponding to frequency and intensity.</span>
<span class="sd">            Data should look like this example:</span>
<span class="sd">            [</span>
<span class="sd">                (12345.213, 5.),</span>
<span class="sd">                (18623.125, 12.3)</span>
<span class="sd">            ]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">default_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;experiment&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">experiment</span><span class="p">,</span>
            <span class="s2">&quot;velocity&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">velocity</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">default_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;Peaks&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">[</span><span class="s2">&quot;Peaks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">add_ulines</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="o">**</span><span class="n">default_dict</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="si">}</span><span class="s2"> transitions to U-lines.&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_init_logging</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set up the logging formatting and files. The levels are defined in the dictionary mapping, and so new</span>
<span class="sd">        levels and their warning level should be defined there. Additional log files can be added in the</span>
<span class="sd">        log_handlers dictionary. In the other routines, the logger attribute should be used.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;debug&quot;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
            <span class="s2">&quot;warning&quot;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">,</span>
            <span class="s2">&quot;analysis&quot;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
            <span class="s2">&quot;stream&quot;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">captureWarnings</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">experiment</span><span class="si">}</span><span class="s2"> log&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>
        <span class="c1"># Define file handlers for each type of log</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_handlers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;analysis&quot;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;./logs/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">experiment</span><span class="si">}</span><span class="s2">-analysis.log&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span>
            <span class="p">),</span>
            <span class="s2">&quot;warning&quot;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;./logs/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">experiment</span><span class="si">}</span><span class="s2">-warnings.log&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span>
            <span class="p">),</span>
            <span class="s2">&quot;debug&quot;</span><span class="p">:</span> <span class="n">logging</span><span class="o">.</span><span class="n">FileHandler</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;./logs/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">experiment</span><span class="si">}</span><span class="s2">-debug.log&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span>
            <span class="p">),</span>
        <span class="p">}</span>
        <span class="c1"># If verbose is specified, the logging info is directly printed as well</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log_handlers</span><span class="p">[</span><span class="s2">&quot;stream&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">StreamHandler</span><span class="p">()</span>
        <span class="c1"># Set up the formatting and the level definitions</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">handler</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handlers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> - </span><span class="si">%(levelname)s</span><span class="s2"> - </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># do not redefine the default warning levels</span>
            <span class="n">handler</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">mapping</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>

<div class="viewcode-block" id="AssignmentSession.set_velocity"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.set_velocity">[docs]</a>    <span class="k">def</span> <span class="nf">set_velocity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the radial velocity offset for the spectrum. The velocity is specified in km/s, and is set up</span>
<span class="sd">        such that the notation is positive velocity yields a redshifted spectrum (i.e. moving towards us).</span>

<span class="sd">        This method should be used to change the velocity, as it will automatically re-calculate the dataframe</span>
<span class="sd">        frequency column to the new velocity.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        value : float</span>
<span class="sd">            Velocity in km/s</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Assume that if this is the first time we&#39;re performing a frequency offset, make a copy of the data</span>
        <span class="k">if</span> <span class="s2">&quot;Laboratory Frame&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;Laboratory Frame&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq_col</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># If we have performed the shift before, copy back the unshifted data</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq_col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;Laboratory Frame&quot;</span><span class="p">]</span>
        <span class="n">doppler_offset</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">dop2freq</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Laboratory Frame&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="c1"># Offset the values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq_col</span><span class="p">]</span> <span class="o">+=</span> <span class="n">doppler_offset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">velocity</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Set the session velocity to </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AssignmentSession.detect_noise_floor"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.detect_noise_floor">[docs]</a>    <span class="k">def</span> <span class="nf">detect_noise_floor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">als</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set the noise parameters for the current spectrum. Control over what &quot;defines&quot; the noise floor</span>
<span class="sd">        is specified with the parameter region. By default, if region is None then the function will</span>
<span class="sd">        perform an initial peak find using 1% of the maximum intensity as the threshold. The noise region</span>
<span class="sd">        will be established based on the largest gap between peaks, i.e. hopefully capturing as little</span>
<span class="sd">        features in the statistics as possible.</span>
<span class="sd">        </span>
<span class="sd">        The alternative method is invoked when the `als` argument is set to True, which will use the</span>
<span class="sd">        asymmetric least-squares method to determine the baseline. Afterwards, the baseline is decimated</span>
<span class="sd">        by an extremely heavy Gaussian blur, and one ends up with a smoothly varying baseline. In this</span>
<span class="sd">        case, there is no `noise_rms` attribute to be returned as it is not required to determine the</span>
<span class="sd">        minimum peak threshold.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        region : 2-tuple or None, optional</span>
<span class="sd">            If None, use the automatic algorithm. Otherwise, a 2-tuple specifies the region of the spectrum</span>
<span class="sd">            in frequency to use for noise statistics.</span>
<span class="sd">        als : bool, optional</span>
<span class="sd">            If True, will use the asymmetric least squares method to determine the baseline.</span>
<span class="sd">        kwargs</span>
<span class="sd">            Additional kwargs are passed into the ALS function.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        baseline - float</span>
<span class="sd">            Value of the noise floor</span>
<span class="sd">        rms - float</span>
<span class="sd">            Noise RMS/standard deviation</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">als</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">region</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Perform rudimentary peak detection</span>
                <span class="n">threshold</span> <span class="o">=</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">int_col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
                <span class="n">peaks_df</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">peak_find</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                    <span class="n">freq_col</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_col</span><span class="p">,</span>
                    <span class="n">int_col</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">int_col</span><span class="p">,</span>
                    <span class="n">thres</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaks_df</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="c1"># find largest gap in data, including the edges of the spectrum</span>
                    <span class="n">freq_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">peaks_df</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
                    <span class="n">freq_values</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                        <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()]</span>
                    <span class="p">)</span>
                    <span class="c1"># sort the values</span>
                    <span class="n">freq_values</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">freq_values</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Possible noise region:&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">freq_values</span><span class="p">)</span>
                    <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">freq_values</span><span class="p">))</span>
                    <span class="c1"># Define region as the largest gap</span>
                    <span class="n">region</span> <span class="o">=</span> <span class="n">freq_values</span><span class="p">[</span><span class="n">index</span> <span class="p">:</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span>
                    <span class="c1"># Add a 30 MHz offset to either end of the spectrum</span>
                    <span class="n">region</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">region</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">30.0</span>
                    <span class="n">region</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">region</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">30.0</span>
                    <span class="c1"># Make sure the frequencies are in ascending order</span>
                    <span class="n">region</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s2">&quot;Noise region defined as </span><span class="si">{}</span><span class="s2"> to </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">region</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="n">noise_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_col</span><span class="p">]</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="o">*</span><span class="n">region</span><span class="p">)]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">noise_df</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">:</span>
                        <span class="n">noise_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">))</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s2">&quot;Noise region too small; taking a statistical sample.&quot;</span>
                        <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># If we haven&#39;t found any peaks, sample 10% of random channels and determine the</span>
                    <span class="c1"># baseline from those values</span>
                    <span class="n">noise_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="s2">&quot;No obvious peaks detected; taking a statistical sample.&quot;</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># If we haven&#39;t found any peaks, sample 10% of random channels and determine the</span>
                <span class="c1"># baseline from those values</span>
                <span class="n">noise_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="s2">&quot;No obvious peaks detected; taking a statistical sample.&quot;</span>
                <span class="p">)</span>
                <span class="c1"># Calculate statistics</span>
            <span class="n">baseline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">noise_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">int_col</span><span class="p">])</span>
            <span class="n">rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">noise_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">int_col</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">noise_region</span> <span class="o">=</span> <span class="n">region</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">noise_rms</span> <span class="o">=</span> <span class="n">rms</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">baseline</span> <span class="o">=</span> <span class="n">baseline</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Baseline signal set to </span><span class="si">{</span><span class="n">baseline</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Noise RMS set to </span><span class="si">{</span><span class="n">rms</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">als</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># Use the asymmetric least-squares method to determine the baseline</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="s2">&quot;Using asymmetric least squares method for baseline determination.&quot;</span>
            <span class="p">)</span>
            <span class="n">als_params</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;lam&quot;</span><span class="p">:</span> <span class="mf">1e2</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">:</span> <span class="mf">0.05</span><span class="p">,</span> <span class="s2">&quot;niter&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>
            <span class="n">als_params</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">baseline</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">baseline_als</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">int_col</span><span class="p">],</span> <span class="o">**</span><span class="n">als_params</span><span class="p">)</span>
            <span class="c1"># Decimate the noise with a huge Gaussian blur</span>
            <span class="n">baseline</span> <span class="o">=</span> <span class="n">gaussian_filter</span><span class="p">(</span><span class="n">baseline</span><span class="p">,</span> <span class="mf">200.0</span><span class="p">)</span>
            <span class="n">rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">baseline</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">baseline</span> <span class="o">=</span> <span class="n">baseline</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">noise_region</span> <span class="o">=</span> <span class="s2">&quot;als&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">noise_rms</span> <span class="o">=</span> <span class="n">rms</span>
        <span class="k">return</span> <span class="n">baseline</span><span class="p">,</span> <span class="n">rms</span></div>

<div class="viewcode-block" id="AssignmentSession.find_peaks"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.find_peaks">[docs]</a>    <span class="k">def</span> <span class="nf">find_peaks</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">region</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">min_dist</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">als</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Find peaks in the experiment spectrum, with a specified threshold value or automatic threshold.</span>
<span class="sd">            The method calls the peak_find function from the analysis module, which in itself wraps peakutils.</span>

<span class="sd">            The function works by finding regions of the intensity where the first derivative goes to zero</span>
<span class="sd">            and changes sign. This gives peak frequency/intensities from the digitized spectrum, which is</span>
<span class="sd">            then &quot;refined&quot; by interpolating over each peak and fitting a Gaussian to determine the peak.</span>

<span class="sd">            The peaks are then returned as a pandas DataFrame, which can also be accessed in the peaks_df</span>
<span class="sd">            attribute of AssignmentSession.</span>
<span class="sd">            </span>
<span class="sd">            When a value of threshold is not provided, the function will turn to use automated methods for</span>
<span class="sd">            noise detection, either by taking a single value as the baseline (not ALS), or by using the</span>
<span class="sd">            asymmetric least-squares method for fitting the baseline. In both instances, the primary intensity</span>
<span class="sd">            column to be used for analysis will be changed to &quot;SNR&quot;, which is the recommended approach.</span>

<span class="sd">            To use the ALS algorithm there may be some tweaking involved for the parameters.</span>
<span class="sd">            These are typically found empirically, but for reference here are some &quot;optimal&quot; values</span>
<span class="sd">            that have been tested.</span>
<span class="sd">            </span>
<span class="sd">            For millimeter-wave spectra, larger values of lambda are favored:</span>
<span class="sd">            </span>
<span class="sd">            lambda = 1e5</span>
<span class="sd">            p = 0.1</span>
<span class="sd">            </span>
<span class="sd">            This should get rid of periodic (fringe) baselines, and leave the &quot;real&quot; signal behind.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>
<span class="sd">            threshold : float or None, optional</span>
<span class="sd">                Peak detection threshold. If None, will take 1.5 times the noise RMS.</span>
<span class="sd">            region : 2-tuple or None, optional</span>
<span class="sd">                If None, use the automatic algorithm. Otherwise, a 2-tuple specifies the region of the spectrum</span>
<span class="sd">                in frequency to use for noise statistics.</span>
<span class="sd">            sigma : float, optional</span>
<span class="sd">                Defines the number of sigma (noise RMS) above the baseline to use as the peak detection threshold.</span>
<span class="sd">            min_dist : int, optional</span>
<span class="sd">                Number of channels between peaks to be detected.</span>
<span class="sd">            als : bool, optional</span>
<span class="sd">                If True, uses ALS fitting to determine a baseline.</span>
<span class="sd">            kwargs</span>
<span class="sd">                Additional keyword arguments are passed to the ALS fitting routine.</span>

<span class="sd">            Returns</span>
<span class="sd">            -------</span>
<span class="sd">            peaks_df : dataframe</span>
<span class="sd">                Pandas dataframe with Frequency/Intensity columns, corresponding to peaks</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_col</span> <span class="o">==</span> <span class="s2">&quot;SNR&quot;</span><span class="p">:</span>
            <span class="c1"># if we run peak find again, the int_col is incorrectly</span>
            <span class="c1"># going to be set to SNR giving us bad results. Use the</span>
            <span class="c1"># last column instead.</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
            <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span> <span class="k">if</span> <span class="n">col</span> <span class="o">!=</span> <span class="s2">&quot;SNR&quot;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">int_col</span> <span class="o">=</span> <span class="n">columns</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;SNR set as int_col and is invalid for peak finding. Using </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">int_col</span><span class="si">}</span><span class="s2"> instead.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">als</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="c1"># Use a quasi-intelligent method of determining the noise floor</span>
            <span class="c1"># and ultimately using noise + 1 sigma</span>
            <span class="n">baseline</span><span class="p">,</span> <span class="n">rms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_noise_floor</span><span class="p">(</span><span class="n">region</span><span class="p">)</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">baseline</span> <span class="o">+</span> <span class="p">(</span><span class="n">rms</span> <span class="o">*</span> <span class="n">sigma</span><span class="p">)</span>
            <span class="c1"># Convert threshold into SNR units</span>
            <span class="n">threshold</span> <span class="o">/=</span> <span class="n">baseline</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;SNR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">int_col</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">baseline</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">int_col</span> <span class="o">=</span> <span class="s2">&quot;SNR&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Now using SNR as primary intensity unit.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">threshold</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">als</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">baseline</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_noise_floor</span><span class="p">(</span><span class="n">als</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="c1"># Convert to SNR, and start using this instead</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;SNR&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">int_col</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">baseline</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">int_col</span> <span class="o">=</span> <span class="s2">&quot;SNR&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Now using SNR as primary intensity unit.&quot;</span><span class="p">)</span>
            <span class="c1"># If using ALS, the sigma argument becomes the threshold value in SNR units</span>
            <span class="n">threshold</span> <span class="o">=</span> <span class="n">sigma</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Peak detection threshold is: </span><span class="si">{</span><span class="n">threshold</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">peaks_df</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">peak_find</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="n">freq_col</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_col</span><span class="p">,</span>
            <span class="n">int_col</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">int_col</span><span class="p">,</span>
            <span class="n">thres</span><span class="o">=</span><span class="n">threshold</span><span class="p">,</span>
            <span class="n">min_dist</span><span class="o">=</span><span class="n">min_dist</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Shift the peak intensities down by the noise baseline</span>
        <span class="k">if</span> <span class="n">als</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">baseline</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="s2">&quot;baseline&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>
            <span class="n">peaks_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">peaks_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">int_col</span><span class="p">]</span> <span class="o">-</span> <span class="n">baseline</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">peaks_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> peaks in total.&quot;</span><span class="p">)</span>
        <span class="c1"># Reindex the peaks</span>
        <span class="n">peaks_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">peaks_df</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># Generate U-lines</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">df2ulines</span><span class="p">(</span><span class="n">peaks_df</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq_col</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_col</span><span class="p">)</span>
            <span class="c1"># Assign attribute</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">peaks</span> <span class="o">=</span> <span class="n">peaks_df</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;./outputs/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">experiment</span><span class="si">}</span><span class="s2">-peaks.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">peaks_df</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="AssignmentSession.df2ulines"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.df2ulines">[docs]</a>    <span class="k">def</span> <span class="nf">df2ulines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataframe</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span> <span class="n">freq_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">int_col</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a dataframe of frequency and intensities to the session U-line dictionary. This function provides more</span>
<span class="sd">        manual control over what can be processed in the assignment pipeline, as not everything can be picked</span>
<span class="sd">        up by the peak finding algorithm.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dataframe : pandas dataframe</span>
<span class="sd">            Dataframe containing a frequency and intensity column to add to the uline list.</span>
<span class="sd">        freq_col : None or str</span>
<span class="sd">            Specify column to use for frequencies. If None, uses the session value freq_col.</span>
<span class="sd">        int_col : None or str</span>
<span class="sd">            Specify column to use for intensities. If None, uses the session value int_col.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">freq_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">freq_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq_col</span>
        <span class="k">if</span> <span class="n">int_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">int_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_col</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Modifying the experiment LineList.&quot;</span><span class="p">)</span>
        <span class="c1"># Set up session information to be passed in the U-line</span>
        <span class="n">skip</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;temperature&quot;</span><span class="p">,</span>
            <span class="s2">&quot;doppler&quot;</span><span class="p">,</span>
            <span class="s2">&quot;freq_abs&quot;</span><span class="p">,</span>
            <span class="s2">&quot;freq_prox&quot;</span><span class="p">,</span>
            <span class="s2">&quot;noise_rms&quot;</span><span class="p">,</span>
            <span class="s2">&quot;baseline&quot;</span><span class="p">,</span>
            <span class="s2">&quot;header&quot;</span><span class="p">,</span>
            <span class="s2">&quot;noise_region&quot;</span><span class="p">,</span>
            <span class="s2">&quot;composition&quot;</span><span class="p">,</span>
            <span class="s2">&quot;name&quot;</span><span class="p">,</span>
            <span class="s2">&quot;max_uncertainty&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">selected_session</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="vm">__dict__</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">skip</span>
        <span class="p">}</span>
        <span class="c1"># If the Peaks key has not been set up yet, we set it up now</span>
        <span class="k">if</span> <span class="s2">&quot;Peaks&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">[</span><span class="s2">&quot;Peaks&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">LineList</span><span class="o">.</span><span class="n">from_dataframe</span><span class="p">(</span>
                <span class="n">dataframe</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Peaks&quot;</span><span class="p">,</span>
                <span class="n">freq_col</span><span class="o">=</span><span class="n">freq_col</span><span class="p">,</span>
                <span class="n">int_col</span><span class="o">=</span><span class="n">int_col</span><span class="p">,</span>
                <span class="o">**</span><span class="n">selected_session</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="c1"># Otherwise, we&#39;ll just update the existing LineList</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vfunc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">Transition</span><span class="p">)</span>
            <span class="n">transitions</span> <span class="o">=</span> <span class="n">vfunc</span><span class="p">(</span>
                <span class="n">frequency</span><span class="o">=</span><span class="n">dataframe</span><span class="p">[</span><span class="n">freq_col</span><span class="p">],</span>
                <span class="n">intensity</span><span class="o">=</span><span class="n">dataframe</span><span class="p">[</span><span class="n">int_col</span><span class="p">],</span>
                <span class="o">**</span><span class="n">selected_session</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">[</span><span class="s2">&quot;Peaks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update_linelist</span><span class="p">(</span><span class="n">transitions</span><span class="p">)</span>
        <span class="n">new_remaining</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">[</span><span class="s2">&quot;Peaks&quot;</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;There are now </span><span class="si">{</span><span class="n">new_remaining</span><span class="si">}</span><span class="s2"> line entries in this session.&quot;</span><span class="p">)</span>
        <span class="n">peaks_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">[</span><span class="s2">&quot;Peaks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()[[</span><span class="s2">&quot;frequency&quot;</span><span class="p">,</span> <span class="s2">&quot;intensity&quot;</span><span class="p">]]</span>
        <span class="n">peaks_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">,</span> <span class="s2">&quot;Intensity&quot;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peaks</span> <span class="o">=</span> <span class="n">peaks_df</span></div>

<div class="viewcode-block" id="AssignmentSession.search_frequency"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.search_frequency">[docs]</a>    <span class="k">def</span> <span class="nf">search_frequency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frequency</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function for searching the experiment for a particular frequency. The search range is defined by</span>
<span class="sd">        the Session attribute freq_prox, and will first look for the frequency in the assigned features</span>
<span class="sd">        if any have been made. The routine will then look for it in the U-lines.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        frequency : float</span>
<span class="sd">            Center frequency in MHz</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dataframe</span>
<span class="sd">            Pandas dataframe with the matches</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">slice_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">freq_abs</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">lower_freq</span> <span class="o">=</span> <span class="n">frequency</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">freq_prox</span><span class="p">)</span>
            <span class="n">upper_freq</span> <span class="o">=</span> <span class="n">frequency</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">freq_prox</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">lower_freq</span> <span class="o">=</span> <span class="n">frequency</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">freq_prox</span>
            <span class="n">upper_freq</span> <span class="o">=</span> <span class="n">frequency</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">freq_prox</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;table&quot;</span><span class="p">):</span>
            <span class="n">slice_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;frequency&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">lower_freq</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;frequency&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">upper_freq</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="c1"># If no hits turn up, look for it in U-lines</span>
        <span class="k">if</span> <span class="n">slice_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No assignment found; searching U-lines&quot;</span><span class="p">)</span>
            <span class="n">ulines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[[</span><span class="n">index</span><span class="p">,</span> <span class="n">uline</span><span class="o">.</span><span class="n">frequency</span><span class="p">]</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">uline</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ulines</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
            <span class="p">)</span>
            <span class="n">nearest</span><span class="p">,</span> <span class="n">array_index</span> <span class="o">=</span> <span class="n">routines</span><span class="o">.</span><span class="n">find_nearest</span><span class="p">(</span><span class="n">ulines</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">frequency</span><span class="p">)</span>
            <span class="n">uline_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ulines</span><span class="p">[</span><span class="n">array_index</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">nearest</span><span class="p">,</span> <span class="n">uline_index</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Found assignments.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">slice_df</span></div>

<div class="viewcode-block" id="AssignmentSession.apply_filter"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.apply_filter">[docs]</a>    <span class="k">def</span> <span class="nf">apply_filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">int_col</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Applies a filter to the spectral signal. If multiple window functions</span>
<span class="sd">        are to be used, a list of windows can be provided, which will then</span>
<span class="sd">        perform the convolution stepwise. With the exception of the gaussian</span>
<span class="sd">        window function, the others functions use the SciPy signal functions.</span>

<span class="sd">        A reference copy of the original signal is kept as the &quot;Ref&quot; column;</span>
<span class="sd">        this is used if a new window function is applied, rather than on the</span>
<span class="sd">        already convolved signal.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        window: str, or iterable of str</span>
<span class="sd">            Name of the window function</span>
<span class="sd">        sigma: float, optional</span>
<span class="sd">            Specifies the magnitude of the gaussian blur. Only used when the</span>
<span class="sd">            window function asked for is &quot;gaussian&quot;.</span>
<span class="sd">        int_col: None or str, optional</span>
<span class="sd">            Specifies which column to apply the window function to. If None,</span>
<span class="sd">            defaults to the session-wide intensity column</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">int_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">int_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_col</span>
        <span class="c1"># If the reference spectrum exists, we&#39;ll use that instead</span>
        <span class="k">if</span> <span class="s2">&quot;Ref&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">int_col</span> <span class="o">=</span> <span class="s2">&quot;Ref&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using Ref signal for window function.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Make a copy of the original signal</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Ref&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">int_col</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Copied signal to Ref column.&quot;</span><span class="p">)</span>
        <span class="n">intensity</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">int_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Applying </span><span class="si">{</span><span class="n">window</span><span class="si">}</span><span class="s2"> to column </span><span class="si">{</span><span class="n">int_col</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="c1"># Try to see if the window variable is an iterable</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">window</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span>
            <span class="k">for</span> <span class="n">function</span> <span class="ow">in</span> <span class="nb">iter</span><span class="p">(</span><span class="n">window</span><span class="p">):</span>
                <span class="n">intensity</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">filter_spectrum</span><span class="p">(</span><span class="n">intensity</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AssertionError</span><span class="p">:</span>
            <span class="c1"># In the event that window is not a list, just apply the filter</span>
            <span class="n">intensity</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">filter_spectrum</span><span class="p">(</span><span class="n">intensity</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="c1"># Windowed signal is usually too small for float printing in the html</span>
        <span class="c1"># report</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">int_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">intensity</span> <span class="o">*</span> <span class="mf">1000.0</span></div>

<div class="viewcode-block" id="AssignmentSession.splat_assign_spectrum"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.splat_assign_spectrum">[docs]</a>    <span class="k">def</span> <span class="nf">splat_assign_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">auto</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Alias for `process_splatalogue`. Function will be removed in a later version.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        auto : bool</span>
<span class="sd">            Specifies whether the assignment procedure is automatic.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_splatalogue</span><span class="p">(</span><span class="n">auto</span><span class="o">=</span><span class="n">auto</span><span class="p">)</span></div>

<div class="viewcode-block" id="AssignmentSession.process_clock_spurs"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.process_clock_spurs">[docs]</a>    <span class="k">def</span> <span class="nf">process_clock_spurs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method that will generate a LineList corresponding to possible</span>
<span class="sd">        harmonics, sum, and difference frequencies based on a given clock</span>
<span class="sd">        frequency (default: 65,000 MHz).</span>
<span class="sd">        </span>
<span class="sd">        It is advised to run this function at the end of assignments, owing</span>
<span class="sd">        to the sheer number of possible combinations of lines, which may</span>
<span class="sd">        interfere with real molecular features.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        kwargs</span>
<span class="sd">            Optional kwargs are passed into the creation of the LineList</span>
<span class="sd">            with `LineList.from_clock`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing electronics RFI peaks.&quot;</span><span class="p">)</span>
        <span class="n">clock_linelist</span> <span class="o">=</span> <span class="n">LineList</span><span class="o">.</span><span class="n">from_clock</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_linelist</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;Clock&quot;</span><span class="p">,</span> <span class="n">linelist</span><span class="o">=</span><span class="n">clock_linelist</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Done processing electronic RFI peaks.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AssignmentSession.process_splatalogue"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.process_splatalogue">[docs]</a>    <span class="k">def</span> <span class="nf">process_splatalogue</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">auto</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">progressbar</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Function that will provide an &quot;interface&quot; for interactive</span>
<span class="sd">            line assignment in a notebook environment.</span>

<span class="sd">            Basic functionality is looping over a series of peaks,</span>
<span class="sd">            which will query splatalogue for known transitions in the</span>
<span class="sd">            vicinity. If the line is known in Splatalogue, it will</span>
<span class="sd">            throw it into an Transition object and flag it as known.</span>
<span class="sd">            Conversely, if it&#39;s not known in Splatalogue it will defer</span>
<span class="sd">            assignment, flagging it as unassigned and dumping it into</span>
<span class="sd">            the `uline` attribute.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">         auto: bool</span>
<span class="sd">             If True the assignment process does not require user input, otherwise will prompt user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ulines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">[</span><span class="s2">&quot;Peaks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_ulines</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Beginning Splatalogue lookup on </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">ulines</span><span class="p">)</span><span class="si">}</span><span class="s2"> lines.&quot;</span><span class="p">)</span>
        <span class="n">iterator</span> <span class="o">=</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ulines</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">progressbar</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">iterator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">uline</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
            <span class="n">frequency</span> <span class="o">=</span> <span class="n">uline</span><span class="o">.</span><span class="n">frequency</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Searching for frequency </span><span class="si">{</span><span class="n">frequency</span><span class="si">:</span><span class="s2">,.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># Call splatalogue API to search for frequency</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">freq_abs</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">freq_prox</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">width</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">freq_prox</span> <span class="o">*</span> <span class="n">frequency</span>
            <span class="n">splat_df</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">search_center_frequency</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">splat_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># Filter out lines that are way too unlikely on grounds of temperature</span>
                <span class="n">splat_df</span> <span class="o">=</span> <span class="n">splat_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">splat_df</span><span class="p">[</span><span class="s2">&quot;E_U (K)&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_threshold</span><span class="p">]</span>
                <span class="c1"># Filter out quack elemental compositions</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">splat_df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
                    <span class="c1"># Convert the string into a chemical formula object</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># Clean vibrational state and torsional specification</span>
                        <span class="n">cation_flag</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">clean_formula</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;Species&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;v&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="c1"># Remove labels</span>
                        <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="p">[</span>
                            <span class="s2">&quot;l-&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;c-&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;t-&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;,&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;-gauche&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;cis-&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;trans-&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;trans&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;anti&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;sym&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;=&quot;</span><span class="p">,</span>
                        <span class="p">]:</span>
                            <span class="n">clean_formula</span> <span class="o">=</span> <span class="n">clean_formula</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="c1"># Remove the torsional states</span>
                        <span class="n">clean_formula</span> <span class="o">=</span> <span class="n">clean_formula</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="c1"># These are typically charged, and the chemical fomrula parsing does not play well</span>
                        <span class="k">if</span> <span class="s2">&quot;+&quot;</span> <span class="ow">in</span> <span class="n">clean_formula</span><span class="p">:</span>
                            <span class="n">cation_flag</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">clean_formula</span> <span class="o">=</span> <span class="n">clean_formula</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                        <span class="n">formula_obj</span> <span class="o">=</span> <span class="n">formula</span><span class="p">(</span><span class="n">clean_formula</span><span class="p">)</span>
                        <span class="c1"># Add the charge back on</span>
                        <span class="k">if</span> <span class="n">cation_flag</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">clean_formula</span> <span class="o">+=</span> <span class="s2">&quot;+&quot;</span>
                        <span class="c1"># Check if proposed molecule contains atoms not</span>
                        <span class="c1"># expected in composition</span>
                        <span class="n">comp_check</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">atom</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">composition</span>
                            <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">formula_obj</span><span class="o">.</span><span class="n">atoms</span>
                        <span class="p">)</span>
                        <span class="k">if</span> <span class="n">comp_check</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                            <span class="c1"># If there are crazy things in the mix, forget about it</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Molecule &quot;</span> <span class="o">+</span> <span class="n">clean_formula</span> <span class="o">+</span> <span class="s2">&quot; rejected.&quot;</span><span class="p">)</span>
                            <span class="n">splat_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                            <span class="s2">&quot;Could not parse molecule &quot;</span> <span class="o">+</span> <span class="n">clean_formula</span> <span class="o">+</span> <span class="s2">&quot; rejected.&quot;</span>
                        <span class="p">)</span>
                        <span class="n">splat_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">nitems</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">splat_df</span><span class="p">)</span>

                <span class="n">splat_df</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">calc_line_weighting</span><span class="p">(</span>
                    <span class="n">frequency</span><span class="p">,</span>
                    <span class="n">splat_df</span><span class="p">,</span>
                    <span class="n">prox</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">freq_prox</span><span class="p">,</span>
                    <span class="nb">abs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">freq_abs</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="n">splat_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">splat_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> candidates for frequency </span><span class="si">{</span><span class="n">frequency</span><span class="si">:</span><span class="s2">,.4f</span><span class="si">}</span><span class="s2">, index </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">.&quot;</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="n">splat_df</span><span class="o">.</span><span class="n">to_html</span><span class="p">()))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">auto</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                            <span class="c1"># If not automated, we need a human to look at frequencies</span>
                            <span class="c1"># Print the dataframe for notebook viewing</span>
                            <span class="n">splat_index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                                <span class="nb">input</span><span class="p">(</span>
                                    <span class="s2">&quot;Please choose an assignment index: 0 - &quot;</span>
                                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nitems</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="p">)</span>
                            <span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># If automated, choose closest frequency</span>
                            <span class="n">splat_index</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Index </span><span class="si">{</span><span class="n">splat_index</span><span class="si">}</span><span class="s2"> was chosen.&quot;</span><span class="p">)</span>
                        <span class="n">ass_df</span> <span class="o">=</span> <span class="n">splat_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[[</span><span class="n">splat_index</span><span class="p">]]</span>
                        <span class="n">splat_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;queries/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">experiment</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">,</span>
                            <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="p">)</span>
                        <span class="n">ass_dict</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;uline&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                            <span class="s2">&quot;frequency&quot;</span><span class="p">:</span> <span class="n">frequency</span><span class="p">,</span>
                            <span class="s2">&quot;intensity&quot;</span><span class="p">:</span> <span class="n">uline</span><span class="o">.</span><span class="n">intensity</span><span class="p">,</span>
                            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">ass_df</span><span class="p">[</span><span class="s2">&quot;Chemical Name&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                            <span class="s2">&quot;catalog_frequency&quot;</span><span class="p">:</span> <span class="n">ass_df</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                            <span class="s2">&quot;catalog_intensity&quot;</span><span class="p">:</span> <span class="n">ass_df</span><span class="p">[</span><span class="s2">&quot;CDMS/JPL Intensity&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                            <span class="s2">&quot;formula&quot;</span><span class="p">:</span> <span class="n">ass_df</span><span class="p">[</span><span class="s2">&quot;Species&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                            <span class="s2">&quot;r_qnos&quot;</span><span class="p">:</span> <span class="n">ass_df</span><span class="p">[</span><span class="s2">&quot;Resolved QNs&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                            <span class="c1"># &quot;S&quot;: ass_df[&quot;$S_{ij}^2 D^2$&quot;][0],</span>
                            <span class="s2">&quot;ustate_energy&quot;</span><span class="p">:</span> <span class="n">ass_df</span><span class="p">[</span><span class="s2">&quot;E_U (K)&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                            <span class="s2">&quot;weighting&quot;</span><span class="p">:</span> <span class="n">ass_df</span><span class="p">[</span><span class="s2">&quot;Weighting&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;CDMS/JPL&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;deviation&quot;</span><span class="p">:</span> <span class="n">frequency</span> <span class="o">-</span> <span class="n">ass_df</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                        <span class="p">}</span>
                        <span class="c1"># Update the Transition entry</span>
                        <span class="n">uline</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">ass_dict</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="c1"># If nothing matches, keep in the U-line</span>
                        <span class="c1"># pile.</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deferring assignment for index </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Throw into U-line pile if no matches at all</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No species known for </span><span class="si">{</span><span class="n">frequency</span><span class="si">:</span><span class="s2">,.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Splatalogue search finished.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AssignmentSession.overlay_molecule"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.overlay_molecule">[docs]</a>    <span class="k">def</span> <span class="nf">overlay_molecule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">species</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">freq_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=-</span><span class="mf">7.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to query splatalogue for a specific molecule. By default, the</span>
<span class="sd">        frequency range that will be requested corresponds to the spectral range</span>
<span class="sd">        available in the experiment.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        species : str</span>
<span class="sd">            Identifier for a specific molecule, typically name</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        FigureWidget</span>
<span class="sd">            Plotly FigureWidget that shows the experimental spectrum along</span>
<span class="sd">            with the detected peaks, and the molecule spectrum.</span>
<span class="sd">        DataFrame</span>
<span class="sd">            Pandas DataFrame from the Splatalogue query.</span>
<span class="sd">        </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        Exception</span>
<span class="sd">            If no species are found in the query, raises Exception.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">freq_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">freq_range</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
            <span class="p">]</span>
        <span class="n">molecule_df</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">search_molecule</span><span class="p">(</span><span class="n">species</span><span class="p">,</span> <span class="n">freq_range</span><span class="p">)</span>
        <span class="c1"># Threshold intensity</span>
        <span class="n">molecule_df</span> <span class="o">=</span> <span class="n">molecule_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">molecule_df</span><span class="p">[</span><span class="s2">&quot;CDMS/JPL Intensity&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">]</span>
        <span class="c1"># This prevents missing values from blowing up the normalization</span>
        <span class="n">molecule_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">molecule_df</span><span class="p">[</span><span class="s2">&quot;CDMS/JPL Intensity&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">][</span>
            <span class="s2">&quot;CDMS/JPL Intensity&quot;</span>
        <span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
        <span class="c1"># Calculate the real intensity and normalize</span>
        <span class="n">molecule_df</span><span class="p">[</span><span class="s2">&quot;Intensity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">**</span> <span class="n">molecule_df</span><span class="p">[</span><span class="s2">&quot;CDMS/JPL Intensity&quot;</span><span class="p">]</span>
        <span class="n">molecule_df</span><span class="p">[</span><span class="s2">&quot;Normalized&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">molecule_df</span><span class="p">[</span><span class="s2">&quot;Intensity&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">molecule_df</span><span class="p">[</span><span class="s2">&quot;Intensity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="c1"># Add annotations to the hovertext</span>
        <span class="n">molecule_df</span><span class="p">[</span><span class="s2">&quot;Annotation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">molecule_df</span><span class="p">[</span><span class="s2">&quot;Resolved QNs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;-&quot;</span>
            <span class="o">+</span> <span class="n">molecule_df</span><span class="p">[</span><span class="s2">&quot;E_U (K)&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">molecule_df</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot_spectrum</span><span class="p">()</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_bar</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">molecule_df</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">],</span>
                <span class="n">y</span><span class="o">=</span><span class="n">molecule_df</span><span class="p">[</span><span class="s2">&quot;Normalized&quot;</span><span class="p">],</span>
                <span class="n">hoverinfo</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="n">molecule_df</span><span class="p">[</span><span class="s2">&quot;Annotation&quot;</span><span class="p">],</span>
                <span class="n">name</span><span class="o">=</span><span class="n">species</span><span class="p">,</span>
                <span class="n">width</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">molecule_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;linelists/</span><span class="si">{</span><span class="n">species</span><span class="si">}</span><span class="s2">-splatalogue.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">molecule_df</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No molecules found in Splatalogue named </span><span class="si">{</span><span class="n">species</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AssignmentSession.process_linelist_batch"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.process_linelist_batch">[docs]</a>    <span class="k">def</span> <span class="nf">process_linelist_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_dict</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">yml_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function for processing a whole folder of catalog files. This takes a user-specified</span>
<span class="sd">        mapping scheme that will associate catalog files with molecule names, formulas, and</span>
<span class="sd">        any other `LineList`/`Transition` attributes. This can be in the form of a dictionary</span>
<span class="sd">        or a YAML file; one has to be provided.</span>
<span class="sd">        </span>
<span class="sd">        An example scheme is given here:</span>
<span class="sd">        {</span>
<span class="sd">            &quot;cyclopentadiene&quot;: {</span>
<span class="sd">                &quot;formula&quot;: &quot;c5h6&quot;,</span>
<span class="sd">                &quot;filepath&quot;: &quot;../data/catalogs/cyclopentadiene.cat&quot;</span>
<span class="sd">            }</span>
<span class="sd">        }</span>
<span class="sd">        The top dictionary has keys corresponding to the name of the molecule,</span>
<span class="sd">        and the value as a sub dictionary containing the formula and filepath</span>
<span class="sd">        to the catalog file as minimum input.</span>
<span class="sd">        </span>
<span class="sd">        You can also provide additional details that are `Transition` attributes:</span>
<span class="sd">        {</span>
<span class="sd">            &quot;benzene&quot;: {</span>
<span class="sd">                &quot;formula&quot;: &quot;c6h6&quot;,</span>
<span class="sd">                &quot;filepath&quot;: &quot;../data/catalogs/benzene.cat&quot;,</span>
<span class="sd">                &quot;smiles&quot;: &quot;c1ccccc1&quot;,</span>
<span class="sd">                &quot;publc&quot;: False</span>
<span class="sd">            }</span>
<span class="sd">        }</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        param_dict : dict or None, optional</span>
<span class="sd">            If not None, a dictionary containing the mapping scheme will be used</span>
<span class="sd">            to process the catalogs. Defaults to None.</span>
<span class="sd">        yml_path : str or None, optional</span>
<span class="sd">            If not None, corresponds to a str filepath to the YAML file to be read.</span>
<span class="sd">        kwargs</span>
<span class="sd">            Additional keyword arguments will be passed into the assignment process,</span>
<span class="sd">            which are the args for `process_linelist`.</span>
<span class="sd">            </span>
<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        ValueError : If yml_path and param_dict args are the same value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">param_dict</span> <span class="o">==</span> <span class="n">yml_path</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Please provide arguments to param_dict or yml_path.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">yml_path</span><span class="p">:</span>
            <span class="n">param_dict</span> <span class="o">=</span> <span class="n">routines</span><span class="o">.</span><span class="n">read_yaml</span><span class="p">(</span><span class="n">yml_path</span><span class="p">)</span>
            <span class="n">yml_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">yml_path</span><span class="p">)</span>
            <span class="n">root</span> <span class="o">=</span> <span class="n">yml_path</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">linelists</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">param_dict</span><span class="p">)</span><span class="si">}</span><span class="s2"> catalog entries in batch mode.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">subdict</span> <span class="ow">in</span> <span class="n">param_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Append the directory path to the catalog filepath</span>
                <span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;filepath&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">root</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;filepath&quot;</span><span class="p">]))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Creating LineList for molecule </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="n">extension</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">subdict</span><span class="p">[</span><span class="s2">&quot;filepath&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">suffix</span>
                <span class="k">if</span> <span class="n">extension</span> <span class="o">==</span> <span class="s2">&quot;.cat&quot;</span><span class="p">:</span>
                    <span class="n">func</span> <span class="o">=</span> <span class="n">LineList</span><span class="o">.</span><span class="n">from_catalog</span>
                <span class="k">elif</span> <span class="n">extension</span> <span class="o">==</span> <span class="s2">&quot;.lin&quot;</span><span class="p">:</span>
                    <span class="n">func</span> <span class="o">=</span> <span class="n">LineList</span><span class="o">.</span><span class="n">from_lin</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;File extension not recognized: </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> extension: </span><span class="si">{</span><span class="n">extension</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="n">linelist_obj</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">subdict</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">linelist_obj</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process_linelist</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">linelist_obj</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">linelist</span><span class="o">=</span><span class="n">linelist_obj</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not parse molecule </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Could not parse molecule </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> from dictionary.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Completed catalog batch analysis.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AssignmentSession.process_linelist"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.process_linelist">[docs]</a>    <span class="k">def</span> <span class="nf">process_linelist</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">formula</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">linelist</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">auto</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">thres</span><span class="o">=-</span><span class="mf">10.0</span><span class="p">,</span>
        <span class="n">progressbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">tol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        General purpose function for performing line assignments using local catalog and line data. The two main ways</span>
<span class="sd">        of running this function is to either provide a linelist or filepath argument. The type of linelist will be</span>
<span class="sd">        checked to determine how the catalog data will be processed: if it&#39;s a string, it will be used to use</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name: str, optional</span>
<span class="sd">            Name of the molecule being assigned. This should be specified when providing a new line list, which then</span>
<span class="sd">            gets added to the experiment.</span>
<span class="sd">        formula: str, optional</span>
<span class="sd">            Chemical formula for the molecule being assigned. Should be added in conjuction with name.</span>
<span class="sd">        filepath: str, optional</span>
<span class="sd">            If a linelist is not given, a filepath can be specified corresponding to a .cat or .lin file, which will</span>
<span class="sd">            be used to create a LineList object.</span>
<span class="sd">        linelist: str or LineList, optional</span>
<span class="sd">            Can be the name of a molecule or LineList object; the former is specified as a string which looks up the</span>
<span class="sd">            experiment line_list attribute for an existing LineList object. If a LineList object is provided, the</span>
<span class="sd">            function will use this directly.</span>
<span class="sd">        auto: bool, optional</span>
<span class="sd">            Specifies whether the assignment procedure works without intervention. If False, the user will be prompted</span>
<span class="sd">            to provide a candidate index.</span>
<span class="sd">        thres: float, optional</span>
<span class="sd">            log Intensity cut off used to screen candidates.</span>
<span class="sd">        progressbar: bool, optional</span>
<span class="sd">            If True, a tqdm progressbar will indicate assignment progress.</span>
<span class="sd">        tol: float, optional</span>
<span class="sd">            Tolerance for making assignments. If None, the function will default to the session-wide values of</span>
<span class="sd">            freq_abs and freq_prox to determine the tolerance.</span>
<span class="sd">        kwargs</span>
<span class="sd">            Kwargs are passed to the Transition object update when assignments are made.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># First case is if linelist is provided as a string corresponding to the key in the line_lists attribute</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing local catalog for molecule </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">linelist</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">linelist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">[</span><span class="n">linelist</span><span class="p">]</span>
        <span class="c1"># In the event that linelist is an actual LineList object</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">linelist</span><span class="p">)</span> <span class="o">==</span> <span class="n">LineList</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">linelist</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">[</span><span class="n">linelist</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">linelist</span>
        <span class="k">elif</span> <span class="n">filepath</span><span class="p">:</span>
            <span class="c1"># If a catalog is specified, create a LineList object with this catalog. The parser is inferred from the</span>
            <span class="c1"># file extension.</span>
            <span class="k">if</span> <span class="s2">&quot;.cat&quot;</span> <span class="ow">in</span> <span class="n">filepath</span><span class="p">:</span>
                <span class="n">func</span> <span class="o">=</span> <span class="n">LineList</span><span class="o">.</span><span class="n">from_catalog</span>
            <span class="k">elif</span> <span class="s2">&quot;.lin&quot;</span> <span class="ow">in</span> <span class="n">filepath</span><span class="p">:</span>
                <span class="n">func</span> <span class="o">=</span> <span class="n">LineList</span><span class="o">.</span><span class="n">from_lin</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                    <span class="s2">&quot;File extension for reference line list not recognized!&quot;</span>
                <span class="p">)</span>
            <span class="n">linelist</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">formula</span><span class="o">=</span><span class="n">formula</span><span class="p">,</span>
                <span class="n">filepath</span><span class="o">=</span><span class="n">filepath</span><span class="p">,</span>
                <span class="n">min_freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span>
                <span class="n">max_freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">linelist</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please specify an internal or external line list!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">linelist</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nassigned</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># Sort the LineList by intensity if possible. If the strongest line isn&#39;t</span>
            <span class="c1"># there, the other lines shouldn&#39;t be there</span>
            <span class="k">if</span> <span class="n">linelist</span><span class="o">.</span><span class="n">source</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Splatalogue&quot;</span><span class="p">,</span> <span class="s2">&quot;Catalog&quot;</span><span class="p">]:</span>
                <span class="n">linelist</span><span class="o">.</span><span class="n">transitions</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
                    <span class="n">linelist</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">line</span><span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">catalog_intensity</span>
                <span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="c1"># Filter out out-of-band stuff, but with some small tolerance extending</span>
            <span class="c1"># out just in case it&#39;s close</span>
            <span class="n">max_freq</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">[</span><span class="s2">&quot;Peaks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_frequencies</span><span class="p">())</span> <span class="o">*</span> <span class="mf">1.001</span>
            <span class="n">min_freq</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">[</span><span class="s2">&quot;Peaks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_frequencies</span><span class="p">())</span> <span class="o">*</span> <span class="mf">0.999</span>
            <span class="c1"># Make sure we&#39;re only assigning with in-band, has a suitable uncertainty,</span>
            <span class="c1"># and that the lower state energy is within range</span>
            <span class="n">transitions</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">transition</span>
                <span class="k">for</span> <span class="n">transition</span> <span class="ow">in</span> <span class="n">linelist</span><span class="o">.</span><span class="n">transitions</span>
                <span class="k">if</span> <span class="nb">all</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">min_freq</span> <span class="o">&lt;=</span> <span class="n">transition</span><span class="o">.</span><span class="n">catalog_frequency</span> <span class="o">&lt;=</span> <span class="n">max_freq</span><span class="p">,</span>
                        <span class="n">transition</span><span class="o">.</span><span class="n">uncertainty</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">max_uncertainty</span><span class="p">,</span>
                        <span class="n">transition</span><span class="o">.</span><span class="n">lstate_energy</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">t_threshold</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="p">]</span>
            <span class="c1"># Loop over the LineList lines</span>
            <span class="k">if</span> <span class="n">progressbar</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">iterator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">transitions</span><span class="p">)</span>
                <span class="n">iterator</span> <span class="o">=</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">iterator</span> <span class="o">=</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">transitions</span><span class="p">)</span>
            <span class="c1"># Loop over all of the U-lines</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">transition</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
                <span class="c1"># Control the flow so that we&#39;re not wasting time looking for lines if the strongest</span>
                <span class="c1"># transitions are not seen</span>
                <span class="c1"># if (index &gt; 5) and (nassigned == 0) and (linelist.source in [&quot;Catalog&quot;, &quot;Splatalogue&quot;]):</span>
                <span class="c1">#    self.logger.info(</span>
                <span class="c1">#    &quot;Searched for five strongest transitions in {linelist.name}, and nothing; aborting.&quot;</span>
                <span class="c1">#    )</span>
                <span class="c1">#    break</span>
                <span class="c1"># If no value of tolerance is provided, determine from the session</span>
                <span class="k">if</span> <span class="n">tol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">freq_abs</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">tol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">freq_prox</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">tol</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">freq_prox</span><span class="p">)</span> <span class="o">*</span> <span class="n">transition</span><span class="o">.</span><span class="n">frequency</span>
                <span class="c1"># Log the search</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Searching for frequency </span><span class="si">{</span><span class="n">transition</span><span class="o">.</span><span class="n">catalog_frequency</span><span class="si">:</span><span class="s2">,.4f</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; with tolerances: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">t_threshold</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> K, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot; +/-</span><span class="si">{</span><span class="n">tol</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2"> MHz, </span><span class="si">{</span><span class="n">thres</span><span class="si">}</span><span class="s2"> intensity.&quot;</span>
                <span class="p">)</span>
                <span class="c1"># Find transitions in the peak list that might match</span>
                <span class="n">can_pkg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">[</span><span class="s2">&quot;Peaks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">find_candidates</span><span class="p">(</span>
                    <span class="n">transition</span><span class="o">.</span><span class="n">catalog_frequency</span><span class="p">,</span>
                    <span class="n">lstate_threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">t_threshold</span><span class="p">,</span>
                    <span class="n">freq_tol</span><span class="o">=</span><span class="n">tol</span><span class="p">,</span>
                    <span class="n">int_tol</span><span class="o">=</span><span class="n">thres</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># If there are actual candidates instead of NoneType, we can process it.</span>
                <span class="k">if</span> <span class="n">can_pkg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">candidates</span><span class="p">,</span> <span class="n">weighting</span> <span class="o">=</span> <span class="n">can_pkg</span>
                    <span class="n">ncandidates</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="n">ncandidates</span><span class="si">}</span><span class="s2"> possible matches.&quot;</span><span class="p">)</span>
                    <span class="n">make_assignment</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># If auto mode or if there&#39;s just one candidate, just take the highest weighting</span>
                    <span class="k">if</span> <span class="n">auto</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">chosen</span> <span class="o">=</span> <span class="n">candidates</span><span class="p">[</span><span class="n">weighting</span><span class="o">.</span><span class="n">argmax</span><span class="p">()]</span>
                        <span class="k">if</span> <span class="n">chosen</span><span class="o">.</span><span class="n">uline</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                            <span class="c1"># If this line has previously been assigned, then we</span>
                            <span class="c1"># fill up the multiple &quot;buffer&quot;</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">chosen</span><span class="o">.</span><span class="n">check_molecule</span><span class="p">(</span><span class="n">transition</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">transition</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">chosen</span><span class="o">.</span><span class="n">multiple</span><span class="p">:</span>
                                    <span class="c1"># Only add more transitions if this is a</span>
                                    <span class="c1"># different molecule and it&#39;s not already in</span>
                                    <span class="c1"># the list</span>
                                    <span class="n">chosen</span><span class="o">.</span><span class="n">multiple</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">transition</span><span class="p">)</span>
                            <span class="n">make_assignment</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">elif</span> <span class="n">auto</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">cand_idx</span><span class="p">,</span> <span class="n">candidate</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">candidates</span><span class="p">):</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">cand_idx</span><span class="p">,</span> <span class="n">candidate</span><span class="p">)</span>
                        <span class="n">chosen_idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span>
                            <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Please specify the candidate index.   &quot;</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">chosen</span> <span class="o">=</span> <span class="n">candidates</span><span class="p">[</span><span class="n">chosen_idx</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">make_assignment</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;Assigning </span><span class="si">{</span><span class="n">transition</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot; (catalog </span><span class="si">{</span><span class="n">transition</span><span class="o">.</span><span class="n">catalog_frequency</span><span class="si">:</span><span class="s2">,.4f</span><span class="si">}</span><span class="s2">)&quot;</span>
                            <span class="sa">f</span><span class="s2">&quot; to peak </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2"> at </span><span class="si">{</span><span class="n">chosen</span><span class="o">.</span><span class="n">frequency</span><span class="si">:</span><span class="s2">,.4f</span><span class="si">}</span><span class="s2">.&quot;</span>
                        <span class="p">)</span>
                        <span class="c1"># Create a copy of the Transition data from the LineList</span>
                        <span class="n">assign_dict</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="n">transition</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
                        <span class="c1"># Update with the measured frequency and intensity</span>
                        <span class="n">assign_dict</span><span class="p">[</span><span class="s2">&quot;frequency&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chosen</span><span class="o">.</span><span class="n">frequency</span>
                        <span class="n">assign_dict</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chosen</span><span class="o">.</span><span class="n">intensity</span>
                        <span class="n">assign_dict</span><span class="p">[</span><span class="s2">&quot;experiment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chosen</span><span class="o">.</span><span class="n">experiment</span>
                        <span class="n">assign_dict</span><span class="p">[</span><span class="s2">&quot;velocity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">velocity</span>
                        <span class="n">assign_dict</span><span class="p">[</span><span class="s2">&quot;peak_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">chosen</span><span class="o">.</span><span class="n">peak_id</span>
                        <span class="n">assign_dict</span><span class="p">[</span><span class="s2">&quot;uline&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="c1"># Add any other additional kwargs</span>
                        <span class="n">assign_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                        <span class="c1"># Copy over the information from the assignment, and update</span>
                        <span class="c1"># the experimental peak information with the assignment</span>
                        <span class="n">chosen</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">assign_dict</span><span class="p">)</span>
                        <span class="n">nassigned</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Assigned </span><span class="si">{</span><span class="n">nassigned</span><span class="si">}</span><span class="s2"> new transitions to </span><span class="si">{</span><span class="n">linelist</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;LineList was empty, and no lines were assigned.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AssignmentSession.process_db"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.process_db">[docs]</a>    <span class="k">def</span> <span class="nf">process_db</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">auto</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dbpath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function for assigning peaks based on a local database file.</span>
<span class="sd">        The database is controlled with the SpectralCatalog class, which will handle all of the searching.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        auto : bool, optional</span>
<span class="sd">            If True, the assignments are made automatically.</span>
<span class="sd">        dbpath : str or None, optional</span>
<span class="sd">            Filepath to the local database. If none is supplied, uses the default value from the user&#39;s home directory.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Get the U-line list</span>
        <span class="n">ulines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Peaks&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">get_ulines</span><span class="p">()</span>
        <span class="n">old_nulines</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ulines</span><span class="o">.</span><span class="n">get_ulines</span><span class="p">())</span>
        <span class="n">db</span> <span class="o">=</span> <span class="n">database</span><span class="o">.</span><span class="n">SpectralCatalog</span><span class="p">(</span><span class="n">dbpath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Processing local database: </span><span class="si">{</span><span class="n">dbpath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">uline</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">ulines</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Searching database for </span><span class="si">{</span><span class="n">uline</span><span class="o">.</span><span class="n">frequency</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">catalog_df</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">search_frequency</span><span class="p">(</span>
                <span class="n">uline</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">freq_prox</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">freq_abs</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">catalog_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">catalog_df</span><span class="p">[</span><span class="s2">&quot;frequency&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">catalog_df</span><span class="p">[</span><span class="s2">&quot;frequency&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span>
                    <span class="n">catalog_df</span><span class="p">[</span><span class="s2">&quot;catalog_frequency&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">catalog_df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">sliced_catalog</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">line_weighting</span><span class="p">(</span>
                        <span class="n">uline</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span>
                        <span class="n">catalog_df</span><span class="p">,</span>
                        <span class="n">prox</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">freq_prox</span><span class="p">,</span>
                        <span class="nb">abs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">freq_abs</span><span class="p">,</span>
                        <span class="n">freq_col</span><span class="o">=</span><span class="s2">&quot;frequency&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">display</span><span class="p">(</span><span class="n">HTML</span><span class="p">(</span><span class="n">sliced_catalog</span><span class="o">.</span><span class="n">to_html</span><span class="p">()))</span>
                    <span class="k">if</span> <span class="n">auto</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                        <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Please choose a candidate by index.&quot;</span><span class="p">))</span>
                    <span class="k">elif</span> <span class="n">auto</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                        <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">catalog_df</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                        <span class="n">select_df</span> <span class="o">=</span> <span class="n">catalog_df</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                        <span class="c1"># Create an approximate quantum number string</span>
                        <span class="n">new_dict</span> <span class="o">=</span> <span class="p">{</span>
                            <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="n">index</span><span class="p">,</span>
                            <span class="s2">&quot;frequency&quot;</span><span class="p">:</span> <span class="n">uline</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span>
                            <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="s2">&quot;Database&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;deviation&quot;</span><span class="p">:</span> <span class="n">uline</span><span class="o">.</span><span class="n">frequency</span> <span class="o">-</span> <span class="n">select_df</span><span class="p">[</span><span class="s2">&quot;frequency&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;uline&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                        <span class="p">}</span>
                        <span class="n">assign_dict</span> <span class="o">=</span> <span class="n">select_df</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
                        <span class="n">assign_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">new_dict</span><span class="p">)</span>
                        <span class="c1"># Use assign_line function to mark peak as assigned</span>
                        <span class="n">uline</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">assign_dict</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span><span class="s2">&quot;Invalid index chosen for assignment.&quot;</span><span class="p">)</span>
        <span class="c1"># Update the internal table</span>
        <span class="n">ass_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">ass_obj</span><span class="o">.</span><span class="vm">__dict__</span> <span class="k">for</span> <span class="n">ass_obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignments</span><span class="p">])</span>
        <span class="n">remaining_ulines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Peaks&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_ulines</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">ass_df</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Prior number of ulines: </span><span class="si">{</span><span class="n">old_nulines</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Current number of ulines: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">remaining_ulines</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Finished processing local database.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AssignmentSession.copy_assignments"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.copy_assignments">[docs]</a>    <span class="k">def</span> <span class="nf">copy_assignments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="s2">&quot;AssignmentSession&quot;</span><span class="p">,</span> <span class="n">thres_prox</span><span class="o">=</span><span class="mf">1e-2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to copy assignments from another experiment. This class</span>
<span class="sd">        method wraps two analysis routines: first, correlations in detected</span>
<span class="sd">        peaks are found, and indexes of where correlations are found will be</span>
<span class="sd">        used to locate the corresponding Transition object, and copy its data</span>
<span class="sd">        over to the current experiment.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        other : AssignmentSession object</span>
<span class="sd">            The reference AssignmentSession object to copy assignments from</span>
<span class="sd">        thres_prox : float, optional</span>
<span class="sd">            Threshold for considering coincidences between spectra.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Copying assignments from Experiment </span><span class="si">{</span><span class="n">other</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">experiment</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">correlate_experiments</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">],</span> <span class="n">thres_prox</span><span class="o">=</span><span class="n">thres_prox</span>
        <span class="p">)</span>
        <span class="c1"># Get the correlation matrix</span>
        <span class="n">corr_mat</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="n">other</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">experiment</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">analysis</span><span class="o">.</span><span class="n">copy_assignments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">corr_mat</span><span class="p">)</span>
        <span class="n">n_assign</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">corr_mat</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Copied </span><span class="si">{</span><span class="n">n_assign</span><span class="si">}</span><span class="s2"> assignments.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AssignmentSession.blank_spectrum"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.blank_spectrum">[docs]</a>    <span class="k">def</span> <span class="nf">blank_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">noise</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">noise_std</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Blanks a spectrum based on the lines already previously assigned. The required arguments are the average</span>
<span class="sd">        and standard deviation of the noise, typically estimated by picking a region free of spectral features.</span>

<span class="sd">        The spectra are sequentially blanked - online catalogs first, followed by literature species, finally the</span>
<span class="sd">        private assignments.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        noise - float</span>
<span class="sd">            Average noise value for the spectrum. Typically measured by choosing a region void of spectral lines.</span>
<span class="sd">        noise_std - float</span>
<span class="sd">            Standard deviation for the spectrum noise.</span>
<span class="sd">        window - float</span>
<span class="sd">            Value to use for the range to blank. This region blanked corresponds to frequency+/-window.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;CDMS/JPL&quot;</span><span class="p">,</span> <span class="s2">&quot;Literature&quot;</span><span class="p">,</span> <span class="s2">&quot;New&quot;</span><span class="p">]</span>
        <span class="n">slices</span> <span class="o">=</span> <span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;CDMS/JPL&quot;</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;CDMS/JPL&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;public&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>
            <span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;CDMS/JPL&quot;</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;public&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">)</span>
            <span class="p">],</span>
        <span class="p">]</span>
        <span class="n">last_source</span> <span class="o">=</span> <span class="s2">&quot;Catalog&quot;</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">source</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">slices</span><span class="p">,</span> <span class="n">sources</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">reference</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_col</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">reference</span> <span class="o">=</span> <span class="n">last_source</span>
                    <span class="n">blanked_spectrum</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">blank_spectrum</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;frequency&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                        <span class="n">noise</span><span class="p">,</span>
                        <span class="n">noise_std</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">freq_col</span><span class="p">,</span>
                        <span class="n">reference</span><span class="p">,</span>
                        <span class="n">window</span><span class="p">,</span>
                        <span class="n">df</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">source</span><span class="p">]</span> <span class="o">=</span> <span class="n">blanked_spectrum</span>
                    <span class="n">last_source</span> <span class="o">=</span> <span class="n">source</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Could not blank spectrum </span><span class="si">{</span><span class="n">last_source</span><span class="si">}</span><span class="s2"> with </span><span class="si">{</span><span class="n">source</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_assigned_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method for getting all the unique molecules out</span>
<span class="sd">            of the assignments, and tally up the counts.</span>

<span class="sd">            :return identifications: dict containing a tally of molecules</span>
<span class="sd">                                     identified</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">ass_obj</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">ass_obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">[</span><span class="s2">&quot;Peaks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_assignments</span><span class="p">()]</span>
        <span class="c1"># Get unique names</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">seen_add</span> <span class="o">=</span> <span class="n">seen</span><span class="o">.</span><span class="n">add</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span> <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">name</span> <span class="ow">in</span> <span class="n">seen</span> <span class="ow">or</span> <span class="n">seen_add</span><span class="p">(</span><span class="n">name</span><span class="p">))]</span>
        <span class="c1"># Tally up the molecules</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">identifications</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">names</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">}</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifications</span>

<div class="viewcode-block" id="AssignmentSession.create_uline_ftb_batch"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.create_uline_ftb_batch">[docs]</a>    <span class="k">def</span> <span class="nf">create_uline_ftb_batch</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">shots</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
        <span class="n">dipole</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">threshold</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
        <span class="n">sort_int</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">atten</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an FTB file for use in QtFTM based on the remaining ulines. This is used to provide cavity</span>
<span class="sd">        frequencies.</span>
<span class="sd">        </span>
<span class="sd">        If a filepath is not specified, a -uline.ftb file will be created in the</span>
<span class="sd">        ftb folder.</span>
<span class="sd">        </span>
<span class="sd">        The user has the ability to control parameters of the batch by setting</span>
<span class="sd">        a global shot count, dipole moment, and minimum intensity value for</span>
<span class="sd">        creation.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath : str or None, optional</span>
<span class="sd">            Path to save the .ftb file to. If None, defaults to the session ID.</span>
<span class="sd">        shots : int, optional</span>
<span class="sd">            Number of shots to integrate on each frequency</span>
<span class="sd">        dipole : float, optional</span>
<span class="sd">            Dipole moment in Debye attenuation target for each frequency</span>
<span class="sd">        threshold : float, optional</span>
<span class="sd">            Minimum value for the line intensity to be considered. For example,</span>
<span class="sd">            if the spectrum is analyzed in units of SNR, this would be the minimum</span>
<span class="sd">            value of SNR to consider in the FTB file.</span>
<span class="sd">        sort_int : bool, optional</span>
<span class="sd">            If True, sorts the FTB entries in descending intensity order.</span>
<span class="sd">        atten : None or int, optional</span>
<span class="sd">            Value to use for the attenuation, overwriting the `dipole` argument. This is</span>
<span class="sd">            useful for forcing cavity power in the high band.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filepath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;./ftb/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">experiment</span><span class="si">}</span><span class="s2">-ulines.ftb&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">transitions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">[</span><span class="s2">&quot;Peaks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_ulines</span><span class="p">()</span>
        <span class="n">transitions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">transition</span>
            <span class="k">for</span> <span class="n">transition</span> <span class="ow">in</span> <span class="n">transitions</span>
            <span class="k">if</span> <span class="n">transition</span><span class="o">.</span><span class="n">intensity</span> <span class="o">&gt;=</span> <span class="n">threshold</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">atten</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">atten</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span>
            <span class="n">ftb_settings</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;atten&quot;</span><span class="p">:</span> <span class="n">atten</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ftb_settings</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;dipole&quot;</span><span class="p">:</span> <span class="n">dipole</span><span class="p">}</span>
        <span class="c1"># Sort the intensities such that the strongest ones are scanned first.</span>
        <span class="k">if</span> <span class="n">sort_int</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">transitions</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">transitions</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">line</span><span class="p">:</span> <span class="n">line</span><span class="o">.</span><span class="n">intensity</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">uline</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">transitions</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">uline</span><span class="o">.</span><span class="n">intensity</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">:</span>
                <span class="n">lines</span> <span class="o">+=</span> <span class="n">fa</span><span class="o">.</span><span class="n">generate_ftb_line</span><span class="p">(</span><span class="n">uline</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span> <span class="n">shots</span><span class="p">,</span> <span class="o">**</span><span class="n">ftb_settings</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">write_file</span><span class="p">:</span>
            <span class="n">write_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

<div class="viewcode-block" id="AssignmentSession.create_uline_dr_batch"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.create_uline_dr_batch">[docs]</a>    <span class="k">def</span> <span class="nf">create_uline_dr_batch</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">select</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">shots</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
        <span class="n">dipole</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">min_dist</span><span class="o">=</span><span class="mf">500.0</span><span class="p">,</span>
        <span class="n">thres</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">atten</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">drpower</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an FTB batch file for use in QtFTM to perform a DR experiment.</span>
<span class="sd">        A list of selected frequencies can be used as the cavity frequencies, which will</span>
<span class="sd">        subsequently be exhaustively DR&#39;d against by all of the U-line frequencies</span>
<span class="sd">        remaining in this experiment.</span>

<span class="sd">        The file is then saved to &quot;ftb/XXX-dr.ftb&quot;.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath: str, optional</span>
<span class="sd">            Path to save the ftb file to. Defaults to ftb/{}-dr.ftb</span>
<span class="sd">        select: list of floats, optional</span>
<span class="sd">            List of frequencies to use as cavity frequencies. Defaults to None, which</span>
<span class="sd">            will just DR every frequency against each other.</span>
<span class="sd">        shots: int, optional</span>
<span class="sd">            Number of integration shots</span>
<span class="sd">        dipole: float, optional</span>
<span class="sd">            Dipole moment used for attenuation setting</span>
<span class="sd">        gap: float, optional</span>
<span class="sd">            Minimum frequency difference between cavity and DR frequency to actually perform</span>
<span class="sd">            the experiment</span>
<span class="sd">        thres: None or float, optional</span>
<span class="sd">            Minimum value in absolute intensity units to consider in the DR</span>
<span class="sd">            batch. If None, this is ignored (default).</span>
<span class="sd">        atten: None or int, optional</span>
<span class="sd">            Value to use for the attenuation, overwriting the `dipole` argument. This is</span>
<span class="sd">            useful for forcing cavity power in the high band.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ulines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">[</span><span class="s2">&quot;Peaks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_ulines</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">select</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cavity_freqs</span> <span class="o">=</span> <span class="p">[</span><span class="n">uline</span><span class="o">.</span><span class="n">frequency</span> <span class="k">for</span> <span class="n">uline</span> <span class="ow">in</span> <span class="n">ulines</span><span class="p">]</span>
            <span class="n">dr_freqs</span> <span class="o">=</span> <span class="p">[</span><span class="n">uline</span><span class="o">.</span><span class="n">frequency</span> <span class="k">for</span> <span class="n">uline</span> <span class="ow">in</span> <span class="n">ulines</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cavity_freqs</span> <span class="o">=</span> <span class="n">select</span>
            <span class="n">dr_freqs</span> <span class="o">=</span> <span class="n">select</span>
        <span class="k">if</span> <span class="n">thres</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">intensities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">uline</span><span class="o">.</span><span class="n">intensity</span> <span class="k">for</span> <span class="n">uline</span> <span class="ow">in</span> <span class="n">ulines</span><span class="p">])</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">intensities</span> <span class="o">&gt;=</span> <span class="n">thres</span><span class="p">)</span>
            <span class="n">dr_freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">dr_freqs</span><span class="p">)[</span><span class="n">mask</span><span class="p">]</span>
            <span class="n">cavity_freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">cavity_freqs</span><span class="p">)</span>
        <span class="n">ftb_settings</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;drpower&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;skiptune&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;dipole&quot;</span><span class="p">:</span> <span class="n">dipole</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">atten</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">atten</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span>
            <span class="k">del</span> <span class="n">ftb_settings</span><span class="p">[</span><span class="s2">&quot;dipole&quot;</span><span class="p">]</span>
            <span class="n">ftb_settings</span><span class="p">[</span><span class="s2">&quot;atten&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">atten</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">for</span> <span class="n">cindex</span><span class="p">,</span> <span class="n">cavity</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cavity_freqs</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">dindex</span><span class="p">,</span> <span class="n">dr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dr_freqs</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">dindex</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ftb_settings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="s2">&quot;drpower&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;skiptune&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
                    <span class="n">lines</span> <span class="o">+=</span> <span class="n">fa</span><span class="o">.</span><span class="n">generate_ftb_line</span><span class="p">(</span><span class="n">cavity</span><span class="p">,</span> <span class="n">shots</span><span class="p">,</span> <span class="o">**</span><span class="n">ftb_settings</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cavity</span> <span class="o">-</span> <span class="n">dr</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">min_dist</span><span class="p">:</span>
                    <span class="n">ftb_settings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="o">**</span><span class="p">{</span><span class="s2">&quot;drpower&quot;</span><span class="p">:</span> <span class="n">drpower</span><span class="p">,</span> <span class="s2">&quot;skiptune&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;drfreq&quot;</span><span class="p">:</span> <span class="n">dr</span><span class="p">}</span>
                    <span class="p">)</span>
                    <span class="n">lines</span> <span class="o">+=</span> <span class="n">fa</span><span class="o">.</span><span class="n">generate_ftb_line</span><span class="p">(</span><span class="n">cavity</span><span class="p">,</span> <span class="n">shots</span><span class="p">,</span> <span class="o">**</span><span class="n">ftb_settings</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filepath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ftb/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">experiment</span><span class="si">}</span><span class="s2">-dr.ftb&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">write_file</span><span class="p">:</span>
            <span class="n">write_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

<div class="viewcode-block" id="AssignmentSession.create_full_dr_batch"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.create_full_dr_batch">[docs]</a>    <span class="k">def</span> <span class="nf">create_full_dr_batch</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">cavity_freqs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">shots</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
        <span class="n">dipole</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
        <span class="n">min_dist</span><span class="o">=</span><span class="mf">500.0</span><span class="p">,</span>
        <span class="n">atten</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">drpower</span><span class="o">=</span><span class="mi">13</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create an FTB batch file for use in QtFTM to perform a DR experiment.</span>
<span class="sd">        A list of selected frequencies can be used as the cavity frequencies, which will</span>
<span class="sd">        subsequently be exhaustively DR&#39;d against by ALL frequencies in the</span>
<span class="sd">        experiment.</span>

<span class="sd">        The file is then saved to &quot;ftb/XXX-full-dr.ftb&quot;.</span>
<span class="sd">        </span>
<span class="sd">        The ``atten`` parameter provides a more direct way to control RF power;</span>
<span class="sd">        if this value is used, it will overwrite the dipole moment setting.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cavity_freqs : iterable of floats</span>
<span class="sd">            Iterable of frequencies to tune to, in MHz.</span>
<span class="sd">        filepath : str, optional</span>
<span class="sd">            Path to save the ftb file to. Defaults to ftb/{}-dr.ftb</span>
<span class="sd">        shots : int, optional</span>
<span class="sd">            Number of integration shots</span>
<span class="sd">        dipole : float, optional</span>
<span class="sd">            Dipole moment used for attenuation setting</span>
<span class="sd">        min_dist : float, optional</span>
<span class="sd">            Minimum frequency difference between cavity and DR frequency to actually perform</span>
<span class="sd">            the experiment</span>
<span class="sd">        atten : None or int, optional</span>
<span class="sd">            Value to set the rf attenuation. By default, this is None, which will use the</span>
<span class="sd">            dipole moment instead to set the rf power. If a value is provided, it will</span>
<span class="sd">            overwrite whatever the dipole moment setting is.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dr_freqs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">[</span><span class="s2">&quot;Peaks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_frequencies</span><span class="p">())</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">ftb_settings</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;drpower&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;skiptune&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;dipole&quot;</span><span class="p">:</span> <span class="n">dipole</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">atten</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="nb">type</span><span class="p">(</span><span class="n">atten</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span>
            <span class="k">del</span> <span class="n">ftb_settings</span><span class="p">[</span><span class="s2">&quot;dipole&quot;</span><span class="p">]</span>
            <span class="n">ftb_settings</span><span class="p">[</span><span class="s2">&quot;atten&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">atten</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">cindex</span><span class="p">,</span> <span class="n">cavity</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cavity_freqs</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">dindex</span><span class="p">,</span> <span class="n">dr</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dr_freqs</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">dindex</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ftb_settings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="s2">&quot;drpower&quot;</span><span class="p">:</span> <span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="s2">&quot;skiptune&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
                    <span class="n">lines</span> <span class="o">+=</span> <span class="n">fa</span><span class="o">.</span><span class="n">generate_ftb_line</span><span class="p">(</span><span class="n">cavity</span><span class="p">,</span> <span class="n">shots</span><span class="p">,</span> <span class="o">**</span><span class="n">ftb_settings</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">cavity</span> <span class="o">-</span> <span class="n">dr</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">min_dist</span><span class="p">:</span>
                    <span class="n">ftb_settings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                        <span class="o">**</span><span class="p">{</span><span class="s2">&quot;drpower&quot;</span><span class="p">:</span> <span class="n">drpower</span><span class="p">,</span> <span class="s2">&quot;skiptune&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;drfreq&quot;</span><span class="p">:</span> <span class="n">dr</span><span class="p">}</span>
                    <span class="p">)</span>
                    <span class="n">lines</span> <span class="o">+=</span> <span class="n">fa</span><span class="o">.</span><span class="n">generate_ftb_line</span><span class="p">(</span><span class="n">cavity</span><span class="p">,</span> <span class="n">shots</span><span class="p">,</span> <span class="o">**</span><span class="n">ftb_settings</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filepath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ftb/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">experiment</span><span class="si">}</span><span class="s2">-full-dr.ftb&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">write_file</span><span class="p">:</span>
            <span class="n">write_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span></div>

<div class="viewcode-block" id="AssignmentSession.analyze_molecule"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.analyze_molecule">[docs]</a>    <span class="k">def</span> <span class="nf">analyze_molecule</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">Q</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">T</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">formula</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">smiles</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">chi_thres</span><span class="o">=</span><span class="mf">10.0</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function for providing some astronomically relevant parameters by analyzing Gaussian line shapes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Q - float</span>
<span class="sd">            Partition function at temperature T</span>
<span class="sd">        T - float</span>
<span class="sd">            Temperature in Kelvin</span>
<span class="sd">        name - str, optional</span>
<span class="sd">            Name of the molecule to perform the analysis on. Can be used as a selector.</span>
<span class="sd">        formula - str, optional</span>
<span class="sd">            Chemical formula of the molecule to perform the analysis on. Can be used as a selector.</span>
<span class="sd">        smiles - str, optional</span>
<span class="sd">            SMILES code of the molecule to perform the analysis on. Can be used as a selector,</span>
<span class="sd">        chi_thres - float</span>
<span class="sd">            Threshold for the Chi Squared value to consider fits for statistics. Any instances of fits with Chi</span>
<span class="sd">            squared values above this value will not be used to calculate line profile statistics.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        return_data - list</span>
<span class="sd">            First element is the profile dataframe, and second element is the fitted velocity.</span>
<span class="sd">            If a rotational temperature analysis is also performed, the third element will be the least-squares</span>
<span class="sd">            regression.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">selector</span> <span class="o">=</span> <span class="s2">&quot;name&quot;</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">elif</span> <span class="n">formula</span><span class="p">:</span>
            <span class="n">selector</span> <span class="o">=</span> <span class="s2">&quot;formula&quot;</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">formula</span>
        <span class="k">elif</span> <span class="n">smiles</span><span class="p">:</span>
            <span class="n">selector</span> <span class="o">=</span> <span class="s2">&quot;smiles&quot;</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">smiles</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;No valid selector specified! Please give a name, formula, or SMILES code.&quot;</span>
            <span class="p">)</span>
        <span class="c1"># Loop over all of the assignments</span>
        <span class="n">mol_data</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">ass_obj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assignments</span><span class="p">):</span>
            <span class="c1"># If the assignment matches the criteria</span>
            <span class="c1"># we perform the analysis</span>
            <span class="k">if</span> <span class="n">ass_obj</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">selector</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Performing line profile analysis on assignment index </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
                <span class="c1"># Perform a Gaussian fit whilst supplying as much information as we can</span>
                <span class="c1"># The width is excluded because it changes significantly between line profiles</span>
                <span class="n">fit_result</span><span class="p">,</span> <span class="n">summary</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">fit_line_profile</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                    <span class="n">center</span><span class="o">=</span><span class="n">ass_obj</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span>
                    <span class="n">intensity</span><span class="o">=</span><span class="n">ass_obj</span><span class="o">.</span><span class="n">intensity</span><span class="p">,</span>
                    <span class="n">freq_col</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_col</span><span class="p">,</span>
                    <span class="n">int_col</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">int_col</span><span class="p">,</span>
                    <span class="n">logger</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="c1"># If the fit actually converged and worked</span>
                <span class="k">if</span> <span class="n">fit_result</span><span class="p">:</span>
                    <span class="c1"># Calculate what the lab frame frequency would be in order to calculate the frequency offset</span>
                    <span class="n">lab_freq</span> <span class="o">=</span> <span class="n">fit_result</span><span class="o">.</span><span class="n">best_values</span><span class="p">[</span><span class="s2">&quot;center&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">units</span><span class="o">.</span><span class="n">dop2freq</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">velocity</span><span class="p">,</span> <span class="n">fit_result</span><span class="o">.</span><span class="n">best_values</span><span class="p">[</span><span class="s2">&quot;center&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;Frequency offset&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lab_freq</span> <span class="o">-</span> <span class="n">ass_obj</span><span class="o">.</span><span class="n">catalog_frequency</span>
                    <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;Doppler velocity&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">freq2vel</span><span class="p">(</span>
                        <span class="n">ass_obj</span><span class="o">.</span><span class="n">catalog_frequency</span><span class="p">,</span> <span class="n">summary</span><span class="p">[</span><span class="s2">&quot;Frequency offset&quot;</span><span class="p">]</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="n">Q</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">T</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="c1"># Add the profile parameters to list</span>
                        <span class="n">profile_dict</span> <span class="o">=</span> <span class="n">aa</span><span class="o">.</span><span class="n">lineprofile_analysis</span><span class="p">(</span>
                            <span class="n">fit_result</span><span class="p">,</span> <span class="n">ass_obj</span><span class="o">.</span><span class="n">I</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">ass_obj</span><span class="o">.</span><span class="n">ustate_energy</span>
                        <span class="p">)</span>
                        <span class="n">ass_obj</span><span class="o">.</span><span class="n">N</span> <span class="o">=</span> <span class="n">profile_dict</span><span class="p">[</span><span class="s2">&quot;N cm$^{-2}$&quot;</span><span class="p">]</span>
                        <span class="n">summary</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">profile_dict</span><span class="p">)</span>
                    <span class="n">ass_obj</span><span class="o">.</span><span class="n">fit</span> <span class="o">=</span> <span class="n">fit_result</span>
                    <span class="n">mol_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>
        <span class="c1"># If there are successful analyses performed, format the results</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mol_data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">profile_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">mol_data</span><span class="p">)</span>
            <span class="c1"># Sort the dataframe by ascending order of chi square - better fits are at the top</span>
            <span class="n">profile_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;Chi squared&quot;</span><span class="p">],</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># Threshold the dataframe to ensure good statistics</span>
            <span class="n">profile_df</span> <span class="o">=</span> <span class="n">profile_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">profile_df</span><span class="p">[</span><span class="s2">&quot;Chi squared&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">chi_thres</span><span class="p">]</span>
            <span class="c1"># Calculate the weighted average VLSR based on the goodness-of-fit</span>
            <span class="n">profile_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;Weight&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">profile_df</span><span class="p">[</span><span class="s2">&quot;Chi squared&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">/</span> <span class="n">profile_df</span><span class="p">[</span><span class="s2">&quot;Chi squared&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
            <span class="p">)</span>
            <span class="n">weighted_avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">profile_df</span><span class="p">[</span><span class="s2">&quot;Weight&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">profile_df</span><span class="p">[</span><span class="s2">&quot;Doppler velocity&quot;</span><span class="p">]</span>
            <span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">profile_df</span><span class="p">[</span><span class="s2">&quot;Weight&quot;</span><span class="p">])</span>
            <span class="c1"># Calculate the weighted standard deviation</span>
            <span class="n">stdev</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">profile_df</span><span class="p">[</span><span class="s2">&quot;Weight&quot;</span><span class="p">]</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">profile_df</span><span class="p">[</span><span class="s2">&quot;Doppler velocity&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">weighted_avg</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>
            <span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">profile_df</span><span class="p">[</span><span class="s2">&quot;Weight&quot;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Calculated VLSR: </span><span class="si">{</span><span class="n">weighted_avg</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">+/-</span><span class="si">{</span><span class="n">stdev</span><span class="si">:</span><span class="s2">.3f</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="sa">f</span><span class="s2">&quot; based on </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">profile_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> samples.&quot;</span>
            <span class="p">)</span>
            <span class="n">return_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">profile_df</span><span class="p">,</span> <span class="n">ufloat</span><span class="p">(</span><span class="n">weighted_avg</span><span class="p">,</span> <span class="n">stdev</span><span class="p">)]</span>
            <span class="c1"># If there&#39;s data to perform a rotational temperature analysis, then do it!</span>
            <span class="k">if</span> <span class="s2">&quot;L&quot;</span> <span class="ow">in</span> <span class="n">profile_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Performing rotational temperature analysis.&quot;</span><span class="p">)</span>
                <span class="n">rot_temp</span> <span class="o">=</span> <span class="n">aa</span><span class="o">.</span><span class="n">rotational_temperature_analysis</span><span class="p">(</span>
                    <span class="n">profile_df</span><span class="p">[</span><span class="s2">&quot;L&quot;</span><span class="p">],</span> <span class="n">profile_df</span><span class="p">[</span><span class="s2">&quot;E upper&quot;</span><span class="p">]</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">rot_temp</span><span class="o">.</span><span class="n">fit_report</span><span class="p">())</span>
                <span class="n">return_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rot_temp</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">return_data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No molecules found, or fits were unsuccessful!&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span></div>

<div class="viewcode-block" id="AssignmentSession.finalize_assignments"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.finalize_assignments">[docs]</a>    <span class="k">def</span> <span class="nf">finalize_assignments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Function that will complete the assignment process by</span>
<span class="sd">            serializing DataClass objects and formatting a report.</span>

<span class="sd">            Creates summary pandas dataframes as self.table and self.profiles,</span>
<span class="sd">            which correspond to the assignments and fitted line profiles respectively.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">assignments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">[</span><span class="s2">&quot;Peaks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_assignments</span><span class="p">()</span>
        <span class="n">ulines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">[</span><span class="s2">&quot;Peaks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_ulines</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">assignments</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">assignments</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">multiple</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">obj</span><span class="o">.</span><span class="n">final</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Transition at </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">frequency</span><span class="si">:</span><span class="s2">4f</span><span class="si">}</span><span class="s2"> has multiple candidates.&quot;</span>
                    <span class="p">)</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Please choose assignment for peak </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">peak_id</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Set the transition as finalized</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">final</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># Dump all the assignments into YAML format</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">to_file</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;assignment_objs/</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">experiment</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">peak_id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;yaml&quot;</span><span class="p">)</span>
                <span class="n">obj</span><span class="o">.</span><span class="n">deviation</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">catalog_frequency</span> <span class="o">-</span> <span class="n">obj</span><span class="o">.</span><span class="n">frequency</span>
            <span class="c1"># Convert all of the assignment data into a CSV file</span>
            <span class="n">assignment_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="vm">__dict__</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">assignments</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">assignment_df</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;frequency&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># Generate a LaTeX table for publication</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_latex_table</span><span class="p">()</span>
            <span class="c1"># Dump assignments to disk</span>
            <span class="n">assignment_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;reports/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">experiment</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># Dump Uline data to disk</span>
            <span class="n">peak_data</span> <span class="o">=</span> <span class="p">[[</span><span class="n">peak</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span> <span class="n">peak</span><span class="o">.</span><span class="n">intensity</span><span class="p">]</span> <span class="k">for</span> <span class="n">peak</span> <span class="ow">in</span> <span class="n">ulines</span><span class="p">]</span>
            <span class="n">peak_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">peak_data</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">,</span> <span class="s2">&quot;Intensity&quot;</span><span class="p">])</span>
            <span class="n">peak_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;reports/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">experiment</span><span class="si">}</span><span class="s2">-ulines.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

            <span class="n">tally</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_assigned_names</span><span class="p">()</span>
            <span class="n">combined_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;assigned_lines&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">assignments</span><span class="p">),</span>
                <span class="s2">&quot;ulines&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">ulines</span><span class="p">),</span>
                <span class="s2">&quot;peaks&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">[</span><span class="s2">&quot;Peaks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_frequencies</span><span class="p">(),</span>
                <span class="s2">&quot;num_peaks&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">[</span><span class="s2">&quot;Peaks&quot;</span><span class="p">]),</span>
                <span class="s2">&quot;tally&quot;</span><span class="p">:</span> <span class="n">tally</span><span class="p">,</span>
                <span class="s2">&quot;unique_molecules&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">,</span>
                <span class="s2">&quot;num_unique&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">),</span>
            <span class="p">}</span>
            <span class="c1"># Combine Session information</span>
            <span class="n">combined_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
            <span class="c1"># Dump to disk</span>
            <span class="n">routines</span><span class="o">.</span><span class="n">dump_yaml</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;sessions/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">experiment</span><span class="si">}</span><span class="s2">.yml&quot;</span><span class="p">,</span> <span class="s2">&quot;yaml&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_create_html_report</span><span class="p">()</span>
            <span class="c1"># Dump data to notebook output</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">combined_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">key</span> <span class="o">+</span> <span class="s2">&quot;:   &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
                <span class="s2">&quot;No assignments made in this session - nothing to finalize!&quot;</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="AssignmentSession.clean_folder"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.clean_folder">[docs]</a>    <span class="k">def</span> <span class="nf">clean_folder</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Method for cleaning up all of the directories used by this routine.</span>
<span class="sd">            Use with caution!!!</span>

<span class="sd">            Requires passing a True statement to actually clean up.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ----------</span>

<span class="sd">            action : bool</span>
<span class="sd">                If True, folders will be deleted. If False (default) nothing is done.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">folders</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;assignment_objs&quot;</span><span class="p">,</span> <span class="s2">&quot;queries&quot;</span><span class="p">,</span> <span class="s2">&quot;sessions&quot;</span><span class="p">,</span> <span class="s2">&quot;clean&quot;</span><span class="p">,</span> <span class="s2">&quot;reports&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">action</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="n">folders</span><span class="p">:</span>
                <span class="n">rmtree</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span></div>

<div class="viewcode-block" id="AssignmentSession.update_database"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.update_database">[docs]</a>    <span class="k">def</span> <span class="nf">update_database</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dbpath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Adds all of the entries to a specified SpectralCatalog database. The database defaults</span>
<span class="sd">        to the global database stored in the home directory. This method will remove everything</span>
<span class="sd">        in the database associated with this experiment&#39;s ID, and re-add the entries.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dbpath : str, optional</span>
<span class="sd">            path to a SpectralCatalog database. Defaults to the system-wide catalog.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">database</span><span class="o">.</span><span class="n">SpectralCatalog</span><span class="p">(</span><span class="n">dbpath</span><span class="p">)</span> <span class="k">as</span> <span class="n">db_obj</span><span class="p">:</span>
            <span class="c1"># Tabula rasa</span>
            <span class="n">db_obj</span><span class="o">.</span><span class="n">remove_experiment</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">experiment</span><span class="p">)</span>
            <span class="n">ass_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">assignment</span><span class="o">.</span><span class="vm">__dict__</span> <span class="k">for</span> <span class="n">assignment</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignments</span><span class="p">]</span>
            <span class="n">db_obj</span><span class="o">.</span><span class="n">insert_multiple</span><span class="p">(</span><span class="n">ass_list</span><span class="p">)</span></div>

<div class="viewcode-block" id="AssignmentSession.simulate_sticks"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.simulate_sticks">[docs]</a>    <span class="k">def</span> <span class="nf">simulate_sticks</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">catalogpath</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">N</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">Q</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">T</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">doppler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">gaussian</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Simulates a stick spectrum with intensities in flux units (Jy) for</span>
<span class="sd">        a given catalog file, the column density, and the rotational partition</span>
<span class="sd">        function at temperature T.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">         catalogpath : str</span>
<span class="sd">            path to SPCAT catalog file</span>
<span class="sd">         N : float</span>
<span class="sd">            column density in cm^-2</span>
<span class="sd">         Q : float</span>
<span class="sd">            partition function at temperature T</span>
<span class="sd">         T : float</span>
<span class="sd">            temperature in Kelvin</span>
<span class="sd">         doppler : float, optional</span>
<span class="sd">            doppler width in km/s; defaults to session wide value</span>
<span class="sd">         gaussian : bool, optional</span>
<span class="sd">                   if True, simulates Gaussian profiles instead of sticks</span>
<span class="sd">         Returns</span>
<span class="sd">         -------</span>
<span class="sd">        :return: if gaussian is False, returns a dataframe with sticks; if True,</span>
<span class="sd">                 returns a simulated Gaussian line profile spectrum</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If no Doppler width provided, use the session wide value</span>
        <span class="k">if</span> <span class="n">doppler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">doppler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">doppler</span>
        <span class="n">catalog_df</span> <span class="o">=</span> <span class="n">aa</span><span class="o">.</span><span class="n">simulate_catalog</span><span class="p">(</span><span class="n">catalogpath</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">T</span><span class="p">,</span> <span class="n">doppler</span><span class="p">)</span>
        <span class="c1"># Take only the values within band</span>
        <span class="n">catalog_df</span> <span class="o">=</span> <span class="n">catalog_df</span><span class="p">[</span>
            <span class="p">(</span><span class="n">catalog_df</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">())</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">catalog_df</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="n">gaussian</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">catalog_df</span><span class="p">[[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">,</span> <span class="s2">&quot;Flux (Jy)&quot;</span><span class="p">]]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Convert Doppler width to frequency widths</span>
            <span class="n">widths</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">dop2freq</span><span class="p">(</span><span class="n">doppler</span><span class="p">,</span> <span class="n">catalog_df</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="c1"># Calculate the Gaussian amplitude</span>
            <span class="n">amplitudes</span> <span class="o">=</span> <span class="n">catalog_df</span><span class="p">[</span><span class="s2">&quot;Flux (Jy)&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">**</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">widths</span><span class="p">)</span>
            <span class="n">sim_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_spectrum</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_col</span><span class="p">],</span>
                <span class="n">catalog_df</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                <span class="n">widths</span><span class="p">,</span>
                <span class="n">amplitudes</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">simulated_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="n">data</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_col</span><span class="p">],</span> <span class="n">sim_y</span><span class="p">)),</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">,</span> <span class="s2">&quot;Flux (Jy)&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="k">return</span> <span class="n">simulated_df</span></div>

<div class="viewcode-block" id="AssignmentSession.simulate_spectrum"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.simulate_spectrum">[docs]</a>    <span class="k">def</span> <span class="nf">simulate_spectrum</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">centers</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">widths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">amplitudes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">fake</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Generate a synthetic spectrum with Gaussians with the</span>
<span class="sd">            specified parameters, on a given x axis.</span>

<span class="sd">            GaussianModel is used here to remain internally consistent</span>
<span class="sd">            with the rest of the code.</span>

<span class="sd">             x: array of x values to evaluate Gaussians on</span>
<span class="sd">             centers: array of Gaussian centers</span>
<span class="sd">             widths: array of Gaussian widths</span>
<span class="sd">             amplitudes: array of Gaussian amplitudes</span>
<span class="sd">             fake: bool indicating whether false intensities are used for the simulation</span>
<span class="sd">            :return y: array of y values</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">GaussianModel</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">c</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">centers</span><span class="p">,</span> <span class="n">widths</span><span class="p">,</span> <span class="n">amplitudes</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">fake</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">scaling</span> <span class="o">=</span> <span class="n">a</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scaling</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">y</span> <span class="o">+=</span> <span class="n">scaling</span> <span class="o">*</span> <span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">c</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">amplitude</span><span class="o">=</span><span class="n">a</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">y</span></div>

<div class="viewcode-block" id="AssignmentSession.clean_spectral_assignments"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.clean_spectral_assignments">[docs]</a>    <span class="k">def</span> <span class="nf">clean_spectral_assignments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to blank regions of the spectrum that have already been</span>
<span class="sd">        assigned. This function takes the frequencies of assignments, and</span>
<span class="sd">        uses the noise statistics to generate white noise to replace the</span>
<span class="sd">        peak. This is to let one focus on unidentified features, rather than</span>
<span class="sd">        be distracted by the assignments with large amplitudes.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        window: float, optional</span>
<span class="sd">            Frequency value in MHz to blank. The region corresponds to the</span>
<span class="sd">            frequency +/- this value.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make a back up of the full spectrum</span>
        <span class="k">if</span> <span class="s2">&quot;Full&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Full&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">int_col</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># If the backup exists, restore the backup first before blanking.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">int_col</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Full&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">assignments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">[</span><span class="s2">&quot;Peaks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_assignments</span><span class="p">()</span>
        <span class="n">frequencies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">transition</span><span class="o">.</span><span class="n">frequency</span> <span class="k">for</span> <span class="n">transition</span> <span class="ow">in</span> <span class="n">assignments</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Blanking spectrum over </span><span class="si">{</span><span class="n">frequencies</span><span class="si">}</span><span class="s2"> windows.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">noise_region</span> <span class="o">==</span> <span class="s2">&quot;als&quot;</span><span class="p">:</span>
            <span class="n">baseline</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">baseline</span><span class="p">)</span>
            <span class="n">baseline</span> <span class="o">/=</span> <span class="n">baseline</span>
            <span class="n">rms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">baseline</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">baseline</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">baseline</span>
            <span class="n">rms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">noise_rms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">int_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">blank_spectrum</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
            <span class="n">frequencies</span><span class="p">,</span>
            <span class="n">baseline</span><span class="p">,</span>
            <span class="n">rms</span><span class="p">,</span>
            <span class="n">freq_col</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_col</span><span class="p">,</span>
            <span class="n">int_col</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">int_col</span><span class="p">,</span>
            <span class="n">window</span><span class="o">=</span><span class="n">window</span><span class="p">,</span>
            <span class="n">df</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="AssignmentSession.calculate_assignment_statistics"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.calculate_assignment_statistics">[docs]</a>    <span class="k">def</span> <span class="nf">calculate_assignment_statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function for calculating some aggregate statistics of the assignments and u-lines. This</span>
<span class="sd">        breaks the assignments sources up to identify what the dominant source of information was.</span>
<span class="sd">        The two metrics for assignments are the number of transitions and the intensity contribution</span>
<span class="sd">        assigned by a particular source.</span>
<span class="sd">        :return: dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">reduced_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span>
            <span class="p">[</span>
                <span class="s2">&quot;frequency&quot;</span><span class="p">,</span>
                <span class="s2">&quot;intensity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;formula&quot;</span><span class="p">,</span>
                <span class="s2">&quot;name&quot;</span><span class="p">,</span>
                <span class="s2">&quot;catalog_frequency&quot;</span><span class="p">,</span>
                <span class="s2">&quot;deviation&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ustate_energy&quot;</span><span class="p">,</span>
                <span class="s2">&quot;source&quot;</span><span class="p">,</span>
                <span class="s2">&quot;public&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">]</span>
        <span class="n">artifacts</span> <span class="o">=</span> <span class="n">reduced_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">reduced_table</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Artifact&quot;</span><span class="p">]</span>
        <span class="n">splat</span> <span class="o">=</span> <span class="n">reduced_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">reduced_table</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;CDMS/JPL&quot;</span><span class="p">]</span>
        <span class="n">local</span> <span class="o">=</span> <span class="n">reduced_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">reduced_table</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;Artifact&quot;</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">reduced_table</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;CDMS/JPL&quot;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">public</span> <span class="o">=</span> <span class="n">local</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">local</span><span class="p">[</span><span class="s2">&quot;public&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span>
        <span class="n">private</span> <span class="o">=</span> <span class="n">local</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">local</span><span class="p">[</span><span class="s2">&quot;public&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;Artifacts&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Splatalogue&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Published molecules&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Unpublished molecules&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="c1"># Added up the total number of lines</span>
        <span class="n">total_lines</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">[</span><span class="s2">&quot;Peaks&quot;</span><span class="p">])</span>
        <span class="c1"># Add up the total intensity</span>
        <span class="n">ulines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Peaks&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_ulines</span><span class="p">()</span>
        <span class="n">total_intensity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">uline</span><span class="o">.</span><span class="n">intensity</span> <span class="k">for</span> <span class="n">uline</span> <span class="ow">in</span> <span class="n">ulines</span><span class="p">])</span>
        <span class="n">total_intensity</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">reduced_table</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">])</span>
        <span class="n">line_breakdown</span> <span class="o">=</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="p">[</span><span class="n">artifacts</span><span class="p">,</span> <span class="n">splat</span><span class="p">,</span> <span class="n">public</span><span class="p">,</span> <span class="n">private</span><span class="p">]]</span>
        <span class="n">intensity_breakdown</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="p">[</span><span class="n">artifacts</span><span class="p">,</span> <span class="n">splat</span><span class="p">,</span> <span class="n">public</span><span class="p">,</span> <span class="n">private</span><span class="p">]</span>
        <span class="p">]</span>
        <span class="c1"># Calculate the aggregate statistics</span>
        <span class="n">cum_line_breakdown</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">line_breakdown</span><span class="p">)</span>
        <span class="n">cum_int_breakdown</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">intensity_breakdown</span><span class="p">)</span>
        <span class="c1"># Organize results into dictionary for return</span>
        <span class="n">return_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;sources&quot;</span><span class="p">:</span> <span class="n">sources</span><span class="p">,</span>
            <span class="c1"># These are absolute values</span>
            <span class="s2">&quot;abs&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;total lines&quot;</span><span class="p">:</span> <span class="n">total_lines</span><span class="p">,</span>
                <span class="s2">&quot;total intensity&quot;</span><span class="p">:</span> <span class="n">total_intensity</span><span class="p">,</span>
                <span class="s2">&quot;line breakdown&quot;</span><span class="p">:</span> <span class="n">line_breakdown</span><span class="p">,</span>
                <span class="s2">&quot;intensity breakdown&quot;</span><span class="p">:</span> <span class="n">intensity_breakdown</span><span class="p">,</span>
                <span class="s2">&quot;cumulative line breakdown&quot;</span><span class="p">:</span> <span class="n">cum_line_breakdown</span><span class="p">,</span>
                <span class="s2">&quot;cumulative intensity breakdown&quot;</span><span class="p">:</span> <span class="n">cum_int_breakdown</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="c1"># These are the corresponding values in percentage</span>
            <span class="s2">&quot;percent&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;line breakdown&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">(</span><span class="n">value</span> <span class="o">/</span> <span class="n">total_lines</span><span class="p">)</span> <span class="o">*</span> <span class="mf">100.0</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">line_breakdown</span>
                <span class="p">],</span>
                <span class="s2">&quot;intensity breakdown&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">(</span><span class="n">value</span> <span class="o">/</span> <span class="n">total_intensity</span><span class="p">)</span> <span class="o">*</span> <span class="mf">100.0</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">intensity_breakdown</span>
                <span class="p">],</span>
                <span class="s2">&quot;cumulative line breakdown&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">(</span><span class="n">value</span> <span class="o">/</span> <span class="n">total_lines</span><span class="p">)</span> <span class="o">*</span> <span class="mf">100.0</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">cum_line_breakdown</span>
                <span class="p">],</span>
                <span class="s2">&quot;cumulative intensity breakdown&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">(</span><span class="n">value</span> <span class="o">/</span> <span class="n">total_intensity</span><span class="p">)</span> <span class="o">*</span> <span class="mf">100.0</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">cum_int_breakdown</span>
                <span class="p">],</span>
            <span class="p">},</span>
            <span class="s2">&quot;molecules&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;CDMS/JPL&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="n">name</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">splat</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">splat</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">splat</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
                <span class="p">},</span>
                <span class="s2">&quot;Published&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="n">name</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">public</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">public</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">public</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
                <span class="p">},</span>
                <span class="s2">&quot;Unpublished&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="n">name</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">private</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">private</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">name</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">private</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">return_dict</span></div>

<div class="viewcode-block" id="AssignmentSession.plot_spectrum"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.plot_spectrum">[docs]</a>    <span class="k">def</span> <span class="nf">plot_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">simulate</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Generates a Plotly figure of the spectrum. If U-lines are</span>
<span class="sd">            present, it will plot the simulated spectrum also.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">FigureWidget</span><span class="p">()</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s2">&quot;xaxis&quot;</span><span class="p">][</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Frequency (MHz)&quot;</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s2">&quot;xaxis&quot;</span><span class="p">][</span><span class="s2">&quot;tickformat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.,&quot;</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">add_scattergl</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_col</span><span class="p">],</span>
            <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">int_col</span><span class="p">],</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Experiment&quot;</span><span class="p">,</span>
            <span class="n">opacity</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;Peaks&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">:</span>
            <span class="n">ulines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">[</span><span class="s2">&quot;Peaks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_ulines</span><span class="p">()</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ulines</span><span class="p">)))</span>
            <span class="n">amplitudes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">uline</span><span class="o">.</span><span class="n">intensity</span> <span class="k">for</span> <span class="n">uline</span> <span class="ow">in</span> <span class="n">ulines</span><span class="p">])</span>
            <span class="n">centers</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">uline</span><span class="o">.</span><span class="n">frequency</span> <span class="k">for</span> <span class="n">uline</span> <span class="ow">in</span> <span class="n">ulines</span><span class="p">])</span>
            <span class="c1"># Add sticks for U-lines</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_bar</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">centers</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">amplitudes</span><span class="p">,</span> <span class="n">hoverinfo</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Peaks&quot;</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">simulate</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">widths</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">dop2freq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">doppler</span><span class="p">,</span> <span class="n">centers</span><span class="p">)</span>

                <span class="n">simulated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_spectrum</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                    <span class="n">centers</span><span class="p">,</span>
                    <span class="n">widths</span><span class="p">,</span>
                    <span class="n">amplitudes</span><span class="p">,</span>
                    <span class="n">fake</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">simulated</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                    <span class="n">data</span><span class="o">=</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">simulated</span><span class="p">)),</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">,</span> <span class="s2">&quot;Intensity&quot;</span><span class="p">],</span>
                <span class="p">)</span>

                <span class="n">fig</span><span class="o">.</span><span class="n">add_scattergl</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">simulated</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">],</span>
                    <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">simulated</span><span class="p">[</span><span class="s2">&quot;Intensity&quot;</span><span class="p">],</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Simulated spectrum&quot;</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

    <span class="k">def</span> <span class="nf">_create_html_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function for generating an HTML report for sharing. The HTML report is rendered with</span>
<span class="sd">        Jinja2, and uses the template &quot;report_template.html&quot; located in the module directory.</span>
<span class="sd">        The report includes interactive plots showing statistics of the assignments/ulines and</span>
<span class="sd">        an overview of the spectrum. At the end of the report is a table of the assignments and</span>
<span class="sd">        uline data.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        </span>
<span class="sd">        filepath: str or None, optional</span>
<span class="sd">            Path to save the report to. If `None`, defaults to `reports/{id}-summary.html`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">template_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)),</span> <span class="s2">&quot;report_template.html&quot;</span>
        <span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">template_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">read_file</span><span class="p">:</span>
            <span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">read_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
        <span class="n">html_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="c1"># Say what the minimum value for peak detection is.</span>
        <span class="n">html_dict</span><span class="p">[</span><span class="s2">&quot;peak_threshold&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span>
        <span class="c1"># The assigned molecules table</span>
        <span class="n">reduced_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span>
            <span class="p">[</span>
                <span class="s2">&quot;frequency&quot;</span><span class="p">,</span>
                <span class="s2">&quot;intensity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;formula&quot;</span><span class="p">,</span>
                <span class="s2">&quot;name&quot;</span><span class="p">,</span>
                <span class="s2">&quot;catalog_frequency&quot;</span><span class="p">,</span>
                <span class="s2">&quot;deviation&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ustate_energy&quot;</span><span class="p">,</span>
                <span class="s2">&quot;source&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">]</span>
        <span class="c1"># Render pandas dataframe HTML with bar annotations</span>
        <span class="n">reduced_table_html</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">reduced_table</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span>
                <span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;deviation&quot;</span><span class="p">,</span> <span class="s2">&quot;ustate_energy&quot;</span><span class="p">],</span>
                <span class="n">align</span><span class="o">=</span><span class="s2">&quot;mid&quot;</span><span class="p">,</span>
                <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;#d65f5f&quot;</span><span class="p">,</span> <span class="s2">&quot;#5fba7d&quot;</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#5fba7d&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s2">&quot;frequency&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{:.4f}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;catalog_frequency&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{:.4f}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;deviation&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;ustate_energy&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;intensity&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;class = &quot;data-table hover compact&quot; &quot;&quot;&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">classes</span><span class="o">=</span><span class="s2">&quot;&quot;&quot; &quot;data-table hover compact&quot; &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">html_dict</span><span class="p">[</span><span class="s2">&quot;assignments_table&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reduced_table_html</span>
        <span class="c1"># The unidentified features table</span>
        <span class="n">ulines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">[</span><span class="s2">&quot;Peaks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_ulines</span><span class="p">()</span>
        <span class="n">uline_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="p">[[</span><span class="n">uline</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span> <span class="n">uline</span><span class="o">.</span><span class="n">intensity</span><span class="p">]</span> <span class="k">for</span> <span class="n">uline</span> <span class="ow">in</span> <span class="n">ulines</span><span class="p">],</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">,</span> <span class="s2">&quot;Intensity&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">html_dict</span><span class="p">[</span><span class="s2">&quot;uline_table&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">uline_df</span><span class="o">.</span><span class="n">style</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Intensity&quot;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;#5fba7d&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">format</span><span class="p">({</span><span class="s2">&quot;Frequency&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{:.4f}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;Intensity&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="p">})</span>
            <span class="o">.</span><span class="n">set_table_attributes</span><span class="p">(</span><span class="s2">&quot;&quot;&quot;class = &quot;data-table hover compact&quot; &quot;&quot;&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">classes</span><span class="o">=</span><span class="s2">&quot;&quot;&quot; &quot;data-table hover compact&quot; &quot;&quot;&quot;</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Plotly displays of the spectral feature breakdown and whatnot</span>
        <span class="n">html_dict</span><span class="p">[</span><span class="s2">&quot;plotly_breakdown&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_breakdown</span><span class="p">(),</span> <span class="n">output_type</span><span class="o">=</span><span class="s2">&quot;div&quot;</span><span class="p">)</span>
        <span class="n">html_dict</span><span class="p">[</span><span class="s2">&quot;plotly_figure&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">plot_assigned</span><span class="p">(),</span> <span class="n">output_type</span><span class="o">=</span><span class="s2">&quot;div&quot;</span><span class="p">)</span>
        <span class="c1"># Render the template with Jinja and save the HTML report</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">template</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">session</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="p">,</span> <span class="o">**</span><span class="n">html_dict</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filepath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;reports/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">experiment</span><span class="si">}</span><span class="s2">-summary.html&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">write_file</span><span class="p">:</span>
            <span class="n">write_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

<div class="viewcode-block" id="AssignmentSession.create_latex_table"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.create_latex_table">[docs]</a>    <span class="k">def</span> <span class="nf">create_latex_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to create a LaTeX table summarizing the measurements in this experiment.</span>
<span class="sd">        </span>
<span class="sd">        Without any additional inputs, the table will be printed into a .tex file</span>
<span class="sd">        in the reports folder. The table will be created with the minimum amount</span>
<span class="sd">        of information required for a paper, including the frequency and intensity</span>
<span class="sd">        information, assignments, and the source of the information.</span>
<span class="sd">        </span>
<span class="sd">        The user can override the default settings by supplying `header` and `col`</span>
<span class="sd">        arguments, and any other kwargs are passed into the `to_latex` pandas</span>
<span class="sd">        DataFrame method. The header and col lengths must match.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath : str, optional</span>
<span class="sd">            Filepath to save the LaTeX table to; by default None</span>
<span class="sd">        header : iterable of str, optional</span>
<span class="sd">            An iterable of strings specifying the header to be printed. By default None</span>
<span class="sd">        cols : iterable of str, optional</span>
<span class="sd">            An iterable of strings specifying which columns to include. If this is</span>
<span class="sd">            changed, the header must also be changed to reflect the new columns.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">[</span><span class="s2">&quot;Peaks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
        <span class="c1"># Numerical formatting</span>
        <span class="n">formatters</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;frequency&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{:,.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">,</span>
            <span class="s2">&quot;intensity&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{:.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">,</span>
            <span class="s2">&quot;catalog_frequency&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{:,.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">,</span>
            <span class="s2">&quot;deviation&quot;</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{:,.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">def</span> <span class="nf">ref_formatter</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">noform</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;CDMS/JPL&quot;</span><span class="p">,</span> <span class="s2">&quot;Artifact&quot;</span><span class="p">,</span> <span class="s2">&quot;U&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">x</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">noform</span><span class="p">:</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;\cite</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">x</span>

        <span class="c1"># Replace the source information to designate u-line if it is a u-line</span>
        <span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;uline&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;U&quot;</span>
        <span class="k">if</span> <span class="n">header</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">header</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;Frequency&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Intensity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Catalog frequency&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Deviation&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Name&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Formula&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Quantum numbers&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Source&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="k">if</span> <span class="n">cols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span>
                <span class="s2">&quot;frequency&quot;</span><span class="p">,</span>
                <span class="s2">&quot;intensity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;catalog_frequency&quot;</span><span class="p">,</span>
                <span class="s2">&quot;deviation&quot;</span><span class="p">,</span>
                <span class="s2">&quot;name&quot;</span><span class="p">,</span>
                <span class="s2">&quot;formula&quot;</span><span class="p">,</span>
                <span class="s2">&quot;r_qnos&quot;</span><span class="p">,</span>
                <span class="s2">&quot;source&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;source&quot;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="n">table</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">ref_formatter</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;formula&quot;</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="n">table</span><span class="p">[</span><span class="s2">&quot;formula&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;\ce</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filepath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;reports/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">experiment</span><span class="si">}</span><span class="s2">-table.tex&quot;</span>
        <span class="c1"># Settings to be passed into the latex table creation</span>
        <span class="n">table_settings</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;formatters&quot;</span><span class="p">:</span> <span class="n">formatters</span><span class="p">,</span>
            <span class="s2">&quot;index&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;longtable&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="s2">&quot;header&quot;</span><span class="p">:</span> <span class="n">header</span><span class="p">,</span>
            <span class="s2">&quot;escape&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">table_settings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Write the table to file</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">write_file</span><span class="p">:</span>
            <span class="n">table</span><span class="p">[</span><span class="n">cols</span><span class="p">]</span><span class="o">.</span><span class="n">to_latex</span><span class="p">(</span><span class="n">buf</span><span class="o">=</span><span class="n">write_file</span><span class="p">,</span> <span class="o">**</span><span class="n">table_settings</span><span class="p">)</span></div>

<div class="viewcode-block" id="AssignmentSession.plot_breakdown"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.plot_breakdown">[docs]</a>    <span class="k">def</span> <span class="nf">plot_breakdown</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate two charts to summarize the breakdown of spectral features.</span>
<span class="sd">        The left column plot shows the number of ulines being assigned by</span>
<span class="sd">        the various sources of frequency data.</span>

<span class="sd">        Artifacts - instrumental interference, from the function `process_artifacts`</span>
<span class="sd">        Splatalogue - uses the astroquery API, from the function `splat_assign_spectrum`</span>
<span class="sd">        Published - local catalogs, but with the `public` kwarg flagged as True</span>
<span class="sd">        Unpublished - local catalogs, but with the `public` kwarg flagged as False</span>
<span class="sd">        :return: Plotly FigureWidget object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">figurefactory</span><span class="o">.</span><span class="n">init_plotly_subplot</span><span class="p">(</span>
            <span class="n">nrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">ncols</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="o">**</span><span class="p">{</span><span class="s2">&quot;subplot_titles&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;Reference Breakdown&quot;</span><span class="p">,</span> <span class="s2">&quot;Intensity Breakdown&quot;</span><span class="p">)},</span>
        <span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Spectral Feature Breakdown&quot;</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s2">&quot;showlegend&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">reduced_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span>
            <span class="p">[</span>
                <span class="s2">&quot;frequency&quot;</span><span class="p">,</span>
                <span class="s2">&quot;intensity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;formula&quot;</span><span class="p">,</span>
                <span class="s2">&quot;name&quot;</span><span class="p">,</span>
                <span class="s2">&quot;catalog_frequency&quot;</span><span class="p">,</span>
                <span class="s2">&quot;deviation&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ustate_energy&quot;</span><span class="p">,</span>
                <span class="s2">&quot;source&quot;</span><span class="p">,</span>
                <span class="s2">&quot;public&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">]</span>
        <span class="n">artifacts</span> <span class="o">=</span> <span class="n">reduced_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">reduced_table</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;Artifact&quot;</span><span class="p">]</span>
        <span class="n">splat</span> <span class="o">=</span> <span class="n">reduced_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">reduced_table</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;CDMS/JPL&quot;</span><span class="p">]</span>
        <span class="n">local</span> <span class="o">=</span> <span class="n">reduced_table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
            <span class="p">(</span><span class="n">reduced_table</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;Artifact&quot;</span><span class="p">)</span>
            <span class="o">&amp;</span> <span class="p">(</span><span class="n">reduced_table</span><span class="p">[</span><span class="s2">&quot;source&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;CDMS/JPL&quot;</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="n">public</span> <span class="o">=</span> <span class="n">local</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">local</span><span class="p">[</span><span class="s2">&quot;public&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span>
        <span class="n">private</span> <span class="o">=</span> <span class="n">local</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">local</span><span class="p">[</span><span class="s2">&quot;public&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="kc">False</span><span class="p">]</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;Artifacts&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Splatalogue&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Published molecules&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Unpublished molecules&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="c1"># Added up the total number of lines</span>
        <span class="n">ulines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">[</span><span class="s2">&quot;Peaks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_ulines</span><span class="p">()</span>
        <span class="n">assignments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">[</span><span class="s2">&quot;Peaks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_assignments</span><span class="p">()</span>
        <span class="n">total_lines</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ulines</span><span class="p">)</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">assignments</span><span class="p">)</span>
        <span class="c1"># Add up the total intensity</span>
        <span class="n">total_intensity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">uline</span><span class="o">.</span><span class="n">intensity</span> <span class="k">for</span> <span class="n">uline</span> <span class="ow">in</span> <span class="n">ulines</span><span class="p">])</span>
        <span class="n">total_intensity</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">reduced_table</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">])</span>
        <span class="n">line_breakdown</span> <span class="o">=</span> <span class="p">[</span><span class="n">total_lines</span><span class="p">]</span>
        <span class="n">intensity_breakdown</span> <span class="o">=</span> <span class="p">[</span><span class="n">total_intensity</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="p">[</span><span class="n">artifacts</span><span class="p">,</span> <span class="n">splat</span><span class="p">,</span> <span class="n">public</span><span class="p">,</span> <span class="n">private</span><span class="p">]:</span>
            <span class="n">line_breakdown</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">source</span><span class="p">))</span>
            <span class="n">intensity_breakdown</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">]))</span>
        <span class="n">line_breakdown</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">line_breakdown</span><span class="p">)</span>
        <span class="n">intensity_breakdown</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">intensity_breakdown</span><span class="p">)</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Total&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">sources</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;#d7191c&quot;</span><span class="p">,</span> <span class="s2">&quot;#fdae61&quot;</span><span class="p">,</span> <span class="s2">&quot;#ffffbf&quot;</span><span class="p">,</span> <span class="s2">&quot;#abdda4&quot;</span><span class="p">,</span> <span class="s2">&quot;#2b83ba&quot;</span><span class="p">]</span>
        <span class="c1"># Left column plot of the number of lines assigned</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Scattergl</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">line_breakdown</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;tozeroy&quot;</span><span class="p">,</span> <span class="n">hoverinfo</span><span class="o">=</span><span class="s2">&quot;x+y&quot;</span><span class="p">),</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Bar charts showing the number of lines from each source</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>
                <span class="o">+</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">source</span><span class="p">)</span> <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="p">[</span><span class="n">artifacts</span><span class="p">,</span> <span class="n">splat</span><span class="p">,</span> <span class="n">public</span><span class="p">,</span> <span class="n">private</span><span class="p">]],</span>
                <span class="n">hoverinfo</span><span class="o">=</span><span class="s2">&quot;x+y&quot;</span><span class="p">,</span>
                <span class="n">width</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">colors</span><span class="p">},</span>
            <span class="p">),</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Right column plot of the intensity contributions</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Scattergl</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">intensity_breakdown</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;tozeroy&quot;</span><span class="p">,</span> <span class="n">hoverinfo</span><span class="o">=</span><span class="s2">&quot;x+y&quot;</span>
            <span class="p">),</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="c1"># Bar chart showing the intensity contribution from each source</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">add_trace</span><span class="p">(</span>
            <span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>
                <span class="o">+</span> <span class="p">[</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">source</span> <span class="ow">in</span> <span class="p">[</span><span class="n">artifacts</span><span class="p">,</span> <span class="n">splat</span><span class="p">,</span> <span class="n">public</span><span class="p">,</span> <span class="n">private</span><span class="p">]</span>
                <span class="p">],</span>
                <span class="n">hoverinfo</span><span class="o">=</span><span class="s2">&quot;x+y&quot;</span><span class="p">,</span>
                <span class="n">width</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                <span class="n">marker</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">colors</span><span class="p">},</span>
            <span class="p">),</span>
            <span class="mi">1</span><span class="p">,</span>
            <span class="mi">2</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">fig</span><span class="p">[</span><span class="s2">&quot;layout&quot;</span><span class="p">][</span><span class="s2">&quot;xaxis1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Source&quot;</span><span class="p">,</span> <span class="n">showgrid</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">[</span><span class="s2">&quot;layout&quot;</span><span class="p">][</span><span class="s2">&quot;yaxis1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Cumulative number of assignments&quot;</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">total_lines</span> <span class="o">*</span> <span class="mf">1.05</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">fig</span><span class="p">[</span><span class="s2">&quot;layout&quot;</span><span class="p">][</span><span class="s2">&quot;xaxis2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;Source&quot;</span><span class="p">,</span> <span class="n">showgrid</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">[</span><span class="s2">&quot;layout&quot;</span><span class="p">][</span><span class="s2">&quot;yaxis2&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Cumulative intensity&quot;</span><span class="p">,</span> <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">total_intensity</span> <span class="o">*</span> <span class="mf">1.05</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="AssignmentSession.plot_assigned"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.plot_assigned">[docs]</a>    <span class="k">def</span> <span class="nf">plot_assigned</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Generates a Plotly figure with the assignments overlaid</span>
<span class="sd">            on the experimental spectrum.</span>

<span class="sd">            Does not require any parameters, but requires that</span>
<span class="sd">            the assignments and peak finding functions have been</span>
<span class="sd">            run previously.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">FigureWidget</span><span class="p">()</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Experiment </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">experiment</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s2">&quot;xaxis&quot;</span><span class="p">][</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Frequency (MHz)&quot;</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s2">&quot;xaxis&quot;</span><span class="p">][</span><span class="s2">&quot;tickformat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;,.2f&quot;</span>

        <span class="c1"># Update the peaks table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peaks</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="p">[</span>
                <span class="p">[</span><span class="n">uline</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span> <span class="n">uline</span><span class="o">.</span><span class="n">intensity</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">uline</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">[</span><span class="s2">&quot;Peaks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_ulines</span><span class="p">()</span>
            <span class="p">],</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">,</span> <span class="s2">&quot;Intensity&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">add_scattergl</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">],</span>
            <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">int_col</span><span class="p">],</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Experiment&quot;</span><span class="p">,</span>
            <span class="n">opacity</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">add_bar</span><span class="p">(</span>
            <span class="n">x</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;catalog_frequency&quot;</span><span class="p">],</span>
            <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">],</span>
            <span class="n">width</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
            <span class="n">hoverinfo</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="o">+</span> <span class="s2">&quot;-&quot;</span>
            <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;r_qnos&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">),</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Assignments&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ulines</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="p">[</span><span class="n">uline</span><span class="o">.</span><span class="n">intensity</span><span class="p">,</span> <span class="n">uline</span><span class="o">.</span><span class="n">frequency</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">uline</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">[</span><span class="s2">&quot;Peaks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_ulines</span><span class="p">()</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">add_bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">ulines</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">ulines</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">width</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;U-lines&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="AssignmentSession.stacked_plot"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.stacked_plot">[docs]</a>    <span class="k">def</span> <span class="nf">stacked_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frequencies</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span> <span class="n">int_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">freq_range</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Special implementation of the stacked_plot from the figurefactory module, adapted</span>
<span class="sd">        for AssignmentSession. In this version, the assigned/u-lines are also indicated.</span>

<span class="sd">        This function will generate a Plotly figure that stacks up the spectra as subplots,</span>
<span class="sd">        with increasing frequencies going up the plot. This function was written primarily</span>
<span class="sd">        to identify harmonically related lines, which in the absence of centrifugal distortion</span>
<span class="sd">        should line up perfectly in the center of the plot.</span>

<span class="sd">        Due to limitations with Plotly, there is a maximum of ~8 plots that can stacked</span>
<span class="sd">        and will return an Exception if &gt; 8 frequencies are provided.</span>

<span class="sd">         frequencies: list of floats, corresponding to center frequencies</span>
<span class="sd">         freq_range: float percentage value of each center frequency to use as cutoffs</span>
<span class="sd">        :return: Plotly Figure object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">int_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">int_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">int_col</span>
        <span class="c1"># Update the peaks table</span>
        <span class="n">ulines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">[</span><span class="s2">&quot;Peaks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_ulines</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">peaks</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
            <span class="n">data</span><span class="o">=</span><span class="p">[[</span><span class="n">uline</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span> <span class="n">uline</span><span class="o">.</span><span class="n">intensity</span><span class="p">]</span> <span class="k">for</span> <span class="n">uline</span> <span class="ow">in</span> <span class="n">ulines</span><span class="p">],</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">,</span> <span class="s2">&quot;Intensity&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">dataframe</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># Want the frequencies in ascending order, going upwards in the plot</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span>
                <span class="n">dataframe</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="n">frequencies</span><span class="p">,</span>
                <span class="n">frequencies</span> <span class="o">&lt;=</span> <span class="n">dataframe</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="c1"># Plot only frequencies within band</span>
        <span class="n">frequencies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">frequencies</span><span class="p">)[</span><span class="n">indices</span><span class="p">]</span>
        <span class="c1"># Sort frequencies such that plots are descending in frequency</span>
        <span class="n">frequencies</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">frequencies</span><span class="p">)[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">frequencies</span><span class="p">)</span> <span class="o">*</span> <span class="n">freq_range</span>
        <span class="n">nplots</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">frequencies</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nplots</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Too many requested frequencies; I can&#39;t stack them all!&quot;</span><span class="p">)</span>
        <span class="n">titles</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">frequency</span><span class="si">:</span><span class="s2">,.0f</span><span class="si">}</span><span class="s2"> MHz&quot;</span> <span class="k">for</span> <span class="n">frequency</span> <span class="ow">in</span> <span class="n">frequencies</span><span class="p">)</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="n">figurefactory</span><span class="o">.</span><span class="n">init_plotly_subplot</span><span class="p">(</span>
            <span class="n">nrows</span><span class="o">=</span><span class="n">nplots</span><span class="p">,</span>
            <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="o">**</span><span class="p">{</span>
                <span class="s2">&quot;subplot_titles&quot;</span><span class="p">:</span> <span class="n">titles</span><span class="p">,</span>
                <span class="s2">&quot;vertical_spacing&quot;</span><span class="p">:</span> <span class="mf">0.15</span><span class="p">,</span>
                <span class="s2">&quot;shared_xaxes&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
            <span class="p">},</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">frequency</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">frequencies</span><span class="p">):</span>
            <span class="c1"># Calculate the offset frequency</span>
            <span class="n">dataframe</span><span class="p">[</span><span class="s2">&quot;Offset &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)]</span> <span class="o">=</span> <span class="n">dataframe</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">freq_col</span><span class="p">]</span> <span class="o">-</span> <span class="n">frequency</span>
            <span class="c1"># Range as a fraction of the center frequency</span>
            <span class="n">freq_cutoff</span> <span class="o">=</span> <span class="n">freq_range</span> <span class="o">*</span> <span class="n">frequency</span>
            <span class="n">max_freq</span> <span class="o">=</span> <span class="n">frequency</span> <span class="o">+</span> <span class="n">freq_cutoff</span>
            <span class="n">min_freq</span> <span class="o">=</span> <span class="n">frequency</span> <span class="o">-</span> <span class="n">freq_cutoff</span>
            <span class="n">sliced_df</span> <span class="o">=</span> <span class="n">dataframe</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="n">dataframe</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;Offset </span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="o">-</span><span class="n">delta</span><span class="p">,</span> <span class="n">delta</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">sliced_peaks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">peaks</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">peaks</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">min_freq</span><span class="p">,</span> <span class="n">max_freq</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">sliced_peaks</span><span class="p">[</span><span class="s2">&quot;Offset Frequency&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sliced_peaks</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">frequency</span>
            <span class="n">sliced_assignments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="s2">&quot;frequency&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="n">min_freq</span><span class="p">,</span> <span class="n">max_freq</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">sliced_assignments</span><span class="p">[</span><span class="s2">&quot;offset_frequency&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">sliced_assignments</span><span class="p">[</span><span class="s2">&quot;frequency&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">frequency</span>
            <span class="p">)</span>
            <span class="c1"># Plot the data</span>
            <span class="n">traces</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="c1"># Spectrum plot</span>
            <span class="n">traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Scattergl</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">sliced_df</span><span class="p">[</span><span class="s2">&quot;Offset &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)],</span>
                    <span class="n">y</span><span class="o">=</span><span class="n">sliced_df</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">int_col</span><span class="p">],</span>
                    <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;lines&quot;</span><span class="p">,</span>
                    <span class="n">opacity</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span>
                    <span class="n">marker</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;rgb(5,113,176)&quot;</span><span class="p">},</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">sliced_assignments</span><span class="p">[</span><span class="s2">&quot;offset_frequency&quot;</span><span class="p">],</span>
                    <span class="n">y</span><span class="o">=</span><span class="n">sliced_assignments</span><span class="p">[</span><span class="s2">&quot;intensity&quot;</span><span class="p">],</span>
                    <span class="n">width</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                    <span class="n">hoverinfo</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span>
                    <span class="n">text</span><span class="o">=</span><span class="n">sliced_assignments</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
                    <span class="o">+</span> <span class="s2">&quot;-&quot;</span>
                    <span class="o">+</span> <span class="n">sliced_assignments</span><span class="p">[</span><span class="s2">&quot;r_qnos&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">str</span><span class="p">),</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Assignments&quot;</span><span class="p">,</span>
                    <span class="n">marker</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;rgb(253,174,97)&quot;</span><span class="p">},</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">traces</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">go</span><span class="o">.</span><span class="n">Bar</span><span class="p">(</span>
                    <span class="n">x</span><span class="o">=</span><span class="n">sliced_peaks</span><span class="p">[</span><span class="s2">&quot;Offset Frequency&quot;</span><span class="p">],</span>
                    <span class="n">y</span><span class="o">=</span><span class="n">sliced_peaks</span><span class="p">[</span><span class="s2">&quot;Intensity&quot;</span><span class="p">],</span>
                    <span class="n">width</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;U-lines&quot;</span><span class="p">,</span>
                    <span class="n">marker</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="s2">&quot;rgb(26,150,65)&quot;</span><span class="p">},</span>
                    <span class="n">hoverinfo</span><span class="o">=</span><span class="s2">&quot;text&quot;</span><span class="p">,</span>
                    <span class="n">text</span><span class="o">=</span><span class="n">sliced_peaks</span><span class="p">[</span><span class="s2">&quot;Frequency&quot;</span><span class="p">],</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="c1"># Plotly indexes from one because they&#39;re stupid</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">add_traces</span><span class="p">(</span><span class="n">traces</span><span class="p">,</span> <span class="p">[</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>
            <span class="n">fig</span><span class="p">[</span><span class="s2">&quot;layout&quot;</span><span class="p">][</span><span class="s2">&quot;xaxis1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="nb">range</span><span class="o">=</span><span class="p">[</span><span class="o">-</span><span class="n">freq_cutoff</span><span class="p">,</span> <span class="n">freq_cutoff</span><span class="p">],</span>
                <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Offset frequency (MHz)&quot;</span><span class="p">,</span>
                <span class="n">showgrid</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">fig</span><span class="p">[</span><span class="s2">&quot;layout&quot;</span><span class="p">][</span><span class="s2">&quot;yaxis&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">showgrid</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">fig</span><span class="p">[</span><span class="s2">&quot;layout&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">autosize</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">height</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">900</span><span class="p">,</span> <span class="n">showlegend</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="AssignmentSession.match_artifacts"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.match_artifacts">[docs]</a>    <span class="k">def</span> <span class="nf">match_artifacts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">artifact_exp</span><span class="p">:</span> <span class="s2">&quot;AssignmentSession&quot;</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.05</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        TODO: Need to update this method; `process_artifacts` is no longer a method.</span>
<span class="sd">        </span>
<span class="sd">        Remove artifacts based on another experiment which has the blank</span>
<span class="sd">        sample - i.e. only artifacts.</span>

<span class="sd">        The routine will simple match peaks found in the artifact</span>
<span class="sd">        experiment, and assign all coincidences in the present experiment</span>
<span class="sd">        as artifacts.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        artifact_exp - AssignmentSession object</span>
<span class="sd">            Experiment with no sample present</span>
<span class="sd">        threshold - float, optional</span>
<span class="sd">            Threshold in absolute frequency units for matching</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">matches</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">match_artifacts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">artifact_exp</span><span class="p">,</span> <span class="n">threshold</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_artifacts</span><span class="p">([</span><span class="n">freq</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">freq</span> <span class="ow">in</span> <span class="n">matches</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">freq</span> <span class="ow">in</span> <span class="n">matches</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Removed </span><span class="si">{</span><span class="n">freq</span><span class="si">:</span><span class="s2">,.4f</span><span class="si">}</span><span class="s2"> peak as artifact.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AssignmentSession.find_progressions"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.find_progressions">[docs]</a>    <span class="k">def</span> <span class="nf">find_progressions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">search</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
        <span class="n">low_B</span><span class="o">=</span><span class="mf">400.0</span><span class="p">,</span>
        <span class="n">high_B</span><span class="o">=</span><span class="mf">9000.0</span><span class="p">,</span>
        <span class="n">refit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">preferences</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Performs a search for possible harmonically related U-lines.</span>
<span class="sd">        The first step loops over every possible U-line pair, and uses the</span>
<span class="sd">        difference to estimate an effective B value for predicting the next</span>
<span class="sd">        transition. If the search is successful, the U-line is added to the</span>
<span class="sd">        list. The search is repeated until there are no more U-lines within</span>
<span class="sd">        frequency range of the next predicted line.</span>

<span class="sd">        Once the possible series are identified, the frequencies are fit to</span>
<span class="sd">        an effective linear molecule model (B and D terms). An affinity propa-</span>
<span class="sd">        gation cluster model is then used to group similar progressions toge-</span>
<span class="sd">        ther, with either a systematic test of preference values or a user</span>
<span class="sd">        specified value.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        search: float, optional</span>
<span class="sd">            Percentage value of the target frequency cutoff for excluding</span>
<span class="sd">            possible candidates in the harmonic search</span>
<span class="sd">        low_B, high_B: float, optional</span>
<span class="sd">            Minimum and maximum value of B in MHz to be considered. This</span>
<span class="sd">            constrains the size of the molecule you are looking for.</span>
<span class="sd">        refit: bool, optional</span>
<span class="sd">            If True, B and D are refit to the cluster frequencies.</span>
<span class="sd">        plot: bool, optional</span>
<span class="sd">            If True, creates a Plotly scatter plot of the clusters, as a funct-</span>
<span class="sd">            ion of the preference values.</span>
<span class="sd">        preferences: float or array_like of floats, optional</span>
<span class="sd">            A single value or an array of preference values for the AP cluster</span>
<span class="sd">            model. If None, the clustering will be performed on a default grid,</span>
<span class="sd">            where all of the results are returned.</span>
<span class="sd">        kwargs: optional</span>
<span class="sd">            Additional kwargs are passed to the AP model initialization.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        fig</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ulines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_lists</span><span class="p">[</span><span class="s2">&quot;Peaks&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get_ulines</span><span class="p">()</span>
        <span class="n">uline_frequencies</span> <span class="o">=</span> <span class="p">[</span><span class="n">uline</span><span class="o">.</span><span class="n">frequency</span> <span class="k">for</span> <span class="n">uline</span> <span class="ow">in</span> <span class="n">ulines</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Performing harmonic progression search&quot;</span><span class="p">)</span>
        <span class="n">progressions</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">harmonic_finder</span><span class="p">(</span>
            <span class="n">uline_frequencies</span><span class="p">,</span> <span class="n">search</span><span class="o">=</span><span class="n">search</span><span class="p">,</span> <span class="n">low_B</span><span class="o">=</span><span class="n">low_B</span><span class="p">,</span> <span class="n">high_B</span><span class="o">=</span><span class="n">high_B</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Fitting progressions.&quot;</span><span class="p">)</span>
        <span class="n">fit_df</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">harmonic_fitter</span><span class="p">(</span><span class="n">progressions</span><span class="p">,</span> <span class="n">J_thres</span><span class="o">=</span><span class="n">search</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Found </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">fit_df</span><span class="p">)</span><span class="si">}</span><span class="s2"> possible progressions.&quot;</span><span class="p">)</span>
        <span class="n">pref_test_data</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="c1"># Run cluster analysis on the results</span>
        <span class="k">if</span> <span class="n">preferences</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">preferences</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="o">-</span><span class="mf">8e4</span><span class="p">,</span> <span class="o">-</span><span class="mf">4e4</span><span class="p">,</span> <span class="o">-</span><span class="mf">2e4</span><span class="p">,</span> <span class="o">-</span><span class="mf">1e4</span><span class="p">,</span> <span class="o">-</span><span class="mf">5e3</span><span class="p">,</span> <span class="o">-</span><span class="mf">3e3</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5e3</span><span class="p">,</span> <span class="o">-</span><span class="mf">500.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">100.0</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="c1"># Perform the AP cluster modelling</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">preferences</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span> <span class="ow">or</span> <span class="nb">type</span><span class="p">(</span><span class="n">preferences</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Evaluating AP over grid values </span><span class="si">{</span><span class="n">preferences</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">preference</span> <span class="ow">in</span> <span class="n">preferences</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ap_settings</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;preference&quot;</span><span class="p">:</span> <span class="n">preference</span><span class="p">}</span>
                    <span class="n">ap_settings</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                    <span class="n">cluster_dict</span><span class="p">,</span> <span class="n">progressions</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">cluster_AP_analysis</span><span class="p">(</span>
                        <span class="n">fit_df</span><span class="p">,</span> <span class="n">sil_calc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">refit</span><span class="o">=</span><span class="n">refit</span><span class="p">,</span> <span class="o">**</span><span class="n">ap_settings</span>
                    <span class="p">)</span>
                    <span class="n">npoor</span> <span class="o">=</span> <span class="p">(</span><span class="n">progressions</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">progressions</span><span class="p">[</span><span class="s2">&quot;Silhouette&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,)</span>
                    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">npoor</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">:</span>
                        <span class="n">npoor</span> <span class="o">=</span> <span class="n">npoor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">nclusters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster_dict</span><span class="p">)</span>
                    <span class="n">pref_test_data</span><span class="p">[</span><span class="n">preference</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                        <span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_dict</span><span class="p">,</span>
                        <span class="s2">&quot;nclusters&quot;</span><span class="p">:</span> <span class="n">nclusters</span><span class="p">,</span>
                        <span class="s2">&quot;npoor&quot;</span><span class="p">:</span> <span class="n">npoor</span><span class="p">,</span>
                        <span class="s2">&quot;avg_silh&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">progressions</span><span class="p">[</span><span class="s2">&quot;Silhouette&quot;</span><span class="p">]),</span>
                        <span class="s2">&quot;progression_df&quot;</span><span class="p">:</span> <span class="n">progressions</span><span class="p">,</span>
                    <span class="p">}</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">preference</span><span class="si">}</span><span class="s2"> has </span><span class="si">{</span><span class="n">npoor</span><span class="si">}</span><span class="s2"> poor fits &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;out of </span><span class="si">{</span><span class="n">nclusters</span><span class="si">}</span><span class="s2"> clusters (</span><span class="si">{</span><span class="n">npoor</span> <span class="o">/</span> <span class="n">nclusters</span><span class="si">}</span><span class="s2">).&quot;</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Perform the AP clustering with a single preference value</span>
            <span class="n">cluster_dict</span><span class="p">,</span> <span class="n">progressions</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">analysis</span><span class="o">.</span><span class="n">cluster_AP_analysis</span><span class="p">(</span>
                <span class="n">fit_df</span><span class="p">,</span> <span class="n">sil_calc</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">refit</span><span class="o">=</span><span class="n">refit</span><span class="p">,</span> <span class="o">**</span><span class="p">{</span><span class="s2">&quot;preference&quot;</span><span class="p">:</span> <span class="n">preferences</span><span class="p">}</span>
            <span class="p">)</span>
            <span class="n">npoor</span> <span class="o">=</span> <span class="p">(</span><span class="n">progressions</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">progressions</span><span class="p">[</span><span class="s2">&quot;Silhouette&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,)</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">npoor</span><span class="p">)</span> <span class="o">==</span> <span class="nb">tuple</span><span class="p">:</span>
                <span class="n">npoor</span> <span class="o">=</span> <span class="n">npoor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">nclusters</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cluster_dict</span><span class="p">)</span>
            <span class="n">pref_test_data</span><span class="p">[</span><span class="n">preferences</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;cluster_data&quot;</span><span class="p">:</span> <span class="n">cluster_dict</span><span class="p">,</span>
                <span class="s2">&quot;nclusters&quot;</span><span class="p">:</span> <span class="n">nclusters</span><span class="p">,</span>
                <span class="s2">&quot;npoor&quot;</span><span class="p">:</span> <span class="n">npoor</span><span class="p">,</span>
                <span class="s2">&quot;avg_silh&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">progressions</span><span class="p">[</span><span class="s2">&quot;Silhouette&quot;</span><span class="p">]),</span>
                <span class="s2">&quot;progression_df&quot;</span><span class="p">:</span> <span class="n">progressions</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">preferences</span><span class="si">}</span><span class="s2"> has </span><span class="si">{</span><span class="n">npoor</span><span class="si">}</span><span class="s2"> poor fits &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;out of </span><span class="si">{</span><span class="n">nclusters</span><span class="si">}</span><span class="s2"> clusters (</span><span class="si">{</span><span class="n">npoor</span> <span class="o">/</span> <span class="n">nclusters</span><span class="si">}</span><span class="s2">).&quot;</span>
            <span class="p">)</span>
        <span class="c1"># Make a plotly figure of how the clustering goes (with frequency)</span>
        <span class="c1"># as a function of preference</span>
        <span class="k">if</span> <span class="n">plot</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">go</span><span class="o">.</span><span class="n">FigureWidget</span><span class="p">()</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s2">&quot;xaxis&quot;</span><span class="p">][</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Frequency (MHz)&quot;</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s2">&quot;yaxis&quot;</span><span class="p">][</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Preference&quot;</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">layout</span><span class="p">[</span><span class="s2">&quot;xaxis&quot;</span><span class="p">][</span><span class="s2">&quot;tickformat&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.,&quot;</span>
            <span class="c1"># Loop over the preference values</span>
            <span class="k">for</span> <span class="n">preference</span><span class="p">,</span> <span class="n">contents</span> <span class="ow">in</span> <span class="n">pref_test_data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="c1"># Create the colors for the unique clusters</span>
                <span class="n">colors</span> <span class="o">=</span> <span class="n">figurefactory</span><span class="o">.</span><span class="n">generate_colors</span><span class="p">(</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">]),</span> <span class="nb">hex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Spectral</span>
                <span class="p">)</span>
                <span class="c1"># Assign a color to each cluster</span>
                <span class="n">cmap</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="n">index</span><span class="p">:</span> <span class="n">color</span>
                    <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">contents</span><span class="p">[</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">])),</span> <span class="n">colors</span>
                    <span class="p">)</span>
                <span class="p">}</span>
                <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">contents</span><span class="p">[</span><span class="s2">&quot;cluster_data&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">frequencies</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;Frequencies&quot;</span><span class="p">]</span>
                    <span class="n">fig</span><span class="o">.</span><span class="n">add_scattergl</span><span class="p">(</span>
                        <span class="n">x</span><span class="o">=</span><span class="n">frequencies</span><span class="p">,</span>
                        <span class="n">y</span><span class="o">=</span><span class="p">[</span><span class="n">preference</span> <span class="o">+</span> <span class="n">index</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">frequencies</span><span class="p">),</span>
                        <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;markers&quot;</span><span class="p">,</span>
                        <span class="n">marker</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;color&quot;</span><span class="p">:</span> <span class="n">cmap</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;#ffffff&quot;</span><span class="p">)},</span>
                        <span class="n">opacity</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">preference</span><span class="si">}</span><span class="s2">-</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
            <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">pref_test_data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pref_test_data</span></div>

<div class="viewcode-block" id="AssignmentSession.search_species"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.search_species">[docs]</a>    <span class="k">def</span> <span class="nf">search_species</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">formula</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">smiles</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Method for finding species in the assigned dataframe,</span>
<span class="sd">            with the intention of showing where the observed frequencies</span>
<span class="sd">            are.</span>

<span class="sd">            Parameters</span>
<span class="sd">            --------------</span>
<span class="sd">            formula - str for chemical formula lookup</span>
<span class="sd">            name - str for common name</span>
<span class="sd">            smiles - str for unique SMILES string</span>

<span class="sd">            Returns</span>
<span class="sd">            --------------</span>
<span class="sd">            pandas dataframe slice with corresponding lookup</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;table&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No assignment table created yet. Finalize assignments.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">formula</span><span class="p">:</span>
            <span class="n">locator</span> <span class="o">=</span> <span class="s2">&quot;formula&quot;</span>
            <span class="n">check</span> <span class="o">=</span> <span class="n">formula</span>
        <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">locator</span> <span class="o">=</span> <span class="s2">&quot;name&quot;</span>
            <span class="n">check</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">if</span> <span class="n">smiles</span><span class="p">:</span>
            <span class="n">locator</span> <span class="o">=</span> <span class="s2">&quot;smiles&quot;</span>
            <span class="n">check</span> <span class="o">=</span> <span class="n">smiles</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">[</span><span class="n">locator</span><span class="p">]</span> <span class="o">==</span> <span class="n">check</span><span class="p">]</span></div>

<div class="viewcode-block" id="AssignmentSession.save_session"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.AssignmentSession.save_session">[docs]</a>    <span class="k">def</span> <span class="nf">save_session</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Method to save an AssignmentSession to disk.</span>
<span class="sd">            </span>
<span class="sd">            The underlying mechanics are based on the joblib library,</span>
<span class="sd">            and so there can be cross-compatibility issues particularly</span>
<span class="sd">            when loading from different versions of Python.</span>

<span class="sd">            Parameters</span>
<span class="sd">            ---------------</span>
<span class="sd">             filepath - str</span>
<span class="sd">                Path to save the file to. By default it will go into the sessions folder.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filepath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;./sessions/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">experiment</span><span class="si">}</span><span class="s2">.pkl&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Saving session to </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;log_handlers&quot;</span><span class="p">):</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">log_handlers</span>
        <span class="c1"># Save to disk</span>
        <span class="n">routines</span><span class="o">.</span><span class="n">save_obj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="Molecule"><a class="viewcode-back" href="../../../pyspectools.spectra.html#pyspectools.spectra.assignment.Molecule">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Molecule</span><span class="p">(</span><span class="n">LineList</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Special instance of the LineList class. The idea is to eventually</span>
<span class="sd">    use the high speed fitting/cataloguing routines by Brandon to provide</span>
<span class="sd">    quick simulations overlaid on chirp spectra.</span>
<span class="sd">    </span>
<span class="sd">    Attributes</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">A</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">20000.0</span>
    <span class="n">B</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">6000.0</span>
    <span class="n">C</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3500.0</span>
    <span class="n">var_file</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
</pre></div>

    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2017—2020, Kelvin Lee.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.1.1.<br/>
    </p>
  </div>
</footer>
  </body>
</html>