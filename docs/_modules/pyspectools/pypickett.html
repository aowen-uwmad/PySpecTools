<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#2D2D2D" />
  
  <title>PySpecTools :: pyspectools.pypickett</title>
  

  <link rel="icon" type="image/png" sizes="32x32" href="../../_static/img/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../../_static/img/favicon-16x16.png">
        <link rel="index" title="Index"
              href="../../genindex.html"/>

  <link rel="stylesheet" href="../../_static/css/insegel.css"/>

  <script type="text/javascript">
    var DOCUMENTATION_OPTIONS = {
        URL_ROOT:'',
        VERSION:'4.1.5',
        LANGUAGE:'None',
        COLLAPSE_INDEX:false,
        FILE_SUFFIX:'.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
    };
  </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>

  <script src="https://email.tl.fortawesome.com/c/eJxNjUEOgyAQAF8jR7Kw6wIHDh7sP1Cw2mgxgmn6-3JsMqc5zEQfE8dkxOY1KKMUOI3ACFKRJpSW2AAp7ontYIaxI6i7XPJVwyeVfCQ550Os3jLrGSNOLgbdAy6s0PBk2TFNjEbsfq31LB0OnX407pJa5v2faRadwSW63mn5KuLyR9j2tgx3zecanl-55R_-jjPs"></script>

</head>

<body>
  <div id="insegel-container">
    <header>
      <div id="logo-container">
          
          <a href="../../index.html"><img src="../../_static/img/logo.svg"></a>
          

      </div>
      <div id="project-container">
        <h1>PySpecTools Documentation</h1>
      </div>
    </header>

    <div id="content-container">

      <div id="main-content-container">
        <div id="main-content-header">
          <h1>pyspectools.pypickett</h1>
        </div>
        <div id="main-content">
          
  <h1>Source code for pyspectools.pypickett</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="k">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="k">import</span> <span class="n">glob</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="k">import</span> <span class="n">dataclass</span><span class="p">,</span> <span class="n">field</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="k">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="k">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">product</span><span class="p">,</span> <span class="n">combinations_with_replacement</span>
<span class="kn">from</span> <span class="nn">subprocess</span> <span class="k">import</span> <span class="n">run</span><span class="p">,</span> <span class="n">PIPE</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">stat</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">joblib</span>
<span class="kn">from</span> <span class="nn">tqdm.autonotebook</span> <span class="k">import</span> <span class="n">tqdm</span>

<span class="kn">from</span> <span class="nn">pyspectools</span> <span class="k">import</span> <span class="n">routines</span>
<span class="kn">from</span> <span class="nn">pyspectools.spcat</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">pyspectools</span> <span class="k">import</span> <span class="n">parsers</span>
<span class="kn">from</span> <span class="nn">pyspectools.spectra.assignment</span> <span class="k">import</span> <span class="n">LineList</span>


<div class="viewcode-block" id="MoleculeFit"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.MoleculeFit">[docs]</a><span class="k">class</span> <span class="nc">MoleculeFit</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot; Class for handling the top level of a Pickett simulation.</span>
<span class="sd">        Inspired by PGopher, the `molecule` class stores information about</span>
<span class="sd">        whether we&#39;re dealing with a diatomic or polyatomic, number of lines</span>
<span class="sd">        to fit, temperature, etc.</span>

<span class="sd">        All of the information is bundled into a dictionary called `properties`.</span>

<span class="sd">        There are two methods right now that will generate a `molecule` object;</span>
<span class="sd">        `from_json` and `from_yaml`, which will interpret JSON and YAML input</span>
<span class="sd">        files respectively.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="MoleculeFit.from_json"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.MoleculeFit.from_json">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_json</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">json_filepath</span><span class="p">):</span>
        <span class="c1"># Generate a molecule from a specified JSON file</span>
        <span class="n">json_data</span> <span class="o">=</span> <span class="n">read_json</span><span class="p">(</span><span class="n">json_filepath</span><span class="p">)</span>
        <span class="n">species</span> <span class="o">=</span> <span class="n">MoleculeFit</span><span class="p">(</span><span class="n">json_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">species</span></div>

<div class="viewcode-block" id="MoleculeFit.from_yaml"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.MoleculeFit.from_yaml">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_yaml</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">yaml_filepath</span><span class="p">):</span>
        <span class="c1"># Generate a molecule object from a YAML file</span>
        <span class="n">yaml_data</span> <span class="o">=</span> <span class="n">read_yaml</span><span class="p">(</span><span class="n">yaml_filepath</span><span class="p">)</span>
        <span class="n">species</span> <span class="o">=</span> <span class="n">MoleculeFit</span><span class="p">(</span><span class="n">yaml_data</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">species</span></div>

<div class="viewcode-block" id="MoleculeFit.from_pickle"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.MoleculeFit.from_pickle">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_pickle</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">picklepath</span><span class="p">):</span>
        <span class="c1"># Generate a molecule object from a pickle instance</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">picklepath</span><span class="p">)</span> <span class="k">as</span> <span class="n">pickle_read</span><span class="p">:</span>
            <span class="n">species</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">pickle_read</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">species</span></div>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Initialize the default properties of a diatomic molecule</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;Molecule&quot;</span><span class="p">,</span>
            <span class="s2">&quot;tag&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(),</span>  <span class="c1"># human input of parameters</span>
            <span class="s2">&quot;linear&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;symmetric&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;prolate&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;dipole&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">},</span>
            <span class="s2">&quot;reduction&quot;</span><span class="p">:</span> <span class="s2">&quot;A&quot;</span><span class="p">,</span>
            <span class="s2">&quot;spin&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;spin degeneracy&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="c1"># These are options for the simulation</span>
            <span class="s2">&quot;units&quot;</span><span class="p">:</span> <span class="s2">&quot;MHz&quot;</span><span class="p">,</span>
            <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span>
            <span class="s2">&quot;intensity threshold&quot;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">8.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">3.0</span><span class="p">],</span>
            <span class="s2">&quot;K range&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>  <span class="c1"># range for K quantum number</span>
            <span class="s2">&quot;partition function&quot;</span><span class="p">:</span> <span class="mf">1e3</span><span class="p">,</span>
            <span class="s2">&quot;interactions&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;quantum number range&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">99</span><span class="p">],</span>
            <span class="s2">&quot;odd state weight&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;even state weight&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;frequency limit&quot;</span><span class="p">:</span> <span class="mf">100.0</span><span class="p">,</span>
            <span class="s2">&quot;vibration limit&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;vsym&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;ewt&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;statistical axis&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s2">&quot;number of parameters&quot;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s2">&quot;number of lines&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;number of iterations&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="s2">&quot;number of skipped lines&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;marquadrt-levenburg&quot;</span><span class="p">:</span> <span class="mf">0.0000e00</span><span class="p">,</span>
            <span class="s2">&quot;maximum error&quot;</span><span class="p">:</span> <span class="mf">1e13</span><span class="p">,</span>
            <span class="s2">&quot;fractional importance&quot;</span><span class="p">:</span> <span class="mf">1.0000e00</span><span class="p">,</span>
            <span class="s2">&quot;IR scaling&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="s2">&quot;diagonalization&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;xopt&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">param_objects</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># stores parameter objects</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">iteration_count</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># running count of iterations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iterations</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># stores data from each iteration</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">top_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>  <span class="c1"># top directory always stored</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cwd</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># current working directory</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">experimental_lines</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># experimental lines that go to a .lin</span>

        <span class="c1"># Function that updates parameters, and re-writes the .par and .int</span>
        <span class="c1"># files.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initialize</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Interactive plotting option</span>

<div class="viewcode-block" id="MoleculeFit.initialize"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.MoleculeFit.initialize">[docs]</a>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method that will rewrite the .par and .int files, after updating</span>
<span class="sd">            the properties dictionary.</span>

<span class="sd">            Any warnings regarding common mistakes in input files should also be</span>
<span class="sd">            flagged here.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">options</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">options</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">generate_parameter_objects</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">check_input</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">setup_int</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_par</span><span class="p">()</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initialized settings for molecule &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span></div>

<div class="viewcode-block" id="MoleculeFit.check_input"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.MoleculeFit.check_input">[docs]</a>    <span class="k">def</span> <span class="nf">check_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method for going through the input settings and flagging common</span>
<span class="sd">            mistakes.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If the K range is set to 0, but the molecule is not linear</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;K range&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;linear&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">UserWarning</span><span class="p">(</span>
                <span class="s2">&quot;Warning: You have specified a non-linear molecule </span><span class="se">\</span>
<span class="s2">                               and the maximum K value is unset. Result cat file </span><span class="se">\</span>
<span class="s2">                               may be empty!&quot;</span>
            <span class="p">)</span>

        <span class="c1"># If A and C constants are given and molecule is supposed to be linear</span>
        <span class="k">if</span> <span class="p">[</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="s2">&quot;C&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;linear&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">UserWarning</span><span class="p">(</span>
                    <span class="s2">&quot;Molecule flagged as linear, </span><span class="se">\</span>
<span class="s2">                                   but A and C constants specified.&quot;</span>
                <span class="p">)</span></div>

<div class="viewcode-block" id="MoleculeFit.generate_parameter_objects"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.MoleculeFit.generate_parameter_objects">[docs]</a>    <span class="k">def</span> <span class="nf">generate_parameter_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">param_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">param_objects</span><span class="p">[</span><span class="n">param_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameter</span><span class="p">(</span>
                <span class="n">param_key</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="n">param_key</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;reduction&quot;</span><span class="p">],</span>
                <span class="n">linear</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;linear&quot;</span><span class="p">],</span>
                <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="MoleculeFit.nuclear"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.MoleculeFit.nuclear">[docs]</a>    <span class="k">def</span> <span class="nf">nuclear</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Function that cleans up Pickett files in a folder &quot;&quot;&quot;</span>
        <span class="n">filelist</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;.cat&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.var&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.par&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.int&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_parsedlines.csv&quot;</span><span class="p">,</span>
            <span class="s2">&quot;_spectrum.pdf&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.fit&quot;</span><span class="p">,</span>
            <span class="s2">&quot;.out&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">filelist</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">delete</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s2">&quot;rm &quot;</span> <span class="o">+</span> <span class="n">file</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                    <span class="c1"># Ignore files that aren&#39;t in the folder</span>
                    <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">EnvironmentError</span><span class="p">(</span><span class="s2">&quot;Please provide a True value to confirm deletion!&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MoleculeFit.toggle_interactive"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.MoleculeFit.toggle_interactive">[docs]</a>    <span class="k">def</span> <span class="nf">toggle_interactive</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">connected</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to toggle interactive plots on and off &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span> <span class="o">=</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span>
        <span class="n">init_notebook_mode</span><span class="p">(</span><span class="n">connected</span><span class="o">=</span><span class="n">connected</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">interactive</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="c1"># Pseudo-disconnect interactivity by removing JS injections</span>
            <span class="n">init_notebook_mode</span><span class="p">(</span><span class="n">connected</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>

<div class="viewcode-block" id="MoleculeFit.setup_par"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.MoleculeFit.setup_par">[docs]</a>    <span class="k">def</span> <span class="nf">setup_par</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Function that provides the correct formatting for a .par file &quot;&quot;&quot;</span>
        <span class="n">opt_line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">opt_line</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;number of parameters&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
        <span class="n">opt_line</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;number of lines&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
        <span class="n">opt_line</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;number of iterations&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
        <span class="n">opt_line</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;number of skipped lines&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
        <span class="n">opt_line</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;marquadrt-levenburg&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
        <span class="n">opt_line</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;maximum error&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
        <span class="n">opt_line</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;fractional importance&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
        <span class="n">opt_line</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;IR scaling&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>

        <span class="n">prop_line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="n">prop_line</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;reduction&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="c1"># Format the spin degeneracy sign - if it&#39;s positive, we use asym top</span>
        <span class="c1"># quantum numbers. If negative use symmetric top.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;symmetric&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;linear&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">prop_line</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">negative</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;spin degeneracy&quot;</span><span class="p">]))</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;symmetric&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;linear&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span>
        <span class="p">):</span>
            <span class="n">prop_line</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;spin degeneracy&quot;</span><span class="p">]))</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;symmetric&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;linear&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span>
        <span class="p">):</span>
            <span class="n">prop_line</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">negative</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;spin degeneracy&quot;</span><span class="p">]))</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
            <span class="p">)</span>
        <span class="c1"># Format the sign of vibration limit; negative treats top as oblate case</span>
        <span class="c1"># while positive treats the prolate case</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;prolate&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;linear&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">prop_line</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">absolute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;vibration limit&quot;</span><span class="p">]))</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;prolate&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;linear&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">prop_line</span> <span class="o">+=</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">negative</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;vibration limit&quot;</span><span class="p">]))</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">prop_line</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;vibration limit&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
        <span class="n">prop_line</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;K range&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
        <span class="n">prop_line</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;K range&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
        <span class="n">prop_line</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;interactions&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
        <span class="n">prop_line</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;statistical axis&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
        <span class="n">prop_line</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;even state weight&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
        <span class="n">prop_line</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;odd state weight&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span>
        <span class="n">prop_line</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;vsym&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">prop_line</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;ewt&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">prop_line</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;diagonalization&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="n">prop_line</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;xopt&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
        <span class="c1"># may be missing EWT</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.par&quot;</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">write_file</span><span class="p">:</span>
            <span class="n">write_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">write_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">opt_line</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">write_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">prop_line</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_objects</span><span class="p">:</span>
                <span class="n">par_line</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">param_objects</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span><span class="o">.</span><span class="n">format_line</span><span class="p">()</span>
                <span class="n">write_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">par_line</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MoleculeFit.setup_int"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.MoleculeFit.setup_int">[docs]</a>    <span class="k">def</span> <span class="nf">setup_int</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Setup the int file. Order of things written:</span>
<span class="sd">            1. units</span>
<span class="sd">            2. molecular tag identifier</span>
<span class="sd">            3. partition function</span>
<span class="sd">            4. quantum number lower limit</span>
<span class="sd">            5. quantum number upper limit</span>
<span class="sd">            6. intensity threshold lower limit</span>
<span class="sd">            7. intensity threshold upper limit</span>
<span class="sd">            8. frequency limit in GHz</span>
<span class="sd">            9. vibrational quantum number limit</span>
<span class="sd">            10. dipole moments</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">settings_line</span> <span class="o">=</span> <span class="s2">&quot; &quot;</span>  <span class="c1"># units of the sim</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;wavenumbers&quot;</span><span class="p">:</span>
            <span class="n">settings_line</span> <span class="o">+=</span> <span class="s2">&quot;1&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;MHz&quot;</span><span class="p">:</span>
            <span class="n">settings_line</span> <span class="o">+=</span> <span class="s2">&quot;0&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">settings_line</span> <span class="o">+=</span> <span class="s2">&quot;0&quot;</span>
        <span class="n">settings_line</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;tag&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">settings_line</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;partition function&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;quantum number range&quot;</span><span class="p">]:</span>
            <span class="n">settings_line</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;intensity threshold&quot;</span><span class="p">]:</span>
            <span class="n">settings_line</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
        <span class="n">settings_line</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;frequency limit&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
        <span class="n">settings_line</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
        <span class="n">settings_line</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;vibration limit&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.int&quot;</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">write_file</span><span class="p">:</span>
            <span class="n">write_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">write_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">settings_line</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">projection</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;dipole&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">projection</span> <span class="o">==</span> <span class="s2">&quot;A&quot;</span><span class="p">:</span>
                    <span class="n">write_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="s2">&quot; 1      &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;dipole&quot;</span><span class="p">][</span><span class="n">projection</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">projection</span> <span class="o">==</span> <span class="s2">&quot;B&quot;</span><span class="p">:</span>
                    <span class="n">write_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="s2">&quot; 2      &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;dipole&quot;</span><span class="p">][</span><span class="n">projection</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">projection</span> <span class="o">==</span> <span class="s2">&quot;C&quot;</span><span class="p">:</span>
                    <span class="n">write_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="s2">&quot; 3      &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;dipole&quot;</span><span class="p">][</span><span class="n">projection</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="p">)</span></div>

<div class="viewcode-block" id="MoleculeFit.fit_lines"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.MoleculeFit.fit_lines">[docs]</a>    <span class="k">def</span> <span class="nf">fit_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top_dir</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.lin&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">runinput</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Run calbak to generate a .lin file from .cat? (Y/N)&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">runinput</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
                <span class="n">run_calbak</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.lin not found!&quot;</span><span class="p">)</span>

        <span class="c1"># Read in the .lin file to to figure out the number of lines we&#39;re going</span>
        <span class="c1"># to use in the fit. Right now, the contents are saved to a lin_file</span>
        <span class="c1"># attribute as a list, but can potentially be used to do more...</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.lin&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">read_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lin_file</span> <span class="o">=</span> <span class="n">read_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
            <span class="c1"># self.properties[&quot;number of lines&quot;] = len(self.lin_file)</span>

        <span class="c1"># Figure out what the next iteration is</span>
        <span class="n">folder_number</span> <span class="o">=</span> <span class="n">generate_folder</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cwd</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">folder_number</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span>
        <span class="c1"># If this is the first iteration, backup the data before we do anything</span>
        <span class="k">if</span> <span class="n">folder_number</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s2">&quot;initial&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s2">&quot;initial&quot;</span><span class="p">)</span>
            <span class="n">backup_files</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="s2">&quot;./initial/&quot;</span><span class="p">)</span>
        <span class="c1"># Copy files to the work directory</span>
        <span class="n">backup_files</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">cwd</span><span class="p">)</span>

        <span class="c1"># write the settings used for the current simulation to disk</span>
        <span class="n">dump_yaml</span><span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">folder_number</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.yml&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span>
        <span class="p">)</span>
        <span class="c1"># change directory to the new working directory</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cwd</span><span class="p">)</span>
        <span class="c1"># Write the .int and .par file to disk</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_int</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_par</span><span class="p">()</span>
        <span class="c1"># Run SPFIT to fit the lines</span>
        <span class="n">run_spfit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
        <span class="c1"># Create an instance of a fit object, and add it to the pile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iterations</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iteration_count</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit_output</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.fit&quot;</span><span class="p">,</span>
            <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span>
            <span class="n">interactive</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">interactive</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predict_lines</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top_dir</span><span class="p">)</span>

        <span class="c1"># Update the parameters in the molecule instance!</span>
        <span class="n">current_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterations</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">iteration_count</span><span class="p">]</span><span class="o">.</span><span class="n">export_parameters</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iteration_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_parameters</span><span class="p">(</span><span class="n">current_params</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Save the updated parameters to disk</span>
        <span class="n">dump_yaml</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cwd</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.fit.yml&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Current parameters (MHz)&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">current_params</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="n">parameter</span>
                <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_params</span><span class="p">[</span><span class="n">parameter</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">])</span>
                <span class="o">+</span> <span class="s2">&quot;(&quot;</span>
                <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">current_params</span><span class="p">[</span><span class="n">parameter</span><span class="p">][</span><span class="s2">&quot;uncertainty&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="MoleculeFit.calbak"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.MoleculeFit.calbak">[docs]</a>    <span class="k">def</span> <span class="nf">calbak</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Run calbak to generate a .lin file from .cat &quot;&quot;&quot;</span>
        <span class="n">run_calbak</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.lin&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">read_file</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">read_file</span><span class="o">.</span><span class="n">read</span><span class="p">())</span></div>

<div class="viewcode-block" id="MoleculeFit.predict_lines"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.MoleculeFit.predict_lines">[docs]</a>    <span class="k">def</span> <span class="nf">predict_lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Run SPCAT to predict lines based on a .var and .int file.</span>
<span class="sd">            This will operate in the current directory - since it does not</span>
<span class="sd">            need to overwrite any files, we don&#39;t actually back up anything!</span>

<span class="sd">            The predicted lines are also parsed into a .csv file, and plot up</span>
<span class="sd">            into: (A) a notebook inline plot, and (B) a PDF output.</span>

<span class="sd">            SPCAT is run twice - first to get the partition function, and second</span>
<span class="sd">            to get the correct intensities.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># First pass of SPCAT; get the partition function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;partition function&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">run_spcat</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span>
            <span class="n">temperature</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">{:.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">]),</span>
        <span class="p">)</span>
        <span class="c1"># Make sure the int file has the correct partition function</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">setup_int</span><span class="p">()</span>
        <span class="c1"># Second pass of SPCAT with correct intensities</span>
        <span class="n">run_spcat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">])</span>
        <span class="c1"># Parse the output of SPCAT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cat_lines</span> <span class="o">=</span> <span class="n">parsers</span><span class="o">.</span><span class="n">parse_cat</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.cat&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Saving the parsed lines to &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_parsedlines.csv&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cat_lines</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_parsedlines.csv&quot;</span><span class="p">)</span>

        <span class="c1"># Plot the .cat file up</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plot_pickett</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_lines</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top_dir</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;_spectrum.pdf&quot;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;pdf&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MoleculeFit.copy_settings"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.MoleculeFit.copy_settings">[docs]</a>    <span class="k">def</span> <span class="nf">copy_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Copy settings used in a previous iteration</span>
<span class="sd">            If none specified, we&#39;ll take the settings from before the first fit</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">iteration</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">iteration</span> <span class="o">=</span> <span class="s2">&quot;initial&quot;</span>
        <span class="c1"># current_params = self.iterations[iteration].export_parameters()</span>
        <span class="n">iteration_folder</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">iteration</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">iteration_folder</span> <span class="o">+</span> <span class="s2">&quot;.fit.yml&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">iteration_file</span> <span class="o">=</span> <span class="n">iteration_folder</span> <span class="o">+</span> <span class="s2">&quot;.fit.yml&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">iteration_file</span> <span class="o">=</span> <span class="n">iteration_folder</span> <span class="o">+</span> <span class="s2">&quot;.yml&quot;</span>
        <span class="n">iteration_params</span> <span class="o">=</span> <span class="n">read_yaml</span><span class="p">(</span><span class="n">iteration_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">iteration_params</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Settings copied from &quot;</span> <span class="o">+</span> <span class="n">iteration_file</span><span class="p">)</span></div>

<div class="viewcode-block" id="MoleculeFit.update_parameters"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.MoleculeFit.update_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">update_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Update the simulation parameters</span>
<span class="sd">            This is written with a loop in order to make sure the</span>
<span class="sd">            keys that aren&#39;t specified remain the same as before without</span>
<span class="sd">            change.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_parameter_objects</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span></div>

<div class="viewcode-block" id="MoleculeFit.backup"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.MoleculeFit.backup">[docs]</a>    <span class="k">def</span> <span class="nf">backup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method for backing up files for a specific reason.</span>
<span class="sd">            The most common use I have for this is to backup .cat and .lin files</span>
<span class="sd">            for whatever reason (adding/removing lines to/from fit)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">comment</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Please provide a comment for this backup!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s2">&quot;backup&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s2">&quot;backup&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="s2">&quot;backup&quot;</span><span class="p">)</span>
        <span class="n">folder_number</span> <span class="o">=</span> <span class="n">generate_folder</span><span class="p">()</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">folder_number</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/README&quot;</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">write_file</span><span class="p">:</span>
            <span class="n">write_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">comment</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top_dir</span><span class="p">)</span>
        <span class="n">backup_files</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="s2">&quot;./backup/&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">folder_number</span><span class="p">))</span></div>

<div class="viewcode-block" id="MoleculeFit.restore_backup"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.MoleculeFit.restore_backup">[docs]</a>    <span class="k">def</span> <span class="nf">restore_backup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">number</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Restores backed up files from the `backup` method &quot;&quot;&quot;</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="s2">&quot;backup/&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">number</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;/*&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">top_dir</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Restored from backup &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">number</span><span class="p">))</span></div>

<div class="viewcode-block" id="MoleculeFit.save_progress"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.MoleculeFit.save_progress">[docs]</a>    <span class="k">def</span> <span class="nf">save_progress</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="s2">&quot;instances&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="s2">&quot;instances&quot;</span><span class="p">)</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span>
            <span class="s2">&quot;instances/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.</span><span class="si">%s</span><span class="s2">.pickle&quot;</span> <span class="o">%</span> <span class="n">counter</span>
        <span class="p">):</span>
            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span>
            <span class="s2">&quot;instances/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.pickle&quot;</span><span class="p">,</span>
            <span class="s2">&quot;wb&quot;</span><span class="p">,</span>
        <span class="p">)</span> <span class="k">as</span> <span class="n">write_file</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">write_file</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span></div>

<div class="viewcode-block" id="MoleculeFit.set_fit"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.MoleculeFit.set_fit">[docs]</a>    <span class="k">def</span> <span class="nf">set_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Function to flip all parameters to fit or not to fit.</span>
<span class="sd">            The default behaviour, if nothing is provided, is to fit all the</span>
<span class="sd">            parameters.</span>

<span class="sd">            A list of parameters can be supplied to the params argument, which</span>
<span class="sd">            will specifically fit or not fit those parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">str</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">params</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                    <span class="s2">&quot;Parameter &quot;</span> <span class="o">+</span> <span class="n">parameter</span> <span class="o">+</span> <span class="s2">&quot; is not in your parameter list!&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="n">parameter</span><span class="p">][</span><span class="s2">&quot;fit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">params</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">parameter</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                        <span class="s2">&quot;Parameter &quot;</span> <span class="o">+</span> <span class="n">parameter</span> <span class="o">+</span> <span class="s2">&quot; is not in your parameter list!&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="n">parameter</span><span class="p">][</span><span class="s2">&quot;fit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">generate_parameter_objects</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span></div>

<div class="viewcode-block" id="MoleculeFit.report_parameters"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.MoleculeFit.report_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">report_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Method to return a dictionary of only the parameter values &quot;&quot;&quot;</span>
        <span class="n">param_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]:</span>
            <span class="n">param_dict</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="n">parameter</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">param_dict</span></div>

<div class="viewcode-block" id="MoleculeFit.finalize"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.MoleculeFit.finalize">[docs]</a>    <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Been hard to keep track which iteration was the final one</span>
<span class="sd">            sometimes, and so this function will &quot;finalize&quot; the fits by</span>
<span class="sd">            creating a separate folder for the final fits.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">iteration</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># If no iteration is specified, the last iteration is used</span>
            <span class="n">iteration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iteration_count</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No iteration specified, using the last iteration.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top_dir</span> <span class="o">+</span> <span class="s2">&quot;/final&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">confirmation</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;Final folder exists. Confirm deletion? Y/N&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">confirmation</span> <span class="o">==</span> <span class="s2">&quot;y&quot;</span><span class="p">:</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top_dir</span> <span class="o">+</span> <span class="s2">&quot;/final&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Final folder exists, and not deleting.&quot;</span><span class="p">)</span>
        <span class="c1"># Copy the files over from designated iteration</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top_dir</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">iteration</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">top_dir</span> <span class="o">+</span> <span class="s2">&quot;/final&quot;</span><span class="p">)</span>
        <span class="c1"># Generate a report for the final fits</span>
        <span class="k">for</span> <span class="n">parameter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s2">&quot;uncertainty&quot;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="n">parameter</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="n">parameter</span><span class="p">][</span><span class="s2">&quot;formatted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="n">parameter</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">])</span>
                    <span class="o">+</span> <span class="s2">&quot;(&quot;</span>
                    <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="n">parameter</span><span class="p">][</span><span class="s2">&quot;uncertainty&quot;</span><span class="p">])</span>
                    <span class="o">+</span> <span class="s2">&quot;)&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="n">parameter</span><span class="p">][</span><span class="s2">&quot;formatted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="n">parameter</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
                <span class="p">)</span>
        <span class="n">report_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top_dir</span> <span class="o">+</span> <span class="s2">&quot;/final/parameter_report.html&quot;</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">write_file</span><span class="p">:</span>
            <span class="n">write_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">report_df</span><span class="o">.</span><span class="n">to_html</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">top_dir</span> <span class="o">+</span> <span class="s2">&quot;/final/*&quot;</span><span class="p">):</span>
            <span class="c1"># Make the final files read-only</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chmod</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IRGRP</span> <span class="o">|</span> <span class="n">stat</span><span class="o">.</span><span class="n">S_IROTH</span><span class="p">)</span></div>

<div class="viewcode-block" id="MoleculeFit.parameter_scan"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.MoleculeFit.parameter_scan">[docs]</a>    <span class="k">def</span> <span class="nf">parameter_scan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">relaxed</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; A method for automatically scanning parameter space to see</span>
<span class="sd">            what values give a minimum RMS.</span>

<span class="sd">            We will repeatedly call SPFIT to estimate the fitting error</span>
<span class="sd">            based on what the parameters are. There are two modes depending</span>
<span class="sd">            on the `relaxed` variable: whether or not all other values are</span>
<span class="sd">            allowed to relax (like a relaxed potential energy scan) or if</span>
<span class="sd">            all parameters are held frozen.</span>

<span class="sd">            Args:</span>
<span class="sd">            parameter - a string input name of the parameter to change</span>
<span class="sd">            values - a list or array of values to be scanned</span>
<span class="sd">            relaxed - boolean determining whether the parameters are fixed</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Make sure none of the parameters are being fit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_fit</span><span class="p">(</span><span class="n">fit</span><span class="o">=</span><span class="n">relaxed</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># We won&#39;t fit the scanning parameter regardless of relaxation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="n">parameter</span><span class="p">][</span><span class="s2">&quot;fit&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># &quot;Remember&quot; what the parameter settings were at this point in time</span>
        <span class="n">parameter_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span>
        <span class="c1"># Loop over all the specified values</span>
        <span class="n">parameter_values</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">values</span><span class="p">):</span>
            <span class="c1"># Reset the parameters to scan values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parameter_dict</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="n">parameter</span><span class="p">][</span><span class="s2">&quot;value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">generate_parameter_objects</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># Silence the output</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fit_lines</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># Record the final RMS error for this parameter</span>
            <span class="n">current_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">report_parameters</span><span class="p">()</span>
            <span class="n">last_key</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">iterations</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            <span class="n">current_params</span><span class="p">[</span><span class="s2">&quot;rms&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">iterations</span><span class="p">[</span><span class="n">last_key</span><span class="p">]</span><span class="o">.</span><span class="n">fit_properties</span><span class="p">[</span>
                <span class="s2">&quot;final rms&quot;</span>
            <span class="p">]</span>
            <span class="n">parameter_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_params</span><span class="p">)</span>
        <span class="n">scan_report</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">parameter_values</span><span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">))</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">scan_report</span><span class="p">[</span><span class="n">parameter</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">scan_report</span><span class="p">[</span><span class="s2">&quot;rms&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;RMS (MHz)&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="n">parameter</span> <span class="o">+</span> <span class="s2">&quot; value (MHz)&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">values</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Parameter scan for &quot;</span> <span class="o">+</span> <span class="n">parameter</span><span class="p">)</span>

        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
            <span class="s2">&quot;scan_&quot;</span> <span class="o">+</span> <span class="n">parameter</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">,</span>
            <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;pdf&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">isnotebook</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">scan_report</span> <span class="o">=</span> <span class="n">scan_report</span></div>

<div class="viewcode-block" id="MoleculeFit.parameter"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.MoleculeFit.parameter">[docs]</a>    <span class="k">class</span> <span class="nc">parameter</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Class for handling parameters in Pickett.</span>
<span class="sd">            Each instance has a human name (i.e. A, B, C constants) which</span>
<span class="sd">            is to be translated to Pickett identifiers.</span>

<span class="sd">            A `fit` flag is used to denote whether or not the parameter</span>
<span class="sd">            is going to be fit, which automatically sets the uncertainty</span>
<span class="sd">            to a large number.</span>

<span class="sd">            Nuclear spin terms will have the nuclei identifier</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">parameter_dict</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="n">linear</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">):</span>
            <span class="c1"># Initialize values for parameters</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variables</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
                <span class="s2">&quot;uncertainty&quot;</span><span class="p">:</span> <span class="mf">1e-25</span><span class="p">,</span>
                <span class="s2">&quot;fit&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;identifier&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;nuclei&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="c1"># After initializing, put in user values</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parameter_dict</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fit_check</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># Format the parameter printing to be nicer</span>
                <span class="n">pp</span> <span class="o">=</span> <span class="n">pprint</span><span class="o">.</span><span class="n">PrettyPrinter</span><span class="p">(</span><span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
                <span class="n">pp</span><span class="o">.</span><span class="n">pprint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;nuclei&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;eQq&quot;</span><span class="p">,</span>
                <span class="s2">&quot;eQq/2&quot;</span><span class="p">,</span>
            <span class="p">]:</span>
                <span class="c1"># warning message issued if no nucleus specified</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;You have specificed a hyperfine parameter, but&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;did not specify a nucleus in your input file.&quot;</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Hyperfine parameter with no nuclei ID!&quot;</span><span class="p">)</span>

            <span class="c1"># Convert the human parameter name to a Pickett identifier</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;identifier&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">human2pickett</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">reduction</span><span class="p">,</span> <span class="n">linear</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;nuclei&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;fit&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># flag variable for fitting</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;uncertainty&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e25</span>

<div class="viewcode-block" id="MoleculeFit.parameter.format_line"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.MoleculeFit.parameter.format_line">[docs]</a>        <span class="k">def</span> <span class="nf">format_line</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; Formats a string output to match the Pickett format for a parameter &quot;&quot;&quot;</span>
            <span class="n">pickett_line</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;identifier&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">13</span><span class="p">)</span>
            <span class="n">pickett_line</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span>
            <span class="n">pickett_line</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;uncertainty&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
            <span class="n">pickett_line</span> <span class="o">+=</span> <span class="s2">&quot; /&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">pickett_line</span></div>

<div class="viewcode-block" id="MoleculeFit.parameter.fit_check"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.MoleculeFit.parameter.fit_check">[docs]</a>        <span class="k">def</span> <span class="nf">fit_check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot; A function to flip the uncertainty if we will fit a parameter &quot;&quot;&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;fit&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;uncertainty&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e25</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s2">&quot;uncertainty&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1e-25</span></div></div>

<div class="viewcode-block" id="MoleculeFit.exp_line"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.MoleculeFit.exp_line">[docs]</a>    <span class="k">class</span> <span class="nc">exp_line</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Class for an experimental line. Converts to and from .lin files. &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">uncertainty</span><span class="p">,</span> <span class="n">lower_num</span><span class="p">,</span> <span class="n">upper_num</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;frequency&quot;</span><span class="p">:</span> <span class="n">frequency</span><span class="p">,</span>  <span class="c1"># frequency in MHz</span>
                <span class="s2">&quot;uncertainty&quot;</span><span class="p">:</span> <span class="n">uncertainty</span><span class="p">,</span>  <span class="c1"># uncertainty in MHz</span>
                <span class="s2">&quot;lower quantum nos.&quot;</span><span class="p">:</span> <span class="n">lower_num</span><span class="p">,</span>  <span class="c1"># list of quantum numbers</span>
                <span class="s2">&quot;upper quantum nos.&quot;</span><span class="p">:</span> <span class="n">upper_num</span><span class="p">,</span>  <span class="c1"># for lower and upper states</span>
                <span class="s2">&quot;comment&quot;</span><span class="p">:</span> <span class="n">comment</span><span class="p">,</span>
            <span class="p">}</span>

<div class="viewcode-block" id="MoleculeFit.exp_line.update_line"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.MoleculeFit.exp_line.update_line">[docs]</a>        <span class="k">def</span> <span class="nf">update_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line_dict</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">line_dict</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">)</span></div>

<div class="viewcode-block" id="MoleculeFit.exp_line.format_quantum_numbers"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.MoleculeFit.exp_line.format_quantum_numbers">[docs]</a>        <span class="k">def</span> <span class="nf">format_quantum_numbers</span><span class="p">(</span><span class="n">quantum_list</span><span class="p">):</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">quantum_list</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>  <span class="c1"># each quantum number is right</span>
            <span class="k">return</span> <span class="n">line</span>  <span class="c1"># justified by 3 positions...</span></div>

<div class="viewcode-block" id="MoleculeFit.exp_line.format_line"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.MoleculeFit.exp_line.format_line">[docs]</a>        <span class="k">def</span> <span class="nf">format_line</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
            <span class="c1"># Formatting for a .lin line</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_quantum_numbers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;upper quantum nos.&quot;</span><span class="p">])</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">format_quantum_numbers</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;lower quantum nos.&quot;</span><span class="p">])</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;frequency&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">33</span><span class="p">)</span>
            <span class="n">line</span> <span class="o">+=</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;uncertainty&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">rjust</span><span class="p">(</span><span class="mi">9</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;comment&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot; /&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span><span class="p">[</span><span class="s2">&quot;comment&quot;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">line</span></div></div></div>


<div class="viewcode-block" id="QuantumNumber"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.QuantumNumber">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">QuantumNumber</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for a Quantum Number.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">value</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">upper</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">frozen</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">j</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">center</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">width</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">delta</span><span class="p">:</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">center</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

<div class="viewcode-block" id="QuantumNumber.roll"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.QuantumNumber.roll">[docs]</a>    <span class="k">def</span> <span class="nf">roll</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate a random value for the current quantum number.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">center</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span></div>

<div class="viewcode-block" id="QuantumNumber.spawn_upper"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.QuantumNumber.spawn_upper">[docs]</a>    <span class="k">def</span> <span class="nf">spawn_upper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a new QuantumNumber instance for the corresponding upper state.</span>
<span class="sd">        Will also shift the quantum number to a new value, +/-2,1,0.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        QuantumNumber: object</span>
<span class="sd">            A deep copy of the current QuantumNumber instance, but also shifts the</span>
<span class="sd">            quantum number by a random integer.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If the user specified did not give a value of delta to enforce, generate it</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">center</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">delta</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">delta</span>
        <span class="n">new_qno</span> <span class="o">=</span> <span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_qno</span><span class="o">.</span><span class="n">value</span> <span class="o">+</span> <span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">new_qno</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">new_qno</span><span class="o">.</span><span class="n">value</span> <span class="o">+=</span> <span class="n">delta</span>
        <span class="n">new_qno</span><span class="o">.</span><span class="n">upper</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">new_qno</span></div></div>


<div class="viewcode-block" id="Transition"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.Transition">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Transition</span><span class="p">:</span>
    <span class="n">frequency</span><span class="p">:</span> <span class="nb">float</span>
    <span class="n">n_numbers</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">quantum_numbers</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">j</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">lower_state</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">upper_state</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">centers</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">widths</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">deltas</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">uncertainty</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.005</span>

<div class="viewcode-block" id="Transition.from_list"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.Transition.from_list">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_list</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">qnos</span><span class="p">,</span> <span class="n">uncertainty</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class method to spawn a Transition from a list of quantum numbers.</span>
<span class="sd">        This takes a flat iterable (qnos), and splits it into two; the first</span>
<span class="sd">        half is used for the lower state quantum numbers, and the second half</span>
<span class="sd">        the upper state.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        frequency: float</span>
<span class="sd">            Frequency of the transition in MHz</span>
<span class="sd">        qnos: list</span>
<span class="sd">            Flat list of quantum numbers, includes both lower and upper states</span>
<span class="sd">        uncertainty: float or None, optional</span>
<span class="sd">            Optional frequency uncertainty of the transition in MHz. Defaults to None, which uses</span>
<span class="sd">            the default value of 0.005 MHz.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Transition: object</span>
<span class="sd">            Transition object initialized with the specifications</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">n_numbers</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">qnos</span><span class="p">)</span>
        <span class="n">half</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n_numbers</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="n">frequency</span><span class="o">=</span><span class="n">frequency</span><span class="p">,</span> <span class="n">n_numbers</span><span class="o">=</span><span class="n">n_numbers</span><span class="p">,</span> <span class="n">uncertainty</span><span class="o">=</span><span class="n">uncertainty</span><span class="p">)</span>
        <span class="n">lower_state</span> <span class="o">=</span> <span class="n">qnos</span><span class="p">[:</span><span class="n">half</span><span class="p">]</span>
        <span class="n">upper_state</span> <span class="o">=</span> <span class="n">qnos</span><span class="p">[</span><span class="n">half</span><span class="p">:]</span>
        <span class="n">trans</span><span class="o">.</span><span class="n">quantum_numbers</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">lower</span><span class="p">)</span> <span class="k">for</span> <span class="n">lower</span> <span class="ow">in</span> <span class="n">lower_state</span><span class="p">],</span>
            <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">upper</span><span class="p">)</span> <span class="k">for</span> <span class="n">upper</span> <span class="ow">in</span> <span class="n">upper_state</span><span class="p">],</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="n">trans</span></div>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">centers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">centers</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_numbers</span><span class="p">)]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">widths</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">widths</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">n_numbers</span><span class="p">)]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncertainty</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uncertainty</span> <span class="o">=</span> <span class="mf">0.005</span>
        <span class="c1"># Initialize the quantum numbers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lower_state</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">QuantumNumber</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="n">center</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">width</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">center</span><span class="p">,</span> <span class="n">width</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">centers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">widths</span><span class="p">)</span>
        <span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">j</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">qno</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lower_state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">j</span><span class="p">):</span>
                <span class="n">qno</span><span class="o">.</span><span class="n">j</span> <span class="o">=</span> <span class="n">j</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Method to format the quantum numbers into lin file format.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        line: str</span>
<span class="sd">            Upper and lower state quantum numbers formatted into lin</span>
<span class="sd">            format.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;  </span><span class="si">{upper}</span><span class="s2">  </span><span class="si">{lower}</span><span class="s2">                 </span><span class="si">{frequency}</span><span class="s2">     </span><span class="si">{uncertainty}</span><span class="s2">   1.&quot;</span>
        <span class="n">format_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;upper&quot;</span><span class="p">:</span> <span class="s2">&quot;  &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quantum_numbers</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
            <span class="s2">&quot;lower&quot;</span><span class="p">:</span> <span class="s2">&quot;  &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quantum_numbers</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="s2">&quot;frequency&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span><span class="p">,</span>
            <span class="s2">&quot;uncertainty&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncertainty</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">line</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">format_dict</span><span class="p">)</span>

<div class="viewcode-block" id="Transition.random_quantum_numbers"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.Transition.random_quantum_numbers">[docs]</a>    <span class="k">def</span> <span class="nf">random_quantum_numbers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a random set of quantum numbers for a transition. First, the lower state is generated based on</span>
<span class="sd">        lower and upper bounds specified by the user. A deepcopy is made for each lower state quantum number,</span>
<span class="sd">        and the associated upper state number is created by shifting the lower value by a random integer between</span>
<span class="sd">        -2 and 2.</span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">qno</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_state</span><span class="p">:</span>
            <span class="n">qno</span><span class="o">.</span><span class="n">roll</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upper_state</span> <span class="o">=</span> <span class="p">[</span><span class="n">qno</span><span class="o">.</span><span class="n">spawn_upper</span><span class="p">()</span> <span class="k">for</span> <span class="n">qno</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_state</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quantum_numbers</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">qno</span><span class="p">)</span> <span class="k">for</span> <span class="n">qno</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">lower_state</span><span class="p">],</span>
            <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">qno</span><span class="p">)</span> <span class="k">for</span> <span class="n">qno</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">upper_state</span><span class="p">],</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">quantum_numbers</span></div></div>


<div class="viewcode-block" id="AutoFitSession"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.AutoFitSession">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">AutoFitSession</span><span class="p">:</span>
    <span class="n">filename</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">n_numbers</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">frequencies</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">uncertainties</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">centers</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">widths</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">deltas</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">j</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">method</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;mc&quot;</span>
    <span class="n">rms_target</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1.0</span>
    <span class="n">rms</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">1e9</span>
    <span class="n">nfit</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">niter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span>
    <span class="n">nprocesses</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">debug</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">clean</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>

<div class="viewcode-block" id="AutoFitSession.from_yml"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.AutoFitSession.from_yml">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_yml</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Class method to read the settings for an AutoFitSession via YAML file.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath: str</span>
<span class="sd">            Filepath to the YAML settings file</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        AutoFitSession object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">session</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">routines</span><span class="o">.</span><span class="n">read_yaml</span><span class="p">(</span><span class="n">filepath</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">session</span></div>

<div class="viewcode-block" id="AutoFitSession.from_pkl"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.AutoFitSession.from_pkl">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">from_pkl</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to load a previously saved Pickle instance of AutoFitSession.</span>

<span class="sd">        TODO: write a check to make sure we&#39;re reading in an AutoFitSession pickle!</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath: str</span>
<span class="sd">            Filepath to the pickle file to load.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        Loaded</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="n">routines</span><span class="o">.</span><span class="n">read_obj</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="c1"># if cls.__name__ != &quot;AutoFitSession&quot;:</span>
        <span class="c1">#    raise Exception(&quot;Target file is not an AutoFitSession object!&quot;)</span>
        <span class="c1"># else:</span>
        <span class="k">return</span> <span class="bp">cls</span></div>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncertainties</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">uncertainties</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.005</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.par&quot;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;.par file does not exist!&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.par&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">read_file</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">par</span> <span class="o">=</span> <span class="n">read_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">clean</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">for</span> <span class="nb">dir</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;fits&quot;</span><span class="p">,</span> <span class="s2">&quot;yml&quot;</span><span class="p">,</span> <span class="s2">&quot;lin&quot;</span><span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">rmdir</span><span class="p">(</span><span class="nb">dir</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                    <span class="k">pass</span>
        <span class="c1"># Setup filestructure</span>
        <span class="k">for</span> <span class="n">folder</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;fits&quot;</span><span class="p">,</span> <span class="s2">&quot;yml&quot;</span><span class="p">,</span> <span class="s2">&quot;lin&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;mc&quot;</span><span class="p">,</span> <span class="s2">&quot;bruteforce&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Testing method </span><span class="si">{}</span><span class="s2"> not implemented!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">method</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;mc&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_iteration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rng</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;bruteforce&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_iteration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_brute</span>

    <span class="k">def</span> <span class="nf">_brute_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a generator that will brute force every possible combination of quantum numbers for every</span>
<span class="sd">        transition. The user sets the maximum values for each quantum number, and this function will produce a</span>
<span class="sd">        generator.</span>

<span class="sd">        The quantum number tuple that is produced from the generator is flat, and will need to be</span>
<span class="sd">        reshaped before feeding into a QuantumNumber object.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        enumerate: generator</span>
<span class="sd">            Product generator from itertools, wrapped around an enumerate generator</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># This bit of code is probably not very pythonic. The general gist of it is to generate</span>
        <span class="c1"># a nested list since for every transition (number of frequencies), we want to systematically</span>
        <span class="c1"># test every possible combination of quantum numbers.</span>
        <span class="n">possible</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">val</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_values</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="n">combinations_with_replacement</span><span class="p">(</span><span class="n">product</span><span class="p">(</span><span class="o">*</span><span class="n">possible</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span><span class="p">))</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="nf">_brute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">iteration</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        iteration</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">index</span><span class="p">,</span> <span class="n">qnos</span> <span class="o">=</span> <span class="n">iteration</span>
        <span class="c1"># Set up the quantum numbers for this transition</span>
        <span class="n">transitions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Transition</span><span class="o">.</span><span class="n">from_list</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="n">qno</span><span class="p">,</span> <span class="n">uncertainty</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">uncertainty</span><span class="p">,</span> <span class="n">qno</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncertainties</span><span class="p">,</span> <span class="n">qnos</span>
            <span class="p">)</span>
        <span class="p">]</span>
        <span class="c1"># Call SPFIT and return the fit RMS</span>
        <span class="n">index</span><span class="p">,</span> <span class="n">rms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_spfit</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">transitions</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">index</span><span class="p">,</span> <span class="n">rms</span>

    <span class="k">def</span> <span class="nf">_rng</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Private method to perform a single iteration of the whole process. Starts by generating random quantum</span>
<span class="sd">        numbers, and creates a temporary folder to run SPFIT along with the .par and .lin files.</span>

<span class="sd">        The output .fit file is parsed, and both the parsed data and the .fit file is copied back over to</span>
<span class="sd">        the working directory. An index argument will let the function be run in async while still letting</span>
<span class="sd">        the specific file index be known.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        index: int</span>
<span class="sd">            Index that keeps track of the file name to save the output as</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        index, rms: 2-tuple</span>
<span class="sd">            The current iteration index and the RMS for this iteration</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pkg</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">frequencies</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">uncertainties</span><span class="p">)</span>
        <span class="c1"># Make sure a different seed is used to other parallel jobs</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">()</span>
        <span class="c1"># Initialize the Transition object, which handles all of the quantum numbers for a given transition</span>
        <span class="n">transitions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">Transition</span><span class="p">(</span>
                <span class="n">frequency</span><span class="p">,</span>
                <span class="n">uncertainty</span><span class="o">=</span><span class="n">uncertainty</span><span class="p">,</span>
                <span class="n">n_numbers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_numbers</span><span class="p">,</span>
                <span class="n">centers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">centers</span><span class="p">,</span>
                <span class="n">widths</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">widths</span><span class="p">,</span>
                <span class="n">deltas</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">deltas</span><span class="p">,</span>
                <span class="n">j</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">j</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">uncertainty</span> <span class="ow">in</span> <span class="n">pkg</span>
        <span class="p">]</span>
        <span class="c1"># Generate the quantum numbers for each transition</span>
        <span class="n">_</span> <span class="o">=</span> <span class="p">[</span><span class="n">transition</span><span class="o">.</span><span class="n">random_quantum_numbers</span><span class="p">()</span> <span class="k">for</span> <span class="n">transition</span> <span class="ow">in</span> <span class="n">transitions</span><span class="p">]</span>
        <span class="n">index</span><span class="p">,</span> <span class="n">rms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_check_spfit</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">transitions</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">index</span><span class="p">,</span> <span class="n">rms</span>

    <span class="k">def</span> <span class="nf">_check_spfit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">transitions</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Driver to actually run SPFIT and parse the output of the .fit file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lines</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">transition</span><span class="p">)</span> <span class="k">for</span> <span class="n">transition</span> <span class="ow">in</span> <span class="n">transitions</span><span class="p">])</span>
        <span class="n">update</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.lin&quot;</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">write_file</span><span class="p">:</span>
                <span class="n">write_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.par&quot;</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">write_file</span><span class="p">:</span>
                <span class="n">write_file</span><span class="o">.</span><span class="n">writelines</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">par</span><span class="p">)</span>
            <span class="c1"># Run SPFIT</span>
            <span class="n">routines</span><span class="o">.</span><span class="n">run_spfit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
            <span class="c1"># Parse the output</span>
            <span class="n">fit_dict</span> <span class="o">=</span> <span class="n">parsers</span><span class="o">.</span><span class="n">parse_fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.fit&quot;</span><span class="p">)</span>
            <span class="c1"># If the RMS is improved upon, and there is more than one line fit</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">fit_dict</span><span class="p">[</span><span class="s2">&quot;rms&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">rms</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fit_dict</span><span class="p">[</span><span class="s2">&quot;o-c&quot;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nfit</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">fit_dict</span><span class="p">[</span><span class="s2">&quot;rms&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.001</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">.par&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">),</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">read_file</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">par</span> <span class="o">=</span> <span class="n">read_file</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">nfit</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fit_dict</span><span class="p">[</span><span class="s2">&quot;o-c&quot;</span><span class="p">])</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">rms</span> <span class="o">=</span> <span class="n">fit_dict</span><span class="p">[</span><span class="s2">&quot;rms&quot;</span><span class="p">]</span>
                    <span class="n">update</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="c1"># Dump files only if debug mode is on, or we had a successful iteration</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="ow">is</span> <span class="kc">True</span> <span class="ow">or</span> <span class="n">update</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># Copy some of the data back over</span>
                <span class="n">routines</span><span class="o">.</span><span class="n">dump_yaml</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wd</span><span class="p">,</span> <span class="s2">&quot;yml/</span><span class="si">{}</span><span class="s2">.yml&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">)),</span> <span class="n">fit_dict</span>
                <span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.fit&quot;</span><span class="p">,</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wd</span><span class="p">,</span> <span class="s2">&quot;fits/</span><span class="si">{}</span><span class="s2">.fit&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">)),</span>
                <span class="p">)</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.lin&quot;</span><span class="p">,</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wd</span><span class="p">,</span> <span class="s2">&quot;lin/</span><span class="si">{}</span><span class="s2">.lin&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">)),</span>
                <span class="p">)</span>
            <span class="c1"># Not sure if this is necessary, but just in case</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wd</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">index</span><span class="p">,</span> <span class="n">fit_dict</span><span class="p">[</span><span class="s2">&quot;rms&quot;</span><span class="p">]</span>

<div class="viewcode-block" id="AutoFitSession.run"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.AutoFitSession.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nprocesses</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">headless</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;mc&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the search for assignments. The function wraps a private method, and is parallelized with a joblib</span>
<span class="sd">        Pool.</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        niter: int or None, optional</span>
<span class="sd">            Number of iterations. If None, uses the class attribute, otherwise the user specified value.</span>
<span class="sd">        nprocesses: int or None, optional</span>
<span class="sd">            Number of parallel jobs to break the task into. If None, uses the class attribute.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        results: list</span>
<span class="sd">            List of the final RMS values from individual SPFIT runs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">niter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">niter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">niter</span>
        <span class="k">if</span> <span class="n">nprocesses</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">nprocesses</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">nprocesses</span>
        <span class="n">pool</span> <span class="o">=</span> <span class="n">joblib</span><span class="o">.</span><span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">nprocesses</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">30.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">method</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;mc&quot;</span><span class="p">,</span> <span class="s2">&quot;bruteforce&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;mc&quot;</span><span class="p">:</span>
                <span class="n">iterator</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">niter</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_iteration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rng</span>
            <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;bruteforce&quot;</span><span class="p">:</span>
                <span class="n">iterator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_brute_generator</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_iteration</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_brute</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Iterator not implemented. Please choose mc or bruteforce.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">headless</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">iterator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>
        <span class="c1"># Distribute and run the quantum number testing</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">pool</span><span class="p">(</span><span class="n">joblib</span><span class="o">.</span><span class="n">delayed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_iteration</span><span class="p">)(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">results</span> <span class="o">=</span> <span class="n">results</span>
        <span class="k">return</span> <span class="n">results</span></div>

<div class="viewcode-block" id="AutoFitSession.filter"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.AutoFitSession.filter">[docs]</a>    <span class="k">def</span> <span class="nf">filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nlines</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Reads in all of the YAML parsed fits, and reduces the number of possible fits</span>
<span class="sd">        a person has to look through.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        nlines: int</span>
<span class="sd">            Integer value for the minimum number of lines seen in the observed - calc. parse</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        viable: dict</span>
<span class="sd">            Dictionary with indexes corresponding to the fit number, and values are the parsed</span>
<span class="sd">            fit dictionaries</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fits</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">index</span><span class="p">:</span> <span class="n">routines</span><span class="o">.</span><span class="n">read_yaml</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;yml/*.yml&quot;</span><span class="p">))</span>
        <span class="p">}</span>
        <span class="c1"># Find all fits where the number of actual fitted lines exceeds nlines</span>
        <span class="n">viable</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">index</span><span class="p">:</span> <span class="n">fit</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">fit</span> <span class="ow">in</span> <span class="n">fits</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fit</span><span class="p">[</span><span class="s2">&quot;o-c&quot;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">nlines</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">viable</span></div>

<div class="viewcode-block" id="AutoFitSession.save"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.AutoFitSession.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dump the current session to disk as a Pickle file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filepath: str, optional</span>
<span class="sd">            Filepath to save the file to. If None, uses the filename attribute plus .pkl extension</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filepath</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filepath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span> <span class="o">+</span> <span class="s2">&quot;.pkl&quot;</span>
        <span class="n">routines</span><span class="o">.</span><span class="n">save_obj</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="GenerateCatalog"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.GenerateCatalog">[docs]</a><span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">GenerateCatalog</span><span class="p">:</span>
    <span class="n">niter</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="n">temp_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">out_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="n">temp_dict</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">constants_dict</span><span class="p">:</span> <span class="n">Dict</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">dict</span><span class="p">)</span>
    <span class="n">constants</span><span class="p">:</span> <span class="n">List</span> <span class="o">=</span> <span class="n">field</span><span class="p">(</span><span class="n">default_factory</span><span class="o">=</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">cwd</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__post_init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">temp_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">out_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">out_path</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Target template folder is missing!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cwd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">counter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_count_generator</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_count_generator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Private generator for counting the simulation number.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        index : str</span>
<span class="sd">            Left zero-padded string corresponding to the index</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">niter</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{index:07d}</span><span class="s2">&quot;</span>

    <span class="k">def</span> <span class="nf">_read_templates</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Private method for reading in the var and int file templates. Will</span>
<span class="sd">        perform checks to make sure that the correct number of templates are</span>
<span class="sd">        actually found.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="n">template_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_path</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&quot;template*&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">template_paths</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Template files missing; found </span><span class="si">{template_paths}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_path</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&quot;template*&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">temp_dict</span><span class="p">[</span><span class="n">path</span><span class="o">.</span><span class="n">suffix</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">read_text</span><span class="p">()</span>

<div class="viewcode-block" id="GenerateCatalog.generate_constants"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.GenerateCatalog.generate_constants">[docs]</a>    <span class="k">def</span> <span class="nf">generate_constants</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mf">1000.0</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="mf">10000.0</span><span class="p">,</span> <span class="n">distortion</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to generate a random set of constants for an Asymmetric top</span>
<span class="sd">        based on a uniform random distribution. This also includes centrifugal</span>
<span class="sd">        distortion terms.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        lower, upper : float, optional</span>
<span class="sd">            Lower and upper bounds for constants to be generated, in MHz.</span>
<span class="sd">        distortion : bool, optional</span>
<span class="sd">            If True, quartic centrifugal distortion terms are also included</span>
<span class="sd">            in the simulation. This option is on by default.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        constants_dict : dict</span>
<span class="sd">            Dictionary with generated rotational constants</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">lower</span> <span class="o">&lt;=</span> <span class="n">upper</span>
        <span class="n">c</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">distortion</span><span class="p">:</span>
            <span class="c1"># Generate random values for quartic centrifugal distortion as well</span>
            <span class="n">cd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">1e-6</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="n">dj</span><span class="p">,</span> <span class="n">djk</span><span class="p">,</span> <span class="n">dk</span><span class="p">,</span> <span class="n">d1</span><span class="p">,</span> <span class="n">d2</span> <span class="o">=</span> <span class="n">cd</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Otherwise set CD terms to zero and not use them</span>
            <span class="n">dj</span> <span class="o">=</span> <span class="n">djk</span> <span class="o">=</span> <span class="n">dk</span> <span class="o">=</span> <span class="n">d1</span> <span class="o">=</span> <span class="n">d2</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="c1"># Generate dipole moment as boolean values</span>
        <span class="n">dipoles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="c1"># Make sure that we have at least one dipole moment; at the very least</span>
        <span class="c1"># an a-type</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dipoles</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">dipoles</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="n">u_a</span><span class="p">,</span> <span class="n">u_b</span><span class="p">,</span> <span class="n">u_c</span> <span class="o">=</span> <span class="n">dipoles</span>
        <span class="c1"># This part ensures that there is a minimum working example</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constants_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="mf">10000.0</span><span class="p">,</span>
            <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="mf">5000.0</span><span class="p">,</span>
            <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="mf">2000.0</span><span class="p">,</span>
            <span class="s2">&quot;u_a&quot;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>
            <span class="s2">&quot;u_b&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
            <span class="s2">&quot;u_c&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constants_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="o">**</span><span class="p">{</span>
                <span class="s2">&quot;A&quot;</span><span class="p">:</span> <span class="n">a</span><span class="p">,</span>
                <span class="s2">&quot;B&quot;</span><span class="p">:</span> <span class="n">b</span><span class="p">,</span>
                <span class="s2">&quot;C&quot;</span><span class="p">:</span> <span class="n">c</span><span class="p">,</span>
                <span class="s2">&quot;DJ&quot;</span><span class="p">:</span> <span class="n">dj</span><span class="p">,</span>
                <span class="s2">&quot;DJK&quot;</span><span class="p">:</span> <span class="n">djk</span><span class="p">,</span>
                <span class="s2">&quot;DK&quot;</span><span class="p">:</span> <span class="n">dk</span><span class="p">,</span>
                <span class="s2">&quot;d1&quot;</span><span class="p">:</span> <span class="n">d1</span><span class="p">,</span>
                <span class="s2">&quot;d2&quot;</span><span class="p">:</span> <span class="n">d2</span><span class="p">,</span>
                <span class="s2">&quot;u_a&quot;</span><span class="p">:</span> <span class="n">u_a</span><span class="p">,</span>
                <span class="s2">&quot;u_b&quot;</span><span class="p">:</span> <span class="n">u_b</span><span class="p">,</span>
                <span class="s2">&quot;u_c&quot;</span><span class="p">:</span> <span class="n">u_c</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">constants_dict</span></div>

<div class="viewcode-block" id="GenerateCatalog.run_spcat"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.GenerateCatalog.run_spcat">[docs]</a>    <span class="k">def</span> <span class="nf">run_spcat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Function to run SPCAT from within Python. The function does so with</span>
<span class="sd">        temporary folders within a context manager, such that there are no</span>
<span class="sd">        scratch files left behind when the process is finished.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        catalog : LineList object</span>
<span class="sd">            PySpecTools LineList object based on the digested catalog</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">counter</span><span class="p">)</span>
        <span class="c1"># Assume that the constants dictionary actually has values in it</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constants_dict</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span>
        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">temp_dir</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">temp_dir</span><span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;molecule.var&quot;</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">write_file</span><span class="p">:</span>
                    <span class="n">write_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">temp_dict</span><span class="p">[</span><span class="s2">&quot;.var&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constants_dict</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;molecule.int&quot;</span><span class="p">,</span> <span class="s2">&quot;w+&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">write_file</span><span class="p">:</span>
                    <span class="n">write_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">temp_dict</span><span class="p">[</span><span class="s2">&quot;.int&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">format_map</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constants_dict</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="c1"># Call SPCAT</span>
                <span class="n">_</span> <span class="o">=</span> <span class="n">run</span><span class="p">([</span><span class="s2">&quot;spcat&quot;</span><span class="p">,</span> <span class="s2">&quot;molecule&quot;</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">PIPE</span><span class="p">)</span>
                <span class="c1"># Create LineList object from the catalog</span>
                <span class="n">catalog</span> <span class="o">=</span> <span class="n">LineList</span><span class="o">.</span><span class="n">from_catalog</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s2">&quot;molecule.cat&quot;</span><span class="p">)</span>
                <span class="n">catalog</span><span class="o">.</span><span class="n">constants</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constants_dict</span>
                <span class="k">return</span> <span class="n">catalog</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;temp_dict is missing entries!&quot;</span><span class="p">)</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="c1"># finally statement to make sure we go back to the original</span>
                <span class="c1"># working directory before finishing</span>
                <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cwd</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_iteration</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">constants</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_constants</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">catalog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">run_spcat</span><span class="p">()</span>
        <span class="c1"># Add this to the list of constants created</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constants</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">constants</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">catalog</span>

<div class="viewcode-block" id="GenerateCatalog.run_batch"><a class="viewcode-back" href="../../pyspectools.html#pyspectools.pypickett.GenerateCatalog.run_batch">[docs]</a>    <span class="k">def</span> <span class="nf">run_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">niter</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">progressbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run a batch of simulations. This is the main function to be called by a</span>
<span class="sd">        user, and will automatically carry out all of the book keeping and</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        niter : int or None, optional</span>
<span class="sd">            Number of simulations to perform. This option overrides the class</span>
<span class="sd">            attribute, and if the user provided argument is None, will just use</span>
<span class="sd">            that instead.</span>
<span class="sd">        progressbar : bool, optional</span>
<span class="sd">            If True, wraps the iterator with a `tqdm` progress bar.</span>
<span class="sd">        kwargs</span>
<span class="sd">            Additional kwargs are passed into the `generate_constants`</span>
<span class="sd">            function, which allows for control on bounds, etc.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Reset the constants list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constants</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">niter</span><span class="p">:</span>
            <span class="n">niter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">niter</span>
        <span class="c1"># Set up an iterator for the batch</span>
        <span class="n">iterator</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">niter</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">progressbar</span><span class="p">:</span>
            <span class="n">iterator</span> <span class="o">=</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">iterator</span><span class="p">)</span>
        <span class="c1"># Run the loop</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_iteration</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">results</span></div></div>
</pre></div>

        </div>
      </div>

      <div id="side-menu-container">

        <div id="search" role="search">
        <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
            <input type="text" name="q" placeholder="Search..." />
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
        </form>
</div>

        <div id="side-menu" role="navigation">

          
  
    
  
  
    <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq.html">PySpecTools FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pyspectools.spectra.html">pyspectools.spectra package</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">PySpecTools</a></li>
</ul>

  


        </div>

        

      </div>

    </div>

<footer>
    <div id="footer-info">
        <ul id="build-details">
            

            

            
        </ul>
        <div id="credit">
            created with <a href="http://sphinx-doc.org/">Sphinx</a> and <a href="https://github.com/Autophagy/insegel">Insegel</a>

        </div>
    </div>

    <a id="menu-toggle" class="fa fa-bars" aria-hidden="true"></a>

    <script type="text/javascript">
      $("#menu-toggle").click(function() {
        $("#menu-toggle").toggleClass("toggled");
        $("#side-menu-container").slideToggle(300);
      });
    </script>

</footer> 

</div>

</body>
</html>